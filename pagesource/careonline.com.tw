


<!DOCTYPE html>

<html>
<head>
    <meta name="viewport" content="width=device-width initial-scale=1.0" />
    <title>Map</title>

    <link href="/Content/mapcss?v=85IX1OZnEEfFPTPvinzKvCSnMDuGGPSM7y2TNhEH6H41" rel="stylesheet"/>

    <link rel="stylesheet" href="/Content/rwd.css?v=20170622" />
    
</head>
<body>
    <div id="search" class="search">
    <div class="container">
<form action="/Home/FindHospital" class="form-horizontal" method="post" role="form">        <div class="row">
            <div class="col-xs-12">
                <div class="row">
                    <div class="col-xs-12 col-md-12" style="padding: 0;">
                        <div class="col-xs-12 hospTypeList">
                            <input type="hidden" id="hidHospType" name="hidHospType" value="診所" />
                            <button type="button" class="btn btn-primary hosp1">診所</button>
                            <button type="button" class="btn btn-default hosp2">藥局</button>
                            <button type="button" class="btn btn-default hosp3">居家護理</button>
                            <button type="button" class="btn btn-default hosp4">康復之家</button>
                        </div>
                        <div class="col-xs-12 condition">
                            <div class="form-group">
                                <div class="col-xs-12">
                                    <label class="control-label" for="">日期</label>
                                    <input id="date" name="date" type='text' class="form-control date" />
                                    <select id="time" name="time" class="form-control time">
                                        <option>上午</option>
                                        <option>下午</option>
                                        <option>晚上</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="col-xs-12">
                                    <label class="control-label" for="">縣市</label>
                                    <div id="twzipcode" class="inlineBlock"></div>
                                </div>
                            </div>
                            <div id="divisionWrap" class="form-group">
                                <div class="col-xs-12">
                                    <label class="control-label" for="">科別</label>
                                    <select id="hospDivision" name="hospDivision" class="form-control hospDivision"></select>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="col-xs-12">
                                    <label class="control-label" for="">名稱</label>
                                    <input id="hospName" name="hospName" placeholder="請輸入診所名稱" type="text" value="" class="form-control input">
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="col-xs-12">
                                    <label class="control-label" for="">地址</label>
                                    <input id="address" name="address" placeholder="請輸入診所地址" type="text" value="" class="form-control input">
                                    <input id="btnSearch" type="button" class="btn btn-default" value="搜尋" />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <button id="btnExpand" type="button" class="btn btn-default search_button">進階搜尋</button>
</form>    </div>
</div>

    <div id="map"></div>
    
    
    <div id="legend" class="legend">
        <table class="css-table">
            <thead>
                <tr>
                    <td style="background-color: gray; color: white;">圖例</td>
                    <td style="background-color: gray;"></td>
                    <td><div id="legendExpand" class="expand"><span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span></div></td>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>看診</td>                    
                    <td style="width: 20px;"><i class="sprite sprite-open_nm" style="margin: 3px;"></i></td>
                    <td><i class="sprite sprite-open_m"></i></td>
                </tr>
                <tr>
                    <td>休診</td>                    
                    <td><i class="sprite sprite-close_nm" style="margin: 3px;"></i></td>
                    <td><i class="sprite sprite-close_m"></i></td>
                </tr>
            </tbody>
        </table>
    </div>

    <script src="/bundles/jquery?v=_vU_acqM9vSfyehOzSlOKnUbuXHgiKK2NrhpicYLilY1"></script>

    <script src="/bundles/bootstrap?v=f0Ddf2Ko7zrd5YYP7dnqhRtp_1xAb-tVR2ztd0FI8Yo1"></script>

    <script type="text/javascript">
        $(function () {
            $(".hospTypeList > button").on("click", function () {
                $(".hospTypeList > button").removeClass("btn-primary").addClass("btn-default");
                $this = $(this);
                $this.addClass("btn-primary");
                $("#hidHospType").val($this.text());
                if ($this.text() == "藥局") {
                    $("#divisionWrap").hide();
                    $("#map").css("height", "calc(100% - 205px)");
                } else {
                    $("#divisionWrap").show();
                    $("#map").css("height", "calc(100% - 245px)");
                }
            });

            $('#twzipcode').twzipcode({
                'zipcodeIntoDistrict': true,
                'css': ['county form-control', 'district form-control', 'zipcode form-control hidden'],
                'detect': function (data) {
                    //$("#twzipcode").twzipcode('reset');
                    //$("select[name=district]").val("");
                    careOnline.location = { "lat": data.coords.latitude, "lng": data.coords.longitude };
                    if (careOnline.map) {
                        careOnline.map.setCenter(careOnline.location);
                        $.ajax({
                            url: "/api/TaiwanCity" + "?x=" + data.coords.longitude + "&y=" + data.coords.latitude,
                            dataType: "json"
                        }).done(function (city) {
                            $('#twzipcode').twzipcode('set', {
                                'county': city.County,
                                'district': city.Town
                            });

                            if ($('#hospDivision').val() !== "") { $("#btnSearch").click(); }
                        });
                    }

                }
            });

            $('#date').datetimepicker({
                locale: 'zh-tw',
                format: 'YYYY年MM月DD日 dddd',
                defaultDate: new Date()
            });

            //getLocation();

            $("#btnSearch").on("click", function () {
                for (var i = 0; i < careOnline.markers.length; i++) {
                    careOnline.markers[i].setMap(null);
                }
                careOnline.markers = [];

                var formData = $('form').serialize();
                $.ajax({
                    type: "POST",
                    url: "/Home/FindHospital",
                    data: formData,
                    dataType: "json"
                }).done(function (data) {
                    if (data.Status == "OK") {
                        careOnline.infowindow = new google.maps.InfoWindow();
     
                        var open_m = { //看診_會員icon
                            url: "/Content/images/spritesheet.png?v=0227",
                            size: new google.maps.Size(30, 38), // the size it should be on the map
                            origin: new google.maps.Point(69, 3), // position in the sprite
                            anchor: new google.maps.Point(15, 38)
                        };
                        var open_nm = { //看診_非會員icon
                            url: "/Content/images/spritesheet.png?v=0227",
                            size: new google.maps.Size(24, 32), // the size it should be on the map
                            origin: new google.maps.Point(105, 3), // position in the sprite
                            anchor: new google.maps.Point(12, 32)
                        };
                        var close_m = { //休診_會員icon
                            url: "/Content/images/spritesheet.png?v=0227",
                            size: new google.maps.Size(30, 38), // the size it should be on the map
                            origin: new google.maps.Point(3, 3), // position in the sprite
                            anchor: new google.maps.Point(15, 38)
                        };
                        var close_nm = { //休診_非會員icon
                            url: "/Content/images/spritesheet.png?v=0227",
                            size: new google.maps.Size(24, 32), // the size it should be on the map
                            origin: new google.maps.Point(39, 3), // position in the sprite
                            anchor: new google.maps.Point(12, 32)
                        };

                        var m = moment($('#date').val(), ['YYYY年MM月DD日 dddd'], 'zh-tw');
                        var tt = $("#time").val();
                        var now = moment(new Date());
                        var hour = now.hour();
                        var isClose = false;
                        if (m.format("YYYY-MM-DD") === now.format("YYYY-MM-DD")) {
                            if (hour >= 21 && hour <= 23) {
                                isClose = true;
                            }
                        }

                        var condition = m.format('dddd') + tt + '看診';

                        var open_DEMO = { //照護線上診所DEMO
                            url: "/Content/images/icon.png",
                            scaledSize: new google.maps.Size(215, 73), // the size it should be on the map
                            origin: new google.maps.Point(0, 0), // position in the sprite
                            anchor: new google.maps.Point(16.5, 73)
                        };

                        var open_3507320848 = { //懿聖皮膚科診所
                            url: "/Content/images/3507320848.png",
                            scaledSize: new google.maps.Size(215, 73), // the size it should be on the map
                            origin: new google.maps.Point(0, 0), // position in the sprite
                            anchor: new google.maps.Point(16.5, 73)
                        };

                        var open_3505380159 = { //朝陽泌尿科診所
                            url: "/Content/images/3505380159.png",
                            scaledSize: new google.maps.Size(215, 73), // the size it should be on the map
                            origin: new google.maps.Point(0, 0), // position in the sprite
                            anchor: new google.maps.Point(16.5, 73)
                        };

                        var open_3517030940 = { //吳及時皮膚科診所（自費）
                            url: "/Content/images/3517030940.png",
                            scaledSize: new google.maps.Size(215, 73), // the size it should be on the map
                            origin: new google.maps.Point(0, 0), // position in the sprite
                            anchor: new google.maps.Point(16.5, 73)
                        };

                        var open_3532017729 = { //杏蘊婦產科
                            url: "/Content/images/3532017729.png",
                            scaledSize: new google.maps.Size(215, 73), // the size it should be on the map
                            origin: new google.maps.Point(0, 0), // position in the sprite
                            anchor: new google.maps.Point(16.5, 73)
                        };

                        var open_3505350017 = { //安安婦幼診所
                            url: "/Content/images/3505350017.png",
                            scaledSize: new google.maps.Size(215, 73), // the size it should be on the map
                            origin: new google.maps.Point(0, 0), // position in the sprite
                            anchor: new google.maps.Point(16.5, 73)
                        };

                        var open_3502072258 = { //宏祐診所
                            url: "/Content/images/3502072258.png",
                            scaledSize: new google.maps.Size(215, 73), // the size it should be on the map
                            origin: new google.maps.Point(0, 0), // position in the sprite
                            anchor: new google.maps.Point(16.5, 73)
                        };

                        var open_3521013662 = { //璺到底皮膚專科診所
                            url: "/Content/images/3521013662.png",
                            scaledSize: new google.maps.Size(215, 73), // the size it should be on the map
                            origin: new google.maps.Point(0, 0), // position in the sprite
                            anchor: new google.maps.Point(16.5, 73)
                        };

                        var open_3543013568 = { //海豐診所
                            url: "/Content/images/3543013568.png",
                            scaledSize: new google.maps.Size(215, 73), // the size it should be on the map
                            origin: new google.maps.Point(0, 0), // position in the sprite
                            anchor: new google.maps.Point(16.5, 73)
                        };

                        var hosps = ["DEMO", "3507320848", "3505380159", "3517030940", "3532017729", "3505350017", "3502072258", "3521013662", "3543013568"];

                        $.each(data.Data, function (idx, item) {

                            var icon = close_nm;
                            if ((item.HospConsultingHours && item.HospConsultingHours.indexOf(condition) > -1 && !isClose) || ($("#hidHospType").val() == "藥局")) {
                                icon = open_nm;
                            }

                            if (item.HospID == "DEMO") {
                                icon = open_demo;
                            }

                            if (item.HospID == "3507320848") {
                                icon = open_3507320848
                            }

                            if (item.HospID == "3505380159") {
                                icon = open_3505380159;
                            }

                            if (item.HospID == "3517030940") {
                                icon = open_3517030940
                            }

                            if (item.HospID == "3532017729") {
                                icon = open_3532017729;
                            }

                            if (item.HospID == "3505350017") {
                                icon = open_3505350017
                            }

                            if (item.HospID == "3502072258") {
                                icon = open_3502072258;
                            }

                            if (item.HospID == "3521013662") {
                                icon = open_3521013662
                            }

                            if (item.HospID == "3543013568") {
                                icon = open_3543013568;
                            }

                            var content = "<div><table><tbody><tr><td style='text-align: center;'>" + item.HospName + "</td></tr><tr><td>電話：<a href='tel:" + item.HospTel + "'>" + item.HospTel + "</a></td></tr><tr><td>地址：" + item.HospAddress + "</td></tr></tbody></table></div>";

                            var isMember = hosps.indexOf(item.HospID) > -1;
                            var marker = new google.maps.Marker({
                                position: new google.maps.LatLng(item.HospLat, item.HospLng),
                                map: careOnline.map,
                                title: item.HospName,
                                hospId: item.HospID,
                                isMember: isMember,
                                icon: icon
                            });

                            
                            if (isMember) {
                                marker.setZIndex(9999999);
                            }

                            marker.addListener('click', function () {
                                if (this.isMember) {
                                    window.open("https://careonline.com.tw/Clinic/" + this.hospId);
                                } else {
                                    careOnline.infowindow.setContent(content);
                                    careOnline.infowindow.open(careOnline.map, marker);
                                }
                                //if (this.title == "照護線上診所DEMO") {
                                //    window.open("https://careonline.com.tw/Clinic/DEMO")
                                //} else if (this.hospId == "懿聖皮膚科診所") {
                                //    window.open("https://careonline.com.tw/Clinic/3507320848");
                                //} else if (this.hospId == "朝陽泌尿科診所") {
                                //    window.open("https://careonline.com.tw/Clinic/3505380159");
                                //} else if (this.hospId == "吳及時皮膚科診所（自費）") {
                                //    window.open("https://careonline.com.tw/Clinic/3517030940");
                                //} else if (this.hospId == "杏蘊婦產科") {
                                //    window.open("https://careonline.com.tw/Clinic/3532017729");
                                //} else if (this.hospId == "安安婦幼診所") {
                                //    window.open("https://careonline.com.tw/Clinic/3505350017");
                                //} else if (this.hospId == "宏祐診所") {
                                //    window.open("https://careonline.com.tw/Clinic/3502072258");
                                //} else if (this.hospId == "璺到底皮膚專科診所") {
                                //    window.open("https://careonline.com.tw/Clinic/3521013662");
                                //} else if (this.hospId == "海豐診所") {
                                //    window.open("https://careonline.com.tw/Clinic/3543013568");
                                //} else {
                                //    careOnline.infowindow.setContent(content);
                                //    careOnline.infowindow.open(careOnline.map, marker);
                                //}
                            });

                            careOnline.markers.push(marker);
                        });
                        var bounds = new google.maps.LatLngBounds();
                        for (var i = 0; i < careOnline.markers.length; i++) {
                            bounds.extend(careOnline.markers[i].getPosition());
                        }

                        if (careOnline.markers.length > 0) {
                            careOnline.map.fitBounds(bounds);
                        } else {
                            alert("查無資料");
                        }

                        //console.log(data.Data);
                    } else {
                        console.log("no data");
                    }
                }).fail(function (err) {
                    console.log("something wrong!");
                });
            });
        });

        var careOnline = {
            markers: [],
            isExpand: false,
            isLegendExpand: false,
            searchPanelTop: 0,
            divisions: [["", "（全部）"], ["不分科", "不分科（一般科）"], ["家醫科", "家庭醫學科"], ["內科", "內科"], ["外科", "外科"], ["兒科", "兒科"], ["婦產科", "婦產科"], ["骨科", "骨科"], ["神經外科", "神經外科"], ["泌尿科", "泌尿科"], ["耳鼻喉科", "耳鼻喉科"], ["眼科", "眼科"], ["皮膚科", "皮膚科"], ["神經科", "神經科"], ["精神科", "精神科"], ["復健科", "復健科"], ["整形外科", "整形外科"], ["職業醫學科", "職業醫學科"], ["急診醫學科", "急診醫學科"], ["結核科", "結核科"], ["洗腎科", "洗腎科"], ["牙科", "牙科"], ["復形牙科", "復形牙科"], ["牙髓病科", "牙髓病科"], ["牙周病科", "牙周病科"], ["補綴牙科", "補綴牙科"], ["齒顎矯正科", "齒顎矯正科"], ["兒童牙科", "兒童牙科"], ["口腔顎面外科", "口腔顎面外科"], ["中醫科", "中醫科"], ["麻醉科", "麻醉科"]]
        };

        function initMap() {
            var styles = [
    {
        "featureType": "poi",
        "elementType": "all",
        "stylers": [
            {
                "visibility": "on"
            }
        ]
    },
    {
        "featureType": "poi",
        "elementType": "labels",
        "stylers": [
            {
                "visibility": "off"
            }
        ]
    },
    {
        "featureType": "poi.government",
        "elementType": "labels",
        "stylers": [
            {
                "visibility": "on"
            }
        ]
    }
            ];

            careOnline.map = new google.maps.Map(document.getElementById('map'), {
                center: careOnline.location || { lat: 23.000224, lng: 120.224608 },
                zoom: 15,
                styles: styles
            });

            var $divisions = $("#hospDivision");
            $.each(careOnline.divisions, function (idx, item) {
                $divisions.append("<option value='" + item[0] + "'>" + item[1] + "</option>");
            })

            var $searchPanel = $("#search");
            setSearchPanelTop();
            $searchPanel.css('top', careOnline.searchPanelTop);
            $("#btnExpand").on("click", function () {
                careOnline.isExpand = !careOnline.isExpand;
                setSearchPanelTop();
                $searchPanel.animate({ top: careOnline.searchPanelTop }, 300);
            });

            $(window).resize(function () { setSearchPanelTop(); $searchPanel.css({ top: careOnline.searchPanelTop }) });

            var querystring = getUrlVars();
            if (querystring["division"]) {
                var divisions = querystring["division"].split(",");
                $('#hospDivision option[value=' + decodeURIComponent(divisions[0]) + ']').attr('selected', true);
                if (careOnline.location) { $("#btnSearch").click(); }
            }

            if (querystring["hosptype"]) {
                var hospType = decodeURIComponent(querystring["hosptype"]);
                if (hospType == "藥局") {
                    $(".hosp2").click();
                }                
            }

            $("#legendExpand").on("click", function () {
                careOnline.isLegendExpand = !careOnline.isLegendExpand;
                $(this).find("span")
                    .removeClass((careOnline.isLegendExpand ? "glyphicon-chevron-right" : "glyphicon-chevron-left"))
                    .addClass((careOnline.isLegendExpand ? "glyphicon-chevron-left" : "glyphicon-chevron-right"));
                $("#legend").animate({ left: (careOnline.isLegendExpand ? -82 : -140) }, 300);
            });
        }

        function setSearchPanelTop() {
            careOnline.searchPanelTop = careOnline.isExpand ? 0 : -$("#search").height() + 5;
        }

        function getLocation() {
            var output;
            if (!navigator.geolocation) {
                return;
            }

            function success(position) {
                careOnline.location = { "lat": position.coords.latitude, "lng": position.coords.longitude };
                //initMap();
                if (careOnline.map) {
                    careOnline.map.setCenter(careOnline.location);
                }
            };

            function error() {
                console.log("get location error");
                //initMap();
            };

            function getCurrentPosition() {
                navigator.geolocation.getCurrentPosition(success, error, { timeout: 5000 });
            }
            setTimeout(getCurrentPosition, 3000);
        }

        function getUrlVars() {
            var vars = [], hash;
            var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
            for (var i = 0; i < hashes.length; i++) {
                hash = hashes[i].split('=');
                vars.push(hash[0]);
                vars[hash[0]] = hash[1];
            }
            return vars;
        }
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDpMA2Y0cCelflvQ-XNTBRrfXpDYJBh_J4&callback=initMap">
    </script>    
</body>
</html>