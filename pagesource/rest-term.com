<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta property="fb:admins" content="100002055572704" /> 
<link rel="stylesheet" href="http://rest-term.com/wp-content/themes/simple-organization/style.css?x45852" type="text/css" media="screen" />
<link rel="pingback" href="http://rest-term.com/xmlrpc.php" />
<link rel="alternate" type="application/rss+xml" href="http://feeds.feedburner.com/rest-term" title="RSS 2.0" />
<link rel="alternate" type="application/atom+xml" href="http://feeds.feedburner.com/rest-term" title="Atom cite contents" />
<link rel="shortcut icon" href="http://rest-term.com/favicon.ico?x45852" />
<title>
            Rest Term
    </title>
<link rel='dns-prefetch' href='//s.w.org' />
<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2.4\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2.4\/svg\/","svgExt":".svg","source":{"concatemoji":"http:\/\/rest-term.com\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.9.3"}};
			!function(a,b,c){function d(a,b){var c=String.fromCharCode;l.clearRect(0,0,k.width,k.height),l.fillText(c.apply(this,a),0,0);var d=k.toDataURL();l.clearRect(0,0,k.width,k.height),l.fillText(c.apply(this,b),0,0);var e=k.toDataURL();return d===e}function e(a){var b;if(!l||!l.fillText)return!1;switch(l.textBaseline="top",l.font="600 32px Arial",a){case"flag":return!(b=d([55356,56826,55356,56819],[55356,56826,8203,55356,56819]))&&(b=d([55356,57332,56128,56423,56128,56418,56128,56421,56128,56430,56128,56423,56128,56447],[55356,57332,8203,56128,56423,8203,56128,56418,8203,56128,56421,8203,56128,56430,8203,56128,56423,8203,56128,56447]),!b);case"emoji":return b=d([55357,56692,8205,9792,65039],[55357,56692,8203,9792,65039]),!b}return!1}function f(a){var c=b.createElement("script");c.src=a,c.defer=c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var g,h,i,j,k=b.createElement("canvas"),l=k.getContext&&k.getContext("2d");for(j=Array("flag","emoji"),c.supports={everything:!0,everythingExceptFlag:!0},i=0;i<j.length;i++)c.supports[j[i]]=e(j[i]),c.supports.everything=c.supports.everything&&c.supports[j[i]],"flag"!==j[i]&&(c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&c.supports[j[i]]);c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&!c.supports.flag,c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.everything||(h=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",h,!1),a.addEventListener("load",h,!1)):(a.attachEvent("onload",h),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),g=c.source||{},g.concatemoji?f(g.concatemoji):g.wpemoji&&g.twemoji&&(f(g.twemoji),f(g.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
<link rel='stylesheet' id='crayon-theme-ado-css' href='http://rest-term.com/wp-content/plugins/crayon-syntax-highlighter/themes/ado/ado.css?x45852' type='text/css' media='all' />
<link rel='stylesheet' id='crayon-font-consolas-css' href='http://rest-term.com/wp-content/plugins/crayon-syntax-highlighter/fonts/consolas.css?x45852' type='text/css' media='all' />
<link rel='stylesheet' id='fi_buttons-css' href='http://rest-term.com/wp-content/plugins/feedly-insight/css/fi-buttons-deprecated.css?x45852' type='text/css' media='all' />
<link rel='stylesheet' id='wordpress-popular-posts-css-css' href='http://rest-term.com/wp-content/plugins/wordpress-popular-posts/public/css/wpp.css?x45852' type='text/css' media='all' />
<script type='text/javascript' src='http://rest-term.com/wp-includes/js/jquery/jquery.js?x45852'></script>
<script type='text/javascript' src='http://rest-term.com/wp-includes/js/jquery/jquery-migrate.min.js?x45852'></script>
<link rel='https://api.w.org/' href='http://rest-term.com/wp-json/' />
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://rest-term.com/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://rest-term.com/wp-includes/wlwmanifest.xml" />
<meta name="generator" content="WordPress 4.9.3" />

<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@ryo6036" />
<meta name="twitter:creator" content="@ryo6036" />
<meta name="twitter:url" content="http://rest-term.com" />
<meta name="twitter:title" content="Rest Term" />
<meta name="twitter:description" content="画像処理やWeb関連技術の話など" />
<meta name="twitter:image" content="http://rest-term.com/wp-content/themes/simple-organization/img/site_logo.png" />

<style data-context="foundation-flickity-css">/*! Flickity v2.0.2
http://flickity.metafizzy.co
---------------------------------------------- */.flickity-enabled{position:relative}.flickity-enabled:focus{outline:0}.flickity-viewport{overflow:hidden;position:relative;height:100%}.flickity-slider{position:absolute;width:100%;height:100%}.flickity-enabled.is-draggable{-webkit-tap-highlight-color:transparent;tap-highlight-color:transparent;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.flickity-enabled.is-draggable .flickity-viewport{cursor:move;cursor:-webkit-grab;cursor:grab}.flickity-enabled.is-draggable .flickity-viewport.is-pointer-down{cursor:-webkit-grabbing;cursor:grabbing}.flickity-prev-next-button{position:absolute;top:50%;width:44px;height:44px;border:none;border-radius:50%;background:#fff;background:hsla(0,0%,100%,.75);cursor:pointer;-webkit-transform:translateY(-50%);transform:translateY(-50%)}.flickity-prev-next-button:hover{background:#fff}.flickity-prev-next-button:focus{outline:0;box-shadow:0 0 0 5px #09F}.flickity-prev-next-button:active{opacity:.6}.flickity-prev-next-button.previous{left:10px}.flickity-prev-next-button.next{right:10px}.flickity-rtl .flickity-prev-next-button.previous{left:auto;right:10px}.flickity-rtl .flickity-prev-next-button.next{right:auto;left:10px}.flickity-prev-next-button:disabled{opacity:.3;cursor:auto}.flickity-prev-next-button svg{position:absolute;left:20%;top:20%;width:60%;height:60%}.flickity-prev-next-button .arrow{fill:#333}.flickity-page-dots{position:absolute;width:100%;bottom:-25px;padding:0;margin:0;list-style:none;text-align:center;line-height:1}.flickity-rtl .flickity-page-dots{direction:rtl}.flickity-page-dots .dot{display:inline-block;width:10px;height:10px;margin:0 8px;background:#333;border-radius:50%;opacity:.25;cursor:pointer}.flickity-page-dots .dot.is-selected{opacity:1}</style><style data-context="foundation-slideout-css">.slideout-menu{position:fixed;left:0;top:0;bottom:0;right:auto;z-index:0;width:256px;overflow-y:auto;-webkit-overflow-scrolling:touch;display:none}.slideout-menu.pushit-right{left:auto;right:0}.slideout-panel{position:relative;z-index:1;will-change:transform}.slideout-open,.slideout-open .slideout-panel,.slideout-open body{overflow:hidden}.slideout-open .slideout-menu{display:block}.pushit{display:none}</style>

<script>
    (function (d, s, id) {
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) return;
        js = d.createElement(s);
        js.id = id;
        js.src = "//connect.facebook.net/ja_JP/sdk.js#xfbml=1&version=v2.7";
        fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));
</script>
<style type="text/css">
    .wp_social_bookmarking_light{
    border: 0 !important;
    padding: 0 !important;
    margin: 0 !important;
}
.wp_social_bookmarking_light div{
    float: left !important;
    border: 0 !important;
    padding: 0 !important;
    margin: 0 5px 0px 0 !important;
    height: 23px !important;
    text-indent: 0 !important;
}
.wp_social_bookmarking_light img{
    border: 0 !important;
    padding: 0;
    margin: 0;
    vertical-align: top !important;
}
.wp_social_bookmarking_light_clear{
    clear: both !important;
}
.wsbl_twitter{
    width: 90px;
}
</style>

<style type="text/css">.broken_link, a.broken_link {
	text-decoration: line-through;
}</style><style>.ios7.web-app-mode.has-fixed header{ background-color: rgba(29,154,186,.88);}</style> <rdf:RDF xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:foaf="http://xmlns.com/foaf/0.1/">
<rdf:Description rdf:about="http://rest-term.com">
<foaf:maker rdf:parseType="Resource">
<foaf:holdsAccount>
<foaf:OnlineAccount foaf:accountName="wellflat">
<foaf:accountServiceHomepage rdf:resource="http://www.hatena.ne.jp/" />
</foaf:OnlineAccount>
</foaf:holdsAccount>
</foaf:maker>
</rdf:Description>
</rdf:RDF>
</head>
<body>
<h1 id="site_title">Rest Term</h1>
<div id="site-wrapper">
<div id="header">
<div id="top">
<div class="left" id="logo"><a href="http://rest-term.com/" title="Rest Term"><img src="http://rest-term.com/wp-content/themes/simple-organization/img/site_logo.png?x45852" alt="Rest Term" /></a>
<div id="site-description">Web関連技術の話など</div>
</div>
<div class="navigation left" id="main-nav">
<ul class="tabbed">
<li class="current_page_item"><a href="http://rest-term.com">Hello</a></li><li class="page_item page-item-2977"><a href="http://rest-term.com/lab/">Labs</a></li>
<li class="page_item page-item-7"><a href="http://rest-term.com/about/">About</a></li>
<li class="page_item"><a href="http://rest-term.com/technote/" title="Tech Note">Tech Note</a></li>
</ul>
<div class="clearer">&nbsp;</div>
</div>
<div class="clearer">&nbsp;</div>
</div>
</div>

<div class="main" id="main-two-columns">
<div class="left" id="main-content">
<div class="section-title">Blog</div>
<div class="post" id="post-3434">
<div class="post-title">
<h2 class="label label-blue"><a href="http://rest-term.com/archives/3434/" rel="bookmark" title="Permanent Link to libvipsで高速省メモリな画像処理 part1">
libvipsで高速省メモリな画像処理 part1 </a></h2>
</div>
<div class="post-date">
<div class="left">
1月 22nd, 2018 in
<a href="http://rest-term.com/archives/category/tech/" rel="category tag">tech/study</a> &nbsp;tags: <a href="http://rest-term.com/archives/tag/cvim/" rel="tag">cv/im</a>, <a href="http://rest-term.com/archives/tag/python/" rel="tag">python</a>&nbsp; </div>
<div class="right">
<a href="http://rest-term.com/archives/3434/#respond" class="icon icon-comment">Comments &rarr;</a> </div>
<div class="clearer">&nbsp;</div>
</div>
<div class="post-body">
<p>今回は高速省メモリな画像処理ライブラリである <a onclick="javascript:pageTracker._trackPageview('/outgoing/jcupitt.github.io/libvips/');" href="https://jcupitt.github.io/libvips/">libvips</a> を使ってみます。</p>
<p><img src="http://rest-term.com/wp-content/plugins/lazy-load/images/1x1.trans.gif?x45852" data-lazy-src="http://rest-term.com/wp-content/uploads/2018/01/libvips_logo.png?x45852" alt width="566" height="119" class="alignnone size-full wp-image-3436"><noscript><img src="http://rest-term.com/wp-content/uploads/2018/01/libvips_logo.png?x45852" alt="" width="566" height="119" class="alignnone size-full wp-image-3436" /></noscript></p>
<blockquote><p>
libvips is a demand-driven, horizontally threaded image processing library. Compared to similar libraries, libvips runs quickly and uses little memory. It has around 300 operations covering arithmetic, histograms, convolution, morphological operations, frequency filtering, colour, resampling, statistics and others. - <a onclick="javascript:pageTracker._trackPageview('/outgoing/github.com/jcupitt/libvips');" href="https://github.com/jcupitt/libvips">libvips: A fast image processing library with low memory needs.</a>
</p></blockquote>
<ul>
<li><a onclick="javascript:pageTracker._trackPageview('/outgoing/jcupitt.github.io/libvips/');" href="https://jcupitt.github.io/libvips/">libvips: A fast image processing library with low memory needs.</a></li>
<li><a onclick="javascript:pageTracker._trackPageview('/outgoing/pypi.python.org/pypi/pyvips');" href="https://pypi.python.org/pypi/pyvips">pyvips: Python Package Index</a> (libvips Pythonバインディング)</li>
</ul>
<p>libvips自体は著名な画像処理プロダクトですが、各スクリプト言語のバインディングライブラリや公式サイトが2017年に刷新されたようで、今後はさらに利用が普及することが予想されます。また、Pythonバインディングのpyvipsは<a onclick="javascript:pageTracker._trackPageview('/outgoing/tryolabs.com/blog/2017/12/19/top-10-python-libraries-of-2017/');" href="https://tryolabs.com/blog/2017/12/19/top-10-python-libraries-of-2017/">Top 10 Python libraries of 2017</a>でも紹介されており、注目度も高くなっています。今回はこのpyvipsを使って簡単な使い方を学びます。</p>
<h4 class="term">環境</h4>
<ul>
<li>Ubuntu 16.04.3 LTS (Bash on Ubuntu on Windows10 Pro)</li>
<li>Python 3.6.3 (conda 4.3)</li>
<li>libvips 8.6.1</li>
<li>pyvips 2.0.4</li>
</ul>
<h3 class="term">導入</h3>
<p>* apt を利用する場合</p>
<div id="crayon-5ab1b61385464128166329" class="crayon-syntax crayon-theme-ado crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 10px; margin-bottom: 10px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
## libvips-dev をインストールすればlibvips本体も併せてインストールされる
$ sudo apt install libvips-dev</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5ab1b61385464128166329-1">1</div><div class="crayon-num" data-line="crayon-5ab1b61385464128166329-2">2</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5ab1b61385464128166329-1"><span class="crayon-p">## libvips-dev をインストールすればlibvips本体も併せてインストールされる</span></div><div class="crayon-line" id="crayon-5ab1b61385464128166329-2"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">sudo </span><span class="crayon-e">apt </span><span class="crayon-e">install </span><span class="crayon-v">libvips</span><span class="crayon-o">-</span><span class="crayon-v">dev</span></div></div></td>
</tr>
</table>
</div>
</div>

<p>aptでインストールするのは簡単ですが、バージョンがけっこう古いようなので注意してください。それに必須ではない依存パッケージもいろいろインストールされるようなのでミニマリストの方にはあまり印象は良くないかも。最新版かつ好きな構成で使いたいならgithubからソースをダウンロードしてきて手動でコンパイル・インストールします。</p>
<p>* ソースからインストールする場合</p>
<div id="crayon-5ab1b61385474362936868" class="crayon-syntax crayon-theme-ado crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 10px; margin-bottom: 10px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
# libvipsのビルドに必要な以下のパッケージを事前にインストールしておく
$ sudo apt install build-essential pkg-config glib2.0-dev libexpat1-dev

# libvipsのソースをダウンロード・コンパイル・インストール
$ wget https://github.com/jcupitt/libvips/releases/download/v8.6.1/vips-8.6.1.tar.gz
$ tar zxf vips-8.6.1.tar.gz
$ cd vips-8.6.1
$ ./configure
$ make -j4
$ sudo make install</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5ab1b61385474362936868-1">1</div><div class="crayon-num" data-line="crayon-5ab1b61385474362936868-2">2</div><div class="crayon-num" data-line="crayon-5ab1b61385474362936868-3">3</div><div class="crayon-num" data-line="crayon-5ab1b61385474362936868-4">4</div><div class="crayon-num" data-line="crayon-5ab1b61385474362936868-5">5</div><div class="crayon-num" data-line="crayon-5ab1b61385474362936868-6">6</div><div class="crayon-num" data-line="crayon-5ab1b61385474362936868-7">7</div><div class="crayon-num" data-line="crayon-5ab1b61385474362936868-8">8</div><div class="crayon-num" data-line="crayon-5ab1b61385474362936868-9">9</div><div class="crayon-num" data-line="crayon-5ab1b61385474362936868-10">10</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5ab1b61385474362936868-1"><span class="crayon-p"># libvipsのビルドに必要な以下のパッケージを事前にインストールしておく</span></div><div class="crayon-line" id="crayon-5ab1b61385474362936868-2"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">sudo </span><span class="crayon-e">apt </span><span class="crayon-e">install </span><span class="crayon-v">build</span><span class="crayon-o">-</span><span class="crayon-e">essential </span><span class="crayon-v">pkg</span><span class="crayon-o">-</span><span class="crayon-e">config </span><span class="crayon-v">glib2</span><span class="crayon-sy">.</span><span class="crayon-cn">0</span><span class="crayon-o">-</span><span class="crayon-e">dev </span><span class="crayon-v">libexpat1</span><span class="crayon-o">-</span><span class="crayon-v">dev</span></div><div class="crayon-line" id="crayon-5ab1b61385474362936868-3">&nbsp;</div><div class="crayon-line" id="crayon-5ab1b61385474362936868-4"><span class="crayon-p"># libvipsのソースをダウンロード・コンパイル・インストール</span></div><div class="crayon-line" id="crayon-5ab1b61385474362936868-5"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">wget </span><span class="crayon-v">https</span><span class="crayon-o">:</span><span class="crayon-c">//github.com/jcupitt/libvips/releases/download/v8.6.1/vips-8.6.1.tar.gz</span></div><div class="crayon-line" id="crayon-5ab1b61385474362936868-6"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">tar </span><span class="crayon-e">zxf </span><span class="crayon-v">vips</span><span class="crayon-o">-</span><span class="crayon-cn">8.6.1.tar.gz</span></div><div class="crayon-line" id="crayon-5ab1b61385474362936868-7"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">cd </span><span class="crayon-v">vips</span><span class="crayon-o">-</span><span class="crayon-cn">8.6.1</span></div><div class="crayon-line" id="crayon-5ab1b61385474362936868-8"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-sy">.</span><span class="crayon-o">/</span><span class="crayon-i">configure</span></div><div class="crayon-line" id="crayon-5ab1b61385474362936868-9"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-v">make</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">j4</span></div><div class="crayon-line" id="crayon-5ab1b61385474362936868-10"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">sudo </span><span class="crayon-e">make </span><span class="crayon-v">install</span></div></div></td>
</tr>
</table>
</div>
</div>

<p>./configure時に対応ファイルフォーマットが標準出力に表示されるので、必要な依存ライブラリ(libjpeg、libpngなど)も併せてインストールしておいてください。</p>
<p>* 確認</p>
<div id="crayon-5ab1b61385479977553429" class="crayon-syntax crayon-theme-ado crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 10px; margin-bottom: 10px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
$ ldconfig -p | grep libvips
  libvipsCC.so.42 (libc6,x86-64) =&gt; /usr/local/lib/libvipsCC.so.42
  libvipsCC.so (libc6,x86-64) =&gt; /usr/local/lib/libvipsCC.so
  libvips.so.42 (libc6,x86-64) =&gt; /usr/local/lib/libvips.so.42
  libvips.so (libc6,x86-64) =&gt; /usr/local/lib/libvips.so
  libvips-cpp.so.42 (libc6,x86-64) =&gt; /usr/local/lib/libvips-cpp.so.42
  libvips-cpp.so (libc6,x86-64) =&gt; /usr/local/lib/libvips-cpp.so
$ pkg-config --cflags --libs vips
-pthread -I/usr/include/libpng12 -I/usr/include/glib-2.0 -I/usr/lib/x86_64-linux-gnu/glib-2.0/include -L/usr/local/lib -lvips -lgobject-2.0 -lglib-2.0</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5ab1b61385479977553429-1">1</div><div class="crayon-num" data-line="crayon-5ab1b61385479977553429-2">2</div><div class="crayon-num" data-line="crayon-5ab1b61385479977553429-3">3</div><div class="crayon-num" data-line="crayon-5ab1b61385479977553429-4">4</div><div class="crayon-num" data-line="crayon-5ab1b61385479977553429-5">5</div><div class="crayon-num" data-line="crayon-5ab1b61385479977553429-6">6</div><div class="crayon-num" data-line="crayon-5ab1b61385479977553429-7">7</div><div class="crayon-num" data-line="crayon-5ab1b61385479977553429-8">8</div><div class="crayon-num" data-line="crayon-5ab1b61385479977553429-9">9</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5ab1b61385479977553429-1"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-v">ldconfig</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">p</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-e">grep </span><span class="crayon-e">libvips</span></div><div class="crayon-line" id="crayon-5ab1b61385479977553429-2"><span class="crayon-e">&nbsp;&nbsp;</span><span class="crayon-v">libvipsCC</span><span class="crayon-sy">.</span><span class="crayon-v">so</span><span class="crayon-sy">.</span><span class="crayon-cn">42</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">libc6</span><span class="crayon-sy">,</span><span class="crayon-v">x86</span><span class="crayon-o">-</span><span class="crayon-cn">64</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-v">usr</span><span class="crayon-o">/</span><span class="crayon-v">local</span><span class="crayon-o">/</span><span class="crayon-v">lib</span><span class="crayon-o">/</span><span class="crayon-v">libvipsCC</span><span class="crayon-sy">.</span><span class="crayon-v">so</span><span class="crayon-sy">.</span><span class="crayon-cn">42</span></div><div class="crayon-line" id="crayon-5ab1b61385479977553429-3"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">libvipsCC</span><span class="crayon-sy">.</span><span class="crayon-e">so</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">libc6</span><span class="crayon-sy">,</span><span class="crayon-v">x86</span><span class="crayon-o">-</span><span class="crayon-cn">64</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-v">usr</span><span class="crayon-o">/</span><span class="crayon-v">local</span><span class="crayon-o">/</span><span class="crayon-v">lib</span><span class="crayon-o">/</span><span class="crayon-v">libvipsCC</span><span class="crayon-sy">.</span><span class="crayon-e">so</span></div><div class="crayon-line" id="crayon-5ab1b61385479977553429-4"><span class="crayon-e">&nbsp;&nbsp;</span><span class="crayon-v">libvips</span><span class="crayon-sy">.</span><span class="crayon-v">so</span><span class="crayon-sy">.</span><span class="crayon-cn">42</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">libc6</span><span class="crayon-sy">,</span><span class="crayon-v">x86</span><span class="crayon-o">-</span><span class="crayon-cn">64</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-v">usr</span><span class="crayon-o">/</span><span class="crayon-v">local</span><span class="crayon-o">/</span><span class="crayon-v">lib</span><span class="crayon-o">/</span><span class="crayon-v">libvips</span><span class="crayon-sy">.</span><span class="crayon-v">so</span><span class="crayon-sy">.</span><span class="crayon-cn">42</span></div><div class="crayon-line" id="crayon-5ab1b61385479977553429-5"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">libvips</span><span class="crayon-sy">.</span><span class="crayon-e">so</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">libc6</span><span class="crayon-sy">,</span><span class="crayon-v">x86</span><span class="crayon-o">-</span><span class="crayon-cn">64</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-v">usr</span><span class="crayon-o">/</span><span class="crayon-v">local</span><span class="crayon-o">/</span><span class="crayon-v">lib</span><span class="crayon-o">/</span><span class="crayon-v">libvips</span><span class="crayon-sy">.</span><span class="crayon-e">so</span></div><div class="crayon-line" id="crayon-5ab1b61385479977553429-6"><span class="crayon-e">&nbsp;&nbsp;</span><span class="crayon-v">libvips</span><span class="crayon-o">-</span><span class="crayon-v">cpp</span><span class="crayon-sy">.</span><span class="crayon-v">so</span><span class="crayon-sy">.</span><span class="crayon-cn">42</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">libc6</span><span class="crayon-sy">,</span><span class="crayon-v">x86</span><span class="crayon-o">-</span><span class="crayon-cn">64</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-v">usr</span><span class="crayon-o">/</span><span class="crayon-v">local</span><span class="crayon-o">/</span><span class="crayon-v">lib</span><span class="crayon-o">/</span><span class="crayon-v">libvips</span><span class="crayon-o">-</span><span class="crayon-v">cpp</span><span class="crayon-sy">.</span><span class="crayon-v">so</span><span class="crayon-sy">.</span><span class="crayon-cn">42</span></div><div class="crayon-line" id="crayon-5ab1b61385479977553429-7"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">libvips</span><span class="crayon-o">-</span><span class="crayon-v">cpp</span><span class="crayon-sy">.</span><span class="crayon-e">so</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">libc6</span><span class="crayon-sy">,</span><span class="crayon-v">x86</span><span class="crayon-o">-</span><span class="crayon-cn">64</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-v">usr</span><span class="crayon-o">/</span><span class="crayon-v">local</span><span class="crayon-o">/</span><span class="crayon-v">lib</span><span class="crayon-o">/</span><span class="crayon-v">libvips</span><span class="crayon-o">-</span><span class="crayon-v">cpp</span><span class="crayon-sy">.</span><span class="crayon-i">so</span></div><div class="crayon-line" id="crayon-5ab1b61385479977553429-8"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-v">pkg</span><span class="crayon-o">-</span><span class="crayon-v">config</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-v">cflags</span><span class="crayon-h"> </span><span class="crayon-o">--</span><span class="crayon-e">libs </span><span class="crayon-v">vips</span></div><div class="crayon-line" id="crayon-5ab1b61385479977553429-9"><span class="crayon-o">-</span><span class="crayon-v">pthread</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">I</span><span class="crayon-o">/</span><span class="crayon-v">usr</span><span class="crayon-o">/</span><span class="crayon-v">include</span><span class="crayon-o">/</span><span class="crayon-v">libpng12</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">I</span><span class="crayon-o">/</span><span class="crayon-v">usr</span><span class="crayon-o">/</span><span class="crayon-v">include</span><span class="crayon-o">/</span><span class="crayon-v">glib</span><span class="crayon-o">-</span><span class="crayon-cn">2.0</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">I</span><span class="crayon-o">/</span><span class="crayon-v">usr</span><span class="crayon-o">/</span><span class="crayon-v">lib</span><span class="crayon-o">/</span><span class="crayon-v">x86_64</span><span class="crayon-o">-</span><span class="crayon-v">linux</span><span class="crayon-o">-</span><span class="crayon-v">gnu</span><span class="crayon-o">/</span><span class="crayon-v">glib</span><span class="crayon-o">-</span><span class="crayon-cn">2.0</span><span class="crayon-o">/</span><span class="crayon-v">include</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">L</span><span class="crayon-o">/</span><span class="crayon-v">usr</span><span class="crayon-o">/</span><span class="crayon-v">local</span><span class="crayon-o">/</span><span class="crayon-v">lib</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">lvips</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">lgobject</span><span class="crayon-o">-</span><span class="crayon-cn">2.0</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">lglib</span><span class="crayon-o">-</span><span class="crayon-cn">2.0</span></div></div></td>
</tr>
</table>
</div>
</div>

<p></p>
<p>libvips本体のインストールが完了したら続けてPythonバインディングのpyvipsをインストールします。こちらはpipを使えば簡単に入ります。</p>
<div id="crayon-5ab1b6138547e734348155" class="crayon-syntax crayon-theme-ado crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 10px; margin-bottom: 10px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
$ sudo pip install pyvips</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5ab1b6138547e734348155-1">1</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5ab1b6138547e734348155-1"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">sudo </span><span class="crayon-e">pip </span><span class="crayon-e">install </span><span class="crayon-v">pyvips</span></div></div></td>
</tr>
</table>
</div>
</div>

<p>libvips本体が事前にインストールされていない場合、pyvipsのimport時にOSErrorが出ます。</p>
<h3 class="term">使い方</h3>
<p>今回は動作確認を兼ねて画像入出力や簡単な画像処理を試してみます。以降はJupyter Notebookで書いたドキュメントを貼り付けます。</p>
<p></p>
<ul>
<li><a onclick="javascript:pageTracker._trackPageview('/outgoing/github.com/wellflat/tech-note/blob/master/image-processing/pyvips.ipynb');" href="https://github.com/wellflat/tech-note/blob/master/image-processing/pyvips.ipynb">tech-note/image-processing/pyvips.ipynb </a></li>
</ul>
<p><script src="https://gist.github.com/wellflat/8d007222bfac5f734ef3790522a322a6.js"></script></p>
<p>上記のように、pivipsとnumpy間のデータ相互変換(pyvips.Image <-> numpy.ndarray)が可能なので、OpenCVとの連携も簡単に行うことができそうですね。</p>
<h3 class="term">おわりに</h3>
<p>libvipsは比較的簡単な画像処理用途に特化したプロダクトで、高速省メモリな処理が特徴となっています(<a onclick="javascript:pageTracker._trackPageview('/outgoing/github.com/jcupitt/libvips/wiki/Speed-and-memory-use');" href="https://github.com/jcupitt/libvips/wiki/Speed-and-memory-use">Speed and memory use</a>)。もし画像処理を手軽に行いたいだけならOpenCVを導入するのは大袈裟なので、要件に応じて適切なプロダクトを採用したいですね。今回は導入部分の紹介でしたが、次回はより深掘りして調査できればと思います。</p>
<p>ちなみに今回のエントリーからJupyter Notebookで書いたドキュメントを時々記事に貼ろうと考えているので、GitHubにNotebook用のリポジトリを作りました。こちらも興味があれば。</p>
<ul>
<li><a onclick="javascript:pageTracker._trackPageview('/outgoing/github.com/wellflat/tech-note');" href="https://github.com/wellflat/tech-note">wellflat/tech-note - GitHub </a></li>
</ul>
<div class="clearer">&nbsp;</div>
<p>Tags: <a href="http://rest-term.com/archives/tag/cvim/" rel="tag">cv/im</a>, <a href="http://rest-term.com/archives/tag/python/" rel="tag">python</a></p> </div>
</div>
<div class="content-separator"></div>
<div class="post" id="post-3426">
<div class="post-title">
<h2 class="label label-blue"><a href="http://rest-term.com/archives/3426/" rel="bookmark" title="Permanent Link to JavaScriptで機械学習の実装 5 Gradient Boosting">
JavaScriptで機械学習の実装 5 Gradient Boosting </a></h2>
</div>
<div class="post-date">
<div class="left">
10月 30th, 2017 in
<a href="http://rest-term.com/archives/category/tech/" rel="category tag">tech/study</a> &nbsp;tags: <a href="http://rest-term.com/archives/tag/algorithm/" rel="tag">algorithm</a>, <a href="http://rest-term.com/archives/tag/javascript/" rel="tag">javascript</a>, <a href="http://rest-term.com/archives/tag/ml/" rel="tag">ml</a>&nbsp; </div>
<div class="right">
<a href="http://rest-term.com/archives/3426/#respond" class="icon icon-comment">Comments &rarr;</a> </div>
<div class="clearer">&nbsp;</div>
</div>
<div class="post-body">
<p>少し間が空いてしまいましたけど、今回は<strong><a onclick="javascript:pageTracker._trackPageview('/outgoing/en.wikipedia.org/wiki/Gradient_boosting');" href="https://en.wikipedia.org/wiki/Gradient_boosting">Gradient Boosting (勾配ブースティング)</a></strong>と呼ばれる機械学習アルゴリズムを試してみます。機械学習関連のコンペでも大人気の手法ですね。かなり昔(2011年)に決定木をJavaScriptで実装したことはあるので勾配ブースティングも併せて学んでおこうと思います。</p>
<ul>
<li><a href="http://rest-term.com/archives/2928/">JavaScriptで決定木</a></li>
</ul>
<h3 class="term">Gradient Boosting (勾配ブースティング)</h3>
<p>ブースティングについてWikipediaを引用すると、</p>
<blockquote><p>ブースティング（英: Boosting）とは、教師あり学習を実行するための機械学習メタアルゴリズムの一種。ブースティングは、Michael Kearns の提示した「一連の弱い学習機をまとめることで強い学習機を生成できるか？」という疑問に基づいている[1]。弱い学習機は、真の分類と若干の相関のある分類器と定義される。- <a onclick="javascript:pageTracker._trackPageview('/outgoing/ja.wikipedia.org/wiki/%E3%83%96%E3%83%BC%E3%82%B9%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0');" href="https://ja.wikipedia.org/wiki/%E3%83%96%E3%83%BC%E3%82%B9%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0">ブースティング - Wikipedia</a></p></blockquote>
<p>ブースティングは逐次的(弱学習器を1つずつ順番に構築)に弱学習器を構築していく手法で、新しい弱学習器を構築する際にはそれまでに構築された全ての弱学習器の予測結果を利用するという特徴があります。Gradient Boosting (勾配ブースティング)では正解値と弱学習器の予測値との差を負の勾配と見なして、それを最小化するように逐次的に弱学習器を学習させていきます。弱学習器として<a onclick="javascript:pageTracker._trackPageview('/outgoing/ja.wikipedia.org/wiki/%E6%B1%BA%E5%AE%9A%E6%9C%A8');" href="https://ja.wikipedia.org/wiki/%E6%B1%BA%E5%AE%9A%E6%9C%A8">決定木</a>が用いられるため <strong>Gradient Boosting Decision Tree (GBDT)</strong> と呼ばれます。ちなみにOpenCVに顔検出機能は<a onclick="javascript:pageTracker._trackPageview('/outgoing/ja.wikipedia.org/wiki/AdaBoost');" href="https://ja.wikipedia.org/wiki/AdaBoost">AdaBoost</a>と呼ばれるブースティングアルゴリズムを利用していますね。AdaBoostは学生時代に特にお世話になりました。</p>
<p>今回は回帰問題を扱うので弱学習器には回帰木を用います。JavaScript(ES2015)での学習処理部分の実装を抜粋しますが、ここを見るだけでも勾配ブースティングの特徴がよく表れているのではないでしょうか。</p>
<div id="crayon-5ab1b61385974034556090" class="crayon-syntax crayon-theme-ado crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 10px; margin-bottom: 10px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">JavaScript</span></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
   /**
     * @param {Float64Array[]} x
     * @param {Float64Array} y
     */
    fit(x, y) {
        this.trees[0].fit(x, y);  // 1つ目の回帰木を弱学習器として学習
        let f = x.map(v =&gt;  this.trees[0].predict(v));  // 学習した回帰木で予測
        for (let i = 1; i &lt; this.nEstimators; i++) {
            const ngrad = y.map((v, i) =&gt;  this.loss(v, f[i]));  // 損失関数 L(y, f(x)) で勾配を計算
            this.trees[i].fit(x, ngrad);  // 勾配を最小化するように学習 (勾配降下)
            f = x.map((v, j) =&gt; f[j] + this.lr * this.trees[i].predict(v)); // 予測結果を利用、これを回帰木の本数分繰り返す
        }
    }</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5ab1b61385974034556090-1">1</div><div class="crayon-num" data-line="crayon-5ab1b61385974034556090-2">2</div><div class="crayon-num" data-line="crayon-5ab1b61385974034556090-3">3</div><div class="crayon-num" data-line="crayon-5ab1b61385974034556090-4">4</div><div class="crayon-num" data-line="crayon-5ab1b61385974034556090-5">5</div><div class="crayon-num" data-line="crayon-5ab1b61385974034556090-6">6</div><div class="crayon-num" data-line="crayon-5ab1b61385974034556090-7">7</div><div class="crayon-num" data-line="crayon-5ab1b61385974034556090-8">8</div><div class="crayon-num" data-line="crayon-5ab1b61385974034556090-9">9</div><div class="crayon-num" data-line="crayon-5ab1b61385974034556090-10">10</div><div class="crayon-num" data-line="crayon-5ab1b61385974034556090-11">11</div><div class="crayon-num" data-line="crayon-5ab1b61385974034556090-12">12</div><div class="crayon-num" data-line="crayon-5ab1b61385974034556090-13">13</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5ab1b61385974034556090-1"><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-c">/**</span></div><div class="crayon-line" id="crayon-5ab1b61385974034556090-2"><span class="crayon-c">&nbsp;&nbsp;&nbsp;&nbsp; * @param {Float64Array[]} x</span></div><div class="crayon-line" id="crayon-5ab1b61385974034556090-3"><span class="crayon-c">&nbsp;&nbsp;&nbsp;&nbsp; * @param {Float64Array} y</span></div><div class="crayon-line" id="crayon-5ab1b61385974034556090-4"><span class="crayon-c">&nbsp;&nbsp;&nbsp;&nbsp; */</span></div><div class="crayon-line" id="crayon-5ab1b61385974034556090-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">fit</span><span class="crayon-sy">(</span><span class="crayon-v">x</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5ab1b61385974034556090-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-r">this</span><span class="crayon-sy">.</span><span class="crayon-v">trees</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-e">fit</span><span class="crayon-sy">(</span><span class="crayon-v">x</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c">// 1つ目の回帰木を弱学習器として学習</span></div><div class="crayon-line" id="crayon-5ab1b61385974034556090-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-i">let</span><span class="crayon-h"> </span><span class="crayon-v">f</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">x</span><span class="crayon-sy">.</span><span class="crayon-e">map</span><span class="crayon-sy">(</span><span class="crayon-v">v</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-o">&gt;</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-r">this</span><span class="crayon-sy">.</span><span class="crayon-v">trees</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-e">predict</span><span class="crayon-sy">(</span><span class="crayon-v">v</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c">// 学習した回帰木で予測</span></div><div class="crayon-line" id="crayon-5ab1b61385974034556090-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-i">let</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-r">this</span><span class="crayon-sy">.</span><span class="crayon-v">nEstimators</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-o">++</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5ab1b61385974034556090-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-m">const</span><span class="crayon-h"> </span><span class="crayon-v">ngrad</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-sy">.</span><span class="crayon-e">map</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-v">v</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-o">&gt;</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-r">this</span><span class="crayon-sy">.</span><span class="crayon-e">loss</span><span class="crayon-sy">(</span><span class="crayon-v">v</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">f</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c">// 損失関数 L(y, f(x)) で勾配を計算</span></div><div class="crayon-line" id="crayon-5ab1b61385974034556090-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-r">this</span><span class="crayon-sy">.</span><span class="crayon-v">trees</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-e">fit</span><span class="crayon-sy">(</span><span class="crayon-v">x</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">ngrad</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c">// 勾配を最小化するように学習 (勾配降下)</span></div><div class="crayon-line" id="crayon-5ab1b61385974034556090-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">f</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">x</span><span class="crayon-sy">.</span><span class="crayon-e">map</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-v">v</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">j</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-v">f</span><span class="crayon-sy">[</span><span class="crayon-v">j</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-r">this</span><span class="crayon-sy">.</span><span class="crayon-v">lr</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-r">this</span><span class="crayon-sy">.</span><span class="crayon-v">trees</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-e">predict</span><span class="crayon-sy">(</span><span class="crayon-v">v</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-c">// 予測結果を利用、これを回帰木の本数分繰り返す</span></div><div class="crayon-line" id="crayon-5ab1b61385974034556090-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5ab1b61385974034556090-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div></div></td>
</tr>
</table>
</div>
</div>

<p></p>
<h3 class="term">検証</h3>
<p>データセットは<a onclick="javascript:pageTracker._trackPageview('/outgoing/www.cs.toronto.edu/~delve/data/boston/bostonDetail.html');" href="http://www.cs.toronto.edu/~delve/data/boston/bostonDetail.html">Boston housing</a>を用い、人口 1 人当たりの犯罪発生数やNOxの濃度などの情報からボストン市の住宅価格を予測します。</p>
<div id="crayon-5ab1b61385985609524717" class="crayon-syntax crayon-theme-ado crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 10px; margin-bottom: 10px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
* Boston housing
Samples total 	506
Dimensionality 	13
Features 	real, positive
Targets 	real 5. - 50.</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5ab1b61385985609524717-1">1</div><div class="crayon-num" data-line="crayon-5ab1b61385985609524717-2">2</div><div class="crayon-num" data-line="crayon-5ab1b61385985609524717-3">3</div><div class="crayon-num" data-line="crayon-5ab1b61385985609524717-4">4</div><div class="crayon-num" data-line="crayon-5ab1b61385985609524717-5">5</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5ab1b61385985609524717-1"><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-e">Boston </span><span class="crayon-e">housing</span></div><div class="crayon-line" id="crayon-5ab1b61385985609524717-2"><span class="crayon-e">Samples </span><span class="crayon-i">total</span><span class="crayon-h"> </span><span class="crayon-cn">506</span></div><div class="crayon-line" id="crayon-5ab1b61385985609524717-3"><span class="crayon-i">Dimensionality</span><span class="crayon-h"> </span><span class="crayon-cn">13</span></div><div class="crayon-line" id="crayon-5ab1b61385985609524717-4"><span class="crayon-e">Features </span><span class="crayon-v">real</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">positive</span></div><div class="crayon-line" id="crayon-5ab1b61385985609524717-5"><span class="crayon-e">Targets </span><span class="crayon-i">real</span><span class="crayon-h"> </span><span class="crayon-cn">5.</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-cn">50.</span></div></div></td>
</tr>
</table>
</div>
</div>

<p></p>
<p>今回もJavaScript(ES2015)で実装したのですが、いつものようにscikit-learn風なインタフェースにしていて、パラメータのデフォルト値はscikit-learnのGBDT実装(<a onclick="javascript:pageTracker._trackPageview('/outgoing/scikit-learn.org/stable/modules/generated/sklearn.ensemble.GradientBoostingRegressor.html');" href="http://scikit-learn.org/stable/modules/generated/sklearn.ensemble.GradientBoostingRegressor.html">sklearn.ensemble.GradientBoostingRegressor</a>)を参考にしました。もちろん外からパラメータ変更もできます。また、ファイルからのデータ読み込み処理は省略してデータセット自体も1つのモジュールとして埋め込んでいます。ソースコードもいつものようにGitHubに置いてあるので興味があれば。</p>
<ul>
<li><a onclick="javascript:pageTracker._trackPageview('/outgoing/github.com/wellflat/imageprocessing-labs/tree/master/ml/gbdt');" href="https://github.com/wellflat/imageprocessing-labs/tree/master/ml/gbdt"><strong>imageprocessing-labs/ml/gbdt at master · wellflat/imageprocessing-labs</strong></a></li>
</ul>
<p>クライアント側では以下のように使います。</p>
<div id="crayon-5ab1b6138598f304740824" class="crayon-syntax crayon-theme-ado crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 10px; margin-bottom: 10px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">JavaScript</span></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
import GradientBoostingRegressor from './gradient_boosting';
import boston from './boston_data'; // Boston housing dataset
import { rmse, score } from './metrics';   // RMSE, R^2 Score

// データセットの準備
const [x, y] = [boston.data, boston.target];

// 学習データ 8割, テストデータ 2割で勾配ブースティングの学習/テスト
const end = Math.floor(x.length * 0.8);
const trainX = x.slice(0, end),
    testX = x.slice(end),
    trainY = y.slice(0, end),
    testY = y.slice(end);

// 回帰木 100個, 学習率 0.1, 回帰木の深さ 3で学習
const estimator = new GradientBoostingRegressor(100, 0.1, 3);
estimator.fit(trainX, trainY);

// テストデータで予測
const predY = estimator.predict(testX);

// RMSE, R^2(決定係数)を計算
console.log(`RMSE = {rmse(testY, predY)}`);
console.log(`R2 Score = ${score(testY, predY)}`);</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5ab1b6138598f304740824-1">1</div><div class="crayon-num" data-line="crayon-5ab1b6138598f304740824-2">2</div><div class="crayon-num" data-line="crayon-5ab1b6138598f304740824-3">3</div><div class="crayon-num" data-line="crayon-5ab1b6138598f304740824-4">4</div><div class="crayon-num" data-line="crayon-5ab1b6138598f304740824-5">5</div><div class="crayon-num" data-line="crayon-5ab1b6138598f304740824-6">6</div><div class="crayon-num" data-line="crayon-5ab1b6138598f304740824-7">7</div><div class="crayon-num" data-line="crayon-5ab1b6138598f304740824-8">8</div><div class="crayon-num" data-line="crayon-5ab1b6138598f304740824-9">9</div><div class="crayon-num" data-line="crayon-5ab1b6138598f304740824-10">10</div><div class="crayon-num" data-line="crayon-5ab1b6138598f304740824-11">11</div><div class="crayon-num" data-line="crayon-5ab1b6138598f304740824-12">12</div><div class="crayon-num" data-line="crayon-5ab1b6138598f304740824-13">13</div><div class="crayon-num" data-line="crayon-5ab1b6138598f304740824-14">14</div><div class="crayon-num" data-line="crayon-5ab1b6138598f304740824-15">15</div><div class="crayon-num" data-line="crayon-5ab1b6138598f304740824-16">16</div><div class="crayon-num" data-line="crayon-5ab1b6138598f304740824-17">17</div><div class="crayon-num" data-line="crayon-5ab1b6138598f304740824-18">18</div><div class="crayon-num" data-line="crayon-5ab1b6138598f304740824-19">19</div><div class="crayon-num" data-line="crayon-5ab1b6138598f304740824-20">20</div><div class="crayon-num" data-line="crayon-5ab1b6138598f304740824-21">21</div><div class="crayon-num" data-line="crayon-5ab1b6138598f304740824-22">22</div><div class="crayon-num" data-line="crayon-5ab1b6138598f304740824-23">23</div><div class="crayon-num" data-line="crayon-5ab1b6138598f304740824-24">24</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5ab1b6138598f304740824-1"><span class="crayon-e">import </span><span class="crayon-e">GradientBoostingRegressor </span><span class="crayon-i">from</span><span class="crayon-h"> </span><span class="crayon-s">'./gradient_boosting'</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b6138598f304740824-2"><span class="crayon-e">import </span><span class="crayon-e">boston </span><span class="crayon-i">from</span><span class="crayon-h"> </span><span class="crayon-s">'./boston_data'</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-c">// Boston housing dataset</span></div><div class="crayon-line" id="crayon-5ab1b6138598f304740824-3"><span class="crayon-e">import</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-h"> </span><span class="crayon-v">rmse</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">score</span><span class="crayon-h"> </span><span class="crayon-sy">}</span><span class="crayon-h"> </span><span class="crayon-i">from</span><span class="crayon-h"> </span><span class="crayon-s">'./metrics'</span><span class="crayon-sy">;</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-c">// RMSE, R^2 Score</span></div><div class="crayon-line" id="crayon-5ab1b6138598f304740824-4">&nbsp;</div><div class="crayon-line" id="crayon-5ab1b6138598f304740824-5"><span class="crayon-c">// データセットの準備</span></div><div class="crayon-line" id="crayon-5ab1b6138598f304740824-6"><span class="crayon-m">const</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">x</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">boston</span><span class="crayon-sy">.</span><span class="crayon-v">data</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">boston</span><span class="crayon-sy">.</span><span class="crayon-v">target</span><span class="crayon-sy">]</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b6138598f304740824-7">&nbsp;</div><div class="crayon-line" id="crayon-5ab1b6138598f304740824-8"><span class="crayon-c">// 学習データ 8割, テストデータ 2割で勾配ブースティングの学習/テスト</span></div><div class="crayon-line" id="crayon-5ab1b6138598f304740824-9"><span class="crayon-m">const</span><span class="crayon-h"> </span><span class="crayon-st">end</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">Math</span><span class="crayon-sy">.</span><span class="crayon-e">floor</span><span class="crayon-sy">(</span><span class="crayon-v">x</span><span class="crayon-sy">.</span><span class="crayon-v">length</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-cn">0.8</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b6138598f304740824-10"><span class="crayon-m">const</span><span class="crayon-h"> </span><span class="crayon-v">trainX</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">x</span><span class="crayon-sy">.</span><span class="crayon-e">slice</span><span class="crayon-sy">(</span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-st">end</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5ab1b6138598f304740824-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">testX</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">x</span><span class="crayon-sy">.</span><span class="crayon-e">slice</span><span class="crayon-sy">(</span><span class="crayon-st">end</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5ab1b6138598f304740824-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">trainY</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-sy">.</span><span class="crayon-e">slice</span><span class="crayon-sy">(</span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-st">end</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5ab1b6138598f304740824-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">testY</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-sy">.</span><span class="crayon-e">slice</span><span class="crayon-sy">(</span><span class="crayon-st">end</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b6138598f304740824-14">&nbsp;</div><div class="crayon-line" id="crayon-5ab1b6138598f304740824-15"><span class="crayon-c">// 回帰木 100個, 学習率 0.1, 回帰木の深さ 3で学習</span></div><div class="crayon-line" id="crayon-5ab1b6138598f304740824-16"><span class="crayon-m">const</span><span class="crayon-h"> </span><span class="crayon-v">estimator</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-e">GradientBoostingRegressor</span><span class="crayon-sy">(</span><span class="crayon-cn">100</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0.1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">3</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b6138598f304740824-17"><span class="crayon-v">estimator</span><span class="crayon-sy">.</span><span class="crayon-e">fit</span><span class="crayon-sy">(</span><span class="crayon-v">trainX</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">trainY</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b6138598f304740824-18">&nbsp;</div><div class="crayon-line" id="crayon-5ab1b6138598f304740824-19"><span class="crayon-c">// テストデータで予測</span></div><div class="crayon-line" id="crayon-5ab1b6138598f304740824-20"><span class="crayon-m">const</span><span class="crayon-h"> </span><span class="crayon-v">predY</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">estimator</span><span class="crayon-sy">.</span><span class="crayon-e">predict</span><span class="crayon-sy">(</span><span class="crayon-v">testX</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b6138598f304740824-21">&nbsp;</div><div class="crayon-line" id="crayon-5ab1b6138598f304740824-22"><span class="crayon-c">// RMSE, R^2(決定係数)を計算</span></div><div class="crayon-line" id="crayon-5ab1b6138598f304740824-23"><span class="crayon-v">console</span><span class="crayon-sy">.</span><span class="crayon-e">log</span><span class="crayon-sy">(</span><span class="crayon-sy">`</span><span class="crayon-v">RMSE</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-e">rmse</span><span class="crayon-sy">(</span><span class="crayon-v">testY</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">predY</span><span class="crayon-sy">)</span><span class="crayon-sy">}</span><span class="crayon-sy">`</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b6138598f304740824-24"><span class="crayon-v">console</span><span class="crayon-sy">.</span><span class="crayon-e">log</span><span class="crayon-sy">(</span><span class="crayon-sy">`</span><span class="crayon-e">R2 </span><span class="crayon-v">Score</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">$</span><span class="crayon-sy">{</span><span class="crayon-e">score</span><span class="crayon-sy">(</span><span class="crayon-v">testY</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">predY</span><span class="crayon-sy">)</span><span class="crayon-sy">}</span><span class="crayon-sy">`</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div></div></td>
</tr>
</table>
</div>
</div>

<p>* 出力結果例</p>
<div id="crayon-5ab1b61385998798488794" class="crayon-syntax crayon-theme-ado crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 10px; margin-bottom: 10px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
RMSE = 3.5189082889186323
R2 Score = 0.8152843242976473</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5ab1b61385998798488794-1">1</div><div class="crayon-num" data-line="crayon-5ab1b61385998798488794-2">2</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5ab1b61385998798488794-1"><span class="crayon-v">RMSE</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">3.5189082889186323</span></div><div class="crayon-line" id="crayon-5ab1b61385998798488794-2"><span class="crayon-e">R2 </span><span class="crayon-v">Score</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0.8152843242976473</span></div></div></td>
</tr>
</table>
</div>
</div>

<p>モデル評価用にRMSEやR^2スコア(決定係数)計算用のモジュールも併せて作りました。まずは残差プロットでざっくりとモデルの性能を眺めてみます。最近はGoogleスプレッドシートでグラフを描くことが増えてきました。さすがにExcelよりは機能不足ですけど簡単なグラフならすぐ作成できるので便利に使っています。<br />
<img src="http://rest-term.com/wp-content/plugins/lazy-load/images/1x1.trans.gif?x45852" data-lazy-src="http://rest-term.com/wp-content/uploads/2017/10/residual_plot.png?x45852" alt width="504" height="293" class="alignnone size-full wp-image-3427"><noscript><img src="http://rest-term.com/wp-content/uploads/2017/10/residual_plot.png?x45852" alt="" width="504" height="293" class="alignnone size-full wp-image-3427" /></noscript><br />
良い感じに残差が均一に分散しています。それなりに上手く学習できているようです。</p>
<p>定量的な確認も少しだけ。データをシャッフルして3回計測したRMSEとR^2スコア(決定係数)の平均値を載せます。GBDTの学習率は0.1で固定して、回帰木の本数(ブースティングの繰り返し回数)と深さを変更しました。</p>
<table>
<tr>
<th></th>
<th>RMSE</th>
<th>R^2 score (決定係数)</th>
</tr>
<tr>
<td>回帰木の本数: 100, 深さ: 3</td>
<td>3.503</td>
<td>0.817</td>
</tr>
<tr>
<td>回帰木の本数: 200, 深さ: 4</td>
<td>3.156</td>
<td>0.851</td>
</tr>
</table>
<p>ある程度想定した通りの結果が出ているので問題なさそうです。パラメータ調整についてはまだ理論を理解しきれていない部分もあるので適当なのですが、いろいろパラメータを変えて試してみた所、回帰木は深くしすぎてもダメみたいです。3 ～ 5くらいがちょうど良いんでしょうか。</p>
<h3 class="term">おわりに</h3>
<p>勾配ブースティングは以前からずっと作ってみたいと思っていたので、今回実装する機会を得ることができて良かったです。ところでロシアのYandexが7月18日に<a onclick="javascript:pageTracker._trackPageview('/outgoing/catboost.yandex/');" href="https://catboost.yandex/">CatBoost</a>というすばらしい名前の勾配ブースティング実装を公開しました。今はこちらを使っていろいろ勉強中です。まだ日本語のドキュメント類は無いみたいなので情報がまとまったらCatBoostに関するエントリーを書くかもしれません。またよろしくおねがいします。</p>
<ul>
<li><a onclick="javascript:pageTracker._trackPageview('/outgoing/github.com/wellflat/imageprocessing-labs/tree/master/ml/gbdt');" href="https://github.com/wellflat/imageprocessing-labs/tree/master/ml/gbdt"><strong>imageprocessing-labs/ml/gbdt at master · wellflat/imageprocessing-labs</strong></a> (今回作成したコード)</li>
</ul>
<h3 class="term">参考</h3>
<ul>
<li><a onclick="javascript:pageTracker._trackPageview('/outgoing/homes.cs.washington.edu/~tqchen/pdf/BoostedTree.pdf');" href="https://homes.cs.washington.edu/~tqchen/pdf/BoostedTree.pdf">SGHMC+DDP Learning - BoostedTree.pdf</a>(PDF)</li>
<li><a onclick="javascript:pageTracker._trackPageview('/outgoing/smrmkt.hatenablog.jp/entry/2015/04/28/210039');" href="http://smrmkt.hatenablog.jp/entry/2015/04/28/210039">勾配ブースティングについてざっくりと説明する</a></li>
<li><a onclick="javascript:pageTracker._trackPageview('/outgoing/d.hatena.ne.jp/jetbead/20161005/1475597438');" href="http://d.hatena.ne.jp/jetbead/20161005/1475597438">勾配ブースティング木を試す</a></li>
<li><a onclick="javascript:pageTracker._trackPageview('/outgoing/zaburo-ch.github.io/post/xgboost/');" href="https://zaburo-ch.github.io/post/xgboost/">Gradient Boosting と XGBoost</a></li>
<li><a onclick="javascript:pageTracker._trackPageview('/outgoing/blog.kaggle.com/2017/01/23/a-kaggle-master-explains-gradient-boosting/');" href="http://blog.kaggle.com/2017/01/23/a-kaggle-master-explains-gradient-boosting/">A Kaggle Master Explains Gradient Boosting | No Free Hunch</a></li>
<li><a onclick="javascript:pageTracker._trackPageview('/outgoing/xgboost.readthedocs.io/en/latest/model.html');" href="http://xgboost.readthedocs.io/en/latest/model.html">Introduction to Boosted Trees — xgboost 0.6 documentation</a></li>
<li><a onclick="javascript:pageTracker._trackPageview('/outgoing/scikit-learn.org/stable/modules/generated/sklearn.ensemble.GradientBoostingRegressor.html');" href="http://scikit-learn.org/stable/modules/generated/sklearn.ensemble.GradientBoostingRegressor.html">sklearn.ensemble.GradientBoostingRegressor</a></li>
</ul>
<div class="clearer">&nbsp;</div>
<p>Tags: <a href="http://rest-term.com/archives/tag/algorithm/" rel="tag">algorithm</a>, <a href="http://rest-term.com/archives/tag/javascript/" rel="tag">javascript</a>, <a href="http://rest-term.com/archives/tag/ml/" rel="tag">ml</a></p> </div>
</div>
<div class="content-separator"></div>
<div class="post" id="post-3418">
<div class="post-title">
<h2 class="label label-blue"><a href="http://rest-term.com/archives/3418/" rel="bookmark" title="Permanent Link to GPU対応の類似検索(最近傍探索)ライブラリ Faissの紹介 part2 GPUを利用した検索">
GPU対応の類似検索(最近傍探索)ライブラリ Faissの紹介 part2 GPUを利用した検索 </a></h2>
</div>
<div class="post-date">
<div class="left">
6月 25th, 2017 in
<a href="http://rest-term.com/archives/category/tech/" rel="category tag">tech/study</a> &nbsp;tags: <a href="http://rest-term.com/archives/tag/algorithm/" rel="tag">algorithm</a>, <a href="http://rest-term.com/archives/tag/cc/" rel="tag">c/c++</a>, <a href="http://rest-term.com/archives/tag/hardware/" rel="tag">hardware</a>&nbsp; </div>
<div class="right">
<a href="http://rest-term.com/archives/3418/#respond" class="icon icon-comment">Comments &rarr;</a> </div>
<div class="clearer">&nbsp;</div>
</div>
<div class="post-body">
<p><a onclick="javascript:pageTracker._trackPageview('/outgoing/research.fb.com/category/facebook-ai-research-fair/');" href="https://research.fb.com/category/facebook-ai-research-fair/">Facebook AI Research (FAIR)</a>が開発したGPU対応の類似検索ライブラリ <a onclick="javascript:pageTracker._trackPageview('/outgoing/github.com/facebookresearch/faiss');" href="https://github.com/facebookresearch/faiss"><strong>Faiss</strong></a> に関する2回目の紹介エントリーとなります。前回は、FaissのインストールとC++チュートリアルの説明を行いました。今回はGPUを利用した検索処理を試してみます。</p>
<p>Faissのインストール方法については前回のエントリーを参照してください。</p>
<ul>
<li><a href="http://rest-term.com/archives/3414/">GPU対応の類似検索(最近傍探索)ライブラリ Faissの紹介 part1 導入/チュートリアル</a></li>
</ul>
<h4 class="term">環境</h4>
<table>
<tr>
<td>Amazon Linux AMI release 2017.03<br />
Intel Xeon CPU E5-2686 v4 @ 2.30GHz<br />
NVIDIA GK210GL [Tesla K80]
</td>
<td>Ubuntu 16.04 LTS (x86_64)<br />
Intel Core i5-2500K CPU @ 3.30GHz<br />
NVIDIA GM204 [GeForce GTX 970]
</td>
</tr>
<tr>
<td>
CUDA Toolkit 8.0<br />
GCC 4.8.3 / 5.4.0<br />
Python 3.5.2<br />
NumPy 1.12
</td>
</tr>
</table>
<p>今回からはプログラムのベンチマークも行っていくので自宅のGPUサーバをメインに使って検証します。EC2のp2.xlargeをがっつり使うと請求が怖いし、そもそもレイテンシが大きくてストレスが溜まるので。</p>
<p>前回の導入部分の補足としてCUDAコード部分のコンパイルにはGCCではなくNVCC(CUDAコンパイラ)を利用するので事前にインストール済みであることを確認しておきます。また、GPU製品のCompute Capabilityは3.5以降が必要となっています。</p>
<div id="crayon-5ab1b61385db7433620446" class="crayon-syntax crayon-theme-ado crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 10px; margin-bottom: 10px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
# PATHは事前に通しておく、デフォルトだと /usr/local/cuda-xxx/bin/nvcc
$ nvcc -V
nvcc: NVIDIA (R) Cuda compiler driver
Copyright (c) 2005-2016 NVIDIA Corporation
Built on Sun_Sep__4_22:14:01_CDT_2016
Cuda compilation tools, release 8.0, V8.0.44

$ nvidia-smi -L
GPU 0: GeForce GTX 970 (UUID: GPU-35bd77fd-edfe-861b-c4a6-59e9eb111aa6)</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5ab1b61385db7433620446-1">1</div><div class="crayon-num" data-line="crayon-5ab1b61385db7433620446-2">2</div><div class="crayon-num" data-line="crayon-5ab1b61385db7433620446-3">3</div><div class="crayon-num" data-line="crayon-5ab1b61385db7433620446-4">4</div><div class="crayon-num" data-line="crayon-5ab1b61385db7433620446-5">5</div><div class="crayon-num" data-line="crayon-5ab1b61385db7433620446-6">6</div><div class="crayon-num" data-line="crayon-5ab1b61385db7433620446-7">7</div><div class="crayon-num" data-line="crayon-5ab1b61385db7433620446-8">8</div><div class="crayon-num" data-line="crayon-5ab1b61385db7433620446-9">9</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5ab1b61385db7433620446-1"><span class="crayon-p"># PATHは事前に通しておく、デフォルトだと /usr/local/cuda-xxx/bin/nvcc</span></div><div class="crayon-line" id="crayon-5ab1b61385db7433620446-2"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-v">nvcc</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">V</span></div><div class="crayon-line" id="crayon-5ab1b61385db7433620446-3"><span class="crayon-v">nvcc</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-e">NVIDIA</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">R</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-e">Cuda </span><span class="crayon-e">compiler </span><span class="crayon-e">driver</span></div><div class="crayon-line" id="crayon-5ab1b61385db7433620446-4"><span class="crayon-e">Copyright</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">c</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-cn">2005</span><span class="crayon-o">-</span><span class="crayon-cn">2016</span><span class="crayon-h"> </span><span class="crayon-e">NVIDIA </span><span class="crayon-e">Corporation</span></div><div class="crayon-line" id="crayon-5ab1b61385db7433620446-5"><span class="crayon-e">Built </span><span class="crayon-e">on </span><span class="crayon-v">Sun_Sep__4_22</span><span class="crayon-o">:</span><span class="crayon-cn">14</span><span class="crayon-o">:</span><span class="crayon-cn">01_CDT_2016</span></div><div class="crayon-line" id="crayon-5ab1b61385db7433620446-6"><span class="crayon-e">Cuda </span><span class="crayon-e">compilation </span><span class="crayon-v">tools</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">release</span><span class="crayon-h"> </span><span class="crayon-cn">8.0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">V8</span><span class="crayon-sy">.</span><span class="crayon-cn">0.44</span></div><div class="crayon-line" id="crayon-5ab1b61385db7433620446-7">&nbsp;</div><div class="crayon-line" id="crayon-5ab1b61385db7433620446-8"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-v">nvidia</span><span class="crayon-o">-</span><span class="crayon-v">smi</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">L</span></div><div class="crayon-line" id="crayon-5ab1b61385db7433620446-9"><span class="crayon-i">GPU</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-e">GeForce </span><span class="crayon-i">GTX</span><span class="crayon-h"> </span><span class="crayon-cn">970</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">UUID</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">GPU</span><span class="crayon-o">-</span><span class="crayon-cn">35bd77fd</span><span class="crayon-o">-</span><span class="crayon-v">edfe</span><span class="crayon-o">-</span><span class="crayon-cn">861b</span><span class="crayon-o">-</span><span class="crayon-v">c4a6</span><span class="crayon-o">-</span><span class="crayon-cn">59e9eb111aa6</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>

<p></p>
<h3 class="term">GPUでk-meansクラスタリング</h3>
<p>まずは、公式ドキュメントにサンプルとして掲載されているGPUを利用したk-meansクラスタリングプログラムの動作確認をします。日本語での補足も簡単に入れておきます。</p>
<div id="crayon-5ab1b61385dc1540885326" class="crayon-syntax crayon-theme-ado crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 10px; margin-bottom: 10px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">C++</span></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
#include &lt;cstdio&gt;
#include &lt;vector&gt;
#include &lt;faiss/Clustering.h&gt;
#include &lt;faiss/utils.h&gt;
#include &lt;faiss/gpu/GpuIndexFlat.h&gt;
#include &lt;faiss/gpu/StandardGpuResources.h&gt;

// just generate some random vecs in a hypercube (CPU)
// クラスタリング対象のダミーデータを生成
std::vector&lt;float&gt; makeRandomVecs(size_t numVecs, int dim) {
    std::vector&lt;float&gt; vecs(numVecs * dim);
    // void faiss::float_rand (float * x, size_t n, long seed)
    // OpenMPを利用してマルチスレッドで生成される
    faiss::float_rand(vecs.data(), vecs.size(), 1);
    return vecs;
}

int main(int argc, char** argv) {
    // Reserves 18% of GPU memory for temporary work by default; the
    // size can be adjusted, or your own implementation of GpuResources
    // can be made to manage memory in a different way.
    faiss::gpu::StandardGpuResources res;
    
    int dim = 128;
    int numberOfEMIterations = 20;
    size_t numberOfClusters = 20000;
    size_t numVecsToCluster = 5000000;

    // generate a bunch of random vectors; note that this is on the CPU!
    std::vector&lt;float&gt; vecs = makeRandomVecs(numVecsToCluster, dim);
    faiss::gpu::GpuIndexFlatConfig config;
    config.device = 0;            // this is the default GPUデバイス番号
    config.useFloat16 = false;    // this is the default GPU側でFP16(半精度浮動小数点)を利用するか
    faiss::gpu::GpuIndexFlatL2 index(&amp;res, dim, config);  // faiss::IndexFlatL2 のGPU版
    
    faiss::ClusteringParameters cp;
    cp.niter = numberOfEMIterations;  // niter にイテレーション回数を設定
    cp.verbose = true;  // verbose を true にすると標準出力にイテレーション毎の処理結果が表示される
    
    // faiss::Clustering::Clustering(int d, int k, const ClusteringParameters &amp;cp)
    faiss::Clustering kMeans(dim, numberOfClusters, cp);

    // void faiss::Clustering::train(idx_t n, const float *x, faiss::Index &amp;index)
    kMeans.train(numVecsToCluster, vecs.data(), index);

    // kMeans.centroids contains the resulting cluster centroids (on CPU)
    printf("centroid 3 dim 6 is %f\n", kMeans.centroids[3 * dim + 6]);

    return 0;
}</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5ab1b61385dc1540885326-1">1</div><div class="crayon-num" data-line="crayon-5ab1b61385dc1540885326-2">2</div><div class="crayon-num" data-line="crayon-5ab1b61385dc1540885326-3">3</div><div class="crayon-num" data-line="crayon-5ab1b61385dc1540885326-4">4</div><div class="crayon-num" data-line="crayon-5ab1b61385dc1540885326-5">5</div><div class="crayon-num" data-line="crayon-5ab1b61385dc1540885326-6">6</div><div class="crayon-num" data-line="crayon-5ab1b61385dc1540885326-7">7</div><div class="crayon-num" data-line="crayon-5ab1b61385dc1540885326-8">8</div><div class="crayon-num" data-line="crayon-5ab1b61385dc1540885326-9">9</div><div class="crayon-num" data-line="crayon-5ab1b61385dc1540885326-10">10</div><div class="crayon-num" data-line="crayon-5ab1b61385dc1540885326-11">11</div><div class="crayon-num" data-line="crayon-5ab1b61385dc1540885326-12">12</div><div class="crayon-num" data-line="crayon-5ab1b61385dc1540885326-13">13</div><div class="crayon-num" data-line="crayon-5ab1b61385dc1540885326-14">14</div><div class="crayon-num" data-line="crayon-5ab1b61385dc1540885326-15">15</div><div class="crayon-num" data-line="crayon-5ab1b61385dc1540885326-16">16</div><div class="crayon-num" data-line="crayon-5ab1b61385dc1540885326-17">17</div><div class="crayon-num" data-line="crayon-5ab1b61385dc1540885326-18">18</div><div class="crayon-num" data-line="crayon-5ab1b61385dc1540885326-19">19</div><div class="crayon-num" data-line="crayon-5ab1b61385dc1540885326-20">20</div><div class="crayon-num" data-line="crayon-5ab1b61385dc1540885326-21">21</div><div class="crayon-num" data-line="crayon-5ab1b61385dc1540885326-22">22</div><div class="crayon-num" data-line="crayon-5ab1b61385dc1540885326-23">23</div><div class="crayon-num" data-line="crayon-5ab1b61385dc1540885326-24">24</div><div class="crayon-num" data-line="crayon-5ab1b61385dc1540885326-25">25</div><div class="crayon-num" data-line="crayon-5ab1b61385dc1540885326-26">26</div><div class="crayon-num" data-line="crayon-5ab1b61385dc1540885326-27">27</div><div class="crayon-num" data-line="crayon-5ab1b61385dc1540885326-28">28</div><div class="crayon-num" data-line="crayon-5ab1b61385dc1540885326-29">29</div><div class="crayon-num" data-line="crayon-5ab1b61385dc1540885326-30">30</div><div class="crayon-num" data-line="crayon-5ab1b61385dc1540885326-31">31</div><div class="crayon-num" data-line="crayon-5ab1b61385dc1540885326-32">32</div><div class="crayon-num" data-line="crayon-5ab1b61385dc1540885326-33">33</div><div class="crayon-num" data-line="crayon-5ab1b61385dc1540885326-34">34</div><div class="crayon-num" data-line="crayon-5ab1b61385dc1540885326-35">35</div><div class="crayon-num" data-line="crayon-5ab1b61385dc1540885326-36">36</div><div class="crayon-num" data-line="crayon-5ab1b61385dc1540885326-37">37</div><div class="crayon-num" data-line="crayon-5ab1b61385dc1540885326-38">38</div><div class="crayon-num" data-line="crayon-5ab1b61385dc1540885326-39">39</div><div class="crayon-num" data-line="crayon-5ab1b61385dc1540885326-40">40</div><div class="crayon-num" data-line="crayon-5ab1b61385dc1540885326-41">41</div><div class="crayon-num" data-line="crayon-5ab1b61385dc1540885326-42">42</div><div class="crayon-num" data-line="crayon-5ab1b61385dc1540885326-43">43</div><div class="crayon-num" data-line="crayon-5ab1b61385dc1540885326-44">44</div><div class="crayon-num" data-line="crayon-5ab1b61385dc1540885326-45">45</div><div class="crayon-num" data-line="crayon-5ab1b61385dc1540885326-46">46</div><div class="crayon-num" data-line="crayon-5ab1b61385dc1540885326-47">47</div><div class="crayon-num" data-line="crayon-5ab1b61385dc1540885326-48">48</div><div class="crayon-num" data-line="crayon-5ab1b61385dc1540885326-49">49</div><div class="crayon-num" data-line="crayon-5ab1b61385dc1540885326-50">50</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5ab1b61385dc1540885326-1"><span class="crayon-p">#include &lt;cstdio&gt;</span></div><div class="crayon-line" id="crayon-5ab1b61385dc1540885326-2"><span class="crayon-p">#include &lt;vector&gt;</span></div><div class="crayon-line" id="crayon-5ab1b61385dc1540885326-3"><span class="crayon-p">#include &lt;faiss/Clustering.h&gt;</span></div><div class="crayon-line" id="crayon-5ab1b61385dc1540885326-4"><span class="crayon-p">#include &lt;faiss/utils.h&gt;</span></div><div class="crayon-line" id="crayon-5ab1b61385dc1540885326-5"><span class="crayon-p">#include &lt;faiss/gpu/GpuIndexFlat.h&gt;</span></div><div class="crayon-line" id="crayon-5ab1b61385dc1540885326-6"><span class="crayon-p">#include &lt;faiss/gpu/StandardGpuResources.h&gt;</span></div><div class="crayon-line" id="crayon-5ab1b61385dc1540885326-7">&nbsp;</div><div class="crayon-line" id="crayon-5ab1b61385dc1540885326-8"><span class="crayon-c">// just generate some random vecs in a hypercube (CPU)</span></div><div class="crayon-line" id="crayon-5ab1b61385dc1540885326-9"><span class="crayon-c">// クラスタリング対象のダミーデータを生成</span></div><div class="crayon-line" id="crayon-5ab1b61385dc1540885326-10"><span class="crayon-v">std</span><span class="crayon-o">::</span><span class="crayon-v">vector</span><span class="crayon-o">&lt;</span><span class="crayon-t">float</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-e">makeRandomVecs</span><span class="crayon-sy">(</span><span class="crayon-e">size_t </span><span class="crayon-v">numVecs</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">dim</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5ab1b61385dc1540885326-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">std</span><span class="crayon-o">::</span><span class="crayon-v">vector</span><span class="crayon-o">&lt;</span><span class="crayon-t">float</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-e">vecs</span><span class="crayon-sy">(</span><span class="crayon-v">numVecs</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">dim</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61385dc1540885326-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// void faiss::float_rand (float * x, size_t n, long seed)</span></div><div class="crayon-line" id="crayon-5ab1b61385dc1540885326-13"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// OpenMPを利用してマルチスレッドで生成される</span></div><div class="crayon-line" id="crayon-5ab1b61385dc1540885326-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">faiss</span><span class="crayon-o">::</span><span class="crayon-e">float_rand</span><span class="crayon-sy">(</span><span class="crayon-v">vecs</span><span class="crayon-sy">.</span><span class="crayon-e">data</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">vecs</span><span class="crayon-sy">.</span><span class="crayon-e">size</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61385dc1540885326-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">vecs</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61385dc1540885326-16"><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5ab1b61385dc1540885326-17">&nbsp;</div><div class="crayon-line" id="crayon-5ab1b61385dc1540885326-18"><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-e">main</span><span class="crayon-sy">(</span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">argc</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">char</span><span class="crayon-o">*</span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">argv</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5ab1b61385dc1540885326-19"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// Reserves 18% of GPU memory for temporary work by default; the</span></div><div class="crayon-line" id="crayon-5ab1b61385dc1540885326-20"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// size can be adjusted, or your own implementation of GpuResources</span></div><div class="crayon-line" id="crayon-5ab1b61385dc1540885326-21"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// can be made to manage memory in a different way.</span></div><div class="crayon-line" id="crayon-5ab1b61385dc1540885326-22"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">faiss</span><span class="crayon-o">::</span><span class="crayon-v">gpu</span><span class="crayon-o">::</span><span class="crayon-e">StandardGpuResources </span><span class="crayon-v">res</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61385dc1540885326-23"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span></div><div class="crayon-line" id="crayon-5ab1b61385dc1540885326-24"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">dim</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">128</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61385dc1540885326-25"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">numberOfEMIterations</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">20</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61385dc1540885326-26"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">size_t </span><span class="crayon-v">numberOfClusters</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">20000</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61385dc1540885326-27"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">size_t </span><span class="crayon-v">numVecsToCluster</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">5000000</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61385dc1540885326-28">&nbsp;</div><div class="crayon-line" id="crayon-5ab1b61385dc1540885326-29"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// generate a bunch of random vectors; note that this is on the CPU!</span></div><div class="crayon-line" id="crayon-5ab1b61385dc1540885326-30"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">std</span><span class="crayon-o">::</span><span class="crayon-v">vector</span><span class="crayon-o">&lt;</span><span class="crayon-t">float</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-v">vecs</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">makeRandomVecs</span><span class="crayon-sy">(</span><span class="crayon-v">numVecsToCluster</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">dim</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61385dc1540885326-31"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">faiss</span><span class="crayon-o">::</span><span class="crayon-v">gpu</span><span class="crayon-o">::</span><span class="crayon-e">GpuIndexFlatConfig </span><span class="crayon-v">config</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61385dc1540885326-32"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">config</span><span class="crayon-sy">.</span><span class="crayon-v">device</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">;</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// this is the default GPUデバイス番号</span></div><div class="crayon-line" id="crayon-5ab1b61385dc1540885326-33"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">config</span><span class="crayon-sy">.</span><span class="crayon-v">useFloat16</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">false</span><span class="crayon-sy">;</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// this is the default GPU側でFP16(半精度浮動小数点)を利用するか</span></div><div class="crayon-line" id="crayon-5ab1b61385dc1540885326-34"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">faiss</span><span class="crayon-o">::</span><span class="crayon-v">gpu</span><span class="crayon-o">::</span><span class="crayon-e">GpuIndexFlatL2 </span><span class="crayon-e">index</span><span class="crayon-sy">(</span><span class="crayon-v">&amp;res</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">dim</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">config</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c">// faiss::IndexFlatL2 のGPU版</span></div><div class="crayon-line" id="crayon-5ab1b61385dc1540885326-35"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span></div><div class="crayon-line" id="crayon-5ab1b61385dc1540885326-36"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">faiss</span><span class="crayon-o">::</span><span class="crayon-e">ClusteringParameters </span><span class="crayon-v">cp</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61385dc1540885326-37"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">cp</span><span class="crayon-sy">.</span><span class="crayon-v">niter</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">numberOfEMIterations</span><span class="crayon-sy">;</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c">// niter にイテレーション回数を設定</span></div><div class="crayon-line" id="crayon-5ab1b61385dc1540885326-38"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">cp</span><span class="crayon-sy">.</span><span class="crayon-v">verbose</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">true</span><span class="crayon-sy">;</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c">// verbose を true にすると標準出力にイテレーション毎の処理結果が表示される</span></div><div class="crayon-line" id="crayon-5ab1b61385dc1540885326-39"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span></div><div class="crayon-line" id="crayon-5ab1b61385dc1540885326-40"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// faiss::Clustering::Clustering(int d, int k, const ClusteringParameters &amp;cp)</span></div><div class="crayon-line" id="crayon-5ab1b61385dc1540885326-41"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">faiss</span><span class="crayon-o">::</span><span class="crayon-e">Clustering </span><span class="crayon-e">kMeans</span><span class="crayon-sy">(</span><span class="crayon-v">dim</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">numberOfClusters</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">cp</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61385dc1540885326-42">&nbsp;</div><div class="crayon-line" id="crayon-5ab1b61385dc1540885326-43"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// void faiss::Clustering::train(idx_t n, const float *x, faiss::Index &amp;index)</span></div><div class="crayon-line" id="crayon-5ab1b61385dc1540885326-44"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">kMeans</span><span class="crayon-sy">.</span><span class="crayon-e">train</span><span class="crayon-sy">(</span><span class="crayon-v">numVecsToCluster</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">vecs</span><span class="crayon-sy">.</span><span class="crayon-e">data</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">index</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61385dc1540885326-45">&nbsp;</div><div class="crayon-line" id="crayon-5ab1b61385dc1540885326-46"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// kMeans.centroids contains the resulting cluster centroids (on CPU)</span></div><div class="crayon-line" id="crayon-5ab1b61385dc1540885326-47"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">printf</span><span class="crayon-sy">(</span><span class="crayon-s">"centroid 3 dim 6 is %f\n"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">kMeans</span><span class="crayon-sy">.</span><span class="crayon-v">centroids</span><span class="crayon-sy">[</span><span class="crayon-cn">3</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">dim</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-cn">6</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61385dc1540885326-48">&nbsp;</div><div class="crayon-line" id="crayon-5ab1b61385dc1540885326-49"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61385dc1540885326-50"><span class="crayon-sy">}</span></div></div></td>
</tr>
</table>
</div>
</div>

<p><code>faiss::gpu</code>に属するクラスについては後述しますが、<code>faiss::gpu::GpuIndexFlatL2</code> は前回のエントリーで紹介した <code>faiss::IndexFlatL2</code> のGPU版となっています。<code>faiss::Clustering::train</code> 実装内部ではイテレーション毎に現在のセントロイドをインデックスしておき、全データをクエリとして検索しています。</p>
<p>* コンパイル</p>
<div id="crayon-5ab1b61385dc7001702499" class="crayon-syntax crayon-theme-ado crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 10px; margin-bottom: 10px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
$ nvcc \
    -I/usr/local/cuda-8.0/targets/x86_64-linux/include/ -Xcompiler -fPIC -Xcudafe \
    --diag_suppress=unrecognized_attribute -gencode arch=compute_52,code="compute_52" \
    --std c++11 -lineinfo -ccbin g++ -DFAISS_USE_FLOAT16 \
    -o gpu_kmean gpu_kmean.cpp \
    libgpufaiss.a libfaiss.a -Xcompiler -fopenmp -lcublas -lopenblas</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5ab1b61385dc7001702499-1">1</div><div class="crayon-num" data-line="crayon-5ab1b61385dc7001702499-2">2</div><div class="crayon-num" data-line="crayon-5ab1b61385dc7001702499-3">3</div><div class="crayon-num" data-line="crayon-5ab1b61385dc7001702499-4">4</div><div class="crayon-num" data-line="crayon-5ab1b61385dc7001702499-5">5</div><div class="crayon-num" data-line="crayon-5ab1b61385dc7001702499-6">6</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5ab1b61385dc7001702499-1"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-i">nvcc</span><span class="crayon-h"> </span><span class="crayon-sy">\</span></div><div class="crayon-line" id="crayon-5ab1b61385dc7001702499-2"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-o">-</span><span class="crayon-v">I</span><span class="crayon-o">/</span><span class="crayon-v">usr</span><span class="crayon-o">/</span><span class="crayon-v">local</span><span class="crayon-o">/</span><span class="crayon-v">cuda</span><span class="crayon-o">-</span><span class="crayon-cn">8.0</span><span class="crayon-o">/</span><span class="crayon-v">targets</span><span class="crayon-o">/</span><span class="crayon-v">x86_64</span><span class="crayon-o">-</span><span class="crayon-v">linux</span><span class="crayon-o">/</span><span class="crayon-v">include</span><span class="crayon-o">/</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">Xcompiler</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">fPIC</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">Xcudafe</span><span class="crayon-h"> </span><span class="crayon-sy">\</span></div><div class="crayon-line" id="crayon-5ab1b61385dc7001702499-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-o">--</span><span class="crayon-v">diag_suppress</span><span class="crayon-o">=</span><span class="crayon-v">unrecognized_attribute</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-e">gencode </span><span class="crayon-v">arch</span><span class="crayon-o">=</span><span class="crayon-v">compute_52</span><span class="crayon-sy">,</span><span class="crayon-v">code</span><span class="crayon-o">=</span><span class="crayon-s">"compute_52"</span><span class="crayon-h"> </span><span class="crayon-sy">\</span></div><div class="crayon-line" id="crayon-5ab1b61385dc7001702499-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-o">--</span><span class="crayon-i">std</span><span class="crayon-h"> </span><span class="crayon-v">c</span><span class="crayon-o">++</span><span class="crayon-cn">11</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">lineinfo</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">ccbin</span><span class="crayon-h"> </span><span class="crayon-v">g</span><span class="crayon-o">++</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">DFAISS_USE</span><span class="crayon-sy">_</span>FLOAT16<span class="crayon-h"> </span><span class="crayon-sy">\</span></div><div class="crayon-line" id="crayon-5ab1b61385dc7001702499-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-o">-</span><span class="crayon-i">o</span><span class="crayon-h"> </span><span class="crayon-e">gpu_kmean </span><span class="crayon-v">gpu_kmean</span><span class="crayon-sy">.</span><span class="crayon-i">cpp</span><span class="crayon-h"> </span><span class="crayon-sy">\</span></div><div class="crayon-line" id="crayon-5ab1b61385dc7001702499-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">libgpufaiss</span><span class="crayon-sy">.</span><span class="crayon-i">a</span><span class="crayon-h"> </span><span class="crayon-v">libfaiss</span><span class="crayon-sy">.</span><span class="crayon-v">a</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">Xcompiler</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">fopenmp</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">lcublas</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">lopenblas</span></div></div></td>
</tr>
</table>
</div>
</div>

<p></p>
<p>* 実行結果例</p>
<div id="crayon-5ab1b61385dcc943696246" class="crayon-syntax crayon-theme-ado crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 10px; margin-bottom: 10px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
Clustering 5000000 points in 128D to 20000 clusters, redo 1 times, 20 iterations
  Preprocessing in 0.74 s
  Iteration 19 (238.49 s, search 225.08 s): objective=4.51621e+07 imbalance=1.012 nsplit=0       
centroid 3 dim 6 is 0.468013</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5ab1b61385dcc943696246-1">1</div><div class="crayon-num" data-line="crayon-5ab1b61385dcc943696246-2">2</div><div class="crayon-num" data-line="crayon-5ab1b61385dcc943696246-3">3</div><div class="crayon-num" data-line="crayon-5ab1b61385dcc943696246-4">4</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5ab1b61385dcc943696246-1"><span class="crayon-i">Clustering</span><span class="crayon-h"> </span><span class="crayon-cn">5000000</span><span class="crayon-h"> </span><span class="crayon-e">points </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-cn">128D</span><span class="crayon-h"> </span><span class="crayon-st">to</span><span class="crayon-h"> </span><span class="crayon-cn">20000</span><span class="crayon-h"> </span><span class="crayon-v">clusters</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">redo</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-h"> </span><span class="crayon-v">times</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">20</span><span class="crayon-h"> </span><span class="crayon-e">iterations</span></div><div class="crayon-line" id="crayon-5ab1b61385dcc943696246-2"><span class="crayon-e">&nbsp;&nbsp;</span><span class="crayon-e">Preprocessing </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-cn">0.74</span><span class="crayon-h"> </span><span class="crayon-i">s</span></div><div class="crayon-line" id="crayon-5ab1b61385dcc943696246-3"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-i">Iteration</span><span class="crayon-h"> </span><span class="crayon-cn">19</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-cn">238.49</span><span class="crayon-h"> </span><span class="crayon-v">s</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">search</span><span class="crayon-h"> </span><span class="crayon-cn">225.08</span><span class="crayon-h"> </span><span class="crayon-v">s</span><span class="crayon-sy">)</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">objective</span><span class="crayon-o">=</span><span class="crayon-cn">4.51621e</span><span class="crayon-o">+</span><span class="crayon-cn">07</span><span class="crayon-h"> </span><span class="crayon-v">imbalance</span><span class="crayon-o">=</span><span class="crayon-cn">1.012</span><span class="crayon-h"> </span><span class="crayon-v">nsplit</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></div><div class="crayon-line" id="crayon-5ab1b61385dcc943696246-4"><span class="crayon-i">centroid</span><span class="crayon-h"> </span><span class="crayon-cn">3</span><span class="crayon-h"> </span><span class="crayon-i">dim</span><span class="crayon-h"> </span><span class="crayon-cn">6</span><span class="crayon-h"> </span><span class="crayon-st">is</span><span class="crayon-h"> </span><span class="crayon-cn">0.468013</span></div></div></td>
</tr>
</table>
</div>
</div>

<p>GPUを利用したk-meansクラスタリングは過去にもいろいろライブラリ等が出ていますし、サンプルとしてはよく見るものです。ここでの動作確認では5,000,000個のデータを20,000クラスタに分けるのに4分弱で処理できました。いまいちよく分からないのでCPU版と比較してみます。</p>
<div id="crayon-5ab1b61385dd0936736073" class="crayon-syntax crayon-theme-ado crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 10px; margin-bottom: 10px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
# ちなみにCore i5-2500K(CPU)だと、
Clustering 5000000 points in 128D to 20000 clusters, redo 1 times, 20 iterations
  Preprocessing in 0.73 s
^CIteration 10 (15075.25 s, search 15063.99 s): objective=4.52261e+07 imbalance=1.014 nsplit=0       
./cpu_kmean  26401.24s user 5721.63s system 198% cpu 4:29:12.17 total
## 4時間経っても終わらず、、ここで断念</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5ab1b61385dd0936736073-1">1</div><div class="crayon-num" data-line="crayon-5ab1b61385dd0936736073-2">2</div><div class="crayon-num" data-line="crayon-5ab1b61385dd0936736073-3">3</div><div class="crayon-num" data-line="crayon-5ab1b61385dd0936736073-4">4</div><div class="crayon-num" data-line="crayon-5ab1b61385dd0936736073-5">5</div><div class="crayon-num" data-line="crayon-5ab1b61385dd0936736073-6">6</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5ab1b61385dd0936736073-1"><span class="crayon-p"># ちなみにCore i5-2500K(CPU)だと、</span></div><div class="crayon-line" id="crayon-5ab1b61385dd0936736073-2"><span class="crayon-i">Clustering</span><span class="crayon-h"> </span><span class="crayon-cn">5000000</span><span class="crayon-h"> </span><span class="crayon-e">points </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-cn">128D</span><span class="crayon-h"> </span><span class="crayon-st">to</span><span class="crayon-h"> </span><span class="crayon-cn">20000</span><span class="crayon-h"> </span><span class="crayon-v">clusters</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">redo</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-h"> </span><span class="crayon-v">times</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">20</span><span class="crayon-h"> </span><span class="crayon-e">iterations</span></div><div class="crayon-line" id="crayon-5ab1b61385dd0936736073-3"><span class="crayon-e">&nbsp;&nbsp;</span><span class="crayon-e">Preprocessing </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-cn">0.73</span><span class="crayon-h"> </span><span class="crayon-v">s</span></div><div class="crayon-line" id="crayon-5ab1b61385dd0936736073-4"><span class="crayon-o">^</span><span class="crayon-i">CIteration</span><span class="crayon-h"> </span><span class="crayon-cn">10</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-cn">15075.25</span><span class="crayon-h"> </span><span class="crayon-v">s</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">search</span><span class="crayon-h"> </span><span class="crayon-cn">15063.99</span><span class="crayon-h"> </span><span class="crayon-v">s</span><span class="crayon-sy">)</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">objective</span><span class="crayon-o">=</span><span class="crayon-cn">4.52261e</span><span class="crayon-o">+</span><span class="crayon-cn">07</span><span class="crayon-h"> </span><span class="crayon-v">imbalance</span><span class="crayon-o">=</span><span class="crayon-cn">1.014</span><span class="crayon-h"> </span><span class="crayon-v">nsplit</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></div><div class="crayon-line" id="crayon-5ab1b61385dd0936736073-5"><span class="crayon-sy">.</span><span class="crayon-o">/</span><span class="crayon-v">cpu</span><span class="crayon-sy">_</span>kmean<span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">26401.24s</span><span class="crayon-h"> </span><span class="crayon-i">user</span><span class="crayon-h"> </span><span class="crayon-cn">5721.63s</span><span class="crayon-h"> </span><span class="crayon-i">system</span><span class="crayon-h"> </span><span class="crayon-cn">198</span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-i">cpu</span><span class="crayon-h"> </span><span class="crayon-cn">4</span><span class="crayon-o">:</span><span class="crayon-cn">29</span><span class="crayon-o">:</span><span class="crayon-cn">12.17</span><span class="crayon-h"> </span><span class="crayon-v">total</span></div><div class="crayon-line" id="crayon-5ab1b61385dd0936736073-6"><span class="crayon-p">## 4時間経っても終わらず、、ここで断念</span></div></div></td>
</tr>
</table>
</div>
</div>

<p></p>
<p>上記プログラムをCPUでのクラスタリング処理に変更するには、インデックスオブジェクトである <code>faiss::gpu::GpuIndexFlatL2</code> を <code>faiss::IndexFlatL2</code> に変えるだけです。ただし上記プログラムの設定だとCPU版の処理が一向に終わらなかったので以下のようにテストの規模を縮小することで調整しました。</p>
<ul>
<li>データ(128次元): 500,000</li>
<li>クラス(分割数): 2,000</li>
<li>イテレーション: 20</li>
</ul>
<p>500,000個のデータを2,000クラスタに分けます。それぞれ5回計測した平均処理時間は以下の通りです。また、参考までに各製品のリリース時期も併記しています。</p>
<table>
<tr>
<th>CPU<br /><span style="color:#0071c5">Intel Core i5-2500K</span><br />(2011/1)</th>
<th>CPU<br /><span style="color:#0071c5">Intel Xeon E5-2686</span><br />(2016/6)</th>
<th>GPU<br /><span style="color:#75b902">NVIDIA GM204 [GeForce GTX 970]</span><br />(2014/9)</th>
<th>GPU<br /><span style="color:#75b902">NVIDIA GK210GL [Tesla K80]</span><br />(2014/11)</th>
</tr>
<tr>
<td>511.15s</td>
<td>114.10s</td>
<td>5.70s</td>
<td>4.85s</td>
</tr>
</table>
<p>前回のエントリーにも書いた通り、CPU版はOpenMPやSIMDを駆使して実装されており十分に高速です。しかしGPU版はそれと比較しても遙かに高速に動作します。また、CPUからGPUへのデータ転送は必要に応じて都度行われるため(計算に必要なデータだけGPU上に載せる)、VRAM容量を超えるような巨大なデータセットでもクラスタリング可能となっています。</p>
<p>さらに、FP16(半精度浮動小数点値での演算)を有効にしてGTX 970上で比較してみました。こちらも同様に5回計測した平均処理時間を載せます。</p>
<ul>
<li>データ(128次元): 5,000,000</li>
<li>クラス(分割数): 20,000</li>
<li>イテレーション: 20</li>
</ul>
<table>
<tr>
<th>FP16無効</th>
<th>FP16有効</th>
</tr>
<tr>
<td>228.47s</td>
<td>191.76s</td>
</tr>
</table>
<p>なかなか興味深い結果となりました。確かPascal世代からFP16の性能が格段に上がっていたかと思うので(1SPでFP16二つを同時演算したり)、PascalのGPUでベンチマークしてみたいところです。Facebook Researchのレポートだと<a onclick="javascript:pageTracker._trackPageview('/outgoing/www.nvidia.com/object/tesla-p100.html');" href="http://www.nvidia.com/object/tesla-p100.html">Tesla P100</a>でだいたい100秒ほどで完走するらしいです。<br />
* <a onclick="javascript:pageTracker._trackPageview('/outgoing/github.com/facebookresearch/faiss/wiki/GPU-k-means-example');" href="https://github.com/facebookresearch/faiss/wiki/GPU-k-means-example">GPU k means example</a></p>
<h3 class="term">GPUを利用した検索</h3>
<p>次は前回紹介したCPU版チュートリアルにある各種検索プログラムをGPU対応していきます。</p>
<h4 class="term">GPUリソースの確保・初期化</h4>
<p>GPUで処理するために予めGPUリソースの事前確保作業が必要ですが、生のCUDAプログラムと比較すれば十分抽象化されているので特に難しいところは無いかと思います。GPU版のヘッダファイルは <code>faiss/gpu</code> 以下にあります。</p>
<ul>
<li><code>faiss::gpu::StandardGpuResources</code></li>
<li><code>faiss::gpu::GpuIndexFlatConfig</code></li>
</ul>
<p></p>
<div id="crayon-5ab1b61385dd7642045049" class="crayon-syntax crayon-theme-ado crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 10px; margin-bottom: 10px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">C++</span></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
faiss::gpu::StandardGpuResources res;

faiss::gpu::GpuIndexFlatConfig config;
config.device = 0;
config.useFloat16 = true;</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5ab1b61385dd7642045049-1">1</div><div class="crayon-num" data-line="crayon-5ab1b61385dd7642045049-2">2</div><div class="crayon-num" data-line="crayon-5ab1b61385dd7642045049-3">3</div><div class="crayon-num" data-line="crayon-5ab1b61385dd7642045049-4">4</div><div class="crayon-num" data-line="crayon-5ab1b61385dd7642045049-5">5</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5ab1b61385dd7642045049-1"><span class="crayon-v">faiss</span><span class="crayon-o">::</span><span class="crayon-v">gpu</span><span class="crayon-o">::</span><span class="crayon-e">StandardGpuResources </span><span class="crayon-v">res</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61385dd7642045049-2">&nbsp;</div><div class="crayon-line" id="crayon-5ab1b61385dd7642045049-3"><span class="crayon-v">faiss</span><span class="crayon-o">::</span><span class="crayon-v">gpu</span><span class="crayon-o">::</span><span class="crayon-e">GpuIndexFlatConfig </span><span class="crayon-v">config</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61385dd7642045049-4"><span class="crayon-v">config</span><span class="crayon-sy">.</span><span class="crayon-v">device</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61385dd7642045049-5"><span class="crayon-v">config</span><span class="crayon-sy">.</span><span class="crayon-v">useFloat16</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">true</span><span class="crayon-sy">;</span></div></div></td>
</tr>
</table>
</div>
</div>

<p>前述のk-meansのサンプルコードと同じ設定でだいたい大丈夫です。内部ではcuBLASのハンドル初期化やCUDAのストリーム生成処理等を行っています。デフォルトだとストリーム(cudaStream_t)は2本準備しているようです。</p>
<h4 class="term">GPU版インデックスクラス</h4>
<p>チュートリアルで紹介した各種CPU版インデックス用クラスのGPU対応は簡単なのでまとめて紹介します。</p>
<table>
<tr>
<th><span style="color:#0071c5">CPU</span></th>
<th><span style="color:#75b902">GPU</span></th>
</tr>
<tr>
<td><code>faiss::IndexFlatL2</code></td>
<td><code>faiss::gpu::GpuIndexFlatL2</code></td>
</tr>
<tr>
<td><code>faiss::IndexIVFFlat</code></td>
<td><code>faiss::gpu::GpuIndexIVFFlat</code></td>
</tr>
<tr>
<td><code>faiss::IndexIVFPQ</code></td>
<td><code>faiss::gpu::GpuIndexIVFPQ</code></td>
</tr>
</table>
<p></p>
<div id="crayon-5ab1b61385ddc459105972" class="crayon-syntax crayon-theme-ado crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 10px; margin-bottom: 10px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">C++</span></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
const int d = 64;  // dimension

## IndexFlatL2
faiss::IndexFlatL2 index(d);

## GpuIndexFlatL2 (IndexFlatL2のGPU版)
## GpuIndexFlatL2(GpuResources *resources, int dims, GpuIndexFlatConfig config=GpuIndexFlatConfig())
faiss::gpu::GpuIndexFlatL2 index(&amp;res, d, config);

## IndexIVFFlat
const int nlist = 100;  // number of inverted lists
faiss::IndexFlatL2 quantizer(d);
faiss::IndexIVFFlat index(&amp;quantizer, d, nlist, faiss::METRIC_L2);

## GpuIndexIVFFlat (IndexIVFFlatのGPU版)
## GpuIndexIVFFlat(GpuResources *resources, int device, GpuIndexFlat *quantizer, bool useFloat16, int dims, int nlist, IndicesOptions indicesOptions, faiss::MetricType metric)
faiss::gpu::GpuIndexFlatL2 quantizer(&amp;res, d, config);
faiss::gpu::GpuIndexIVFFlat index(&amp;res, 0, &amp;quantizer, false, d, nlist, faiss::gpu::INDICES_64_BIT, faiss::METRIC_L2);

## IndexIVFPQ
const int m = 8;  // number of subquantizers
const int nbits = 8;  // number of bits per quantization index
faiss::IndexFlatL2 quantizer(d);
faiss::IndexIVFPQ index(&amp;quantizer, d, nlist, m, nbits);

## GpuIndexIVFPQ (IndexIVFPQのGPU版)
## GpuIndexIVFPQ(GpuResources *resources, int device, int dims, int nlist, int subQuantizers, int bitsPerCode, bool usePrecomputed, IndicesOptions indicesOptions, bool useFloat16LookupTables, faiss::MetricType metric)
faiss::gpu::GpuIndexIVFPQ index(&amp;res, 0, d, nlist, m, nbits, true, faiss::gpu::INDICES_64_BIT, false, faiss::METRIC_L2);</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5ab1b61385ddc459105972-1">1</div><div class="crayon-num" data-line="crayon-5ab1b61385ddc459105972-2">2</div><div class="crayon-num" data-line="crayon-5ab1b61385ddc459105972-3">3</div><div class="crayon-num" data-line="crayon-5ab1b61385ddc459105972-4">4</div><div class="crayon-num" data-line="crayon-5ab1b61385ddc459105972-5">5</div><div class="crayon-num" data-line="crayon-5ab1b61385ddc459105972-6">6</div><div class="crayon-num" data-line="crayon-5ab1b61385ddc459105972-7">7</div><div class="crayon-num" data-line="crayon-5ab1b61385ddc459105972-8">8</div><div class="crayon-num" data-line="crayon-5ab1b61385ddc459105972-9">9</div><div class="crayon-num" data-line="crayon-5ab1b61385ddc459105972-10">10</div><div class="crayon-num" data-line="crayon-5ab1b61385ddc459105972-11">11</div><div class="crayon-num" data-line="crayon-5ab1b61385ddc459105972-12">12</div><div class="crayon-num" data-line="crayon-5ab1b61385ddc459105972-13">13</div><div class="crayon-num" data-line="crayon-5ab1b61385ddc459105972-14">14</div><div class="crayon-num" data-line="crayon-5ab1b61385ddc459105972-15">15</div><div class="crayon-num" data-line="crayon-5ab1b61385ddc459105972-16">16</div><div class="crayon-num" data-line="crayon-5ab1b61385ddc459105972-17">17</div><div class="crayon-num" data-line="crayon-5ab1b61385ddc459105972-18">18</div><div class="crayon-num" data-line="crayon-5ab1b61385ddc459105972-19">19</div><div class="crayon-num" data-line="crayon-5ab1b61385ddc459105972-20">20</div><div class="crayon-num" data-line="crayon-5ab1b61385ddc459105972-21">21</div><div class="crayon-num" data-line="crayon-5ab1b61385ddc459105972-22">22</div><div class="crayon-num" data-line="crayon-5ab1b61385ddc459105972-23">23</div><div class="crayon-num" data-line="crayon-5ab1b61385ddc459105972-24">24</div><div class="crayon-num" data-line="crayon-5ab1b61385ddc459105972-25">25</div><div class="crayon-num" data-line="crayon-5ab1b61385ddc459105972-26">26</div><div class="crayon-num" data-line="crayon-5ab1b61385ddc459105972-27">27</div><div class="crayon-num" data-line="crayon-5ab1b61385ddc459105972-28">28</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5ab1b61385ddc459105972-1"><span class="crayon-m">const</span><span class="crayon-h"> </span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">d</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">64</span><span class="crayon-sy">;</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c">// dimension</span></div><div class="crayon-line" id="crayon-5ab1b61385ddc459105972-2">&nbsp;</div><div class="crayon-line" id="crayon-5ab1b61385ddc459105972-3"><span class="crayon-p">## IndexFlatL2</span></div><div class="crayon-line" id="crayon-5ab1b61385ddc459105972-4"><span class="crayon-v">faiss</span><span class="crayon-o">::</span><span class="crayon-e">IndexFlatL2 </span><span class="crayon-e">index</span><span class="crayon-sy">(</span><span class="crayon-v">d</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61385ddc459105972-5">&nbsp;</div><div class="crayon-line" id="crayon-5ab1b61385ddc459105972-6"><span class="crayon-p">## GpuIndexFlatL2 (IndexFlatL2のGPU版)</span></div><div class="crayon-line" id="crayon-5ab1b61385ddc459105972-7"><span class="crayon-p">## GpuIndexFlatL2(GpuResources *resources, int dims, GpuIndexFlatConfig config=GpuIndexFlatConfig())</span></div><div class="crayon-line" id="crayon-5ab1b61385ddc459105972-8"><span class="crayon-v">faiss</span><span class="crayon-o">::</span><span class="crayon-v">gpu</span><span class="crayon-o">::</span><span class="crayon-e">GpuIndexFlatL2 </span><span class="crayon-e">index</span><span class="crayon-sy">(</span><span class="crayon-v">&amp;res</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">d</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">config</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61385ddc459105972-9">&nbsp;</div><div class="crayon-line" id="crayon-5ab1b61385ddc459105972-10"><span class="crayon-p">## IndexIVFFlat</span></div><div class="crayon-line" id="crayon-5ab1b61385ddc459105972-11"><span class="crayon-m">const</span><span class="crayon-h"> </span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">nlist</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">100</span><span class="crayon-sy">;</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c">// number of inverted lists</span></div><div class="crayon-line" id="crayon-5ab1b61385ddc459105972-12"><span class="crayon-v">faiss</span><span class="crayon-o">::</span><span class="crayon-e">IndexFlatL2 </span><span class="crayon-e">quantizer</span><span class="crayon-sy">(</span><span class="crayon-v">d</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61385ddc459105972-13"><span class="crayon-v">faiss</span><span class="crayon-o">::</span><span class="crayon-e">IndexIVFFlat </span><span class="crayon-e">index</span><span class="crayon-sy">(</span><span class="crayon-v">&amp;quantizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">d</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">nlist</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">faiss</span><span class="crayon-o">::</span><span class="crayon-v">METRIC_L2</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61385ddc459105972-14">&nbsp;</div><div class="crayon-line" id="crayon-5ab1b61385ddc459105972-15"><span class="crayon-p">## GpuIndexIVFFlat (IndexIVFFlatのGPU版)</span></div><div class="crayon-line" id="crayon-5ab1b61385ddc459105972-16"><span class="crayon-p">## GpuIndexIVFFlat(GpuResources *resources, int device, GpuIndexFlat *quantizer, bool useFloat16, int dims, int nlist, IndicesOptions indicesOptions, faiss::MetricType metric)</span></div><div class="crayon-line" id="crayon-5ab1b61385ddc459105972-17"><span class="crayon-v">faiss</span><span class="crayon-o">::</span><span class="crayon-v">gpu</span><span class="crayon-o">::</span><span class="crayon-e">GpuIndexFlatL2 </span><span class="crayon-e">quantizer</span><span class="crayon-sy">(</span><span class="crayon-v">&amp;res</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">d</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">config</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61385ddc459105972-18"><span class="crayon-v">faiss</span><span class="crayon-o">::</span><span class="crayon-v">gpu</span><span class="crayon-o">::</span><span class="crayon-e">GpuIndexIVFFlat </span><span class="crayon-e">index</span><span class="crayon-sy">(</span><span class="crayon-v">&amp;res</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">&amp;quantizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">false</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">d</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">nlist</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">faiss</span><span class="crayon-o">::</span><span class="crayon-v">gpu</span><span class="crayon-o">::</span><span class="crayon-v">INDICES_64_BIT</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">faiss</span><span class="crayon-o">::</span><span class="crayon-v">METRIC_L2</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61385ddc459105972-19">&nbsp;</div><div class="crayon-line" id="crayon-5ab1b61385ddc459105972-20"><span class="crayon-p">## IndexIVFPQ</span></div><div class="crayon-line" id="crayon-5ab1b61385ddc459105972-21"><span class="crayon-m">const</span><span class="crayon-h"> </span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">m</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">8</span><span class="crayon-sy">;</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c">// number of subquantizers</span></div><div class="crayon-line" id="crayon-5ab1b61385ddc459105972-22"><span class="crayon-m">const</span><span class="crayon-h"> </span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">nbits</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">8</span><span class="crayon-sy">;</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c">// number of bits per quantization index</span></div><div class="crayon-line" id="crayon-5ab1b61385ddc459105972-23"><span class="crayon-v">faiss</span><span class="crayon-o">::</span><span class="crayon-e">IndexFlatL2 </span><span class="crayon-e">quantizer</span><span class="crayon-sy">(</span><span class="crayon-v">d</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61385ddc459105972-24"><span class="crayon-v">faiss</span><span class="crayon-o">::</span><span class="crayon-e">IndexIVFPQ </span><span class="crayon-e">index</span><span class="crayon-sy">(</span><span class="crayon-v">&amp;quantizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">d</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">nlist</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">m</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">nbits</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61385ddc459105972-25">&nbsp;</div><div class="crayon-line" id="crayon-5ab1b61385ddc459105972-26"><span class="crayon-p">## GpuIndexIVFPQ (IndexIVFPQのGPU版)</span></div><div class="crayon-line" id="crayon-5ab1b61385ddc459105972-27"><span class="crayon-p">## GpuIndexIVFPQ(GpuResources *resources, int device, int dims, int nlist, int subQuantizers, int bitsPerCode, bool usePrecomputed, IndicesOptions indicesOptions, bool useFloat16LookupTables, faiss::MetricType metric)</span></div><div class="crayon-line" id="crayon-5ab1b61385ddc459105972-28"><span class="crayon-v">faiss</span><span class="crayon-o">::</span><span class="crayon-v">gpu</span><span class="crayon-o">::</span><span class="crayon-e">GpuIndexIVFPQ </span><span class="crayon-e">index</span><span class="crayon-sy">(</span><span class="crayon-v">&amp;res</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">d</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">nlist</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">m</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">nbits</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">true</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">faiss</span><span class="crayon-o">::</span><span class="crayon-v">gpu</span><span class="crayon-o">::</span><span class="crayon-v">INDICES_64_BIT</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">false</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">faiss</span><span class="crayon-o">::</span><span class="crayon-v">METRIC_L2</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div></div></td>
</tr>
</table>
</div>
</div>

<p>2017/05現在、<code>faiss::gpu::GpuIndexIVFPQ</code> にはGPU版インデックスクラスのポインタを直接受け取るコンストラクタは未実装のようですので別のコンストラクタを利用しています。この場合は引数で渡す <code>faiss::MetricType</code> に応じたGPU版インデックスクラスのインスタンスを内部で生成/保持してくれます。前回紹介していませんでしたが距離尺度は <code>faiss::MetricType</code> 定数で指定するようになっており、チュートリアルではL2ノルムの紹介のみでしたが、もちろん内積(Inner Product)にも対応しています。</p>
<div id="crayon-5ab1b61385de1154514837" class="crayon-syntax crayon-theme-ado crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 10px; margin-bottom: 10px; font-size: 12px !important; line-height: 15px !important;">

<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">C++</span></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
/// Some algorithms support both an inner product vetsion and a L2 search version.
enum MetricType {
    METRIC_INNER_PRODUCT = 0,
    METRIC_L2 = 1,
};</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5ab1b61385de1154514837-1">1</div><div class="crayon-num" data-line="crayon-5ab1b61385de1154514837-2">2</div><div class="crayon-num" data-line="crayon-5ab1b61385de1154514837-3">3</div><div class="crayon-num" data-line="crayon-5ab1b61385de1154514837-4">4</div><div class="crayon-num" data-line="crayon-5ab1b61385de1154514837-5">5</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5ab1b61385de1154514837-1"><span class="crayon-c">/// Some algorithms support both an inner product vetsion and a L2 search version.</span></div><div class="crayon-line" id="crayon-5ab1b61385de1154514837-2"><span class="crayon-t">enum</span><span class="crayon-h"> </span><span class="crayon-e">MetricType</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5ab1b61385de1154514837-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">METRIC_INNER_PRODUCT</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5ab1b61385de1154514837-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">METRIC_L2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5ab1b61385de1154514837-5"><span class="crayon-sy">}</span><span class="crayon-sy">;</span></div></div></td>
</tr>
</table>
</div>
</div>

<p></p>
<p>また、<code>faiss::gpu::IndicesOptions</code> は以下のように定義されています。これはCPU<->GPU間でのインデックス情報の転送・保存をどのような形式で行うかを指定します。</p>
<div id="crayon-5ab1b61385de5897676147" class="crayon-syntax crayon-theme-ado crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 10px; margin-bottom: 10px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">C++</span></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
enum IndicesOptions {
  /// The user indices are only stored on the CPU; the GPU returns
  /// (inverted list, offset) to the CPU which is then translated to
  /// the real user index.
  INDICES_CPU = 0,
  /// The indices are not stored at all, on either the CPU or
  /// GPU. Only (inverted list, offset) is returned to the user as the
  /// index.
  INDICES_IVF = 1,
  /// Indices are stored as 32 bit integers on the GPU, but returned
  /// as 64 bit integers
  INDICES_32_BIT = 2,
  /// Indices are stored as 64 bit integers on the GPU
  INDICES_64_BIT = 3,
};</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5ab1b61385de5897676147-1">1</div><div class="crayon-num" data-line="crayon-5ab1b61385de5897676147-2">2</div><div class="crayon-num" data-line="crayon-5ab1b61385de5897676147-3">3</div><div class="crayon-num" data-line="crayon-5ab1b61385de5897676147-4">4</div><div class="crayon-num" data-line="crayon-5ab1b61385de5897676147-5">5</div><div class="crayon-num" data-line="crayon-5ab1b61385de5897676147-6">6</div><div class="crayon-num" data-line="crayon-5ab1b61385de5897676147-7">7</div><div class="crayon-num" data-line="crayon-5ab1b61385de5897676147-8">8</div><div class="crayon-num" data-line="crayon-5ab1b61385de5897676147-9">9</div><div class="crayon-num" data-line="crayon-5ab1b61385de5897676147-10">10</div><div class="crayon-num" data-line="crayon-5ab1b61385de5897676147-11">11</div><div class="crayon-num" data-line="crayon-5ab1b61385de5897676147-12">12</div><div class="crayon-num" data-line="crayon-5ab1b61385de5897676147-13">13</div><div class="crayon-num" data-line="crayon-5ab1b61385de5897676147-14">14</div><div class="crayon-num" data-line="crayon-5ab1b61385de5897676147-15">15</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5ab1b61385de5897676147-1"><span class="crayon-t">enum</span><span class="crayon-h"> </span><span class="crayon-e">IndicesOptions</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5ab1b61385de5897676147-2"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c">/// The user indices are only stored on the CPU; the GPU returns</span></div><div class="crayon-line" id="crayon-5ab1b61385de5897676147-3"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c">/// (inverted list, offset) to the CPU which is then translated to</span></div><div class="crayon-line" id="crayon-5ab1b61385de5897676147-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c">/// the real user index.</span></div><div class="crayon-line" id="crayon-5ab1b61385de5897676147-5"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">INDICES_CPU</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5ab1b61385de5897676147-6"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c">/// The indices are not stored at all, on either the CPU or</span></div><div class="crayon-line" id="crayon-5ab1b61385de5897676147-7"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c">/// GPU. Only (inverted list, offset) is returned to the user as the</span></div><div class="crayon-line" id="crayon-5ab1b61385de5897676147-8"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c">/// index.</span></div><div class="crayon-line" id="crayon-5ab1b61385de5897676147-9"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">INDICES_IVF</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5ab1b61385de5897676147-10"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c">/// Indices are stored as 32 bit integers on the GPU, but returned</span></div><div class="crayon-line" id="crayon-5ab1b61385de5897676147-11"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c">/// as 64 bit integers</span></div><div class="crayon-line" id="crayon-5ab1b61385de5897676147-12"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">INDICES_32_BIT</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5ab1b61385de5897676147-13"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c">/// Indices are stored as 64 bit integers on the GPU</span></div><div class="crayon-line" id="crayon-5ab1b61385de5897676147-14"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">INDICES_64_BIT</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">3</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5ab1b61385de5897676147-15"><span class="crayon-sy">}</span><span class="crayon-sy">;</span></div></div></td>
</tr>
</table>
</div>
</div>

<p></p>
<p>CPU版とは異なりGPU版の各種インデックスクラスのメンバ変数はなぜかカプセル化されているみたいなので、提供されているgetter/setter経由でデータ操作を行います。GPU対応する際には忘れないようにしましょう。</p>
<div id="crayon-5ab1b61385de9057385386" class="crayon-syntax crayon-theme-ado crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 10px; margin-bottom: 10px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">C++</span></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
// nprobe を変更する場合
index.nprobe = 10;       // CPU版
index.setNumProbes(10);  // GPU版</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5ab1b61385de9057385386-1">1</div><div class="crayon-num" data-line="crayon-5ab1b61385de9057385386-2">2</div><div class="crayon-num" data-line="crayon-5ab1b61385de9057385386-3">3</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5ab1b61385de9057385386-1"><span class="crayon-c">// nprobe を変更する場合</span></div><div class="crayon-line" id="crayon-5ab1b61385de9057385386-2"><span class="crayon-v">index</span><span class="crayon-sy">.</span><span class="crayon-v">nprobe</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">10</span><span class="crayon-sy">;</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-c">// CPU版</span></div><div class="crayon-line" id="crayon-5ab1b61385de9057385386-3"><span class="crayon-v">index</span><span class="crayon-sy">.</span><span class="crayon-e">setNumProbes</span><span class="crayon-sy">(</span><span class="crayon-cn">10</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c">// GPU版</span></div></div></td>
</tr>
</table>
</div>
</div>

<p></p>
<h3 class="term">ベンチマーク</h4>
<p>次は最近傍探索処理の測定を行います。チュートリアルのプログラムをベースにパラメータ等を調整して比較しました。論文中では<a onclick="javascript:pageTracker._trackPageview('/outgoing/sites.skoltech.ru/compvision/noimi/');" href="http://sites.skoltech.ru/compvision/noimi/">Deep1B</a>や<a onclick="javascript:pageTracker._trackPageview('/outgoing/yfcc100m.appspot.com/about');" href="http://yfcc100m.appspot.com/about">YFCC100M</a>などの巨大なデータセットでベンチマークをしていて真似したかったんですけど、自宅のGPU開発環境だと空冷が適当なので kidle_inject が発生し、温度上昇防止のためCPU使用に制限をかけてしまいます。。ここでは<a onclick="javascript:pageTracker._trackPageview('/outgoing/corpus-texmex.irisa.fr/');" href="http://corpus-texmex.irisa.fr/">ANN_SIFT1M</a>と同じ小規模データでベンチマークを行いました。</p>
<ul>
<li>次元数: 128</li>
<li>データ数: 1,000,000 (100万データ)</li>
<li>同時実行クエリ数: 10,000 (1万クエリ)</li>
<li>インデックス: faiss::gpu::IndexFlatL2 (全探索) / faiss::gpu::IndexIVFPQ (PQ + 転置インデックス)</li>
<li>転置インデックスのリストサイズ 100、サブベクトル数 8、量子化ビット数 8、FP16有効</li>
<li>検索時のkの値: 1 ~ 1024 の範囲で変更</li>
</ul>
<p>ベンチマーク用プログラムはここに記載するには少し長くなるのでGistにアップロードしておきます。</p>
<ul>
<li><a onclick="javascript:pageTracker._trackPageview('/outgoing/gist.github.com/wellflat/6420d1dd3441fc230ede9b6786030df3');" href="https://gist.github.com/wellflat/6420d1dd3441fc230ede9b6786030df3">wellflat/faiss_benchmark_sample.cpp - Gist</a></li>
</ul>
<p><img src="http://rest-term.com/wp-content/plugins/lazy-load/images/1x1.trans.gif?x45852" data-lazy-src="http://rest-term.com/wp-content/uploads/2017/06/index_gpu_bench.png?x45852" alt width="600" height="371" class="alignnone size-full wp-image-3421"><noscript><img src="http://rest-term.com/wp-content/uploads/2017/06/index_gpu_bench.png?x45852" alt="" width="600" height="371" class="alignnone size-full wp-image-3421" /></noscript></p>
<p>僕の個人開発環境だと1万クエリの上位20件を検索するのに、全探索(IndexFlatL2)の場合は約1.1秒、PQ + 転置インデックス(IVFPQ)の場合は約20ミリ秒でした。ただし、Faissの真価はbillion-scaleでの検索処理において発揮されるので、ここでのベンチマークは参考程度ということで。</p>
<p>また、Facebook AI Research公式の詳細なベンチマーク結果は以下を参照してください。</p>
<ul>
<li><a onclick="javascript:pageTracker._trackPageview('/outgoing/github.com/facebookresearch/faiss/wiki/Low-level-benchmarks');" href="https://github.com/facebookresearch/faiss/wiki/Low-level-benchmarks">Low level benchmarks</a></li>
<li><a onclick="javascript:pageTracker._trackPageview('/outgoing/github.com/facebookresearch/faiss/wiki/Indexing-1M-vectors');" href="https://github.com/facebookresearch/faiss/wiki/Indexing-1M-vectors">Indexing 1M vectors</a></li>
<li><a onclick="javascript:pageTracker._trackPageview('/outgoing/github.com/facebookresearch/faiss/wiki/Indexing-1G-vectors');" href="https://github.com/facebookresearch/faiss/wiki/Indexing-1G-vectors">Indexing 1G vectors</a></li>
</ul>
<h3 class="term">注意点など</h4>
<p>GPUでの検索処理にはいくつか制限が設けられています。2017/06現在の仕様なので変更される可能性があります。</p>
<h4 class="term">GPUテンポラリメモリ</h5>
<p><code>cudaMalloc/cudaFree</code> はコストが高い処理なので事前にある程度のメモリ領域が自動的に確保されるのですが、そのサイズをユーザー側が指定することができます。<code>StandardGpuResources</code> のAPIで指定できます。</p>
<div id="crayon-5ab1b61385def867996055" class="crayon-syntax crayon-theme-ado crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 10px; margin-bottom: 10px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">C++</span></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
faiss::gpu::StandardGpuResources res;
size_t memSize = 1073741824;  // 1024MB                                                                                                                                     
res.setTempMemory(memSize);</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5ab1b61385def867996055-1">1</div><div class="crayon-num" data-line="crayon-5ab1b61385def867996055-2">2</div><div class="crayon-num" data-line="crayon-5ab1b61385def867996055-3">3</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5ab1b61385def867996055-1"><span class="crayon-v">faiss</span><span class="crayon-o">::</span><span class="crayon-v">gpu</span><span class="crayon-o">::</span><span class="crayon-e">StandardGpuResources </span><span class="crayon-v">res</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61385def867996055-2"><span class="crayon-e">size_t </span><span class="crayon-v">memSize</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">1073741824</span><span class="crayon-sy">;</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c">// 1024MB&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></div><div class="crayon-line" id="crayon-5ab1b61385def867996055-3"><span class="crayon-v">res</span><span class="crayon-sy">.</span><span class="crayon-e">setTempMemory</span><span class="crayon-sy">(</span><span class="crayon-v">memSize</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div></div></td>
</tr>
</table>
</div>
</div>

<p>テンポラリメモリが足りないと以下のような警告が出力されます。<code>cudaMalloc</code> が新たに必要になってしまうから遅くなるよというヒントであって処理が継続できないわけではありません。</p>
<div id="crayon-5ab1b61385df4169719561" class="crayon-syntax crayon-theme-ado crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 10px; margin-bottom: 10px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
WARN: increase temp memory to avoid cudaMalloc, or decrease query/add size (alloc 268435456 B, highwater 268435456 B)</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5ab1b61385df4169719561-1">1</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5ab1b61385df4169719561-1"><span class="crayon-v">WARN</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-e">increase </span><span class="crayon-e">temp </span><span class="crayon-e">memory </span><span class="crayon-st">to</span><span class="crayon-h"> </span><span class="crayon-e">avoid </span><span class="crayon-v">cudaMalloc</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-st">or</span><span class="crayon-h"> </span><span class="crayon-e">decrease </span><span class="crayon-v">query</span><span class="crayon-o">/</span><span class="crayon-e">add </span><span class="crayon-e">size</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-i">alloc</span><span class="crayon-h"> </span><span class="crayon-cn">268435456</span><span class="crayon-h"> </span><span class="crayon-v">B</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">highwater</span><span class="crayon-h"> </span><span class="crayon-cn">268435456</span><span class="crayon-h"> </span><span class="crayon-v">B</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>

<p>PQ(Product Quantization)のために内部ルックアップテーブルを準備する際にはそこそこ十分な容量を確保しておいた方が良いかと思います。</p>
<h4 class="term">kおよびnprobe値の上限</h5>
<p>kとnprobe値は1024が上限となっていますが、1024もあれば実用上は十分かなと思います。</p>
<div id="crayon-5ab1b61385df7971847551" class="crayon-syntax crayon-theme-ado crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 10px; margin-bottom: 10px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
# 1024以上を指定すると以下のようなエラーが発生する
Faiss assertion k &lt;= 1024 failed in void faiss::gpu::IVFPQ::query(faiss::gpu::Tensor&lt;float, 2, true&gt;&amp;, int, int, faiss::gpu::Tensor&lt;float, 2, true&gt;&amp;, faiss::gpu::Tensor&lt;long int, 2, true&gt;&amp;) ~ ... 省略</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5ab1b61385df7971847551-1">1</div><div class="crayon-num" data-line="crayon-5ab1b61385df7971847551-2">2</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5ab1b61385df7971847551-1"><span class="crayon-p"># 1024以上を指定すると以下のようなエラーが発生する</span></div><div class="crayon-line" id="crayon-5ab1b61385df7971847551-2"><span class="crayon-e">Faiss </span><span class="crayon-i">assertion</span><span class="crayon-h"> </span><span class="crayon-v">k</span><span class="crayon-h"> </span><span class="crayon-o">&lt;=</span><span class="crayon-h"> </span><span class="crayon-cn">1024</span><span class="crayon-h"> </span><span class="crayon-e">failed </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-t">void</span><span class="crayon-h"> </span><span class="crayon-v">faiss</span><span class="crayon-o">::</span><span class="crayon-v">gpu</span><span class="crayon-o">::</span><span class="crayon-v">IVFPQ</span><span class="crayon-o">::</span><span class="crayon-e">query</span><span class="crayon-sy">(</span><span class="crayon-v">faiss</span><span class="crayon-o">::</span><span class="crayon-v">gpu</span><span class="crayon-o">::</span><span class="crayon-v">Tensor</span><span class="crayon-o">&lt;</span><span class="crayon-t">float</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">true</span><span class="crayon-o">&gt;</span><span class="crayon-o">&amp;</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">int</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">int</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">faiss</span><span class="crayon-o">::</span><span class="crayon-v">gpu</span><span class="crayon-o">::</span><span class="crayon-v">Tensor</span><span class="crayon-o">&lt;</span><span class="crayon-t">float</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">true</span><span class="crayon-o">&gt;</span><span class="crayon-o">&amp;</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">faiss</span><span class="crayon-o">::</span><span class="crayon-v">gpu</span><span class="crayon-o">::</span><span class="crayon-v">Tensor</span><span class="crayon-o">&lt;</span><span class="crayon-t">long</span><span class="crayon-h"> </span><span class="crayon-t">int</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">true</span><span class="crayon-o">&gt;</span><span class="crayon-o">&amp;</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">~</span><span class="crayon-h"> </span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-h"> </span>省略</div></div></td>
</tr>
</table>
</div>
</div>

<p></p>
<h4 class="term">Product Quantizationのパラメータ</h5>
<p>PQの実装上、量子化ビット数(サブベクトル当たりのデータサイズ)は8ビット以下、データの次元数をサブベクトル数で割った余りが0になるように調整する必要があります。今回紹介したベンチマークプログラムではデータは128次元、サブベクトル数は8、量子化ビット数は8で設定しています。</p>
<div id="crayon-5ab1b61385dfc982119817" class="crayon-syntax crayon-theme-ado crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 10px; margin-bottom: 10px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
Faiss assertion bitsPerCode_ &lt;= 8 failed in void faiss::gpu::GpuIndexIVFPQ::assertSettings_() const at GpuIndexIVFPQ.cu:436
Faiss assertion this-&gt;d % subQuantizers_ == 0 failed in void faiss::gpu::GpuIndexIVFPQ::assertSettings_() const at GpuIndexIVFPQ.cu:439</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5ab1b61385dfc982119817-1">1</div><div class="crayon-num" data-line="crayon-5ab1b61385dfc982119817-2">2</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5ab1b61385dfc982119817-1"><span class="crayon-e">Faiss </span><span class="crayon-e">assertion </span><span class="crayon-v">bitsPerCode_</span><span class="crayon-h"> </span><span class="crayon-o">&lt;=</span><span class="crayon-h"> </span><span class="crayon-cn">8</span><span class="crayon-h"> </span><span class="crayon-e">failed </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-t">void</span><span class="crayon-h"> </span><span class="crayon-v">faiss</span><span class="crayon-o">::</span><span class="crayon-v">gpu</span><span class="crayon-o">::</span><span class="crayon-v">GpuIndexIVFPQ</span><span class="crayon-o">::</span><span class="crayon-e">assertSettings_</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-m">const</span><span class="crayon-h"> </span><span class="crayon-e">at </span><span class="crayon-v">GpuIndexIVFPQ</span><span class="crayon-sy">.</span><span class="crayon-v">cu</span><span class="crayon-o">:</span><span class="crayon-cn">436</span></div><div class="crayon-line" id="crayon-5ab1b61385dfc982119817-2"><span class="crayon-e">Faiss </span><span class="crayon-e">assertion </span><span class="crayon-r">this</span><span class="crayon-o">-&gt;</span><span class="crayon-v">d</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-v">subQuantizers_</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-h"> </span><span class="crayon-e">failed </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-t">void</span><span class="crayon-h"> </span><span class="crayon-v">faiss</span><span class="crayon-o">::</span><span class="crayon-v">gpu</span><span class="crayon-o">::</span><span class="crayon-v">GpuIndexIVFPQ</span><span class="crayon-o">::</span><span class="crayon-e">assertSettings_</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-m">const</span><span class="crayon-h"> </span><span class="crayon-e">at </span><span class="crayon-v">GpuIndexIVFPQ</span><span class="crayon-sy">.</span><span class="crayon-v">cu</span><span class="crayon-o">:</span><span class="crayon-cn">439</span></div></div></td>
</tr>
</table>
</div>
</div>

<p></p>
<h3 class="term">おわりに</h3>
<p>今回はFaiss GPU版のインタフェースを紹介しました。CPU版から移行修正しやすいように工夫されているので特に難しいところはなかったかなと思います。GPU版の実装は論文と併せて読み進めていますが、k-selection(選択アルゴリズム)のGPU実装の仕組みが難しくて難航しています。。理論面を調べつつ、そろそろPythonインタフェースを用いたアプリケーション寄りの開発もやってみたいと思っています。</p>
<div class="clearer">&nbsp;</div>
<p>Tags: <a href="http://rest-term.com/archives/tag/algorithm/" rel="tag">algorithm</a>, <a href="http://rest-term.com/archives/tag/cc/" rel="tag">c/c++</a>, <a href="http://rest-term.com/archives/tag/hardware/" rel="tag">hardware</a></p> </div>
</div>
<div class="content-separator"></div>
<div class="post" id="post-3414">
<div class="post-title">
<h2 class="label label-blue"><a href="http://rest-term.com/archives/3414/" rel="bookmark" title="Permanent Link to GPU対応の類似検索(最近傍探索)ライブラリ Faissの紹介 part1 導入/チュートリアル">
GPU対応の類似検索(最近傍探索)ライブラリ Faissの紹介 part1 導入/チュートリアル </a></h2>
</div>
<div class="post-date">
<div class="left">
5月 15th, 2017 in
<a href="http://rest-term.com/archives/category/tech/" rel="category tag">tech/study</a> &nbsp;tags: <a href="http://rest-term.com/archives/tag/algorithm/" rel="tag">algorithm</a>, <a href="http://rest-term.com/archives/tag/cc/" rel="tag">c/c++</a>, <a href="http://rest-term.com/archives/tag/hardware/" rel="tag">hardware</a>&nbsp; </div>
<div class="right">
<a href="http://rest-term.com/archives/3414/#respond" class="icon icon-comment">Comments &rarr;</a> </div>
<div class="clearer">&nbsp;</div>
</div>
<div class="post-body">
<p><a onclick="javascript:pageTracker._trackPageview('/outgoing/research.fb.com/category/facebook-ai-research-fair/');" href="https://research.fb.com/category/facebook-ai-research-fair/">Facebook AI Research (FAIR)</a>が開発したGPU対応の類似検索ライブラリ <a onclick="javascript:pageTracker._trackPageview('/outgoing/github.com/facebookresearch/faiss');" href="https://github.com/facebookresearch/faiss"><strong>Faiss</strong></a> を紹介します。</p>
<p>[<strong>06/25追記</strong>]<br />
Faiss GPU版の検索についてエントリーを書きました。</p>
<ul>
<li><a href="http://rest-term.com/archives/3418/">GPU対応の類似検索(最近傍探索)ライブラリ Faissの紹介 part2 GPUを利用した検索</a></li>
</ul>
<p><img src="http://rest-term.com/wp-content/plugins/lazy-load/images/1x1.trans.gif?x45852" data-lazy-src="http://rest-term.com/wp-content/uploads/2017/05/faiss_logo.png?x45852" alt width="500" height="313" class="alignnone size-full wp-image-3416"><noscript><img src="http://rest-term.com/wp-content/uploads/2017/05/faiss_logo.png?x45852" alt="" width="500" height="313" class="alignnone size-full wp-image-3416" /></noscript></p>
<p>論文は以下で公開されています。</p>
<ul>
<li><a onclick="javascript:pageTracker._trackPageview('/outgoing/arxiv.org/abs/1702.08734');" href="https://arxiv.org/abs/1702.08734">[1702.08734] Billion-scale similarity search with GPUs</a></li>
</ul>
<p>論文タイトルの通り、10億スケールの大規模データに対してGPUを駆使した効率的な最近傍探索アルゴリズムの研究事例となっています。分量が多くなりそうなので複数の記事に分けて紹介しようと思います。</p>
<h4 class="term">環境</h4>
<table>
<tr>
<td>Amazon Linux AMI release 2017.03<br />
Intel Xeon CPU E5-2686 v4 @ 2.30GHz<br />
NVIDIA GK210GL [Tesla K80]
</td>
<td>Ubuntu 16.04 LTS (x86_64)<br />
Intel Core i5-2500K CPU @ 3.30GHz<br />
NVIDIA GM204 [GeForce GTX 970]
</td>
</tr>
<tr>
<td>
CUDA Toolkit 8.0<br />
GCC 4.8.3 / 5.4.0<br />
Python 3.5.2<br />
NumPy 1.12
</td>
</tr>
</table>
<p>最初はTesla系GPUを使いたかったのでEC2のp2.xlargeインスタンス上で動作確認をしてましたけど、やっぱりオレゴンは遠くてターミナルがもっさりするので途中から自宅サーバに切り替えて作業しました。快適です。ちょっと前にGTX 1070を買いましたので、お下がりのGTX 970をLinuxサーバに挿しています。GTX 760は使い途がないのでメルカリかヤフオク行きですかね。</p>
<h3 class="term">導入</h3>
<p>※ GPU環境がある場合はNVIDIA DriverとCUDA Toolkit 8.0以降の事前導入が必要です</p>
<p>ここでは通常のC++ライブラリ(GPU非対応)、GPU対応のC++ライブラリ、Python用のライブラリをそれぞれソースコードからコンパイル/インストールします。プラットフォーム毎にMakefileから読み込む設定(makefile.inc.xx)が用意されているのでコピー・編集して使います。2017/05現在、CMake対応も進められているようですけれどまだ作りかけなので普通にmakeでコンパイルした方がいいかと思います。</p>
<div id="crayon-5ab1b6138661d107898581" class="crayon-syntax crayon-theme-ado crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 10px; margin-bottom: 10px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
## ソースコードのダウンロード
$ git clone https://github.com/facebookresearch/faiss.git
$ cd faiss
## Linuxの場合は makefile.inc.Linux を利用
$ cp example_makefiles/makefile.inc.Linux ./makefile.inc</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5ab1b6138661d107898581-1">1</div><div class="crayon-num" data-line="crayon-5ab1b6138661d107898581-2">2</div><div class="crayon-num" data-line="crayon-5ab1b6138661d107898581-3">3</div><div class="crayon-num" data-line="crayon-5ab1b6138661d107898581-4">4</div><div class="crayon-num" data-line="crayon-5ab1b6138661d107898581-5">5</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5ab1b6138661d107898581-1"><span class="crayon-p">## ソースコードのダウンロード</span></div><div class="crayon-line" id="crayon-5ab1b6138661d107898581-2"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">git </span><span class="crayon-r">clone</span><span class="crayon-h"> </span><span class="crayon-v">https</span><span class="crayon-o">:</span><span class="crayon-c">//github.com/facebookresearch/faiss.git</span></div><div class="crayon-line" id="crayon-5ab1b6138661d107898581-3"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">cd </span><span class="crayon-v">faiss</span></div><div class="crayon-line" id="crayon-5ab1b6138661d107898581-4"><span class="crayon-p">## Linuxの場合は makefile.inc.Linux を利用</span></div><div class="crayon-line" id="crayon-5ab1b6138661d107898581-5"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">cp </span><span class="crayon-v">example_makefiles</span><span class="crayon-o">/</span><span class="crayon-v">makefile</span><span class="crayon-sy">.</span><span class="crayon-v">inc</span><span class="crayon-sy">.</span><span class="crayon-i">Linux</span><span class="crayon-h"> </span><span class="crayon-sy">.</span><span class="crayon-o">/</span><span class="crayon-v">makefile</span><span class="crayon-sy">.</span><span class="crayon-v">inc</span></div></div></td>
</tr>
</table>
</div>
</div>

<p>CPU版C++/Pythonライブラリはビルド時にBLASライブラリをリンクしますが、ここではBLAS実装として<a onclick="javascript:pageTracker._trackPageview('/outgoing/www.openblas.net/');" href="http://www.openblas.net/">OpenBLAS</a>を利用しました。Intel MKLやAtlasでもOK、macOSならAccelerateフレームワークにBLAS実装が含まれているのでそれも利用できます。対応ライブラリの中ではIntel MKLが最速ですので、もしプロダクション環境等で可能な限り高速化したい場合はMKLをリンクさせましょう。GPU版は<a onclick="javascript:pageTracker._trackPageview('/outgoing/developer.nvidia.com/cublas');" href="https://developer.nvidia.com/cublas">cuBLAS</a>が利用されます。こちらはCUDA Toolkitに含まれているので別途インストールする必要はありません。最近のCUDAだとBLAS drop-inライブラリとして<a onclick="javascript:pageTracker._trackPageview('/outgoing/docs.nvidia.com/cuda/nvblas/#axzz4g7lIHgtO');" href="http://docs.nvidia.com/cuda/nvblas/#axzz4g7lIHgtO">NVBLAS</a>が付属しているのでそちらをリンクするプロダクトも増えてきたように思いますが、FaissではcuBLASでこつこつと実装されているようです。</p>
<div id="crayon-5ab1b6138662b078743947" class="crayon-syntax crayon-theme-ado crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 10px; margin-bottom: 10px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
## Ubuntuの場合
$ sudo apt-get install libopenblas-dev
## CentOS or Amazon Linuxの場合
$ sudo yum install openblas-devel</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5ab1b6138662b078743947-1">1</div><div class="crayon-num" data-line="crayon-5ab1b6138662b078743947-2">2</div><div class="crayon-num" data-line="crayon-5ab1b6138662b078743947-3">3</div><div class="crayon-num" data-line="crayon-5ab1b6138662b078743947-4">4</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5ab1b6138662b078743947-1"><span class="crayon-p">## Ubuntuの場合</span></div><div class="crayon-line" id="crayon-5ab1b6138662b078743947-2"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">sudo </span><span class="crayon-v">apt</span><span class="crayon-o">-</span><span class="crayon-e">get </span><span class="crayon-e">install </span><span class="crayon-v">libopenblas</span><span class="crayon-o">-</span><span class="crayon-v">dev</span></div><div class="crayon-line" id="crayon-5ab1b6138662b078743947-3"><span class="crayon-p">## CentOS or Amazon Linuxの場合</span></div><div class="crayon-line" id="crayon-5ab1b6138662b078743947-4"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">sudo </span><span class="crayon-e">yum </span><span class="crayon-e">install </span><span class="crayon-v">openblas</span><span class="crayon-o">-</span><span class="crayon-v">devel</span></div></div></td>
</tr>
</table>
</div>
</div>

<p></p>
<div id="crayon-5ab1b61386634763205884" class="crayon-syntax crayon-theme-ado crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 10px; margin-bottom: 10px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
$ diff makefile.inc example_makefiles/makefile.inc.Linux
63c63
&lt; #BLASLDFLAGS?=/usr/lib64/libopenblas.so.0
---
&gt; BLASLDFLAGS?=/usr/lib64/libopenblas.so.0
67c67
&lt; BLASLDFLAGS?=/usr/lib/libopenblas.so.0
---
&gt; # BLASLDFLAGS?=/usr/lib/libopenblas.so.0
112,113c112
&lt; #PYTHONCFLAGS=-I/usr/include/python2.7/ -I/usr/lib64/python2.7/site-packages/numpy/core/include/
&lt; PYTHONCFLAGS=-I/usr/include/python3.5m -I/usr/local/lib/python3.5/dist-packages/numpy/core/include
---
&gt; PYTHONCFLAGS=-I/usr/include/python2.7/ -I/usr/lib64/python2.7/site-packages/numpy/core/include/
134a134
&gt;    -gencode arch=compute_35,code="compute_35" \
135a136
&gt;    -gencode arch=compute_60,code="compute_60" \</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5ab1b61386634763205884-1">1</div><div class="crayon-num" data-line="crayon-5ab1b61386634763205884-2">2</div><div class="crayon-num" data-line="crayon-5ab1b61386634763205884-3">3</div><div class="crayon-num" data-line="crayon-5ab1b61386634763205884-4">4</div><div class="crayon-num" data-line="crayon-5ab1b61386634763205884-5">5</div><div class="crayon-num" data-line="crayon-5ab1b61386634763205884-6">6</div><div class="crayon-num" data-line="crayon-5ab1b61386634763205884-7">7</div><div class="crayon-num" data-line="crayon-5ab1b61386634763205884-8">8</div><div class="crayon-num" data-line="crayon-5ab1b61386634763205884-9">9</div><div class="crayon-num" data-line="crayon-5ab1b61386634763205884-10">10</div><div class="crayon-num" data-line="crayon-5ab1b61386634763205884-11">11</div><div class="crayon-num" data-line="crayon-5ab1b61386634763205884-12">12</div><div class="crayon-num" data-line="crayon-5ab1b61386634763205884-13">13</div><div class="crayon-num" data-line="crayon-5ab1b61386634763205884-14">14</div><div class="crayon-num" data-line="crayon-5ab1b61386634763205884-15">15</div><div class="crayon-num" data-line="crayon-5ab1b61386634763205884-16">16</div><div class="crayon-num" data-line="crayon-5ab1b61386634763205884-17">17</div><div class="crayon-num" data-line="crayon-5ab1b61386634763205884-18">18</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5ab1b61386634763205884-1"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">diff </span><span class="crayon-v">makefile</span><span class="crayon-sy">.</span><span class="crayon-e">inc </span><span class="crayon-v">example_makefiles</span><span class="crayon-o">/</span><span class="crayon-v">makefile</span><span class="crayon-sy">.</span><span class="crayon-v">inc</span><span class="crayon-sy">.</span><span class="crayon-i">Linux</span></div><div class="crayon-line" id="crayon-5ab1b61386634763205884-2"><span class="crayon-cn">63c63</span></div><div class="crayon-line" id="crayon-5ab1b61386634763205884-3"><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-p">#BLASLDFLAGS?=/usr/lib64/libopenblas.so.0</span></div><div class="crayon-line" id="crayon-5ab1b61386634763205884-4"><span class="crayon-o">--</span><span class="crayon-o">-</span></div><div class="crayon-line" id="crayon-5ab1b61386634763205884-5"><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-v">BLASLDFLAGS</span><span class="crayon-sy">?</span><span class="crayon-o">=</span><span class="crayon-o">/</span><span class="crayon-v">usr</span><span class="crayon-o">/</span><span class="crayon-v">lib64</span><span class="crayon-o">/</span><span class="crayon-v">libopenblas</span><span class="crayon-sy">.</span><span class="crayon-v">so</span><span class="crayon-sy">.</span><span class="crayon-cn">0</span></div><div class="crayon-line" id="crayon-5ab1b61386634763205884-6"><span class="crayon-cn">67c67</span></div><div class="crayon-line" id="crayon-5ab1b61386634763205884-7"><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-v">BLASLDFLAGS</span><span class="crayon-sy">?</span><span class="crayon-o">=</span><span class="crayon-o">/</span><span class="crayon-v">usr</span><span class="crayon-o">/</span><span class="crayon-v">lib</span><span class="crayon-o">/</span><span class="crayon-v">libopenblas</span><span class="crayon-sy">.</span><span class="crayon-v">so</span><span class="crayon-sy">.</span><span class="crayon-cn">0</span></div><div class="crayon-line" id="crayon-5ab1b61386634763205884-8"><span class="crayon-o">--</span><span class="crayon-o">-</span></div><div class="crayon-line" id="crayon-5ab1b61386634763205884-9"><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-p"># BLASLDFLAGS?=/usr/lib/libopenblas.so.0</span></div><div class="crayon-line" id="crayon-5ab1b61386634763205884-10"><span class="crayon-cn">112</span><span class="crayon-sy">,</span><span class="crayon-cn">113c112</span></div><div class="crayon-line" id="crayon-5ab1b61386634763205884-11"><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-p">#PYTHONCFLAGS=-I/usr/include/python2.7/ -I/usr/lib64/python2.7/site-packages/numpy/core/include/</span></div><div class="crayon-line" id="crayon-5ab1b61386634763205884-12"><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-v">PYTHONCFLAGS</span><span class="crayon-o">=</span><span class="crayon-o">-</span><span class="crayon-v">I</span><span class="crayon-o">/</span><span class="crayon-v">usr</span><span class="crayon-o">/</span><span class="crayon-v">include</span><span class="crayon-o">/</span><span class="crayon-v">python3</span><span class="crayon-sy">.</span><span class="crayon-cn">5m</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">I</span><span class="crayon-o">/</span><span class="crayon-v">usr</span><span class="crayon-o">/</span><span class="crayon-v">local</span><span class="crayon-o">/</span><span class="crayon-v">lib</span><span class="crayon-o">/</span><span class="crayon-v">python3</span><span class="crayon-sy">.</span><span class="crayon-cn">5</span><span class="crayon-o">/</span><span class="crayon-v">dist</span><span class="crayon-o">-</span><span class="crayon-v">packages</span><span class="crayon-o">/</span><span class="crayon-v">numpy</span><span class="crayon-o">/</span><span class="crayon-v">core</span><span class="crayon-o">/</span><span class="crayon-v">include</span></div><div class="crayon-line" id="crayon-5ab1b61386634763205884-13"><span class="crayon-o">--</span><span class="crayon-o">-</span></div><div class="crayon-line" id="crayon-5ab1b61386634763205884-14"><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-v">PYTHONCFLAGS</span><span class="crayon-o">=</span><span class="crayon-o">-</span><span class="crayon-v">I</span><span class="crayon-o">/</span><span class="crayon-v">usr</span><span class="crayon-o">/</span><span class="crayon-v">include</span><span class="crayon-o">/</span><span class="crayon-v">python2</span><span class="crayon-sy">.</span><span class="crayon-cn">7</span><span class="crayon-o">/</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">I</span><span class="crayon-o">/</span><span class="crayon-v">usr</span><span class="crayon-o">/</span><span class="crayon-v">lib64</span><span class="crayon-o">/</span><span class="crayon-v">python2</span><span class="crayon-sy">.</span><span class="crayon-cn">7</span><span class="crayon-o">/</span><span class="crayon-v">site</span><span class="crayon-o">-</span><span class="crayon-v">packages</span><span class="crayon-o">/</span><span class="crayon-v">numpy</span><span class="crayon-o">/</span><span class="crayon-v">core</span><span class="crayon-o">/</span><span class="crayon-v">include</span><span class="crayon-o">/</span></div><div class="crayon-line" id="crayon-5ab1b61386634763205884-15"><span class="crayon-cn">134a134</span></div><div class="crayon-line" id="crayon-5ab1b61386634763205884-16"><span class="crayon-o">&gt;</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-o">-</span><span class="crayon-e">gencode </span><span class="crayon-v">arch</span><span class="crayon-o">=</span><span class="crayon-v">compute_35</span><span class="crayon-sy">,</span><span class="crayon-v">code</span><span class="crayon-o">=</span><span class="crayon-s">"compute_35"</span><span class="crayon-h"> </span><span class="crayon-sy">\</span></div><div class="crayon-line" id="crayon-5ab1b61386634763205884-17"><span class="crayon-cn">135a136</span></div><div class="crayon-line" id="crayon-5ab1b61386634763205884-18"><span class="crayon-o">&gt;</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-o">-</span><span class="crayon-e">gencode </span><span class="crayon-v">arch</span><span class="crayon-o">=</span><span class="crayon-v">compute_60</span><span class="crayon-sy">,</span><span class="crayon-v">code</span><span class="crayon-o">=</span><span class="crayon-s">"compute_60"</span><span class="crayon-h"> </span><span class="crayon-sy">\</span></div></div></td>
</tr>
</table>
</div>
</div>

<p>GTX 970のCompute Capability(CC)は5.2なのでそれ以外のコード生成オプションは削っておきます。デフォルトのままでも問題ないですけど、無駄を省いてコンパイル時間を短くしたいならハードウェア環境に合わせて設定すると良いです。</p>
<p>PythonインタフェースはSWIG(3.x以上)でビルドされます。依存ライブラリとしてNumPyも必要なので事前にインストールしておきます。</p>
<div id="crayon-5ab1b6138663d154702972" class="crayon-syntax crayon-theme-ado crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 10px; margin-bottom: 10px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
## SWIGのインストール
$ sudo apt-get install swig
## NumPyのインストール
$ sudo pip install numpy</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5ab1b6138663d154702972-1">1</div><div class="crayon-num" data-line="crayon-5ab1b6138663d154702972-2">2</div><div class="crayon-num" data-line="crayon-5ab1b6138663d154702972-3">3</div><div class="crayon-num" data-line="crayon-5ab1b6138663d154702972-4">4</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5ab1b6138663d154702972-1"><span class="crayon-p">## SWIGのインストール</span></div><div class="crayon-line" id="crayon-5ab1b6138663d154702972-2"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">sudo </span><span class="crayon-v">apt</span><span class="crayon-o">-</span><span class="crayon-e">get </span><span class="crayon-e">install </span><span class="crayon-v">swig</span></div><div class="crayon-line" id="crayon-5ab1b6138663d154702972-3"><span class="crayon-p">## NumPyのインストール</span></div><div class="crayon-line" id="crayon-5ab1b6138663d154702972-4"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">sudo </span><span class="crayon-e">pip </span><span class="crayon-e">install </span><span class="crayon-v">numpy</span></div></div></td>
</tr>
</table>
</div>
</div>

<p>Makefileの準備と依存ライブラリの導入が終わったら後はコンパイルするだけですが、最低限 SSE4.2/POPCOUNT/OpenMP に対応しているCPU/C++コンパイラが必要となっています。AVXは使ってないようなのでSandy Bridge以前のかなり古いモデルでも大丈夫なはずです。</p>
<div id="crayon-5ab1b61386645153383489" class="crayon-syntax crayon-theme-ado crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 10px; margin-bottom: 10px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
## CPU版 C++ライブラリ
## jオプションはCPUコア数に合わせる
$ make -j4

## デフォルトではstatic libraryが生成される、もしshared libraryが欲しいなら
$ make libfaiss.so

## CPU版 Pythonライブラリ
$ make py

## GPU版 C++ライブラリ
$ cd gpu
$ make -j4

## GPU版 Pythonライブラリ
$ make py</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5ab1b61386645153383489-1">1</div><div class="crayon-num" data-line="crayon-5ab1b61386645153383489-2">2</div><div class="crayon-num" data-line="crayon-5ab1b61386645153383489-3">3</div><div class="crayon-num" data-line="crayon-5ab1b61386645153383489-4">4</div><div class="crayon-num" data-line="crayon-5ab1b61386645153383489-5">5</div><div class="crayon-num" data-line="crayon-5ab1b61386645153383489-6">6</div><div class="crayon-num" data-line="crayon-5ab1b61386645153383489-7">7</div><div class="crayon-num" data-line="crayon-5ab1b61386645153383489-8">8</div><div class="crayon-num" data-line="crayon-5ab1b61386645153383489-9">9</div><div class="crayon-num" data-line="crayon-5ab1b61386645153383489-10">10</div><div class="crayon-num" data-line="crayon-5ab1b61386645153383489-11">11</div><div class="crayon-num" data-line="crayon-5ab1b61386645153383489-12">12</div><div class="crayon-num" data-line="crayon-5ab1b61386645153383489-13">13</div><div class="crayon-num" data-line="crayon-5ab1b61386645153383489-14">14</div><div class="crayon-num" data-line="crayon-5ab1b61386645153383489-15">15</div><div class="crayon-num" data-line="crayon-5ab1b61386645153383489-16">16</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5ab1b61386645153383489-1"><span class="crayon-p">## CPU版 C++ライブラリ</span></div><div class="crayon-line" id="crayon-5ab1b61386645153383489-2"><span class="crayon-p">## jオプションはCPUコア数に合わせる</span></div><div class="crayon-line" id="crayon-5ab1b61386645153383489-3"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-v">make</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">j4</span></div><div class="crayon-line" id="crayon-5ab1b61386645153383489-4">&nbsp;</div><div class="crayon-line" id="crayon-5ab1b61386645153383489-5"><span class="crayon-p">## デフォルトではstatic libraryが生成される、もしshared libraryが欲しいなら</span></div><div class="crayon-line" id="crayon-5ab1b61386645153383489-6"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">make </span><span class="crayon-v">libfaiss</span><span class="crayon-sy">.</span><span class="crayon-v">so</span></div><div class="crayon-line" id="crayon-5ab1b61386645153383489-7">&nbsp;</div><div class="crayon-line" id="crayon-5ab1b61386645153383489-8"><span class="crayon-p">## CPU版 Pythonライブラリ</span></div><div class="crayon-line" id="crayon-5ab1b61386645153383489-9"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">make </span><span class="crayon-v">py</span></div><div class="crayon-line" id="crayon-5ab1b61386645153383489-10">&nbsp;</div><div class="crayon-line" id="crayon-5ab1b61386645153383489-11"><span class="crayon-p">## GPU版 C++ライブラリ</span></div><div class="crayon-line" id="crayon-5ab1b61386645153383489-12"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">cd </span><span class="crayon-i">gpu</span></div><div class="crayon-line" id="crayon-5ab1b61386645153383489-13"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-v">make</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">j4</span></div><div class="crayon-line" id="crayon-5ab1b61386645153383489-14">&nbsp;</div><div class="crayon-line" id="crayon-5ab1b61386645153383489-15"><span class="crayon-p">## GPU版 Pythonライブラリ</span></div><div class="crayon-line" id="crayon-5ab1b61386645153383489-16"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-e">make </span><span class="crayon-v">py</span></div></div></td>
</tr>
</table>
</div>
</div>

<p>GPU版 C++ライブラリはコンパイルにかなり時間がかかると思います。最近だとこういう手順でプロダクトをインストールするのは逆に新鮮に感じます。リリース初期の頃のCaffeみたいだ。</p>
<p>ちなみに<span style="text-decoration:underline;">付属のMakefileはinstallターゲットがないので、手動でライブラリとヘッダファイル群を任意の場所に配置します。</span>ここでは既にパスの通ったディレクトリに置きました。</p>
<div id="crayon-5ab1b6138664d053149145" class="crayon-syntax crayon-theme-ado crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 10px; margin-bottom: 10px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
$ ldconfig -p | grep faiss
    libfaiss.so (libc6,x86-64) =&gt; /usr/local/lib/libfaiss.so
$ ls /usr/local/include/faiss
AutoTune.h            DeviceUtils.h  GpuIndexFlat.h     GpuIndicesOptions.h  IndexFlat.h   IndexPQ.h           MetaIndexes.h         StackDeviceMemory.h     Timer.h            hamming.h
AuxIndexStructures.h  FaissAssert.h  GpuIndexIVF.h      GpuResources.h       IndexIVF.h    IndexProxy.h        PolysemousTraining.h  StandardGpuResources.h  VectorTransform.h  index_io.h
Clustering.h          GpuAutoTune.h  GpuIndexIVFFlat.h  Heap.h               IndexIVFPQ.h  IndexWrapper-inl.h  ProductQuantizer.h    StaticUtils.h           WorkerThread.h     utils.h
DeviceMemory.h        GpuIndex.h     GpuIndexIVFPQ.h    Index.h              IndexLSH.h    IndexWrapper.h      RemapIndices.h        TestUtils.h             faiss.h</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5ab1b6138664d053149145-1">1</div><div class="crayon-num" data-line="crayon-5ab1b6138664d053149145-2">2</div><div class="crayon-num" data-line="crayon-5ab1b6138664d053149145-3">3</div><div class="crayon-num" data-line="crayon-5ab1b6138664d053149145-4">4</div><div class="crayon-num" data-line="crayon-5ab1b6138664d053149145-5">5</div><div class="crayon-num" data-line="crayon-5ab1b6138664d053149145-6">6</div><div class="crayon-num" data-line="crayon-5ab1b6138664d053149145-7">7</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5ab1b6138664d053149145-1"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-v">ldconfig</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">p</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-e">grep </span><span class="crayon-e">faiss</span></div><div class="crayon-line" id="crayon-5ab1b6138664d053149145-2"><span class="crayon-e">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">libfaiss</span><span class="crayon-sy">.</span><span class="crayon-e">so</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">libc6</span><span class="crayon-sy">,</span><span class="crayon-v">x86</span><span class="crayon-o">-</span><span class="crayon-cn">64</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-v">usr</span><span class="crayon-o">/</span><span class="crayon-v">local</span><span class="crayon-o">/</span><span class="crayon-v">lib</span><span class="crayon-o">/</span><span class="crayon-v">libfaiss</span><span class="crayon-sy">.</span><span class="crayon-i">so</span></div><div class="crayon-line" id="crayon-5ab1b6138664d053149145-3"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-v">ls</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-v">usr</span><span class="crayon-o">/</span><span class="crayon-v">local</span><span class="crayon-o">/</span><span class="crayon-v">include</span><span class="crayon-o">/</span><span class="crayon-e">faiss</span></div><div class="crayon-line" id="crayon-5ab1b6138664d053149145-4"><span class="crayon-v">AutoTune</span><span class="crayon-sy">.</span><span class="crayon-i">h</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">DeviceUtils</span><span class="crayon-sy">.</span><span class="crayon-i">h</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">GpuIndexFlat</span><span class="crayon-sy">.</span><span class="crayon-i">h</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">GpuIndicesOptions</span><span class="crayon-sy">.</span><span class="crayon-i">h</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">IndexFlat</span><span class="crayon-sy">.</span><span class="crayon-i">h</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-v">IndexPQ</span><span class="crayon-sy">.</span><span class="crayon-i">h</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">MetaIndexes</span><span class="crayon-sy">.</span><span class="crayon-i">h</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">StackDeviceMemory</span><span class="crayon-sy">.</span><span class="crayon-i">h</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">Timer</span><span class="crayon-sy">.</span><span class="crayon-i">h</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">hamming</span><span class="crayon-sy">.</span><span class="crayon-i">h</span></div><div class="crayon-line" id="crayon-5ab1b6138664d053149145-5"><span class="crayon-v">AuxIndexStructures</span><span class="crayon-sy">.</span><span class="crayon-i">h</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">FaissAssert</span><span class="crayon-sy">.</span><span class="crayon-i">h</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">GpuIndexIVF</span><span class="crayon-sy">.</span><span class="crayon-i">h</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">GpuResources</span><span class="crayon-sy">.</span><span class="crayon-i">h</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">IndexIVF</span><span class="crayon-sy">.</span><span class="crayon-i">h</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">IndexProxy</span><span class="crayon-sy">.</span><span class="crayon-i">h</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">PolysemousTraining</span><span class="crayon-sy">.</span><span class="crayon-i">h</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">StandardGpuResources</span><span class="crayon-sy">.</span><span class="crayon-i">h</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">VectorTransform</span><span class="crayon-sy">.</span><span class="crayon-i">h</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">index_io</span><span class="crayon-sy">.</span><span class="crayon-i">h</span></div><div class="crayon-line" id="crayon-5ab1b6138664d053149145-6"><span class="crayon-v">Clustering</span><span class="crayon-sy">.</span><span class="crayon-i">h</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">GpuAutoTune</span><span class="crayon-sy">.</span><span class="crayon-i">h</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">GpuIndexIVFFlat</span><span class="crayon-sy">.</span><span class="crayon-i">h</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">Heap</span><span class="crayon-sy">.</span><span class="crayon-i">h</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">IndexIVFPQ</span><span class="crayon-sy">.</span><span class="crayon-i">h</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">IndexWrapper</span><span class="crayon-o">-</span><span class="crayon-v">inl</span><span class="crayon-sy">.</span><span class="crayon-i">h</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">ProductQuantizer</span><span class="crayon-sy">.</span><span class="crayon-i">h</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">StaticUtils</span><span class="crayon-sy">.</span><span class="crayon-i">h</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">WorkerThread</span><span class="crayon-sy">.</span><span class="crayon-i">h</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">utils</span><span class="crayon-sy">.</span><span class="crayon-i">h</span></div><div class="crayon-line" id="crayon-5ab1b6138664d053149145-7"><span class="crayon-v">DeviceMemory</span><span class="crayon-sy">.</span><span class="crayon-i">h</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">GpuIndex</span><span class="crayon-sy">.</span><span class="crayon-i">h</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">GpuIndexIVFPQ</span><span class="crayon-sy">.</span><span class="crayon-i">h</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">Index</span><span class="crayon-sy">.</span><span class="crayon-i">h</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">IndexLSH</span><span class="crayon-sy">.</span><span class="crayon-i">h</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">IndexWrapper</span><span class="crayon-sy">.</span><span class="crayon-i">h</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">RemapIndices</span><span class="crayon-sy">.</span><span class="crayon-i">h</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">TestUtils</span><span class="crayon-sy">.</span><span class="crayon-i">h</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">faiss</span><span class="crayon-sy">.</span><span class="crayon-v">h</span></div></div></td>
</tr>
</table>
</div>
</div>

<p></p>
<h3 class="term">動作確認</h3>
<p>CPU版 C++ライブラリのビルド時にテストプログラムもコンパイルされて実行可能バイナリが生成されているのでそのまま実行できます。GPU版も用意されているのですが、これは2017/05現在、バグがあって特定のGPUだとSEGVしてしまうので完走できません。どうやらGeForce系GPU(GTX 970や1080)でのクラッシュ報告が多いようです。EC2 p2-xlargeインスタンスのTesla-K80なら大丈夫でした。</p>
<ul>
<li>参考: <a onclick="javascript:pageTracker._trackPageview('/outgoing/github.com/facebookresearch/faiss/issues/67');" href="https://github.com/facebookresearch/faiss/issues/67">running demo_ivfpq_indexing_gpu Segmentation fault</a></li>
</ul>
<p></p>
<div id="crayon-5ab1b61386653036326103" class="crayon-syntax crayon-theme-ado crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 10px; margin-bottom: 10px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
## CPU版
$ ./tests/demo_ivfpq_indexing
[0.001 s] Generating 100000 vectors in 128D for training
[0.168 s] Training the index
Training IVF quantizer on 100000 vectors in 128D
Training IVF residual
  Input training set too big (max size is 65536), sampling 65536 / 100000 vectors
computing residuals
training 4x256 product quantizer on 65536 vectors in 128D
Training PQ slice 0/4
Clustering 65536 points in 32D to 256 clusters, redo 1 times, 25 iterations
  Preprocessing in 0.00 s
  Iteration 24 (2.32 s, search 2.10 s): objective=113338 imbalance=1.004 nsplit=0       
Training PQ slice 1/4
Clustering 65536 points in 32D to 256 clusters, redo 1 times, 25 iterations
  Preprocessing in 0.00 s
  Iteration 24 (2.81 s, search 2.55 s): objective=113197 imbalance=1.004 nsplit=0       
Training PQ slice 2/4
Clustering 65536 points in 32D to 256 clusters, redo 1 times, 25 iterations
  Preprocessing in 0.00 s
  Iteration 24 (3.83 s, search 3.48 s): objective=113227 imbalance=1.009 nsplit=0       
Training PQ slice 3/4
Clustering 65536 points in 32D to 256 clusters, redo 1 times, 25 iterations
  Preprocessing in 0.01 s
  Iteration 24 (5.52 s, search 5.06 s): objective=113061 imbalance=1.004 nsplit=0       
[21.231 s] storing the pre-trained index to /tmp/index_trained.faissindex
[21.233 s] Building a dataset of 200000 vectors to index
[21.705 s] Adding the vectors to the index
 add_core times: 2477.588 806.523 13.101 
[25.002 s] imbalance factor: 1.23894
[25.002 s] Searching the 5 nearest neighbors of 9 vectors in the index
[25.006 s] Query results (vector ids, then distances):
query  0:    1234   11667  163213   83335   13439 
     dis: 7.09815 9.59665 9.70155 9.80191  9.8625 
query  1:    1235   76478   56663   28798  117320 
     dis: 7.79175 10.1169 10.4342 10.4568 10.6911 
query  2:    1236  189820   80604  185497   81842 
     dis: 7.60428 11.0645 11.1066 11.1707 11.2591 
query  3:    1237  116226   85618   36842  187787 
     dis: 8.03953 10.4461 10.6549 10.7921 10.7933 
query  4:    1238   91514   86365   52306   69284 
     dis:  7.4044 10.0915 10.1178 10.1657 10.2154 
query  5:    1239  143840   70772    2444   96181 
     dis: 7.18461 9.72012 10.2507  10.364 10.5746 
query  6:    1240   72767  170354  122756   61561 
     dis: 7.31866 9.74185 9.94351 9.97688  10.203 
query  7:    1241   30037  196333  162441  194151 
     dis: 8.19873 11.4148 11.6176 11.6699 11.6904 
query  8:    1242   66419   10135  189152   10030 
     dis:  8.2098 10.8027 11.1994 11.2308 11.2371 
note that the nearest neighbor is not at distance 0 due to quantization errors</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5ab1b61386653036326103-1">1</div><div class="crayon-num" data-line="crayon-5ab1b61386653036326103-2">2</div><div class="crayon-num" data-line="crayon-5ab1b61386653036326103-3">3</div><div class="crayon-num" data-line="crayon-5ab1b61386653036326103-4">4</div><div class="crayon-num" data-line="crayon-5ab1b61386653036326103-5">5</div><div class="crayon-num" data-line="crayon-5ab1b61386653036326103-6">6</div><div class="crayon-num" data-line="crayon-5ab1b61386653036326103-7">7</div><div class="crayon-num" data-line="crayon-5ab1b61386653036326103-8">8</div><div class="crayon-num" data-line="crayon-5ab1b61386653036326103-9">9</div><div class="crayon-num" data-line="crayon-5ab1b61386653036326103-10">10</div><div class="crayon-num" data-line="crayon-5ab1b61386653036326103-11">11</div><div class="crayon-num" data-line="crayon-5ab1b61386653036326103-12">12</div><div class="crayon-num" data-line="crayon-5ab1b61386653036326103-13">13</div><div class="crayon-num" data-line="crayon-5ab1b61386653036326103-14">14</div><div class="crayon-num" data-line="crayon-5ab1b61386653036326103-15">15</div><div class="crayon-num" data-line="crayon-5ab1b61386653036326103-16">16</div><div class="crayon-num" data-line="crayon-5ab1b61386653036326103-17">17</div><div class="crayon-num" data-line="crayon-5ab1b61386653036326103-18">18</div><div class="crayon-num" data-line="crayon-5ab1b61386653036326103-19">19</div><div class="crayon-num" data-line="crayon-5ab1b61386653036326103-20">20</div><div class="crayon-num" data-line="crayon-5ab1b61386653036326103-21">21</div><div class="crayon-num" data-line="crayon-5ab1b61386653036326103-22">22</div><div class="crayon-num" data-line="crayon-5ab1b61386653036326103-23">23</div><div class="crayon-num" data-line="crayon-5ab1b61386653036326103-24">24</div><div class="crayon-num" data-line="crayon-5ab1b61386653036326103-25">25</div><div class="crayon-num" data-line="crayon-5ab1b61386653036326103-26">26</div><div class="crayon-num" data-line="crayon-5ab1b61386653036326103-27">27</div><div class="crayon-num" data-line="crayon-5ab1b61386653036326103-28">28</div><div class="crayon-num" data-line="crayon-5ab1b61386653036326103-29">29</div><div class="crayon-num" data-line="crayon-5ab1b61386653036326103-30">30</div><div class="crayon-num" data-line="crayon-5ab1b61386653036326103-31">31</div><div class="crayon-num" data-line="crayon-5ab1b61386653036326103-32">32</div><div class="crayon-num" data-line="crayon-5ab1b61386653036326103-33">33</div><div class="crayon-num" data-line="crayon-5ab1b61386653036326103-34">34</div><div class="crayon-num" data-line="crayon-5ab1b61386653036326103-35">35</div><div class="crayon-num" data-line="crayon-5ab1b61386653036326103-36">36</div><div class="crayon-num" data-line="crayon-5ab1b61386653036326103-37">37</div><div class="crayon-num" data-line="crayon-5ab1b61386653036326103-38">38</div><div class="crayon-num" data-line="crayon-5ab1b61386653036326103-39">39</div><div class="crayon-num" data-line="crayon-5ab1b61386653036326103-40">40</div><div class="crayon-num" data-line="crayon-5ab1b61386653036326103-41">41</div><div class="crayon-num" data-line="crayon-5ab1b61386653036326103-42">42</div><div class="crayon-num" data-line="crayon-5ab1b61386653036326103-43">43</div><div class="crayon-num" data-line="crayon-5ab1b61386653036326103-44">44</div><div class="crayon-num" data-line="crayon-5ab1b61386653036326103-45">45</div><div class="crayon-num" data-line="crayon-5ab1b61386653036326103-46">46</div><div class="crayon-num" data-line="crayon-5ab1b61386653036326103-47">47</div><div class="crayon-num" data-line="crayon-5ab1b61386653036326103-48">48</div><div class="crayon-num" data-line="crayon-5ab1b61386653036326103-49">49</div><div class="crayon-num" data-line="crayon-5ab1b61386653036326103-50">50</div><div class="crayon-num" data-line="crayon-5ab1b61386653036326103-51">51</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5ab1b61386653036326103-1"><span class="crayon-p">## CPU版</span></div><div class="crayon-line" id="crayon-5ab1b61386653036326103-2"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-sy">.</span><span class="crayon-o">/</span><span class="crayon-v">tests</span><span class="crayon-o">/</span><span class="crayon-v">demo_ivfpq</span><span class="crayon-sy">_</span>indexing</div><div class="crayon-line" id="crayon-5ab1b61386653036326103-3"><span class="crayon-sy">[</span><span class="crayon-cn">0.001</span><span class="crayon-h"> </span><span class="crayon-v">s</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-i">Generating</span><span class="crayon-h"> </span><span class="crayon-cn">100000</span><span class="crayon-h"> </span><span class="crayon-e">vectors </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-cn">128D</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">training</span></div><div class="crayon-line" id="crayon-5ab1b61386653036326103-4"><span class="crayon-sy">[</span><span class="crayon-cn">0.168</span><span class="crayon-h"> </span><span class="crayon-v">s</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-e">Training </span><span class="crayon-e">the </span><span class="crayon-e">index</span></div><div class="crayon-line" id="crayon-5ab1b61386653036326103-5"><span class="crayon-e">Training </span><span class="crayon-e">IVF </span><span class="crayon-e">quantizer </span><span class="crayon-i">on</span><span class="crayon-h"> </span><span class="crayon-cn">100000</span><span class="crayon-h"> </span><span class="crayon-e">vectors </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-cn">128D</span></div><div class="crayon-line" id="crayon-5ab1b61386653036326103-6"><span class="crayon-e">Training </span><span class="crayon-e">IVF </span><span class="crayon-e">residual</span></div><div class="crayon-line" id="crayon-5ab1b61386653036326103-7"><span class="crayon-e">&nbsp;&nbsp;</span><span class="crayon-e">Input </span><span class="crayon-e">training </span><span class="crayon-e">set </span><span class="crayon-e">too </span><span class="crayon-e">big</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-e">max </span><span class="crayon-e">size </span><span class="crayon-st">is</span><span class="crayon-h"> </span><span class="crayon-cn">65536</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">sampling</span><span class="crayon-h"> </span><span class="crayon-cn">65536</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-h"> </span><span class="crayon-cn">100000</span><span class="crayon-h"> </span><span class="crayon-e">vectors</span></div><div class="crayon-line" id="crayon-5ab1b61386653036326103-8"><span class="crayon-e">computing </span><span class="crayon-e">residuals</span></div><div class="crayon-line" id="crayon-5ab1b61386653036326103-9"><span class="crayon-i">training</span><span class="crayon-h"> </span><span class="crayon-cn">4x256</span><span class="crayon-h"> </span><span class="crayon-e">product </span><span class="crayon-e">quantizer </span><span class="crayon-i">on</span><span class="crayon-h"> </span><span class="crayon-cn">65536</span><span class="crayon-h"> </span><span class="crayon-e">vectors </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-cn">128D</span></div><div class="crayon-line" id="crayon-5ab1b61386653036326103-10"><span class="crayon-e">Training </span><span class="crayon-e">PQ </span><span class="crayon-i">slice</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-o">/</span><span class="crayon-cn">4</span></div><div class="crayon-line" id="crayon-5ab1b61386653036326103-11"><span class="crayon-i">Clustering</span><span class="crayon-h"> </span><span class="crayon-cn">65536</span><span class="crayon-h"> </span><span class="crayon-e">points </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-cn">32D</span><span class="crayon-h"> </span><span class="crayon-st">to</span><span class="crayon-h"> </span><span class="crayon-cn">256</span><span class="crayon-h"> </span><span class="crayon-v">clusters</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">redo</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-h"> </span><span class="crayon-v">times</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">25</span><span class="crayon-h"> </span><span class="crayon-e">iterations</span></div><div class="crayon-line" id="crayon-5ab1b61386653036326103-12"><span class="crayon-e">&nbsp;&nbsp;</span><span class="crayon-e">Preprocessing </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-cn">0.00</span><span class="crayon-h"> </span><span class="crayon-i">s</span></div><div class="crayon-line" id="crayon-5ab1b61386653036326103-13"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-i">Iteration</span><span class="crayon-h"> </span><span class="crayon-cn">24</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-cn">2.32</span><span class="crayon-h"> </span><span class="crayon-v">s</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">search</span><span class="crayon-h"> </span><span class="crayon-cn">2.10</span><span class="crayon-h"> </span><span class="crayon-v">s</span><span class="crayon-sy">)</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">objective</span><span class="crayon-o">=</span><span class="crayon-cn">113338</span><span class="crayon-h"> </span><span class="crayon-v">imbalance</span><span class="crayon-o">=</span><span class="crayon-cn">1.004</span><span class="crayon-h"> </span><span class="crayon-v">nsplit</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></div><div class="crayon-line" id="crayon-5ab1b61386653036326103-14"><span class="crayon-e">Training </span><span class="crayon-e">PQ </span><span class="crayon-i">slice</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-o">/</span><span class="crayon-cn">4</span></div><div class="crayon-line" id="crayon-5ab1b61386653036326103-15"><span class="crayon-i">Clustering</span><span class="crayon-h"> </span><span class="crayon-cn">65536</span><span class="crayon-h"> </span><span class="crayon-e">points </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-cn">32D</span><span class="crayon-h"> </span><span class="crayon-st">to</span><span class="crayon-h"> </span><span class="crayon-cn">256</span><span class="crayon-h"> </span><span class="crayon-v">clusters</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">redo</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-h"> </span><span class="crayon-v">times</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">25</span><span class="crayon-h"> </span><span class="crayon-e">iterations</span></div><div class="crayon-line" id="crayon-5ab1b61386653036326103-16"><span class="crayon-e">&nbsp;&nbsp;</span><span class="crayon-e">Preprocessing </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-cn">0.00</span><span class="crayon-h"> </span><span class="crayon-i">s</span></div><div class="crayon-line" id="crayon-5ab1b61386653036326103-17"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-i">Iteration</span><span class="crayon-h"> </span><span class="crayon-cn">24</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-cn">2.81</span><span class="crayon-h"> </span><span class="crayon-v">s</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">search</span><span class="crayon-h"> </span><span class="crayon-cn">2.55</span><span class="crayon-h"> </span><span class="crayon-v">s</span><span class="crayon-sy">)</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">objective</span><span class="crayon-o">=</span><span class="crayon-cn">113197</span><span class="crayon-h"> </span><span class="crayon-v">imbalance</span><span class="crayon-o">=</span><span class="crayon-cn">1.004</span><span class="crayon-h"> </span><span class="crayon-v">nsplit</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></div><div class="crayon-line" id="crayon-5ab1b61386653036326103-18"><span class="crayon-e">Training </span><span class="crayon-e">PQ </span><span class="crayon-i">slice</span><span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-o">/</span><span class="crayon-cn">4</span></div><div class="crayon-line" id="crayon-5ab1b61386653036326103-19"><span class="crayon-i">Clustering</span><span class="crayon-h"> </span><span class="crayon-cn">65536</span><span class="crayon-h"> </span><span class="crayon-e">points </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-cn">32D</span><span class="crayon-h"> </span><span class="crayon-st">to</span><span class="crayon-h"> </span><span class="crayon-cn">256</span><span class="crayon-h"> </span><span class="crayon-v">clusters</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">redo</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-h"> </span><span class="crayon-v">times</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">25</span><span class="crayon-h"> </span><span class="crayon-e">iterations</span></div><div class="crayon-line" id="crayon-5ab1b61386653036326103-20"><span class="crayon-e">&nbsp;&nbsp;</span><span class="crayon-e">Preprocessing </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-cn">0.00</span><span class="crayon-h"> </span><span class="crayon-i">s</span></div><div class="crayon-line" id="crayon-5ab1b61386653036326103-21"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-i">Iteration</span><span class="crayon-h"> </span><span class="crayon-cn">24</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-cn">3.83</span><span class="crayon-h"> </span><span class="crayon-v">s</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">search</span><span class="crayon-h"> </span><span class="crayon-cn">3.48</span><span class="crayon-h"> </span><span class="crayon-v">s</span><span class="crayon-sy">)</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">objective</span><span class="crayon-o">=</span><span class="crayon-cn">113227</span><span class="crayon-h"> </span><span class="crayon-v">imbalance</span><span class="crayon-o">=</span><span class="crayon-cn">1.009</span><span class="crayon-h"> </span><span class="crayon-v">nsplit</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></div><div class="crayon-line" id="crayon-5ab1b61386653036326103-22"><span class="crayon-e">Training </span><span class="crayon-e">PQ </span><span class="crayon-i">slice</span><span class="crayon-h"> </span><span class="crayon-cn">3</span><span class="crayon-o">/</span><span class="crayon-cn">4</span></div><div class="crayon-line" id="crayon-5ab1b61386653036326103-23"><span class="crayon-i">Clustering</span><span class="crayon-h"> </span><span class="crayon-cn">65536</span><span class="crayon-h"> </span><span class="crayon-e">points </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-cn">32D</span><span class="crayon-h"> </span><span class="crayon-st">to</span><span class="crayon-h"> </span><span class="crayon-cn">256</span><span class="crayon-h"> </span><span class="crayon-v">clusters</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">redo</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-h"> </span><span class="crayon-v">times</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">25</span><span class="crayon-h"> </span><span class="crayon-e">iterations</span></div><div class="crayon-line" id="crayon-5ab1b61386653036326103-24"><span class="crayon-e">&nbsp;&nbsp;</span><span class="crayon-e">Preprocessing </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-cn">0.01</span><span class="crayon-h"> </span><span class="crayon-i">s</span></div><div class="crayon-line" id="crayon-5ab1b61386653036326103-25"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-i">Iteration</span><span class="crayon-h"> </span><span class="crayon-cn">24</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-cn">5.52</span><span class="crayon-h"> </span><span class="crayon-v">s</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">search</span><span class="crayon-h"> </span><span class="crayon-cn">5.06</span><span class="crayon-h"> </span><span class="crayon-v">s</span><span class="crayon-sy">)</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">objective</span><span class="crayon-o">=</span><span class="crayon-cn">113061</span><span class="crayon-h"> </span><span class="crayon-v">imbalance</span><span class="crayon-o">=</span><span class="crayon-cn">1.004</span><span class="crayon-h"> </span><span class="crayon-v">nsplit</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></div><div class="crayon-line" id="crayon-5ab1b61386653036326103-26"><span class="crayon-sy">[</span><span class="crayon-cn">21.231</span><span class="crayon-h"> </span><span class="crayon-v">s</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-e">storing </span><span class="crayon-e">the </span><span class="crayon-v">pre</span><span class="crayon-o">-</span><span class="crayon-e">trained </span><span class="crayon-e">index </span><span class="crayon-st">to</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-v">tmp</span><span class="crayon-o">/</span><span class="crayon-v">index_trained</span><span class="crayon-sy">.</span><span class="crayon-i">faissindex</span></div><div class="crayon-line" id="crayon-5ab1b61386653036326103-27"><span class="crayon-sy">[</span><span class="crayon-cn">21.233</span><span class="crayon-h"> </span><span class="crayon-v">s</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-i">Building</span><span class="crayon-h"> </span><span class="crayon-i">a</span><span class="crayon-h"> </span><span class="crayon-e">dataset </span><span class="crayon-i">of</span><span class="crayon-h"> </span><span class="crayon-cn">200000</span><span class="crayon-h"> </span><span class="crayon-e">vectors </span><span class="crayon-st">to</span><span class="crayon-h"> </span><span class="crayon-i">index</span></div><div class="crayon-line" id="crayon-5ab1b61386653036326103-28"><span class="crayon-sy">[</span><span class="crayon-cn">21.705</span><span class="crayon-h"> </span><span class="crayon-v">s</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-e">Adding </span><span class="crayon-e">the </span><span class="crayon-e">vectors </span><span class="crayon-st">to</span><span class="crayon-h"> </span><span class="crayon-e">the </span><span class="crayon-e">index</span></div><div class="crayon-line" id="crayon-5ab1b61386653036326103-29"><span class="crayon-e"> </span><span class="crayon-e">add_core </span><span class="crayon-v">times</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-cn">2477.588</span><span class="crayon-h"> </span><span class="crayon-cn">806.523</span><span class="crayon-h"> </span><span class="crayon-cn">13.101</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5ab1b61386653036326103-30"><span class="crayon-sy">[</span><span class="crayon-cn">25.002</span><span class="crayon-h"> </span><span class="crayon-v">s</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-e">imbalance </span><span class="crayon-v">factor</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-cn">1.23894</span></div><div class="crayon-line" id="crayon-5ab1b61386653036326103-31"><span class="crayon-sy">[</span><span class="crayon-cn">25.002</span><span class="crayon-h"> </span><span class="crayon-v">s</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-e">Searching </span><span class="crayon-i">the</span><span class="crayon-h"> </span><span class="crayon-cn">5</span><span class="crayon-h"> </span><span class="crayon-e">nearest </span><span class="crayon-e">neighbors </span><span class="crayon-i">of</span><span class="crayon-h"> </span><span class="crayon-cn">9</span><span class="crayon-h"> </span><span class="crayon-e">vectors </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">the </span><span class="crayon-i">index</span></div><div class="crayon-line" id="crayon-5ab1b61386653036326103-32"><span class="crayon-sy">[</span><span class="crayon-cn">25.006</span><span class="crayon-h"> </span><span class="crayon-v">s</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-e">Query </span><span class="crayon-e">results</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-e">vector </span><span class="crayon-v">ids</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-st">then</span><span class="crayon-h"> </span><span class="crayon-v">distances</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5ab1b61386653036326103-33"><span class="crayon-i">query</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">0</span><span class="crayon-o">:</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">1234</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">11667</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">163213</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">83335</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">13439</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5ab1b61386653036326103-34"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">dis</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-cn">7.09815</span><span class="crayon-h"> </span><span class="crayon-cn">9.59665</span><span class="crayon-h"> </span><span class="crayon-cn">9.70155</span><span class="crayon-h"> </span><span class="crayon-cn">9.80191</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">9.8625</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5ab1b61386653036326103-35"><span class="crayon-i">query</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">1</span><span class="crayon-o">:</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">1235</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">76478</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">56663</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">28798</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">117320</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5ab1b61386653036326103-36"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">dis</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-cn">7.79175</span><span class="crayon-h"> </span><span class="crayon-cn">10.1169</span><span class="crayon-h"> </span><span class="crayon-cn">10.4342</span><span class="crayon-h"> </span><span class="crayon-cn">10.4568</span><span class="crayon-h"> </span><span class="crayon-cn">10.6911</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5ab1b61386653036326103-37"><span class="crayon-i">query</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">2</span><span class="crayon-o">:</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">1236</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">189820</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">80604</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">185497</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">81842</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5ab1b61386653036326103-38"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">dis</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-cn">7.60428</span><span class="crayon-h"> </span><span class="crayon-cn">11.0645</span><span class="crayon-h"> </span><span class="crayon-cn">11.1066</span><span class="crayon-h"> </span><span class="crayon-cn">11.1707</span><span class="crayon-h"> </span><span class="crayon-cn">11.2591</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5ab1b61386653036326103-39"><span class="crayon-i">query</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">3</span><span class="crayon-o">:</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">1237</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">116226</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">85618</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">36842</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">187787</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5ab1b61386653036326103-40"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">dis</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-cn">8.03953</span><span class="crayon-h"> </span><span class="crayon-cn">10.4461</span><span class="crayon-h"> </span><span class="crayon-cn">10.6549</span><span class="crayon-h"> </span><span class="crayon-cn">10.7921</span><span class="crayon-h"> </span><span class="crayon-cn">10.7933</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5ab1b61386653036326103-41"><span class="crayon-i">query</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">4</span><span class="crayon-o">:</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">1238</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">91514</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">86365</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">52306</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">69284</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5ab1b61386653036326103-42"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">dis</span><span class="crayon-o">:</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">7.4044</span><span class="crayon-h"> </span><span class="crayon-cn">10.0915</span><span class="crayon-h"> </span><span class="crayon-cn">10.1178</span><span class="crayon-h"> </span><span class="crayon-cn">10.1657</span><span class="crayon-h"> </span><span class="crayon-cn">10.2154</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5ab1b61386653036326103-43"><span class="crayon-i">query</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">5</span><span class="crayon-o">:</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">1239</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">143840</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">70772</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">2444</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">96181</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5ab1b61386653036326103-44"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">dis</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-cn">7.18461</span><span class="crayon-h"> </span><span class="crayon-cn">9.72012</span><span class="crayon-h"> </span><span class="crayon-cn">10.2507</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">10.364</span><span class="crayon-h"> </span><span class="crayon-cn">10.5746</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5ab1b61386653036326103-45"><span class="crayon-i">query</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">6</span><span class="crayon-o">:</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">1240</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">72767</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">170354</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">122756</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">61561</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5ab1b61386653036326103-46"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">dis</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-cn">7.31866</span><span class="crayon-h"> </span><span class="crayon-cn">9.74185</span><span class="crayon-h"> </span><span class="crayon-cn">9.94351</span><span class="crayon-h"> </span><span class="crayon-cn">9.97688</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">10.203</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5ab1b61386653036326103-47"><span class="crayon-i">query</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">7</span><span class="crayon-o">:</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">1241</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">30037</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">196333</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">162441</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">194151</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5ab1b61386653036326103-48"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">dis</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-cn">8.19873</span><span class="crayon-h"> </span><span class="crayon-cn">11.4148</span><span class="crayon-h"> </span><span class="crayon-cn">11.6176</span><span class="crayon-h"> </span><span class="crayon-cn">11.6699</span><span class="crayon-h"> </span><span class="crayon-cn">11.6904</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5ab1b61386653036326103-49"><span class="crayon-i">query</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">8</span><span class="crayon-o">:</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">1242</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">66419</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">10135</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">189152</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">10030</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5ab1b61386653036326103-50"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-v">dis</span><span class="crayon-o">:</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">8.2098</span><span class="crayon-h"> </span><span class="crayon-cn">10.8027</span><span class="crayon-h"> </span><span class="crayon-cn">11.1994</span><span class="crayon-h"> </span><span class="crayon-cn">11.2308</span><span class="crayon-h"> </span><span class="crayon-cn">11.2371</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5ab1b61386653036326103-51"><span class="crayon-e">note </span><span class="crayon-e">that </span><span class="crayon-e">the </span><span class="crayon-e">nearest </span><span class="crayon-e">neighbor </span><span class="crayon-st">is</span><span class="crayon-h"> </span><span class="crayon-st">not</span><span class="crayon-h"> </span><span class="crayon-e">at </span><span class="crayon-i">distance</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-h"> </span><span class="crayon-e">due </span><span class="crayon-st">to</span><span class="crayon-h"> </span><span class="crayon-e">quantization </span><span class="crayon-v">errors</span></div></div></td>
</tr>
</table>
</div>
</div>

<p>テストプログラム内部で行われていることはチュートリアルを進めていけばわかるようになるのでここでは省略します。公式のチュートリアルよりもコードは綺麗な気がしますけど。。</p>
<h3 class="term">チュートリアル</h3>
<p>公式のチュートリアルに補足を加えながら順番に動作確認していきます。</p>
<ul>
<li><a onclick="javascript:pageTracker._trackPageview('/outgoing/github.com/facebookresearch/faiss/wiki/Getting-started-tutorial');" href="https://github.com/facebookresearch/faiss/wiki/Getting-started-tutorial">Getting started tutorial · facebookresearch/faiss Wiki</a></li>
<li><a onclick="javascript:pageTracker._trackPageview('/outgoing/github.com/facebookresearch/faiss/tree/master/docs');" href="https://github.com/facebookresearch/faiss/tree/master/docs">faiss/docs at master · facebookresearch/faiss</a> (Doxygen)</li>
</ul>
<p>Faissが提供するクラスや各機能が扱うデータの型を意識しながら学んだ方がより理解しやすいと思うので、最初はC++インタフェースで試します。Pythonインタフェースは前述の通りSWIGで生成されているため、C++インタフェースが使えるようになればPythonインタフェースを使うための学習コストは少なくなります。</p>
<p></p>
<div id="crayon-5ab1b6138665a324272608" class="crayon-syntax crayon-theme-ado crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 10px; margin-bottom: 10px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
## g++によるコンパイルオプション例(shared library利用)
$ g++ -Wall -O2 -Wl,--no-as-needed -I/usr/include -L/usr/lib -lfaiss sample.cpp -o sample</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5ab1b6138665a324272608-1">1</div><div class="crayon-num" data-line="crayon-5ab1b6138665a324272608-2">2</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5ab1b6138665a324272608-1"><span class="crayon-p">## g++によるコンパイルオプション例(shared library利用)</span></div><div class="crayon-line" id="crayon-5ab1b6138665a324272608-2"><span class="crayon-sy">$</span><span class="crayon-h"> </span><span class="crayon-v">g</span><span class="crayon-o">++</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">Wall</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">O2</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">Wl</span><span class="crayon-sy">,</span><span class="crayon-o">--</span><span class="crayon-v">no</span><span class="crayon-o">-</span><span class="crayon-st">as</span><span class="crayon-o">-</span><span class="crayon-v">needed</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">I</span><span class="crayon-o">/</span><span class="crayon-v">usr</span><span class="crayon-o">/</span><span class="crayon-v">include</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-v">L</span><span class="crayon-o">/</span><span class="crayon-v">usr</span><span class="crayon-o">/</span><span class="crayon-v">lib</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-e">lfaiss </span><span class="crayon-v">sample</span><span class="crayon-sy">.</span><span class="crayon-v">cpp</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">o</span><span class="crayon-h"> </span><span class="crayon-v">sample</span></div></div></td>
</tr>
</table>
</div>
</div>

<p></p>
<h4 class="term">データの準備</h4>
<p>Faissが扱うベクトルデータは基本的に単精度(32bits)浮動小数点値を要素とした配列を用います。C++ならfloat型配列 、Python(NumPy)だと <code>numpy.ndarray</code> オブジェクトとなり、1つのベクトルを1行としたrow-majorな行列データとして扱うことになります。</p>
<div id="crayon-5ab1b6138665e899563395" class="crayon-syntax crayon-theme-ado crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 10px; margin-bottom: 10px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">C++</span></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
int d = 64;                            // 次元数
int nb = 100000;                       // データベースのサイズ(格納データ数)
int nq = 10000;                        // 検索クエリのサイズ(クエリ数)
float *xb = new float[d * nb];  // スタックオーバーフローを防ぐためヒープ上に作成
float *xq = new float[d * nq];
for(int i = 0; i &lt; nb; i++) {
  for(int j = 0; j &lt; d; j++) xb[d * i + j] = drand48();  // drand48() [0.0, 1.0) で一様分布する非負の倍精度浮動小数点実数値
  xb[d * i] += i / 1000.;
}
for(int i = 0; i &lt; nq; i++) {
  for(int j = 0; j &lt; d; j++) xq[d * i + j] = drand48();
  xq[d * i] += i / 1000.;
}</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5ab1b6138665e899563395-1">1</div><div class="crayon-num" data-line="crayon-5ab1b6138665e899563395-2">2</div><div class="crayon-num" data-line="crayon-5ab1b6138665e899563395-3">3</div><div class="crayon-num" data-line="crayon-5ab1b6138665e899563395-4">4</div><div class="crayon-num" data-line="crayon-5ab1b6138665e899563395-5">5</div><div class="crayon-num" data-line="crayon-5ab1b6138665e899563395-6">6</div><div class="crayon-num" data-line="crayon-5ab1b6138665e899563395-7">7</div><div class="crayon-num" data-line="crayon-5ab1b6138665e899563395-8">8</div><div class="crayon-num" data-line="crayon-5ab1b6138665e899563395-9">9</div><div class="crayon-num" data-line="crayon-5ab1b6138665e899563395-10">10</div><div class="crayon-num" data-line="crayon-5ab1b6138665e899563395-11">11</div><div class="crayon-num" data-line="crayon-5ab1b6138665e899563395-12">12</div><div class="crayon-num" data-line="crayon-5ab1b6138665e899563395-13">13</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5ab1b6138665e899563395-1"><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">d</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">64</span><span class="crayon-sy">;</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// 次元数</span></div><div class="crayon-line" id="crayon-5ab1b6138665e899563395-2"><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">nb</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">100000</span><span class="crayon-sy">;</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-c">// データベースのサイズ(格納データ数)</span></div><div class="crayon-line" id="crayon-5ab1b6138665e899563395-3"><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">nq</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">10000</span><span class="crayon-sy">;</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// 検索クエリのサイズ(クエリ数)</span></div><div class="crayon-line" id="crayon-5ab1b6138665e899563395-4"><span class="crayon-t">float</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-v">xb</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-t">float</span><span class="crayon-sy">[</span><span class="crayon-v">d</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">nb</span><span class="crayon-sy">]</span><span class="crayon-sy">;</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c">// スタックオーバーフローを防ぐためヒープ上に作成</span></div><div class="crayon-line" id="crayon-5ab1b6138665e899563395-5"><span class="crayon-t">float</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-v">xq</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-t">float</span><span class="crayon-sy">[</span><span class="crayon-v">d</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">nq</span><span class="crayon-sy">]</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b6138665e899563395-6"><span class="crayon-st">for</span><span class="crayon-sy">(</span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-v">nb</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-o">++</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5ab1b6138665e899563395-7"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-st">for</span><span class="crayon-sy">(</span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">j</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">j</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-v">d</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">j</span><span class="crayon-o">++</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-v">xb</span><span class="crayon-sy">[</span><span class="crayon-v">d</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">j</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">drand48</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c">// drand48() [0.0, 1.0) で一様分布する非負の倍精度浮動小数点実数値</span></div><div class="crayon-line" id="crayon-5ab1b6138665e899563395-8"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">xb</span><span class="crayon-sy">[</span><span class="crayon-v">d</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">+=</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-h"> </span><span class="crayon-cn">1000.</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b6138665e899563395-9"><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5ab1b6138665e899563395-10"><span class="crayon-st">for</span><span class="crayon-sy">(</span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-v">nq</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-o">++</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5ab1b6138665e899563395-11"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-st">for</span><span class="crayon-sy">(</span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">j</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">j</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-v">d</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">j</span><span class="crayon-o">++</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-v">xq</span><span class="crayon-sy">[</span><span class="crayon-v">d</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">j</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">drand48</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b6138665e899563395-12"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">xq</span><span class="crayon-sy">[</span><span class="crayon-v">d</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">+=</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-h"> </span><span class="crayon-cn">1000.</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b6138665e899563395-13"><span class="crayon-sy">}</span></div></div></td>
</tr>
</table>
</div>
</div>

<p>64次元ベクトルデータをデータベース登録用に10万個、検索クエリ用に1万個それぞれ作成しています。各ベクトルの1次元目の値だけ修正してますが、検索時にその意図がわかるのでここでは気にしなくても良いです。このチュートリアルでは通常のfloat型配列で入力データを管理していますが、Faissの実装を読んでみたところ、インデックス作成時に <code>std::vector</code> のコンテナにデータを詰め替えています。もしOpenCVと併用するなら <code>cv::Mat</code> に変換するアダプタを作っておきたいですね。</p>
<h4 class="term">インデックスの作成</h4>
<p>データベースのインデックスを作成します。ここからはFaissのAPIを使っていきますが、インデックスの種類はたくさんあるのでここでは基本的なものをピックアップして紹介していこうと思います。</p>
<h5 class="term"><code>faiss::IndexFlatL2</code></h5>
<p>まずは基本となる距離尺度にL2ノルム(L2距離)を利用したインデックスの作り方を確認します。</p>
<div id="crayon-5ab1b61386664437235050" class="crayon-syntax crayon-theme-ado crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 10px; margin-bottom: 10px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">C++</span></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
faiss::IndexFlatL2 index(d);           // L2ノルムインデックスのインスタンス生成
printf("is_trained = %s\n", index.is_trained ? "true" : "false");  // is_trained = true
// 全ベクトルデータのインデックス登録
// faiss::IndexFlatL2::add(idx_t n, const float *x) , idx_t: typedef long
index.add(nb, xb);
printf("ntotal = %ld\n", index.ntotal);  // ntotal = 100000</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5ab1b61386664437235050-1">1</div><div class="crayon-num" data-line="crayon-5ab1b61386664437235050-2">2</div><div class="crayon-num" data-line="crayon-5ab1b61386664437235050-3">3</div><div class="crayon-num" data-line="crayon-5ab1b61386664437235050-4">4</div><div class="crayon-num" data-line="crayon-5ab1b61386664437235050-5">5</div><div class="crayon-num" data-line="crayon-5ab1b61386664437235050-6">6</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5ab1b61386664437235050-1"><span class="crayon-v">faiss</span><span class="crayon-o">::</span><span class="crayon-e">IndexFlatL2 </span><span class="crayon-e">index</span><span class="crayon-sy">(</span><span class="crayon-v">d</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-c">// L2ノルムインデックスのインスタンス生成</span></div><div class="crayon-line" id="crayon-5ab1b61386664437235050-2"><span class="crayon-e">printf</span><span class="crayon-sy">(</span><span class="crayon-s">"is_trained = %s\n"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">index</span><span class="crayon-sy">.</span><span class="crayon-v">is</span><span class="crayon-sy">_</span>trained<span class="crayon-h"> </span><span class="crayon-sy">?</span><span class="crayon-h"> </span><span class="crayon-s">"true"</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"false"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c">// is_trained = true</span></div><div class="crayon-line" id="crayon-5ab1b61386664437235050-3"><span class="crayon-c">// 全ベクトルデータのインデックス登録</span></div><div class="crayon-line" id="crayon-5ab1b61386664437235050-4"><span class="crayon-c">// faiss::IndexFlatL2::add(idx_t n, const float *x) , idx_t: typedef long</span></div><div class="crayon-line" id="crayon-5ab1b61386664437235050-5"><span class="crayon-v">index</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-v">nb</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">xb</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61386664437235050-6"><span class="crayon-e">printf</span><span class="crayon-sy">(</span><span class="crayon-s">"ntotal = %ld\n"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">index</span><span class="crayon-sy">.</span><span class="crayon-v">ntotal</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c">// ntotal = 100000</span></div></div></td>
</tr>
</table>
</div>
</div>

<p><code>IndexFlatL2</code> はL2ノルムでの全探索用(Brute-force search)インデックスとなっており、入力ベクトルデータは未加工のまま全て登録します。publicなメンバとして <code>is_trained</code> と <code>ntotal</code> を参照していますが、それぞれインデックスの学習済フラグ(データ分布等を事前解析、IndexFlatL2では利用されない)、登録データ数を示しています。</p>
<h4 class="term">検索</h4>
<p>データの登録が終わったら検索してみます。前手順で作成した検索クエリ用データを利用してk-近傍探索を行います。</p>
<div id="crayon-5ab1b61386669903905493" class="crayon-syntax crayon-theme-ado crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 10px; margin-bottom: 10px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">C++</span></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
int k = 4;

{ // sanity check: search 5 first vectors of xb (データ確認用の簡易チェック)
  long *I = new long[k * 5];    // 検索結果のインデックスを格納
  float *D = new float[k * 5];  // 検索結果の距離(ここではL2距離)の値を格納

  // faiss::IndexFlatL2::search(idx_t n, const float *x, idx_t k, float *distances, idx_t *labels) const
  // 入力データ(つまりデータベースにインデックス済みの既知のデータ)5件をクエリにして検索
  // k=4なのでクエリ毎に距離が近い順に4件まで検索
  index.search(5, xb, k, D, I);

  // print results
  printf("I=\n");
  for(int i = 0; i &lt; 5; i++) {
      for(int j = 0; j &lt; k; j++) printf("%5ld ", I[i * k + j]);
      printf("\n");
  }

  printf("D=\n");
  for(int i = 0; i &lt; 5; i++) {
      for(int j = 0; j &lt; k; j++) printf("%7g ", D[i * k + j]);
      printf("\n");
  }
  delete [] I;
  delete [] D;
}
{ // search xq (xq:事前に作成した検索クエリ用ダミーデータ)
  long *I = new long[k * nq];
  float *D = new float[k * nq];

  index.search(nq, xq, k, D, I);

  // print results
  printf("I (5 first results)=\n");
  for(int i = 0; i &lt; 5; i++) {
      for(int j = 0; j &lt; k; j++) printf("%5ld ", I[i * k + j]);
      printf("\n");
  }

  printf("I (5 last results)=\n");
  for(int i = nq - 5; i &lt; nq; i++) {
      for(int j = 0; j &lt; k; j++) printf("%5ld ", I[i * k + j]);
      printf("\n");
  }
  delete [] I;
  delete [] D;
}
delete [] xb;
delete [] xq;</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5ab1b61386669903905493-1">1</div><div class="crayon-num" data-line="crayon-5ab1b61386669903905493-2">2</div><div class="crayon-num" data-line="crayon-5ab1b61386669903905493-3">3</div><div class="crayon-num" data-line="crayon-5ab1b61386669903905493-4">4</div><div class="crayon-num" data-line="crayon-5ab1b61386669903905493-5">5</div><div class="crayon-num" data-line="crayon-5ab1b61386669903905493-6">6</div><div class="crayon-num" data-line="crayon-5ab1b61386669903905493-7">7</div><div class="crayon-num" data-line="crayon-5ab1b61386669903905493-8">8</div><div class="crayon-num" data-line="crayon-5ab1b61386669903905493-9">9</div><div class="crayon-num" data-line="crayon-5ab1b61386669903905493-10">10</div><div class="crayon-num" data-line="crayon-5ab1b61386669903905493-11">11</div><div class="crayon-num" data-line="crayon-5ab1b61386669903905493-12">12</div><div class="crayon-num" data-line="crayon-5ab1b61386669903905493-13">13</div><div class="crayon-num" data-line="crayon-5ab1b61386669903905493-14">14</div><div class="crayon-num" data-line="crayon-5ab1b61386669903905493-15">15</div><div class="crayon-num" data-line="crayon-5ab1b61386669903905493-16">16</div><div class="crayon-num" data-line="crayon-5ab1b61386669903905493-17">17</div><div class="crayon-num" data-line="crayon-5ab1b61386669903905493-18">18</div><div class="crayon-num" data-line="crayon-5ab1b61386669903905493-19">19</div><div class="crayon-num" data-line="crayon-5ab1b61386669903905493-20">20</div><div class="crayon-num" data-line="crayon-5ab1b61386669903905493-21">21</div><div class="crayon-num" data-line="crayon-5ab1b61386669903905493-22">22</div><div class="crayon-num" data-line="crayon-5ab1b61386669903905493-23">23</div><div class="crayon-num" data-line="crayon-5ab1b61386669903905493-24">24</div><div class="crayon-num" data-line="crayon-5ab1b61386669903905493-25">25</div><div class="crayon-num" data-line="crayon-5ab1b61386669903905493-26">26</div><div class="crayon-num" data-line="crayon-5ab1b61386669903905493-27">27</div><div class="crayon-num" data-line="crayon-5ab1b61386669903905493-28">28</div><div class="crayon-num" data-line="crayon-5ab1b61386669903905493-29">29</div><div class="crayon-num" data-line="crayon-5ab1b61386669903905493-30">30</div><div class="crayon-num" data-line="crayon-5ab1b61386669903905493-31">31</div><div class="crayon-num" data-line="crayon-5ab1b61386669903905493-32">32</div><div class="crayon-num" data-line="crayon-5ab1b61386669903905493-33">33</div><div class="crayon-num" data-line="crayon-5ab1b61386669903905493-34">34</div><div class="crayon-num" data-line="crayon-5ab1b61386669903905493-35">35</div><div class="crayon-num" data-line="crayon-5ab1b61386669903905493-36">36</div><div class="crayon-num" data-line="crayon-5ab1b61386669903905493-37">37</div><div class="crayon-num" data-line="crayon-5ab1b61386669903905493-38">38</div><div class="crayon-num" data-line="crayon-5ab1b61386669903905493-39">39</div><div class="crayon-num" data-line="crayon-5ab1b61386669903905493-40">40</div><div class="crayon-num" data-line="crayon-5ab1b61386669903905493-41">41</div><div class="crayon-num" data-line="crayon-5ab1b61386669903905493-42">42</div><div class="crayon-num" data-line="crayon-5ab1b61386669903905493-43">43</div><div class="crayon-num" data-line="crayon-5ab1b61386669903905493-44">44</div><div class="crayon-num" data-line="crayon-5ab1b61386669903905493-45">45</div><div class="crayon-num" data-line="crayon-5ab1b61386669903905493-46">46</div><div class="crayon-num" data-line="crayon-5ab1b61386669903905493-47">47</div><div class="crayon-num" data-line="crayon-5ab1b61386669903905493-48">48</div><div class="crayon-num" data-line="crayon-5ab1b61386669903905493-49">49</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5ab1b61386669903905493-1"><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">k</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">4</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61386669903905493-2">&nbsp;</div><div class="crayon-line" id="crayon-5ab1b61386669903905493-3"><span class="crayon-sy">{</span><span class="crayon-h"> </span><span class="crayon-c">// sanity check: search 5 first vectors of xb (データ確認用の簡易チェック)</span></div><div class="crayon-line" id="crayon-5ab1b61386669903905493-4"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-t">long</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-v">I</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-t">long</span><span class="crayon-sy">[</span><span class="crayon-v">k</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-cn">5</span><span class="crayon-sy">]</span><span class="crayon-sy">;</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// 検索結果のインデックスを格納</span></div><div class="crayon-line" id="crayon-5ab1b61386669903905493-5"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-t">float</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-v">D</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-t">float</span><span class="crayon-sy">[</span><span class="crayon-v">k</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-cn">5</span><span class="crayon-sy">]</span><span class="crayon-sy">;</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c">// 検索結果の距離(ここではL2距離)の値を格納</span></div><div class="crayon-line" id="crayon-5ab1b61386669903905493-6">&nbsp;</div><div class="crayon-line" id="crayon-5ab1b61386669903905493-7"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c">// faiss::IndexFlatL2::search(idx_t n, const float *x, idx_t k, float *distances, idx_t *labels) const</span></div><div class="crayon-line" id="crayon-5ab1b61386669903905493-8"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c">// 入力データ(つまりデータベースにインデックス済みの既知のデータ)5件をクエリにして検索</span></div><div class="crayon-line" id="crayon-5ab1b61386669903905493-9"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c">// k=4なのでクエリ毎に距離が近い順に4件まで検索</span></div><div class="crayon-line" id="crayon-5ab1b61386669903905493-10"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">index</span><span class="crayon-sy">.</span><span class="crayon-e">search</span><span class="crayon-sy">(</span><span class="crayon-cn">5</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">xb</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">k</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">D</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">I</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61386669903905493-11">&nbsp;</div><div class="crayon-line" id="crayon-5ab1b61386669903905493-12"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c">// print results</span></div><div class="crayon-line" id="crayon-5ab1b61386669903905493-13"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-e">printf</span><span class="crayon-sy">(</span><span class="crayon-s">"I=\n"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61386669903905493-14"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-st">for</span><span class="crayon-sy">(</span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-cn">5</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-o">++</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5ab1b61386669903905493-15"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">for</span><span class="crayon-sy">(</span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">j</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">j</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-v">k</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">j</span><span class="crayon-o">++</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-e">printf</span><span class="crayon-sy">(</span><span class="crayon-s">"%5ld "</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">I</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">k</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">j</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61386669903905493-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">printf</span><span class="crayon-sy">(</span><span class="crayon-s">"\n"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61386669903905493-17"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5ab1b61386669903905493-18">&nbsp;</div><div class="crayon-line" id="crayon-5ab1b61386669903905493-19"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-e">printf</span><span class="crayon-sy">(</span><span class="crayon-s">"D=\n"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61386669903905493-20"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-st">for</span><span class="crayon-sy">(</span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-cn">5</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-o">++</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5ab1b61386669903905493-21"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">for</span><span class="crayon-sy">(</span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">j</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">j</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-v">k</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">j</span><span class="crayon-o">++</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-e">printf</span><span class="crayon-sy">(</span><span class="crayon-s">"%7g "</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">D</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">k</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">j</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61386669903905493-22"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">printf</span><span class="crayon-sy">(</span><span class="crayon-s">"\n"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61386669903905493-23"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5ab1b61386669903905493-24"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-i">delete</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-v">I</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61386669903905493-25"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-i">delete</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-v">D</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61386669903905493-26"><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5ab1b61386669903905493-27"><span class="crayon-sy">{</span><span class="crayon-h"> </span><span class="crayon-c">// search xq (xq:事前に作成した検索クエリ用ダミーデータ)</span></div><div class="crayon-line" id="crayon-5ab1b61386669903905493-28"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-t">long</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-v">I</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-t">long</span><span class="crayon-sy">[</span><span class="crayon-v">k</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">nq</span><span class="crayon-sy">]</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61386669903905493-29"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-t">float</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-v">D</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">new</span><span class="crayon-h"> </span><span class="crayon-t">float</span><span class="crayon-sy">[</span><span class="crayon-v">k</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">nq</span><span class="crayon-sy">]</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61386669903905493-30">&nbsp;</div><div class="crayon-line" id="crayon-5ab1b61386669903905493-31"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">index</span><span class="crayon-sy">.</span><span class="crayon-e">search</span><span class="crayon-sy">(</span><span class="crayon-v">nq</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">xq</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">k</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">D</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">I</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61386669903905493-32">&nbsp;</div><div class="crayon-line" id="crayon-5ab1b61386669903905493-33"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c">// print results</span></div><div class="crayon-line" id="crayon-5ab1b61386669903905493-34"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-e">printf</span><span class="crayon-sy">(</span><span class="crayon-s">"I (5 first results)=\n"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61386669903905493-35"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-st">for</span><span class="crayon-sy">(</span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-cn">5</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-o">++</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5ab1b61386669903905493-36"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">for</span><span class="crayon-sy">(</span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">j</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">j</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-v">k</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">j</span><span class="crayon-o">++</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-e">printf</span><span class="crayon-sy">(</span><span class="crayon-s">"%5ld "</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">I</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">k</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">j</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61386669903905493-37"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">printf</span><span class="crayon-sy">(</span><span class="crayon-s">"\n"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61386669903905493-38"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5ab1b61386669903905493-39">&nbsp;</div><div class="crayon-line" id="crayon-5ab1b61386669903905493-40"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-e">printf</span><span class="crayon-sy">(</span><span class="crayon-s">"I (5 last results)=\n"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61386669903905493-41"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-st">for</span><span class="crayon-sy">(</span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">nq</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-cn">5</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-v">nq</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-o">++</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5ab1b61386669903905493-42"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">for</span><span class="crayon-sy">(</span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">j</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">j</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-v">k</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">j</span><span class="crayon-o">++</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-e">printf</span><span class="crayon-sy">(</span><span class="crayon-s">"%5ld "</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">I</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">k</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">j</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61386669903905493-43"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">printf</span><span class="crayon-sy">(</span><span class="crayon-s">"\n"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61386669903905493-44"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5ab1b61386669903905493-45"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-i">delete</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-v">I</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61386669903905493-46"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-i">delete</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-v">D</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61386669903905493-47"><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5ab1b61386669903905493-48"><span class="crayon-i">delete</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-v">xb</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61386669903905493-49"><span class="crayon-i">delete</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-v">xq</span><span class="crayon-sy">;</span></div></div></td>
</tr>
</table>
</div>
</div>

<p></p>
<p>* 出力結果例</p>
<div id="crayon-5ab1b6138666f633521869" class="crayon-syntax crayon-theme-ado crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 10px; margin-bottom: 10px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
I=  // 検索結果のインデックス (k=4なので距離が近い順に4件、5クエリ分)
    0   371   187   551 // インデックス済データなので上位1件目は当然検索クエリ自身となる
    1   324   126   279 
    2   213   260   487 
    3   199   402   626 
    4   388   839   222 
D=  // 検索結果の距離の値 (昇順ソート済)
      0 7.52398  7.5694 7.79739 
      0 7.15704 7.19868 7.25345 
      0 6.61889 6.96309 7.00845 
      0   7.001 7.11882 7.48969 
      0 7.14342 7.89587  7.9118 
I (5 first results)=  // ダミーの検索クエリ(未知データ)で同様に検索
  486   287  1111   482 
  320   410    37   460 
  940   189   822   193 
  807  1002   388   505 
  657   156    95  1016 
I (5 last results)=
10842 10827  9938 10004 
 9403 10267 10880 10330 
 9896 10146 10093 10361 
 8603 10523 10582  9895 
11460 10123 11099 10876</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5ab1b6138666f633521869-1">1</div><div class="crayon-num" data-line="crayon-5ab1b6138666f633521869-2">2</div><div class="crayon-num" data-line="crayon-5ab1b6138666f633521869-3">3</div><div class="crayon-num" data-line="crayon-5ab1b6138666f633521869-4">4</div><div class="crayon-num" data-line="crayon-5ab1b6138666f633521869-5">5</div><div class="crayon-num" data-line="crayon-5ab1b6138666f633521869-6">6</div><div class="crayon-num" data-line="crayon-5ab1b6138666f633521869-7">7</div><div class="crayon-num" data-line="crayon-5ab1b6138666f633521869-8">8</div><div class="crayon-num" data-line="crayon-5ab1b6138666f633521869-9">9</div><div class="crayon-num" data-line="crayon-5ab1b6138666f633521869-10">10</div><div class="crayon-num" data-line="crayon-5ab1b6138666f633521869-11">11</div><div class="crayon-num" data-line="crayon-5ab1b6138666f633521869-12">12</div><div class="crayon-num" data-line="crayon-5ab1b6138666f633521869-13">13</div><div class="crayon-num" data-line="crayon-5ab1b6138666f633521869-14">14</div><div class="crayon-num" data-line="crayon-5ab1b6138666f633521869-15">15</div><div class="crayon-num" data-line="crayon-5ab1b6138666f633521869-16">16</div><div class="crayon-num" data-line="crayon-5ab1b6138666f633521869-17">17</div><div class="crayon-num" data-line="crayon-5ab1b6138666f633521869-18">18</div><div class="crayon-num" data-line="crayon-5ab1b6138666f633521869-19">19</div><div class="crayon-num" data-line="crayon-5ab1b6138666f633521869-20">20</div><div class="crayon-num" data-line="crayon-5ab1b6138666f633521869-21">21</div><div class="crayon-num" data-line="crayon-5ab1b6138666f633521869-22">22</div><div class="crayon-num" data-line="crayon-5ab1b6138666f633521869-23">23</div><div class="crayon-num" data-line="crayon-5ab1b6138666f633521869-24">24</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5ab1b6138666f633521869-1"><span class="crayon-v">I</span><span class="crayon-o">=</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c">// 検索結果のインデックス (k=4なので距離が近い順に4件、5クエリ分)</span></div><div class="crayon-line" id="crayon-5ab1b6138666f633521869-2"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">0</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">371</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">187</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">551</span><span class="crayon-h"> </span><span class="crayon-c">// インデックス済データなので上位1件目は当然検索クエリ自身となる</span></div><div class="crayon-line" id="crayon-5ab1b6138666f633521869-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">1</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">324</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">126</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">279</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5ab1b6138666f633521869-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">2</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">213</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">260</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">487</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5ab1b6138666f633521869-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">3</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">199</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">402</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">626</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5ab1b6138666f633521869-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">4</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">388</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">839</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">222</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5ab1b6138666f633521869-7"><span class="crayon-v">D</span><span class="crayon-o">=</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c">// 検索結果の距離の値 (昇順ソート済)</span></div><div class="crayon-line" id="crayon-5ab1b6138666f633521869-8"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">0</span><span class="crayon-h"> </span><span class="crayon-cn">7.52398</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">7.5694</span><span class="crayon-h"> </span><span class="crayon-cn">7.79739</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5ab1b6138666f633521869-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">0</span><span class="crayon-h"> </span><span class="crayon-cn">7.15704</span><span class="crayon-h"> </span><span class="crayon-cn">7.19868</span><span class="crayon-h"> </span><span class="crayon-cn">7.25345</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5ab1b6138666f633521869-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">0</span><span class="crayon-h"> </span><span class="crayon-cn">6.61889</span><span class="crayon-h"> </span><span class="crayon-cn">6.96309</span><span class="crayon-h"> </span><span class="crayon-cn">7.00845</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5ab1b6138666f633521869-11"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">0</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">7.001</span><span class="crayon-h"> </span><span class="crayon-cn">7.11882</span><span class="crayon-h"> </span><span class="crayon-cn">7.48969</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5ab1b6138666f633521869-12"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">0</span><span class="crayon-h"> </span><span class="crayon-cn">7.14342</span><span class="crayon-h"> </span><span class="crayon-cn">7.89587</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">7.9118</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5ab1b6138666f633521869-13"><span class="crayon-e">I</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-cn">5</span><span class="crayon-h"> </span><span class="crayon-e">first </span><span class="crayon-v">results</span><span class="crayon-sy">)</span><span class="crayon-o">=</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c">// ダミーの検索クエリ(未知データ)で同様に検索</span></div><div class="crayon-line" id="crayon-5ab1b6138666f633521869-14"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">486</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">287</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">1111</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">482</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5ab1b6138666f633521869-15"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">320</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">410</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">37</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">460</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5ab1b6138666f633521869-16"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">940</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">189</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">822</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">193</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5ab1b6138666f633521869-17"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">807</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">1002</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">388</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">505</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5ab1b6138666f633521869-18"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">657</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">156</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">95</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">1016</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5ab1b6138666f633521869-19"><span class="crayon-e">I</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-cn">5</span><span class="crayon-h"> </span><span class="crayon-e">last </span><span class="crayon-v">results</span><span class="crayon-sy">)</span><span class="crayon-o">=</span></div><div class="crayon-line" id="crayon-5ab1b6138666f633521869-20"><span class="crayon-cn">10842</span><span class="crayon-h"> </span><span class="crayon-cn">10827</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">9938</span><span class="crayon-h"> </span><span class="crayon-cn">10004</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5ab1b6138666f633521869-21"><span class="crayon-h"> </span><span class="crayon-cn">9403</span><span class="crayon-h"> </span><span class="crayon-cn">10267</span><span class="crayon-h"> </span><span class="crayon-cn">10880</span><span class="crayon-h"> </span><span class="crayon-cn">10330</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5ab1b6138666f633521869-22"><span class="crayon-h"> </span><span class="crayon-cn">9896</span><span class="crayon-h"> </span><span class="crayon-cn">10146</span><span class="crayon-h"> </span><span class="crayon-cn">10093</span><span class="crayon-h"> </span><span class="crayon-cn">10361</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5ab1b6138666f633521869-23"><span class="crayon-h"> </span><span class="crayon-cn">8603</span><span class="crayon-h"> </span><span class="crayon-cn">10523</span><span class="crayon-h"> </span><span class="crayon-cn">10582</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">9895</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5ab1b6138666f633521869-24"><span class="crayon-cn">11460</span><span class="crayon-h"> </span><span class="crayon-cn">10123</span><span class="crayon-h"> </span><span class="crayon-cn">11099</span><span class="crayon-h"> </span><span class="crayon-cn">10876</span></div></div></td>
</tr>
</table>
</div>
</div>

<p>データベースに登録したデータ、検索クエリ用のデータも全てランダムに生成したにもかかわらず、類似検索結果のインデックスに偏りがあることがわかります。ここで、データ生成時に各ベクトルの1次元目のデータだけ少し加工したことを思い出しましょう。データ配列のインデックス値に依存する数値が加算されており、検索結果にもその影響が表れていることが確認できます。</p>
<div id="crayon-5ab1b61386674449199981" class="crayon-syntax crayon-theme-ado crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 10px; margin-bottom: 10px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">C++</span></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
for(int i = 0; i &lt; nb; i++) {
  for(int j = 0; j &lt; d; j++) xb[d * i + j] = drand48();
  xb[d * i] += i / 1000.;
}
for(int i = 0; i &lt; nq; i++) {
  for(int j = 0; j &lt; d; j++) xq[d * i + j] = drand48();
  xq[d * i] += i / 1000.;
}</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5ab1b61386674449199981-1">1</div><div class="crayon-num" data-line="crayon-5ab1b61386674449199981-2">2</div><div class="crayon-num" data-line="crayon-5ab1b61386674449199981-3">3</div><div class="crayon-num" data-line="crayon-5ab1b61386674449199981-4">4</div><div class="crayon-num" data-line="crayon-5ab1b61386674449199981-5">5</div><div class="crayon-num" data-line="crayon-5ab1b61386674449199981-6">6</div><div class="crayon-num" data-line="crayon-5ab1b61386674449199981-7">7</div><div class="crayon-num" data-line="crayon-5ab1b61386674449199981-8">8</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5ab1b61386674449199981-1"><span class="crayon-st">for</span><span class="crayon-sy">(</span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-v">nb</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-o">++</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5ab1b61386674449199981-2"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-st">for</span><span class="crayon-sy">(</span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">j</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">j</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-v">d</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">j</span><span class="crayon-o">++</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-v">xb</span><span class="crayon-sy">[</span><span class="crayon-v">d</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">j</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">drand48</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61386674449199981-3"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">xb</span><span class="crayon-sy">[</span><span class="crayon-v">d</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">+=</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-h"> </span><span class="crayon-cn">1000.</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61386674449199981-4"><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5ab1b61386674449199981-5"><span class="crayon-st">for</span><span class="crayon-sy">(</span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-v">nq</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-o">++</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5ab1b61386674449199981-6"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-st">for</span><span class="crayon-sy">(</span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">j</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">j</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-v">d</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">j</span><span class="crayon-o">++</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-v">xq</span><span class="crayon-sy">[</span><span class="crayon-v">d</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">j</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">drand48</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61386674449199981-7"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">xq</span><span class="crayon-sy">[</span><span class="crayon-v">d</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">+=</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-h"> </span><span class="crayon-cn">1000.</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61386674449199981-8"><span class="crayon-sy">}</span></div></div></td>
</tr>
</table>
</div>
</div>

<p>もし、データを加工しない場合は以下のような検索結果になります。</p>
<div id="crayon-5ab1b61386678992005630" class="crayon-syntax crayon-theme-ado crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 10px; margin-bottom: 10px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
## 例
I (5 first results)=
55040 31506 25128 42339 
52766 50610 38693 41096 
40905 55042 24436  4212 
64192 15007 95432 32551 
45146 62032 44525 82328 
I (5 last results)=
40461 79526 12960 79960 
88504 16638 53654  1626 
59759 33664 35785   835 
67728 38098 19827 30085 
81127 43351 79032 65174</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
 <tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5ab1b61386678992005630-1">1</div><div class="crayon-num" data-line="crayon-5ab1b61386678992005630-2">2</div><div class="crayon-num" data-line="crayon-5ab1b61386678992005630-3">3</div><div class="crayon-num" data-line="crayon-5ab1b61386678992005630-4">4</div><div class="crayon-num" data-line="crayon-5ab1b61386678992005630-5">5</div><div class="crayon-num" data-line="crayon-5ab1b61386678992005630-6">6</div><div class="crayon-num" data-line="crayon-5ab1b61386678992005630-7">7</div><div class="crayon-num" data-line="crayon-5ab1b61386678992005630-8">8</div><div class="crayon-num" data-line="crayon-5ab1b61386678992005630-9">9</div><div class="crayon-num" data-line="crayon-5ab1b61386678992005630-10">10</div><div class="crayon-num" data-line="crayon-5ab1b61386678992005630-11">11</div><div class="crayon-num" data-line="crayon-5ab1b61386678992005630-12">12</div><div class="crayon-num" data-line="crayon-5ab1b61386678992005630-13">13</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5ab1b61386678992005630-1"><span class="crayon-p">## 例</span></div><div class="crayon-line" id="crayon-5ab1b61386678992005630-2"><span class="crayon-e">I</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-cn">5</span><span class="crayon-h"> </span><span class="crayon-e">first </span><span class="crayon-v">results</span><span class="crayon-sy">)</span><span class="crayon-o">=</span></div><div class="crayon-line" id="crayon-5ab1b61386678992005630-3"><span class="crayon-cn">55040</span><span class="crayon-h"> </span><span class="crayon-cn">31506</span><span class="crayon-h"> </span><span class="crayon-cn">25128</span><span class="crayon-h"> </span><span class="crayon-cn">42339</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5ab1b61386678992005630-4"><span class="crayon-cn">52766</span><span class="crayon-h"> </span><span class="crayon-cn">50610</span><span class="crayon-h"> </span><span class="crayon-cn">38693</span><span class="crayon-h"> </span><span class="crayon-cn">41096</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5ab1b61386678992005630-5"><span class="crayon-cn">40905</span><span class="crayon-h"> </span><span class="crayon-cn">55042</span><span class="crayon-h"> </span><span class="crayon-cn">24436</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">4212</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5ab1b61386678992005630-6"><span class="crayon-cn">64192</span><span class="crayon-h"> </span><span class="crayon-cn">15007</span><span class="crayon-h"> </span><span class="crayon-cn">95432</span><span class="crayon-h"> </span><span class="crayon-cn">32551</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5ab1b61386678992005630-7"><span class="crayon-cn">45146</span><span class="crayon-h"> </span><span class="crayon-cn">62032</span><span class="crayon-h"> </span><span class="crayon-cn">44525</span><span class="crayon-h"> </span><span class="crayon-cn">82328</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5ab1b61386678992005630-8"><span class="crayon-e">I</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-cn">5</span><span class="crayon-h"> </span><span class="crayon-e">last </span><span class="crayon-v">results</span><span class="crayon-sy">)</span><span class="crayon-o">=</span></div><div class="crayon-line" id="crayon-5ab1b61386678992005630-9"><span class="crayon-cn">40461</span><span class="crayon-h"> </span><span class="crayon-cn">79526</span><span class="crayon-h"> </span><span class="crayon-cn">12960</span><span class="crayon-h"> </span><span class="crayon-cn">79960</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5ab1b61386678992005630-10"><span class="crayon-cn">88504</span><span class="crayon-h"> </span><span class="crayon-cn">16638</span><span class="crayon-h"> </span><span class="crayon-cn">53654</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">1626</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5ab1b61386678992005630-11"><span class="crayon-cn">59759</span><span class="crayon-h"> </span><span class="crayon-cn">33664</span><span class="crayon-h"> </span><span class="crayon-cn">35785</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">835</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5ab1b61386678992005630-12"><span class="crayon-cn">67728</span><span class="crayon-h"> </span><span class="crayon-cn">38098</span><span class="crayon-h"> </span><span class="crayon-cn">19827</span><span class="crayon-h"> </span><span class="crayon-cn">30085</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5ab1b61386678992005630-13"><span class="crayon-cn">81127</span><span class="crayon-h"> </span><span class="crayon-cn">43351</span><span class="crayon-h"> </span><span class="crayon-cn">79032</span><span class="crayon-h"> </span><span class="crayon-cn">65174</span></div></div></td>
</tr>
</table>
</div>
</div>

<p>2017/05現在のCPU版の実装では、次元数が4の倍数かつ同時検索クエリ数が20件以下の場合はSSEを使って距離計算をしてくれるようです。つまり、上記コード中の最初のsanity checkではSSEを利用、検索クエリデータ xq での検索ではインストール時に採用したBLAS実装(ここではOpenBLAS)に計算処理が委譲されます。また、マルチスレッドで処理される箇所はOpenMPを使って実装されているので大変読みやすくて助かります。</p>
<h5 class="term"><code>faiss::IndexIVFFlat</code></h5>
<p><code>IndexFlatL2</code> をそのまま利用すると、いくらSSEやOpemMPを駆使して計算をしたとしても検索速度が遅くなってしまうため、Billion-scaleの大規模データに対応することは困難です。ここでは、入力ベクトルデータをクラスタリングしておき、検索時にはクエリデータに対応するセルおよび近隣のセルをいくつか選び出して、それらのセルに属するデータのみを最近傍点の候補として距離計算を行うことで検索時間を削減します。</p>
<p></p>
<div id="crayon-5ab1b6138667d990553134" class="crayon-syntax crayon-theme-ado crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 10px; margin-bottom: 10px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">C++</span></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
#include &lt;memory&gt;
... 省略
auto xb = std::make_unique&lt;float[]&gt;(d * nb);  // delete [] を排除したいのでチュートリアルを少しだけ改変
auto xq = std::make_unique&lt;float[]&gt;(d * nq);
... 省略

faiss::IndexFlatL2 quantizer(d);

int nlist = 100;
int k = 4;

// 転置インデックスクラス
// IndexIVFFlat(Index* quantizer, size_t d, size_t nlist_, MetricType = METRIC_INNER_PRODUCT)
// 量子化対象のインデックス、データの次元数、転置インデックスのリストサイズ、距離尺度
faiss::IndexIVFFlat index(&amp;quantizer, d, nlist, faiss::METRIC_L2);

assert(!index.is_trained);  // is_trained: false
index.train(nb, xb.get());  // ベクトル量子化、転置インデックス作成 (データベース登録対象データを利用)
assert(index.is_trained);   // is_trained: true

index.add(nb, xb.get());  // データ登録

{ // search xq
  auto I = std::make_unique&lt;long[]&gt;(k * nq);
  auto D = std::make_unique&lt;float[]&gt;(k * nq);

  index.search(nq, xq.get(), k, D.get(), I.get());

  printf("I=\n");                    // print neighbors of 5 last queries             
  for(int i = nq - 5; i &lt; nq; i++) {
    for(int j = 0; j &lt; k; j++) printf("%5ld ", I[i * k + j]);
    printf("\n");
  }

  index.nprobe = 10;                 // default nprobe is 1, try a few more                                                                                                                      
  index.search(nq, xq.get(), k, D.get(), I.get());

  printf("I=\n");
  for(int i = nq - 5; i &lt; nq; i++) {
    for(int j = 0; j &lt; k; j++) printf("%5ld ", I[i * k + j]);
    printf("\n");
  }
}</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5ab1b6138667d990553134-1">1</div><div class="crayon-num" data-line="crayon-5ab1b6138667d990553134-2">2</div><div class="crayon-num" data-line="crayon-5ab1b6138667d990553134-3">3</div><div class="crayon-num" data-line="crayon-5ab1b6138667d990553134-4">4</div><div class="crayon-num" data-line="crayon-5ab1b6138667d990553134-5">5</div><div class="crayon-num" data-line="crayon-5ab1b6138667d990553134-6">6</div><div class="crayon-num" data-line="crayon-5ab1b6138667d990553134-7">7</div><div class="crayon-num" data-line="crayon-5ab1b6138667d990553134-8">8</div><div class="crayon-num" data-line="crayon-5ab1b6138667d990553134-9">9</div><div class="crayon-num" data-line="crayon-5ab1b6138667d990553134-10">10</div><div class="crayon-num" data-line="crayon-5ab1b6138667d990553134-11">11</div><div class="crayon-num" data-line="crayon-5ab1b6138667d990553134-12">12</div><div class="crayon-num" data-line="crayon-5ab1b6138667d990553134-13">13</div><div class="crayon-num" data-line="crayon-5ab1b6138667d990553134-14">14</div><div class="crayon-num" data-line="crayon-5ab1b6138667d990553134-15">15</div><div class="crayon-num" data-line="crayon-5ab1b6138667d990553134-16">16</div><div class="crayon-num" data-line="crayon-5ab1b6138667d990553134-17">17</div><div class="crayon-num" data-line="crayon-5ab1b6138667d990553134-18">18</div><div class="crayon-num" data-line="crayon-5ab1b6138667d990553134-19">19</div><div class="crayon-num" data-line="crayon-5ab1b6138667d990553134-20">20</div><div class="crayon-num" data-line="crayon-5ab1b6138667d990553134-21">21</div><div class="crayon-num" data-line="crayon-5ab1b6138667d990553134-22">22</div><div class="crayon-num" data-line="crayon-5ab1b6138667d990553134-23">23</div><div class="crayon-num" data-line="crayon-5ab1b6138667d990553134-24">24</div><div class="crayon-num" data-line="crayon-5ab1b6138667d990553134-25">25</div><div class="crayon-num" data-line="crayon-5ab1b6138667d990553134-26">26</div><div class="crayon-num" data-line="crayon-5ab1b6138667d990553134-27">27</div><div class="crayon-num" data-line="crayon-5ab1b6138667d990553134-28">28</div><div class="crayon-num" data-line="crayon-5ab1b6138667d990553134-29">29</div><div class="crayon-num" data-line="crayon-5ab1b6138667d990553134-30">30</div><div class="crayon-num" data-line="crayon-5ab1b6138667d990553134-31">31</div><div class="crayon-num" data-line="crayon-5ab1b6138667d990553134-32">32</div><div class="crayon-num" data-line="crayon-5ab1b6138667d990553134-33">33</div><div class="crayon-num" data-line="crayon-5ab1b6138667d990553134-34">34</div><div class="crayon-num" data-line="crayon-5ab1b6138667d990553134-35">35</div><div class="crayon-num" data-line="crayon-5ab1b6138667d990553134-36">36</div><div class="crayon-num" data-line="crayon-5ab1b6138667d990553134-37">37</div><div class="crayon-num" data-line="crayon-5ab1b6138667d990553134-38">38</div><div class="crayon-num" data-line="crayon-5ab1b6138667d990553134-39">39</div><div class="crayon-num" data-line="crayon-5ab1b6138667d990553134-40">40</div><div class="crayon-num" data-line="crayon-5ab1b6138667d990553134-41">41</div><div class="crayon-num" data-line="crayon-5ab1b6138667d990553134-42">42</div><div class="crayon-num" data-line="crayon-5ab1b6138667d990553134-43">43</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5ab1b6138667d990553134-1"><span class="crayon-p">#include &lt;memory&gt;</span></div><div class="crayon-line" id="crayon-5ab1b6138667d990553134-2"><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-h"> </span>省略</div><div class="crayon-line" id="crayon-5ab1b6138667d990553134-3"><span class="crayon-e">auto </span><span class="crayon-v">xb</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">std</span><span class="crayon-o">::</span><span class="crayon-v">make_unique</span><span class="crayon-o">&lt;</span><span class="crayon-t">float</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-o">&gt;</span><span class="crayon-sy">(</span><span class="crayon-v">d</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">nb</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c">// delete [] を排除したいのでチュートリアルを少しだけ改変</span></div><div class="crayon-line" id="crayon-5ab1b6138667d990553134-4"><span class="crayon-e">auto </span><span class="crayon-v">xq</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">std</span><span class="crayon-o">::</span><span class="crayon-v">make_unique</span><span class="crayon-o">&lt;</span><span class="crayon-t">float</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-o">&gt;</span><span class="crayon-sy">(</span><span class="crayon-v">d</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">nq</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b6138667d990553134-5"><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-h"> </span>省略</div><div class="crayon-line" id="crayon-5ab1b6138667d990553134-6">&nbsp;</div><div class="crayon-line" id="crayon-5ab1b6138667d990553134-7"><span class="crayon-v">faiss</span><span class="crayon-o">::</span><span class="crayon-e">IndexFlatL2 </span><span class="crayon-e">quantizer</span><span class="crayon-sy">(</span><span class="crayon-v">d</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b6138667d990553134-8">&nbsp;</div><div class="crayon-line" id="crayon-5ab1b6138667d990553134-9"><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">nlist</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">100</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b6138667d990553134-10"><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">k</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">4</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b6138667d990553134-11">&nbsp;</div><div class="crayon-line" id="crayon-5ab1b6138667d990553134-12"><span class="crayon-c">// 転置インデックスクラス</span></div><div class="crayon-line" id="crayon-5ab1b6138667d990553134-13"><span class="crayon-c">// IndexIVFFlat(Index* quantizer, size_t d, size_t nlist_, MetricType = METRIC_INNER_PRODUCT)</span></div><div class="crayon-line" id="crayon-5ab1b6138667d990553134-14"><span class="crayon-c">// 量子化対象のインデックス、データの次元数、転置インデックスのリストサイズ、距離尺度</span></div><div class="crayon-line" id="crayon-5ab1b6138667d990553134-15"><span class="crayon-v">faiss</span><span class="crayon-o">::</span><span class="crayon-e">IndexIVFFlat </span><span class="crayon-e">index</span><span class="crayon-sy">(</span><span class="crayon-v">&amp;quantizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">d</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">nlist</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">faiss</span><span class="crayon-o">::</span><span class="crayon-v">METRIC_L2</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b6138667d990553134-16">&nbsp;</div><div class="crayon-line" id="crayon-5ab1b6138667d990553134-17"><span class="crayon-st">assert</span><span class="crayon-sy">(</span><span class="crayon-o">!</span><span class="crayon-v">index</span><span class="crayon-sy">.</span><span class="crayon-v">is_trained</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c">// is_trained: false</span></div><div class="crayon-line" id="crayon-5ab1b6138667d990553134-18"><span class="crayon-v">index</span><span class="crayon-sy">.</span><span class="crayon-e">train</span><span class="crayon-sy">(</span><span class="crayon-v">nb</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">xb</span><span class="crayon-sy">.</span><span class="crayon-e">get</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c">// ベクトル量子化、転置インデックス作成 (データベース登録対象データを利用)</span></div><div class="crayon-line" id="crayon-5ab1b6138667d990553134-19"><span class="crayon-st">assert</span><span class="crayon-sy">(</span><span class="crayon-v">index</span><span class="crayon-sy">.</span><span class="crayon-v">is_trained</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-c">// is_trained: true</span></div><div class="crayon-line" id="crayon-5ab1b6138667d990553134-20">&nbsp;</div><div class="crayon-line" id="crayon-5ab1b6138667d990553134-21"><span class="crayon-v">index</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-v">nb</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">xb</span><span class="crayon-sy">.</span><span class="crayon-e">get</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c">// データ登録</span></div><div class="crayon-line" id="crayon-5ab1b6138667d990553134-22">&nbsp;</div><div class="crayon-line" id="crayon-5ab1b6138667d990553134-23"><span class="crayon-sy">{</span><span class="crayon-h"> </span><span class="crayon-c">// search xq</span></div><div class="crayon-line" id="crayon-5ab1b6138667d990553134-24"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-i">auto</span><span class="crayon-h"> </span><span class="crayon-v">I</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">std</span><span class="crayon-o">::</span><span class="crayon-v">make_unique</span><span class="crayon-o">&lt;</span><span class="crayon-t">long</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-o">&gt;</span><span class="crayon-sy">(</span><span class="crayon-v">k</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">nq</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b6138667d990553134-25"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-i">auto</span><span class="crayon-h"> </span><span class="crayon-v">D</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">std</span><span class="crayon-o">::</span><span class="crayon-v">make_unique</span><span class="crayon-o">&lt;</span><span class="crayon-t">float</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-o">&gt;</span><span class="crayon-sy">(</span><span class="crayon-v">k</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">nq</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b6138667d990553134-26">&nbsp;</div><div class="crayon-line" id="crayon-5ab1b6138667d990553134-27"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">index</span><span class="crayon-sy">.</span><span class="crayon-e">search</span><span class="crayon-sy">(</span><span class="crayon-v">nq</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">xq</span><span class="crayon-sy">.</span><span class="crayon-e">get</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">k</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">D</span><span class="crayon-sy">.</span><span class="crayon-e">get</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">I</span><span class="crayon-sy">.</span><span class="crayon-e">get</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b6138667d990553134-28">&nbsp;</div><div class="crayon-line" id="crayon-5ab1b6138667d990553134-29"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-e">printf</span><span class="crayon-sy">(</span><span class="crayon-s">"I=\n"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-c">// print neighbors of 5 last queries&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></div><div class="crayon-line" id="crayon-5ab1b6138667d990553134-30"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-st">for</span><span class="crayon-sy">(</span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">nq</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-cn">5</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-v">nq</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-o">++</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5ab1b6138667d990553134-31"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">for</span><span class="crayon-sy">(</span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">j</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">j</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-v">k</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">j</span><span class="crayon-o">++</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-e">printf</span><span class="crayon-sy">(</span><span class="crayon-s">"%5ld "</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">I</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">k</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">j</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b6138667d990553134-32"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">printf</span><span class="crayon-sy">(</span><span class="crayon-s">"\n"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b6138667d990553134-33"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5ab1b6138667d990553134-34">&nbsp;</div><div class="crayon-line" id="crayon-5ab1b6138667d990553134-35"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">index</span><span class="crayon-sy">.</span><span class="crayon-v">nprobe</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">10</span><span class="crayon-sy">;</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-c">// default nprobe is 1, try a few more&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></div><div class="crayon-line" id="crayon-5ab1b6138667d990553134-36"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">index</span><span class="crayon-sy">.</span><span class="crayon-e">search</span><span class="crayon-sy">(</span><span class="crayon-v">nq</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">xq</span><span class="crayon-sy">.</span><span class="crayon-e">get</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">k</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">D</span><span class="crayon-sy">.</span><span class="crayon-e">get</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">I</span><span class="crayon-sy">.</span><span class="crayon-e">get</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b6138667d990553134-37">&nbsp;</div><div class="crayon-line" id="crayon-5ab1b6138667d990553134-38"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-e">printf</span><span class="crayon-sy">(</span><span class="crayon-s">"I=\n"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b6138667d990553134-39"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-st">for</span><span class="crayon-sy">(</span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">nq</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-cn">5</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-v">nq</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-o">++</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5ab1b6138667d990553134-40"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">for</span><span class="crayon-sy">(</span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">j</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">j</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-v">k</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">j</span><span class="crayon-o">++</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-e">printf</span><span class="crayon-sy">(</span><span class="crayon-s">"%5ld "</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">I</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">k</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">j</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b6138667d990553134-41"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">printf</span><span class="crayon-sy">(</span><span class="crayon-s">"\n"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b6138667d990553134-42"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5ab1b6138667d990553134-43"><span class="crayon-sy">}</span></div></div></td>
</tr>
</table>
</div>
</div>

<p></p>
<p>* 出力結果例</p>
<div id="crayon-5ab1b61386683373184356" class="crayon-syntax crayon-theme-ado crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 10px; margin-bottom: 10px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
I=
10049 10147 10188 10184 
 9403  9750  9812 10346 
10361 10184  9920 10333 
 9895  9946  9335  9677 
10876  9647  9756 11103 
I=
10842 10827  9938 10004 
 9403 10267 10880 10330 
 9896 10146 10093 10361 
 8603 10523 10582  9895 
11460 10123 11099 10876</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5ab1b61386683373184356-1">1</div><div class="crayon-num" data-line="crayon-5ab1b61386683373184356-2">2</div><div class="crayon-num" data-line="crayon-5ab1b61386683373184356-3">3</div><div class="crayon-num" data-line="crayon-5ab1b61386683373184356-4">4</div><div class="crayon-num" data-line="crayon-5ab1b61386683373184356-5">5</div><div class="crayon-num" data-line="crayon-5ab1b61386683373184356-6">6</div><div class="crayon-num" data-line="crayon-5ab1b61386683373184356-7">7</div><div class="crayon-num" data-line="crayon-5ab1b61386683373184356-8">8</div><div class="crayon-num" data-line="crayon-5ab1b61386683373184356-9">9</div><div class="crayon-num" data-line="crayon-5ab1b61386683373184356-10">10</div><div class="crayon-num" data-line="crayon-5ab1b61386683373184356-11">11</div><div class="crayon-num" data-line="crayon-5ab1b61386683373184356-12">12</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5ab1b61386683373184356-1"><span class="crayon-v">I</span><span class="crayon-o">=</span></div><div class="crayon-line" id="crayon-5ab1b61386683373184356-2"><span class="crayon-cn">10049</span><span class="crayon-h"> </span><span class="crayon-cn">10147</span><span class="crayon-h"> </span><span class="crayon-cn">10188</span><span class="crayon-h"> </span><span class="crayon-cn">10184</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5ab1b61386683373184356-3"><span class="crayon-h"> </span><span class="crayon-cn">9403</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">9750</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">9812</span><span class="crayon-h"> </span><span class="crayon-cn">10346</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5ab1b61386683373184356-4"><span class="crayon-cn">10361</span><span class="crayon-h"> </span><span class="crayon-cn">10184</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">9920</span><span class="crayon-h"> </span><span class="crayon-cn">10333</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5ab1b61386683373184356-5"><span class="crayon-h"> </span><span class="crayon-cn">9895</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">9946</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">9335</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">9677</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5ab1b61386683373184356-6"><span class="crayon-cn">10876</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">9647</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">9756</span><span class="crayon-h"> </span><span class="crayon-cn">11103</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5ab1b61386683373184356-7"><span class="crayon-v">I</span><span class="crayon-o">=</span></div><div class="crayon-line" id="crayon-5ab1b61386683373184356-8"><span class="crayon-cn">10842</span><span class="crayon-h"> </span><span class="crayon-cn">10827</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">9938</span><span class="crayon-h"> </span><span class="crayon-cn">10004</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5ab1b61386683373184356-9"><span class="crayon-h"> </span><span class="crayon-cn">9403</span><span class="crayon-h"> </span><span class="crayon-cn">10267</span><span class="crayon-h"> </span><span class="crayon-cn">10880</span><span class="crayon-h"> </span><span class="crayon-cn">10330</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5ab1b61386683373184356-10"><span class="crayon-h"> </span><span class="crayon-cn">9896</span><span class="crayon-h"> </span><span class="crayon-cn">10146</span><span class="crayon-h"> </span><span class="crayon-cn">10093</span><span class="crayon-h"> </span><span class="crayon-cn">10361</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5ab1b61386683373184356-11"><span class="crayon-h"> </span><span class="crayon-cn">8603</span><span class="crayon-h"> </span><span class="crayon-cn">10523</span><span class="crayon-h"> </span><span class="crayon-cn">10582</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">9895</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5ab1b61386683373184356-12"><span class="crayon-cn">11460</span><span class="crayon-h"> </span><span class="crayon-cn">10123</span><span class="crayon-h"> </span><span class="crayon-cn">11099</span><span class="crayon-h"> </span><span class="crayon-cn">10876</span></div></div></td>
</tr>
</table>
</div>
</div>

<p><code>IndexIVFFlat</code> は各セルの代表ベクトル(母点)を保存しておくための転置ファイル(転置インデックス)用のクラスとなっており、処理手順としてはベクトル量子化処理の学習ステップが一つ増えています(<code>IndexIVFFlat::train</code>)。ここではデータベース登録対象データをそのまま学習に利用していますが、別途用意したデータで学習しても良いです。publicなメンバである <code>nprobe</code> で検索対象のセル数を管理しており、この値を増やすと検索精度の向上と引き替えに検索時間が増えます。上記チュートリアルでは全探索と比較してnprobe=1で15 ~ 20倍、nprobe=10で3 ~ 5倍くらい検索速度が向上しました。</p>
<h5 class="term"><code>faiss::IndexIVFPQ</code></h5>
<p><code>IndexFlatL2</code> および <code>IndexIVFFlat</code> を併用した場合でも、入力ベクトルデータは全て未加工でインデックス登録していました。これでは数億オーダーのデータを全てメモリ上に載せるのは現実問題として困難です(NVMe等ストレージハードウェアも急激に進歩しているのですがここでは考えないこととします)。次は、入力ベクトルデータをProduct Quantization(PQ: 直積量子化)により圧縮することでインデックスするデータ量を削減します。PQはハッシュベースの手法に替わってここ数年の論文等でよく見かけますね。Product Quantizationに関する日本語の概要説明については以下の映像奮闘記さんのエントリーが読みやすくて参考になるかと思います。</p>
<ul>
<li>参考: <a onclick="javascript:pageTracker._trackPageview('/outgoing/mglab.blogspot.com/2011/11/product-quantization.html');" href="http://mglab.blogspot.com/2011/11/product-quantization.html">映像奮闘記: 直積量子化(Product Quantization)を用いた近似最近傍探索についての簡単な解説</a></li>
</ul>
<blockquote>
<ol>
<li>クエリベクトルをM分割し、N/M次元のサブベクトルに分解する</li>
<li>クエリのサブベクトルと、それぞれのコードブックに記された代表ベクトル間の距離を予め計算しておく</li>
<li>それぞれのエントリがどのインデックスに位置しているのか確認し、2で計算した距離を参照して足し算を行う</li>
<li>最小距離をもつエントリを候補として提出する</li>
</ol>
</blockquote>
<p></p>
<div id="crayon-5ab1b61386688776193428" class="crayon-syntax crayon-theme-ado crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 10px; margin-bottom: 10px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div><span class="crayon-language">C++</span></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
... 省略
faiss::IndexFlatL2 quantizer(d);       // the other index

int nlist = 100;
int k = 4;
int m = 8;

// Product Quantizationを伴う転置インデックス
// IndexIVFPQ(Index * quantizer, size_t d, size_t nlist, size_t M, size_t nbits_per_idx)
// 量子化対象のインデックス、データの次元数、転置インデックスのリストサイズ、サブベクトル数、サブベクトルの量子化ビット数
faiss::IndexIVFPQ index(&amp;quantizer, d, nlist, m, 8);  // 8 specifies that each sub-vector is encoded as 8 bits

// 転置インデックス作成のための事前学習(ベクトル量子化処理)
// ここではデータベース登録対象データを利用して学習しているが、別途用意した学習用データを用いて良い
index.train(nb, xb.get());

index.add(nb, xb.get());  // データ登録

{ // sanity check
  auto I = make_unique&lt;long[]&gt;(k * 5);
  auto D = make_unique&lt;float[]&gt;(k * 5);

  index.search(5, xb.get(), k, D.get(), I.get());

  printf("I=\n");
  for(int i = 0; i &lt; 5; i++) {
      for(int j = 0; j &lt; k; j++) printf("%5ld ", I[i * k + j]);
      printf("\n");
  }

  printf("D=\n");
  for(int i = 0; i &lt; 5; i++) {
      for(int j = 0; j &lt; k; j++) printf("%7g ", D[i * k + j]);
      printf("\n");
  }
}

{ // search xq
  auto I = make_unique&lt;long[]&gt;(k * nq);
  auto D = make_unique&lt;float[]&gt;(k * nq);

  index.nprobe = 10;
  index.search(nq, xq.get(), k, D.get(), I.get());

  printf("I=\n");
  for(int i = nq - 5; i &lt; nq; i++) {
      for(int j = 0; j &lt; k; j++) printf("%5ld ", I[i * k + j]);
      printf("\n");
  }
}</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5ab1b61386688776193428-1">1</div><div class="crayon-num" data-line="crayon-5ab1b61386688776193428-2">2</div><div class="crayon-num" data-line="crayon-5ab1b61386688776193428-3">3</div><div class="crayon-num" data-line="crayon-5ab1b61386688776193428-4">4</div><div class="crayon-num" data-line="crayon-5ab1b61386688776193428-5">5</div><div class="crayon-num" data-line="crayon-5ab1b61386688776193428-6">6</div><div class="crayon-num" data-line="crayon-5ab1b61386688776193428-7">7</div><div class="crayon-num" data-line="crayon-5ab1b61386688776193428-8">8</div><div class="crayon-num" data-line="crayon-5ab1b61386688776193428-9">9</div><div class="crayon-num" data-line="crayon-5ab1b61386688776193428-10">10</div><div class="crayon-num" data-line="crayon-5ab1b61386688776193428-11">11</div><div class="crayon-num" data-line="crayon-5ab1b61386688776193428-12">12</div><div class="crayon-num" data-line="crayon-5ab1b61386688776193428-13">13</div><div class="crayon-num" data-line="crayon-5ab1b61386688776193428-14">14</div><div class="crayon-num" data-line="crayon-5ab1b61386688776193428-15">15</div><div class="crayon-num" data-line="crayon-5ab1b61386688776193428-16">16</div><div class="crayon-num" data-line="crayon-5ab1b61386688776193428-17">17</div><div class="crayon-num" data-line="crayon-5ab1b61386688776193428-18">18</div><div class="crayon-num" data-line="crayon-5ab1b61386688776193428-19">19</div><div class="crayon-num" data-line="crayon-5ab1b61386688776193428-20">20</div><div class="crayon-num" data-line="crayon-5ab1b61386688776193428-21">21</div><div class="crayon-num" data-line="crayon-5ab1b61386688776193428-22">22</div><div class="crayon-num" data-line="crayon-5ab1b61386688776193428-23">23</div><div class="crayon-num" data-line="crayon-5ab1b61386688776193428-24">24</div><div class="crayon-num" data-line="crayon-5ab1b61386688776193428-25">25</div><div class="crayon-num" data-line="crayon-5ab1b61386688776193428-26">26</div><div class="crayon-num" data-line="crayon-5ab1b61386688776193428-27">27</div><div class="crayon-num" data-line="crayon-5ab1b61386688776193428-28">28</div><div class="crayon-num" data-line="crayon-5ab1b61386688776193428-29">29</div><div class="crayon-num" data-line="crayon-5ab1b61386688776193428-30">30</div><div class="crayon-num" data-line="crayon-5ab1b61386688776193428-31">31</div><div class="crayon-num" data-line="crayon-5ab1b61386688776193428-32">32</div><div class="crayon-num" data-line="crayon-5ab1b61386688776193428-33">33</div><div class="crayon-num" data-line="crayon-5ab1b61386688776193428-34">34</div><div class="crayon-num" data-line="crayon-5ab1b61386688776193428-35">35</div><div class="crayon-num" data-line="crayon-5ab1b61386688776193428-36">36</div><div class="crayon-num" data-line="crayon-5ab1b61386688776193428-37">37</div><div class="crayon-num" data-line="crayon-5ab1b61386688776193428-38">38</div><div class="crayon-num" data-line="crayon-5ab1b61386688776193428-39">39</div><div class="crayon-num" data-line="crayon-5ab1b61386688776193428-40">40</div><div class="crayon-num" data-line="crayon-5ab1b61386688776193428-41">41</div><div class="crayon-num" data-line="crayon-5ab1b61386688776193428-42">42</div><div class="crayon-num" data-line="crayon-5ab1b61386688776193428-43">43</div><div class="crayon-num" data-line="crayon-5ab1b61386688776193428-44">44</div><div class="crayon-num" data-line="crayon-5ab1b61386688776193428-45">45</div><div class="crayon-num" data-line="crayon-5ab1b61386688776193428-46">46</div><div class="crayon-num" data-line="crayon-5ab1b61386688776193428-47">47</div><div class="crayon-num" data-line="crayon-5ab1b61386688776193428-48">48</div><div class="crayon-num" data-line="crayon-5ab1b61386688776193428-49">49</div><div class="crayon-num" data-line="crayon-5ab1b61386688776193428-50">50</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5ab1b61386688776193428-1"><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-h"> </span>省略</div><div class="crayon-line" id="crayon-5ab1b61386688776193428-2"><span class="crayon-v">faiss</span><span class="crayon-o">::</span><span class="crayon-e">IndexFlatL2 </span><span class="crayon-e">quantizer</span><span class="crayon-sy">(</span><span class="crayon-v">d</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-c">// the other index</span></div><div class="crayon-line" id="crayon-5ab1b61386688776193428-3">&nbsp;</div><div class="crayon-line" id="crayon-5ab1b61386688776193428-4"><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">nlist</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">100</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61386688776193428-5"><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">k</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">4</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61386688776193428-6"><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">m</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">8</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61386688776193428-7">&nbsp;</div><div class="crayon-line" id="crayon-5ab1b61386688776193428-8"><span class="crayon-c">// Product Quantizationを伴う転置インデックス</span></div><div class="crayon-line" id="crayon-5ab1b61386688776193428-9"><span class="crayon-c">// IndexIVFPQ(Index * quantizer, size_t d, size_t nlist, size_t M, size_t nbits_per_idx)</span></div><div class="crayon-line" id="crayon-5ab1b61386688776193428-10"><span class="crayon-c">// 量子化対象のインデックス、データの次元数、転置インデックスのリストサイズ、サブベクトル数、サブベクトルの量子化ビット数</span></div><div class="crayon-line" id="crayon-5ab1b61386688776193428-11"><span class="crayon-v">faiss</span><span class="crayon-o">::</span><span class="crayon-e">IndexIVFPQ </span><span class="crayon-e">index</span><span class="crayon-sy">(</span><span class="crayon-v">&amp;quantizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">d</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">nlist</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">m</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">8</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c">// 8 specifies that each sub-vector is encoded as 8 bits</span></div><div class="crayon-line" id="crayon-5ab1b61386688776193428-12">&nbsp;</div><div class="crayon-line" id="crayon-5ab1b61386688776193428-13"><span class="crayon-c">// 転置インデックス作成のための事前学習(ベクトル量子化処理)</span></div><div class="crayon-line" id="crayon-5ab1b61386688776193428-14"><span class="crayon-c">// ここではデータベース登録対象データを利用して学習しているが、別途用意した学習用データを用いて良い</span></div><div class="crayon-line" id="crayon-5ab1b61386688776193428-15"><span class="crayon-v">index</span><span class="crayon-sy">.</span><span class="crayon-e">train</span><span class="crayon-sy">(</span><span class="crayon-v">nb</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">xb</span><span class="crayon-sy">.</span><span class="crayon-e">get</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61386688776193428-16">&nbsp;</div><div class="crayon-line" id="crayon-5ab1b61386688776193428-17"><span class="crayon-v">index</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-v">nb</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">xb</span><span class="crayon-sy">.</span><span class="crayon-e">get</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-c">// データ登録</span></div><div class="crayon-line" id="crayon-5ab1b61386688776193428-18">&nbsp;</div><div class="crayon-line" id="crayon-5ab1b61386688776193428-19"><span class="crayon-sy">{</span><span class="crayon-h"> </span><span class="crayon-c">// sanity check</span></div><div class="crayon-line" id="crayon-5ab1b61386688776193428-20"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-i">auto</span><span class="crayon-h"> </span><span class="crayon-v">I</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">make_unique</span><span class="crayon-o">&lt;</span><span class="crayon-t">long</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-o">&gt;</span><span class="crayon-sy">(</span><span class="crayon-v">k</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-cn">5</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61386688776193428-21"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-i">auto</span><span class="crayon-h"> </span><span class="crayon-v">D</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">make_unique</span><span class="crayon-o">&lt;</span><span class="crayon-t">float</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-o">&gt;</span><span class="crayon-sy">(</span><span class="crayon-v">k</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-cn">5</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61386688776193428-22">&nbsp;</div><div class="crayon-line" id="crayon-5ab1b61386688776193428-23"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">index</span><span class="crayon-sy">.</span><span class="crayon-e">search</span><span class="crayon-sy">(</span><span class="crayon-cn">5</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">xb</span><span class="crayon-sy">.</span><span class="crayon-e">get</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">k</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">D</span><span class="crayon-sy">.</span><span class="crayon-e">get</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">I</span><span class="crayon-sy">.</span><span class="crayon-e">get</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61386688776193428-24">&nbsp;</div><div class="crayon-line" id="crayon-5ab1b61386688776193428-25"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-e">printf</span><span class="crayon-sy">(</span><span class="crayon-s">"I=\n"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61386688776193428-26"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-st">for</span><span class="crayon-sy">(</span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-cn">5</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-o">++</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5ab1b61386688776193428-27"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">for</span><span class="crayon-sy">(</span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">j</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">j</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-v">k</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">j</span><span class="crayon-o">++</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-e">printf</span><span class="crayon-sy">(</span><span class="crayon-s">"%5ld "</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">I</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">k</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">j</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61386688776193428-28"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">printf</span><span class="crayon-sy">(</span><span class="crayon-s">"\n"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61386688776193428-29"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5ab1b61386688776193428-30">&nbsp;</div><div class="crayon-line" id="crayon-5ab1b61386688776193428-31"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-e">printf</span><span class="crayon-sy">(</span><span class="crayon-s">"D=\n"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61386688776193428-32"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-st">for</span><span class="crayon-sy">(</span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-cn">5</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-o">++</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5ab1b61386688776193428-33"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">for</span><span class="crayon-sy">(</span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">j</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">j</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-v">k</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">j</span><span class="crayon-o">++</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-e">printf</span><span class="crayon-sy">(</span><span class="crayon-s">"%7g "</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">D</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">k</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">j</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61386688776193428-34"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">printf</span><span class="crayon-sy">(</span><span class="crayon-s">"\n"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61386688776193428-35"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5ab1b61386688776193428-36"><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5ab1b61386688776193428-37">&nbsp;</div><div class="crayon-line" id="crayon-5ab1b61386688776193428-38"><span class="crayon-sy">{</span><span class="crayon-h"> </span><span class="crayon-c">// search xq</span></div><div class="crayon-line" id="crayon-5ab1b61386688776193428-39"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-i">auto</span><span class="crayon-h"> </span><span class="crayon-v">I</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">make_unique</span><span class="crayon-o">&lt;</span><span class="crayon-t">long</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-o">&gt;</span><span class="crayon-sy">(</span><span class="crayon-v">k</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">nq</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61386688776193428-40"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-i">auto</span><span class="crayon-h"> </span><span class="crayon-v">D</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">make_unique</span><span class="crayon-o">&lt;</span><span class="crayon-t">float</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-o">&gt;</span><span class="crayon-sy">(</span><span class="crayon-v">k</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">nq</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61386688776193428-41">&nbsp;</div><div class="crayon-line" id="crayon-5ab1b61386688776193428-42"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">index</span><span class="crayon-sy">.</span><span class="crayon-v">nprobe</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">10</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61386688776193428-43"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-v">index</span><span class="crayon-sy">.</span><span class="crayon-e">search</span><span class="crayon-sy">(</span><span class="crayon-v">nq</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">xq</span><span class="crayon-sy">.</span><span class="crayon-e">get</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">k</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">D</span><span class="crayon-sy">.</span><span class="crayon-e">get</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">I</span><span class="crayon-sy">.</span><span class="crayon-e">get</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61386688776193428-44">&nbsp;</div><div class="crayon-line" id="crayon-5ab1b61386688776193428-45"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-e">printf</span><span class="crayon-sy">(</span><span class="crayon-s">"I=\n"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61386688776193428-46"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-st">for</span><span class="crayon-sy">(</span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">nq</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-cn">5</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-v">nq</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-o">++</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5ab1b61386688776193428-47"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-st">for</span><span class="crayon-sy">(</span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">j</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">j</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-v">k</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">j</span><span class="crayon-o">++</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-e">printf</span><span class="crayon-sy">(</span><span class="crayon-s">"%5ld "</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">I</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">k</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">j</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61386688776193428-48"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">printf</span><span class="crayon-sy">(</span><span class="crayon-s">"\n"</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5ab1b61386688776193428-49"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5ab1b61386688776193428-50"><span class="crayon-sy">}</span></div></div></td>
</tr>
</table>
</div>
</div>

<p></p>
<p>* 出力結果例</p>
<div id="crayon-5ab1b6138668e639853823" class="crayon-syntax crayon-theme-ado crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover wrap" style=" margin-top: 10px; margin-bottom: 10px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" show" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
I=
    0    66   283   647 
    1   658   421     8 
    2   349  1111    37 
    3   626   139   199 
    4    38   276   717 
## sanity checkではインデックス済みデータをクエリとして検索しているが、検索結果1位の距離は0にはならない
D=
1.68216 6.97229 7.07727 7.20292
1.33991 6.47805 6.49344  6.8318 
1.21912 6.37759 6.40442 6.42391 
1.51774 5.83502 6.08639 6.62265 
 1.4905 6.57351 6.84026 6.85133 
I=
10049 10053  9608  9938 
10880 10392 10135  9812 
10815 10660 10361  9747 
 9946  9921  9511  9246 
10876  9250 10123 10869</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5ab1b6138668e639853823-1">1</div><div class="crayon-num" data-line="crayon-5ab1b6138668e639853823-2">2</div><div class="crayon-num" data-line="crayon-5ab1b6138668e639853823-3">3</div><div class="crayon-num" data-line="crayon-5ab1b6138668e639853823-4">4</div><div class="crayon-num" data-line="crayon-5ab1b6138668e639853823-5">5</div><div class="crayon-num" data-line="crayon-5ab1b6138668e639853823-6">6</div><div class="crayon-num" data-line="crayon-5ab1b6138668e639853823-7">7</div><div class="crayon-num" data-line="crayon-5ab1b6138668e639853823-8">8</div><div class="crayon-num" data-line="crayon-5ab1b6138668e639853823-9">9</div><div class="crayon-num" data-line="crayon-5ab1b6138668e639853823-10">10</div><div class="crayon-num" data-line="crayon-5ab1b6138668e639853823-11">11</div><div class="crayon-num" data-line="crayon-5ab1b6138668e639853823-12">12</div><div class="crayon-num" data-line="crayon-5ab1b6138668e639853823-13">13</div><div class="crayon-num" data-line="crayon-5ab1b6138668e639853823-14">14</div><div class="crayon-num" data-line="crayon-5ab1b6138668e639853823-15">15</div><div class="crayon-num" data-line="crayon-5ab1b6138668e639853823-16">16</div><div class="crayon-num" data-line="crayon-5ab1b6138668e639853823-17">17</div><div class="crayon-num" data-line="crayon-5ab1b6138668e639853823-18">18</div><div class="crayon-num" data-line="crayon-5ab1b6138668e639853823-19">19</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5ab1b6138668e639853823-1"><span class="crayon-v">I</span><span class="crayon-o">=</span></div><div class="crayon-line" id="crayon-5ab1b6138668e639853823-2"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">0</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">66</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">283</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">647</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5ab1b6138668e639853823-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">1</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">658</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">421</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp; </span><span class="crayon-cn">8</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5ab1b6138668e639853823-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">2</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">349</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">1111</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">37</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5ab1b6138668e639853823-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">3</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">626</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">139</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">199</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5ab1b6138668e639853823-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">4</span><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-cn">38</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">276</span><span class="crayon-h">&nbsp;&nbsp; </span><span class="crayon-cn">717</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5ab1b6138668e639853823-7"><span class="crayon-p">## sanity checkではインデックス済みデータをクエリとして検索しているが、検索結果1位の距離は0にはならない</span></div><div class="crayon-line" id="crayon-5ab1b6138668e639853823-8"><span class="crayon-v">D</span><span class="crayon-o">=</span></div><div class="crayon-line" id="crayon-5ab1b6138668e639853823-9"><span class="crayon-cn">1.68216</span><span class="crayon-h"> </span><span class="crayon-cn">6.97229</span><span class="crayon-h"> </span><span class="crayon-cn">7.07727</span><span class="crayon-h"> </span><span class="crayon-cn">7.20292</span></div><div class="crayon-line" id="crayon-5ab1b6138668e639853823-10"><span class="crayon-cn">1.33991</span><span class="crayon-h"> </span><span class="crayon-cn">6.47805</span><span class="crayon-h"> </span><span class="crayon-cn">6.49344</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">6.8318</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5ab1b6138668e639853823-11"><span class="crayon-cn">1.21912</span><span class="crayon-h"> </span><span class="crayon-cn">6.37759</span><span class="crayon-h"> </span><span class="crayon-cn">6.40442</span><span class="crayon-h"> </span><span class="crayon-cn">6.42391</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5ab1b6138668e639853823-12"><span class="crayon-cn">1.51774</span><span class="crayon-h"> </span><span class="crayon-cn">5.83502</span><span class="crayon-h"> </span><span class="crayon-cn">6.08639</span><span class="crayon-h"> </span><span class="crayon-cn">6.62265</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5ab1b6138668e639853823-13"><span class="crayon-h"> </span><span class="crayon-cn">1.4905</span><span class="crayon-h"> </span><span class="crayon-cn">6.57351</span><span class="crayon-h"> </span><span class="crayon-cn">6.84026</span><span class="crayon-h"> </span><span class="crayon-cn">6.85133</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5ab1b6138668e639853823-14"><span class="crayon-v">I</span><span class="crayon-o">=</span></div><div class="crayon-line" id="crayon-5ab1b6138668e639853823-15"><span class="crayon-cn">10049</span><span class="crayon-h"> </span><span class="crayon-cn">10053</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">9608</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">9938</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5ab1b6138668e639853823-16"><span class="crayon-cn">10880</span><span class="crayon-h"> </span><span class="crayon-cn">10392</span><span class="crayon-h"> </span><span class="crayon-cn">10135</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">9812</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5ab1b6138668e639853823-17"><span class="crayon-cn">10815</span><span class="crayon-h"> </span><span class="crayon-cn">10660</span><span class="crayon-h"> </span><span class="crayon-cn">10361</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">9747</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5ab1b6138668e639853823-18"><span class="crayon-h"> </span><span class="crayon-cn">9946</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">9921</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">9511</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">9246</span><span class="crayon-h"> </span></div><div class="crayon-line" id="crayon-5ab1b6138668e639853823-19"><span class="crayon-cn">10876</span><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-cn">9250</span><span class="crayon-h"> </span><span class="crayon-cn">10123</span><span class="crayon-h"> </span><span class="crayon-cn">10869</span></div></div></td>
</tr>
</table>
</div>
</div>

<p><code>IndexIVFPQ</code> はPQを伴う転置ファイル用クラスです。上記チュートリアルではサブベクトル数を8、各サブベクトルは8bitsにベクトル量子化されます。つまり、元データは64(次元数)*32(float)=2048bits、PQすると8*8=64bitsとなり32分の1のデータサイズとなります。また、各サブベクトル毎の距離計算は独立しているため並列処理とも相性が良さそうです。<code>IndexFlatL2</code> による全探索(線形探索)結果を比較すると量子化の影響は見られますが、高い精度を維持できていることが確認できます。</p>
<p>注意点として、<u>C++版チュートリアルのコードはGPUではなくCPUで動作します。</u>GPU版実装の詳細は次回パート以降に紹介する予定です。</p>
<h3 class="term">おわりに</h3>
<p>今回はチュートリアルレベルの内容でしたので特に目新しい部分は無かったかと思います。Faissの論文は一通り読みましたが、主にGPU上で効率的に計算するアルゴリズムの記述が主でしたので、次パート以降はその理論や実装面についても深掘りしていきたいと思います。</p>
<p>SSEやOpenMP、CUDAを活用した処理は学生時代にけっこう勉強したんですけど、すっかり知識が抜けていたので焦りました。普段のWebアプリケーション開発の現場だと触れる機会がないですから、この分野の技術はプライベートの時間を使ってじっくり学んでいきたいです。</p>
<h3 class="term">参考</h3>
<ul>
<li><a onclick="javascript:pageTracker._trackPageview('/outgoing/code.facebook.com/posts/1373769912645926/faiss-a-library-for-efficient-similarity-search/');" href="https://code.facebook.com/posts/1373769912645926/faiss-a-library-for-efficient-similarity-search/">Faiss: A library for efficient similarity search | Engineering Blog | Facebook Code | Facebook</a></li>
<li><a onclick="javascript:pageTracker._trackPageview('/outgoing/arxiv.org/abs/1702.08734');" href="https://arxiv.org/abs/1702.08734">[1702.08734] Billion-scale similarity search with GPUs</a></li>
<li><a onclick="javascript:pageTracker._trackPageview('/outgoing/hal.archives-ouvertes.fr/file/index/docid/514462/filename/paper_hal.pdf');" href="https://hal.archives-ouvertes.fr/file/index/docid/514462/filename/paper_hal.pdf">Product Quantization for Nearest Neighbor Search</a></li>
<li><a onclick="javascript:pageTracker._trackPageview('/outgoing/mglab.blogspot.com/2011/11/product-quantization.html');" href="http://mglab.blogspot.com/2011/11/product-quantization.html">映像奮闘記: 直積量子化(Product Quantization)を用いた近似最近傍探索についての簡単な解説</a></li>
</ul>
<div class="clearer">&nbsp;</div>
<p>Tags: <a href="http://rest-term.com/archives/tag/algorithm/" rel="tag">algorithm</a>, <a href="http://rest-term.com/archives/tag/cc/" rel="tag">c/c++</a>, <a href="http://rest-term.com/archives/tag/hardware/" rel="tag">hardware</a></p> </div>
</div>
<div class="pagination archive-pagination pagination-bottom">
<div class="left">&nbsp;&nbsp;</div>
<div class="right">&nbsp;<a href="http://rest-term.com/page/2/">次ページへ &raquo;</a></div>
<div class="clearer">&nbsp;</div>
</div>
</div>
<div class="right" id="sidebar">
<div class="section widget widget_text" id="text-197698474"><div class="section-title">Author</div> <div class="textwidget"><div id="author">
<p><a title="about" href="http://rest-term.com/about"><strong>rest-term.com</strong></a></p>
<p class="sprite-github"><a href="https://github.com/wellflat">GitHub wellflat&#8217;s Profile</a></p>
<div class="github-badge"><iframe src="http://githubbadge.appspot.com/wellflat?s=1" frameborder="0"></iframe></div>
<p><a href="http://cloud.feedly.com/#subscription%2Ffeed%2Fhttp%3A%2F%2Ffeeds.feedburner.com%2Frest-term" target="blank"><img id="feedlyFollow" src="http://s3.feedly.com/img/follows/feedly-follow-rectangle-flat-big_2x.png" alt="follow us in feedly" width="131" height="56" /></a></p>
<p></p>
</div>
</div>
</div><div class="section widget widget_search" id="search-2"><div class="section-title">Search</div><form role="search" method="get" id="searchform" class="searchform" action="http://rest-term.com/">
<div>
<label class="screen-reader-text" for="s">検索:</label>
<input type="text" value="" name="s" id="s" />
<input type="submit" id="searchsubmit" value="検索" />
</div>
</form></div>

<div class="section widget popular-posts" id="wpp-3">
<div class="section-title">Recently Viewed Entries</div>
<ul class="wpp-list">
<li><a title='<a href="http://rest-term.com/archives/2999/" title="Pythonの数値計算ライブラリ NumPy入門" class="wpp-post-title" target="_self">Pythonの数値計算ライブラリ NumPy入門</a>' href='http://rest-term.com/archives/2999/'><a href="http://rest-term.com/archives/2999/" title="Pythonの数値計算ライブラリ NumPy入門" class="wpp-post-title" target="_self">Pythonの数値計算ライブラリ NumPy入門</a></a><a href='http://b.hatena.ne.jp/entry/http://rest-term.com/archives/2999/' target='_blank'>&nbsp;<img src='http://b.hatena.ne.jp/entry/image/http://rest-term.com/archives/2999/' /></a></li>
<li><a title='<a href="http://rest-term.com/archives/3131/" title="ねこと画像処理 part 2 &#8211; 猫検出 (モデル配布)" class="wpp-post-title" target="_self">ねこと画像処理 part 2 &#8211; 猫検出 (モデル配布)</a>' href='http://rest-term.com/archives/3131/'><a href="http://rest-term.com/archives/3131/" title="ねこと画像処理 part 2 &#8211; 猫検出 (モデル配布)" class="wpp-post-title" target="_self">ねこと画像処理 part 2 &#8211; 猫検出 (モデル配布)</a></a><a href='http://b.hatena.ne.jp/entry/http://rest-term.com/archives/3131/' target='_blank'>&nbsp;<img src='http://b.hatena.ne.jp/entry/image/http://rest-term.com/archives/3131/' /></a></li>
<li><a title='<a href="http://rest-term.com/archives/3172/" title="ねこと画像処理 part 3 – Deep Learningで猫の品種識別" class="wpp-post-title" target="_self">ねこと画像処理 part 3 – Deep Learningで猫の品種識別</a>' href='http://rest-term.com/archives/3172/'><a href="http://rest-term.com/archives/3172/" title="ねこと画像処理 part 3 – Deep Learningで猫の品種識別" class="wpp-post-title" target="_self">ねこと画像処理 part 3 – Deep Learningで猫の品種識別</a></a><a href='http://b.hatena.ne.jp/entry/http://rest-term.com/archives/3172/' target='_blank'>&nbsp;<img src='http://b.hatena.ne.jp/entry/image/http://rest-term.com/archives/3172/' /></a></li>
<li><a title='<a href="http://rest-term.com/archives/3269/" title="OpenCVのDeep Learningモジュールの紹介" class="wpp-post-title" target="_self">OpenCVのDeep Learningモジュールの紹介</a>' href='http://rest-term.com/archives/3269/'><a href="http://rest-term.com/archives/3269/" title="OpenCVのDeep Learningモジュールの紹介" class="wpp-post-title" target="_self">OpenCVのDeep Learningモジュールの紹介</a></a><a href='http://b.hatena.ne.jp/entry/http://rest-term.com/archives/3269/' target='_blank'>&nbsp;<img src='http://b.hatena.ne.jp/entry/image/http://rest-term.com/archives/3269/' /></a></li>
<li><a title='<a href="http://rest-term.com/archives/3010/" title="OpenCV for Android入門 &#8211; カメラ編" class="wpp-post-title" target="_self">OpenCV for Android入門 &#8211; カメラ編</a>' href='http://rest-term.com/archives/3010/'><a href="http://rest-term.com/archives/3010/" title="OpenCV for Android入門 &#8211; カメラ編" class="wpp-post-title" target="_self">OpenCV for Android入門 &#8211; カメラ編</a></a><a href='http://b.hatena.ne.jp/entry/http://rest-term.com/archives/3010/' target='_blank'>&nbsp;<img src='http://b.hatena.ne.jp/entry/image/http://rest-term.com/archives/3010/' /></a></li>
<li><a title='<a href="http://rest-term.com/archives/3138/" title="C/C++のユニットテストフレームワーク CppUTest が便利" class="wpp-post-title" target="_self">C/C++のユニットテストフレームワーク CppUTest が便利</a>' href='http://rest-term.com/archives/3138/'><a href="http://rest-term.com/archives/3138/" title="C/C++のユニットテストフレームワーク CppUTest が便利" class="wpp-post-title" target="_self">C/C++のユニットテストフレームワーク CppUTest が便利</a></a><a href='http://b.hatena.ne.jp/entry/http://rest-term.com/archives/3138/' target='_blank'>&nbsp;<img src='http://b.hatena.ne.jp/entry/image/http://rest-term.com/archives/3138/' /></a></li>
<li><a title='<a href="http://rest-term.com/archives/3008/" title="NginxとFFmpegを利用したHTTP Live Streaming配信" class="wpp-post-title" target="_self">NginxとFFmpegを利用したHTTP Live Streaming配信</a>' href='http://rest-term.com/archives/3008/'><a href="http://rest-term.com/archives/3008/" title="NginxとFFmpegを利用したHTTP Live Streaming配信" class="wpp-post-title" target="_self">NginxとFFmpegを利用したHTTP Live Streaming配信</a></a><a href='http://b.hatena.ne.jp/entry/http://rest-term.com/archives/3008/' target='_blank'>&nbsp;<img src='http://b.hatena.ne.jp/entry/image/http://rest-term.com/archives/3008/' /></a></li>
<li><a title='<a href="http://rest-term.com/archives/2484/" title="OpenCV 2.0 &#8211; cv::Mat 行列演算" class="wpp-post-title" target="_self">OpenCV 2.0 &#8211; cv::Mat 行列演算</a>' href='http://rest-term.com/archives/2484/'><a href="http://rest-term.com/archives/2484/" title="OpenCV 2.0 &#8211; cv::Mat 行列演算" class="wpp-post-title" target="_self">OpenCV 2.0 &#8211; cv::Mat 行列演算</a></a><a href='http://b.hatena.ne.jp/entry/http://rest-term.com/archives/2484/' target='_blank'>&nbsp;<img src='http://b.hatena.ne.jp/entry/image/http://rest-term.com/archives/2484/' /></a></li>
<li><a title='<a href="http://rest-term.com/archives/3045/" title="Redisの監視/分析系ツールまとめ" class="wpp-post-title" target="_self">Redisの監視/分析系ツールまとめ</a>' href='http://rest-term.com/archives/3045/'><a href="http://rest-term.com/archives/3045/" title="Redisの監視/分析系ツールまとめ" class="wpp-post-title" target="_self">Redisの監視/分析系ツールまとめ</a></a><a href='http://b.hatena.ne.jp/entry/http://rest-term.com/archives/3045/' target='_blank'>&nbsp;<img src='http://b.hatena.ne.jp/entry/image/http://rest-term.com/archives/3045/' /></a></li>
<li><a title='<a href="http://rest-term.com/archives/1777/" title="位相限定相関法" class="wpp-post-title" target="_self">位相限定相関法</a>' href='http://rest-term.com/archives/1777/'><a href="http://rest-term.com/archives/1777/" title="位相限定相関法" class="wpp-post-title" target="_self">位相限定相関法</a></a><a href='http://b.hatena.ne.jp/entry/http://rest-term.com/archives/1777/' target='_blank'>&nbsp;<img src='http://b.hatena.ne.jp/entry/image/http://rest-term.com/archives/1777/' /></a></li>
<li><a title='<a href="http://rest-term.com/archives/2846/" title="パーティクルフィルタによる物体追跡" class="wpp-post-title" target="_self">パーティクルフィルタによる物体追跡</a>' href='http://rest-term.com/archives/2846/'><a href="http://rest-term.com/archives/2846/" title="パーティクルフィルタによる物体追跡" class="wpp-post-title" target="_self">パーティクルフィルタによる物体追跡</a></a><a href='http://b.hatena.ne.jp/entry/http://rest-term.com/archives/2846/' target='_blank'>&nbsp;<img src='http://b.hatena.ne.jp/entry/image/http://rest-term.com/archives/2846/' /></a></li>
<li><a title='<a href="http://rest-term.com/archives/2445/" title="OpenCV 2.0 &#8211; cv::Mat" class="wpp-post-title" target="_self">OpenCV 2.0 &#8211; cv::Mat</a>' href='http://rest-term.com/archives/2445/'><a href="http://rest-term.com/archives/2445/" title="OpenCV 2.0 &#8211; cv::Mat" class="wpp-post-title" target="_self">OpenCV 2.0 &#8211; cv::Mat</a></a><a href='http://b.hatena.ne.jp/entry/http://rest-term.com/archives/2445/' target='_blank'>&nbsp;<img src='http://b.hatena.ne.jp/entry/image/http://rest-term.com/archives/2445/' /></a></li>
<li><a title='<a href="http://rest-term.com/archives/3393/" title="JavaScriptでLSDによる高精度な直線検出" class="wpp-post-title" target="_self">JavaScriptでLSDによる高精度な直線検出</a>' href='http://rest-term.com/archives/3393/'><a href="http://rest-term.com/archives/3393/" title="JavaScriptでLSDによる高精度な直線検出" class="wpp-post-title" target="_self">JavaScriptでLSDによる高精度な直線検出</a></a><a href='http://b.hatena.ne.jp/entry/http://rest-term.com/archives/3393/' target='_blank'>&nbsp;<img src='http://b.hatena.ne.jp/entry/image/http://rest-term.com/archives/3393/' /></a></li>
<li><a title='<a href="http://rest-term.com/archives/3287/" title="Linuxカーネル Docker関連 namespaceのメモ" class="wpp-post-title" target="_self">Linuxカーネル Docker関連 namespaceのメモ</a>' href='http://rest-term.com/archives/3287/'><a href="http://rest-term.com/archives/3287/" title="Linuxカーネル Docker関連 namespaceのメモ" class="wpp-post-title" target="_self">Linuxカーネル Docker関連 namespaceのメモ</a></a><a href='http://b.hatena.ne.jp/entry/http://rest-term.com/archives/3287/' target='_blank'>&nbsp;<img src='http://b.hatena.ne.jp/entry/image/http://rest-term.com/archives/3287/' /></a></li>
<li><a title='<a href="http://rest-term.com/archives/3038/" title="RedisのLuaスクリプティング機能について" class="wpp-post-title" target="_self">RedisのLuaスクリプティング機能について</a>' href='http://rest-term.com/archives/3038/'><a href="http://rest-term.com/archives/3038/" title="RedisのLuaスクリプティング機能について" class="wpp-post-title" target="_self">RedisのLuaスクリプティング機能について</a></a><a href='http://b.hatena.ne.jp/entry/http://rest-term.com/archives/3038/' target='_blank'>&nbsp;<img src='http://b.hatena.ne.jp/entry/image/http://rest-term.com/archives/3038/' /></a></li>
</ul>
</div>
<div class="section widget widget_recent_entries" id="recent-posts-2"> <div class="section-title">Recent Entries</div> <ul>
<li>
<a href="http://rest-term.com/archives/3434/">libvipsで高速省メモリな画像処理 part1</a>
</li>
<li>
<a href="http://rest-term.com/archives/3426/">JavaScriptで機械学習の実装 5 Gradient Boosting</a>
</li>
<li>
<a href="http://rest-term.com/archives/3418/">GPU対応の類似検索(最近傍探索)ライブラリ Faissの紹介 part2 GPUを利用した検索</a>
</li>
<li>
<a href="http://rest-term.com/archives/3414/">GPU対応の類似検索(最近傍探索)ライブラリ Faissの紹介 part1 導入/チュートリアル</a>
</li>
<li>
<a href="http://rest-term.com/archives/3410/">NumPy入門記事をアップデートしました</a>
</li>
<li>
<a href="http://rest-term.com/archives/3393/">JavaScriptでLSDによる高精度な直線検出</a>
</li>
<li>
<a href="http://rest-term.com/archives/3383/">PCパーツ新調メモ 2017/01</a>
</li>
<li>
<a href="http://rest-term.com/archives/3371/">JavaScriptで機械学習の実装 4 SCW</a>
</li>
<li>
<a href="http://rest-term.com/archives/3330/">GTC Japan 2016 参加レポート</a>
</li>
<li>
<a href="http://rest-term.com/archives/3321/">IoT関連のサンプルコードと技術メモ</a>
</li>
<li>
<a href="http://rest-term.com/archives/3315/">JavaScriptで機械学習の実装 3 AROW</a>
</li>
<li>
<a href="http://rest-term.com/archives/3303/">Linuxカーネル Docker関連 cgroupsのメモ</a>
</li>
</ul>
</div><div class="section widget widget_tag_cloud" id="tag_cloud-2"><div class="section-title">Tags</div><div class="tagcloud"><a href="http://rest-term.com/archives/tag/as/" class="tag-cloud-link tag-link-18 tag-link-position-1" style="font-size: 21.820512820513pt;" aria-label="actionscript (68個の項目)">actionscript</a>
<a href="http://rest-term.com/archives/tag/air/" class="tag-cloud-link tag-link-36 tag-link-position-2" style="font-size: 9.6153846153846pt;" aria-label="air (2個の項目)">air</a>
<a href="http://rest-term.com/archives/tag/algorithm/" class="tag-cloud-link tag-link-42 tag-link-position-3" style="font-size: 19.487179487179pt;" aria-label="algorithm (37個の項目)">algorithm</a>
<a href="http://rest-term.com/archives/tag/android/" class="tag-cloud-link tag-link-37 tag-link-position-4" style="font-size: 8pt;" aria-label="android (1個の項目)">android</a>
<a href="http://rest-term.com/archives/tag/cc/" class="tag-cloud-link tag-link-11 tag-link-position-5" style="font-size: 19.576923076923pt;" aria-label="c/c++ (38個の項目)">c/c++</a>
<a href="http://rest-term.com/archives/tag/cat/" class="tag-cloud-link tag-link-44 tag-link-position-6" style="font-size: 10.692307692308pt;" aria-label="cat (3個の項目)">cat</a>
<a href="http://rest-term.com/archives/tag/css/" class="tag-cloud-link tag-link-28 tag-link-position-7" style="font-size: 9.6153846153846pt;" aria-label="css (2個の項目)">css</a>
<a href="http://rest-term.com/archives/tag/cvim/" class="tag-cloud-link tag-link-17 tag-link-position-8" style="font-size: 22pt;" aria-label="cv/im (71個の項目)">cv/im</a>
<a href="http://rest-term.com/archives/tag/database/" class="tag-cloud-link tag-link-27 tag-link-position-9" style="font-size: 16.615384615385pt;" aria-label="database (17個の項目)">database</a>
<a href="http://rest-term.com/archives/tag/flash/" class="tag-cloud-link tag-link-4 tag-link-position-10" style="font-size: 17.961538461538pt;" aria-label="flash (25個の項目)">flash</a>
<a href="http://rest-term.com/archives/tag/flex/" class="tag-cloud-link tag-link-5 tag-link-position-11" style="font-size: 18.320512820513pt;" aria-label="flex (27個の項目)">flex</a>
<a href="http://rest-term.com/archives/tag/font/" class="tag-cloud-link tag-link-6 tag-link-position-12" style="font-size: 13.384615384615pt;" aria-label="font (7個の項目)">font</a>
<a href="http://rest-term.com/archives/tag/hadoop/" class="tag-cloud-link tag-link-30 tag-link-position-13" style="font-size: 10.692307692308pt;" aria-label="hadoop (3個の項目)">hadoop</a>
<a href="http://rest-term.com/archives/tag/hardware/" class="tag-cloud-link tag-link-46 tag-link-position-14" style="font-size: 13.384615384615pt;" aria-label="hardware (7個の項目)">hardware</a>
<a href="http://rest-term.com/archives/tag/java/" class="tag-cloud-link tag-link-13 tag-link-position-15" style="font-size: 15pt;" aria-label="java (11個の項目)">java</a>
<a href="http://rest-term.com/archives/tag/javascript/" class="tag-cloud-link tag-link-22 tag-link-position-16" style="font-size: 18.679487179487pt;" aria-label="javascript (30個の項目)">javascript</a>
<a href="http://rest-term.com/archives/tag/lua/" class="tag-cloud-link tag-link-40 tag-link-position-17" style="font-size: 9.6153846153846pt;" aria-label="lua (2個の項目)">lua</a>
<a href="http://rest-term.com/archives/tag/ml/" class="tag-cloud-link tag-link-41 tag-link-position-18" style="font-size: 15.269230769231pt;" aria-label="ml (12個の項目)">ml</a>
<a href="http://rest-term.com/archives/tag/network/" class="tag-cloud-link tag-link-33 tag-link-position-19" style="font-size: 12.935897435897pt;" aria-label="network (6個の項目)">network</a>
<a href="http://rest-term.com/archives/tag/ops/" class="tag-cloud-link tag-link-32 tag-link-position-20" style="font-size: 14.641025641026pt;" aria-label="ops (10個の項目)">ops</a>
<a href="http://rest-term.com/archives/tag/perl/" class="tag-cloud-link tag-link-26 tag-link-position-21" style="font-size: 13.384615384615pt;" aria-label="perl (7個の項目)">perl</a>
<a href="http://rest-term.com/archives/tag/php/" class="tag-cloud-link tag-link-16 tag-link-position-22" style="font-size: 13.833333333333pt;" aria-label="php (8個の項目)">php</a>
<a href="http://rest-term.com/archives/tag/python/" class="tag-cloud-link tag-link-31 tag-link-position-23" style="font-size: 15pt;" aria-label="python (11個の項目)">python</a>
<a href="http://rest-term.com/archives/tag/ruby/" class="tag-cloud-link tag-link-29 tag-link-position-24" style="font-size: 11.589743589744pt;" aria-label="ruby (4個の項目)">ruby</a>
<a href="http://rest-term.com/archives/tag/scala/" class="tag-cloud-link tag-link-39 tag-link-position-25" style="font-size: 8pt;" aria-label="scala (1個の項目)">scala</a>
<a href="http://rest-term.com/archives/tag/service/" class="tag-cloud-link tag-link-34 tag-link-position-26" style="font-size: 15pt;" aria-label="service (11個の項目)">service</a>
<a href="http://rest-term.com/archives/tag/tool/" class="tag-cloud-link tag-link-12 tag-link-position-27" style="font-size: 17.333333333333pt;" aria-label="tool (21個の項目)">tool</a>
<a href="http://rest-term.com/archives/tag/typescript/" class="tag-cloud-link tag-link-45 tag-link-position-28" style="font-size: 11.589743589744pt;" aria-label="typescript (4個の項目)">typescript</a>
<a href="http://rest-term.com/archives/tag/unixlinux/" class="tag-cloud-link tag-link-19 tag-link-position-29" style="font-size: 15pt;" aria-label="unix/linux (11個の項目)">unix/linux</a>
<a href="http://rest-term.com/archives/tag/video/" class="tag-cloud-link tag-link-38 tag-link-position-30" style="font-size: 9.6153846153846pt;" aria-label="video (2個の項目)">video</a></div>
</div><div class="section widget widget_mycategoryorder" id="mycategoryorder-2"><div class="section-title">Categories</div> <ul>
<li class="cat-item cat-item-3"><a href="http://rest-term.com/archives/category/tech/">tech/study</a>
</li>
<li class="cat-item cat-item-7"><a href="http://rest-term.com/archives/category/design/">design/art</a>
</li>
<li class="cat-item cat-item-8"><a href="http://rest-term.com/archives/category/diary/">diary/work</a>
</li>
<li class="cat-item cat-item-1"><a href="http://rest-term.com/archives/category/nonsorted/">nonsorted</a>
</li>
</ul>
</div><div class="section widget widget_text" id="text-197698473"><div class="section-title">Bookmarks</div> <div class="textwidget">

<p><img src="http://rest-term.com/wp-content/themes/simple-organization/img/tophatenar_chart.png?x45852" width="160" height="120" border="0"></p>
</div>
</div><div class="section widget widget_text" id="text-197698472"><div class="section-title">RSS</div> <div class="textwidget"><p><a href='http://cloud.feedly.com/#subscription%2Ffeed%2Fhttp%3A%2F%2Ffeeds.feedburner.com%2Frest-term' target='blank'><img id='feedlyFollow' src='http://s3.feedly.com/img/follows/feedly-follow-rectangle-flat-big_2x.png' alt='follow us in feedly' width='131' height='56'></a></p>
<p><a href="http://reader.livedoor.com/subscribe/http://rest-term.com" target="_blank" title="Subscribe with livedoor Reader"><img src="http://rest-term.com/wp-content/themes/simple-organization/img/livedoor_banner.gif?x45852" border="0" width="91" height="17" alt="Subscribe with livedoor Reader"></a></p></div>
</div></div>
<div class="clearer">&nbsp;</div>
</div>
<div id="footer">
<div class="left" id="footer-left">

<p>&copy; 2018 Rest Term.</p>
<div class="clearer">&nbsp;</div>
</div>
<div class="right" id="footer-right">
<p class="large">

<a href="#top" class="quiet">Page Top &uarr;</a></p>
</div>
<div class="clearer">&nbsp;</div>
</div>
</div>

<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
var pageTracker = _gat._getTracker("UA-4840440-1");
pageTracker._initData();
pageTracker._trackPageview();
</script>


<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

<link rel='stylesheet' id='crayon-css' href='http://rest-term.com/wp-content/plugins/crayon-syntax-highlighter/css/min/crayon.min.css?x45852' type='text/css' media='all' />
<script type='text/javascript' src='http://rest-term.com/wp-content/plugins/lazy-load/js/jquery.sonar.min.js?x45852'></script>
<script type='text/javascript' src='http://rest-term.com/wp-content/plugins/lazy-load/js/lazy-load.js?x45852'></script>
<script type='text/javascript' src='http://rest-term.com/wp-includes/js/wp-embed.min.js?x45852'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var CrayonSyntaxSettings = {"version":"_2.7.2_beta","is_admin":"0","ajaxurl":"http:\/\/rest-term.com\/wp-admin\/admin-ajax.php","prefix":"crayon-","setting":"crayon-setting","selected":"crayon-setting-selected","changed":"crayon-setting-changed","special":"crayon-setting-special","orig_value":"data-orig-value","debug":""};
var CrayonSyntaxStrings = {"copy":"Press %s to Copy, %s to Paste","minimize":"Click To Expand Code"};
/* ]]> */
</script>
<script type='text/javascript' src='http://rest-term.com/wp-content/plugins/crayon-syntax-highlighter/js/min/crayon.min.js?x45852'></script>

</body></html>