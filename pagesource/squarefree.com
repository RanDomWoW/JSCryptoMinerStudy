<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head profile="http://gmpg.org/xfn/11">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

    <title>Jesse Ruderman </title>
    
    <link rel="stylesheet" href="http://www.squarefree.com/wp-content/themes/indistinguishable-from-jesse/style.css" type="text/css" media="screen" />
    <link rel="alternate" type="application/atom+xml" title="Atom 0.3" href="http://www.squarefree.com/feed/atom/" />
    <link rel="pingback" href="http://www.squarefree.com/xmlrpc.php" />

    <style type="text/css" media="screen">
    
        /* BEGIN IMAGE CSS */
            /*    To accomodate differing install paths of WordPress, images are referred only here,
                and not in the wp-layout.css file. If you prefer to use only CSS for colors and what
                not, then go right ahead and delete the following lines, and the image files. */
            
        body         { background: url("http://www.squarefree.com/wp-content/themes/indistinguishable-from-jesse/images/kubrickbgcolor.jpg"); }                #page        { background: url("http://www.squarefree.com/wp-content/themes/indistinguishable-from-jesse/images/kubrickbg.jpg") repeat-y top; border: none; }             #header     { background: url("http://www.squarefree.com/wp-content/themes/indistinguishable-from-jesse/images/kubrickheader.jpg") no-repeat bottom center; }
            #footer     { background: url("http://www.squarefree.com/wp-content/themes/indistinguishable-from-jesse/images/kubrickfooter.jpg") no-repeat bottom; border: none;}
            
            
            /*    Because the template is slightly different, size-wise, with images, this needs to be set here
                If you don't want to use the template's images, you can also delete the following two lines. */
            
            #header     { margin: 0 !important; margin: 0 0 0 1px; padding: 1px; height: 198px; width: 758px; }
            #headerimg     { margin: 7px 9px 0; height: 192px; width: 740px; } 
        /* END IMAGE CSS */
        
    
        /*     To ease the insertion of a personal header image, I have done it in such a way,
            that you simply drop in an image called 'personalheader.jpg' into your /images/
            directory. Dimensions should be at least 760px x 200px. Anything above that will
            get cropped off of the image. */
        
        /*
        #headerimg     { background: url('http://www.squarefree.com/wp-content/themes/indistinguishable-from-jesse/images/personalheader.jpg') no-repeat top;}
        */

    </style>


    		<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/www.squarefree.com\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.5.13"}};
			!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;if(!g||!g.fillText)return!1;switch(g.textBaseline="top",g.font="600 32px Arial",a){case"flag":return g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3;case"diversity":return g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,d=c[0]+","+c[1]+","+c[2]+","+c[3],g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e;case"simple":return g.fillText(h(55357,56835),0,0),0!==g.getImageData(16,16,1,1).data[0];case"unicode8":return g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0]}return!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g,h,i;for(i=Array("simple","flag","unicode8","diversity"),c.supports={everything:!0,everythingExceptFlag:!0},h=0;h<i.length;h++)c.supports[i[h]]=d(i[h]),c.supports.everything=c.supports.everything&&c.supports[i[h]],"flag"!==i[h]&&(c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&c.supports[i[h]]);c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&!c.supports.flag,c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.everything||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
<link rel='https://api.w.org/' href='http://www.squarefree.com/wp-json/' />
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://www.squarefree.com/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://www.squarefree.com/wp-includes/wlwmanifest.xml" /> 
<meta name="generator" content="WordPress 4.5.13" />
</head>
<body>

<div id="page">


<div id="header">
    <div id="headerimg">



            

        <h1><a href="http://www.squarefree.com">Indistinguishable from Jesse</a></h1>
        <div class="description">Jesse Ruderman on Firefox, security, and more</div>




    </div>
</div>
<hr />

	<div id="content" class="narrowcolumn">

			
						
			<div class="post">
				<h2 id="post-867"><a href="http://www.squarefree.com/2015/07/28/releasing-jsfunfuzz-and-domfuzz/" rel="bookmark" title="Permanent Link to Releasing jsfunfuzz and DOMFuzz">Releasing jsfunfuzz and DOMFuzz</a></h2>
				<small>July 28th, 2015 </small>
				
				<div class="entry">
					<p>Today I'm releasing two fuzzers: <a href="https://github.com/MozillaSecurity/funfuzz/blob/master/js/jsfunfuzz/README.md">jsfunfuzz</a>, which tests JavaScript engines, and <a href="https://github.com/MozillaSecurity/funfuzz/blob/master/dom/README.md">DOMFuzz</a>, which tests layout and DOM APIs.</p>

 <p><iframe border=0 frameborder=0 height=190 width=550 src="https://twitframe.com/show?url=https://twitter.com/reimersjan/status/439538458538041344"></iframe></p>

<p>Over the last 11 years, these fuzzers have found 6450 Firefox bugs, including <a href="https://bugzilla.mozilla.org/buglist.cgi?limit=0&amp;bug_id=205735,306902,306915,307277,307444,307826,307989,307992,308917,309120,310267,310426,310436,310638,317544,317546,317549,321299,329335,329884,337419,338251,340733,347355,356325,359371,361389,365923,369438,374882,377470,377783,389326,393475,395340,399694,404215,411835,413079,413085,416734,421393,428113,429881,430991,443528,445288,449129,453406,453736,457514,460924,462968,466763,468578,473042,478527,481139,496011,496062,503699,505399,538062,538267,580151,590395,591409,604843,637214,674223,718290,791601,890775,306940,313086,316631,316639,316641,317520,322704,330486,336899,336999,337883,349974,353610,364427,367740,371563,373122,380359,391178,393956,395575,399951,400190,400223,400244,404118,406380,406485,408602,411213,413048,415685,420415,422301,423098,429960,430569,431086,436977,437142,437565,444864,448903,449111,452157,452165,454345,457375,459968,465651,467493,468563,471619,474075,476547,478128,493649,495875,497519,499862,513394,515811,534768,537645,542136,571995,576649,592118,612662,615149,664930,668941,686190,686193,735943,750575,751995,764176,804814,812665,325730,338391,338674,339494,359516,366128,367755,370791,398088,420429,420439,423355,424679,449006,471246,475133,564461,583957,674156,678818,711651,742237,793848,849597,326615,369249,369696,371124,371292,372046,382133,385096,395616,398492,404869,409811,417852,427196,436741,454704,462926,467210,475136,475185,503981,565604,596805,601699,602115,605672,606709,614499,616076,616913,626267,626280,626290,634055,636078,637621,642022,648206,660517,669228,670319,711616,714590,727330,736589,738769,743376,761422,763129,764289,766430,767273,769464,790854,806751,809674,812744,815010,822691,827468,842089,851987,851996,856384,865004,866570,867863,868265,872774,872812,873335,876080,895294,928221,933447,1072847,1153688,331284,331446,331679,331883,339651,345139,367243,372237,379799,380012,380101,380217,384649,385445,386266,388367,389630,395316,395623,399843,402380,404219,413185,413388,422283,429969,454751,455976,458653,459883,460349,460389,461239,462392,463350,472919,472950,476245,486428,495892,812929,879139,372284,382778,409990,424027,424276,424300,489477,499844,507566,546530,565125,636074,745494,772282,862309,871849,887631,339129,339130,339165,339246,339315,341227,343087,344000,346980,348062,350370,351328,358729,372376,378273,387460,404209,468771,343850,386566,397007,403454,451323,464197,465832,466607,466945,467881,479931,489925,500788,501535,535926,673757,706249,344228,344340,354645,360642,366956,373533,375399,376223,384105,394800,395331,415192,415503,444260,454736,460803,467481,344749,354777,380691,397704,420697,475181,495315,554141,639728,680687,686044,704706,348492,354766,375775,378146,382396,443089,494283,624198,348049,373586,377820,382376,383709,391904,420835,429458,432068,433429,471594,508927,561981,369150,369168,380512,459439,547333,377360,385423,394275,395458,395651,396321,410228,419095,421813,424629,428633,439206,472776,522374,660416,675515,732696,866544,380100,746896,790865,600109,606729,615763,622480,631488,633413,651030,654015,665996,692608,693250,693399,708825,790856,862606,883037,593867,623791,626835,626856,627286,628349,636921,657201,765179,814839,967354,1010090,790929,790949,791702,792068,794139,800969,801227,803842,805729,808546,808829,810626,811183,811184,812785,820990,824263,824960,828147,835835,836931,838169,839941,849888,856382,857256,862890,863929,1002340,1022945,855174,861472,863931,865550,867086,867104,867203,872394,875144,875221,875402,876207,876273,876338,877523,877527,878014,880342,880384,880404,880724,881775,882956,883591,898962,920987,894348,957452,991471,1005578,1020041,1035007,1033492,350238,350793,351116,352094,352271,352606,352616,352624,353079,353214,353249,354924,354945,355052,355474,355486,355512,355834,356378,356402,361346,361552,361617,375976,378492,379482,380833,381374,382503,387955,391033,391851,426520,427191,429739,431248,435497,452913,456692,457521,457580,458288,458679,458931,460886,461915,465063,465145,466206,466654,469405,469547,469621,470619,472533,472787,473040,473709,476257,476871,482783,485790,486713,486812,509354,510319,510434,514819,514999,520336,521169,525618,528048,528126,528507,528644,528870,531298,532491,539379,541255,546611,554670,558531,558633,559083,561031,561327,561539,563243,565373,566145,567059,567577,567606,568826,568855,569306,569384,571744,572232,572428,575486,576722,576737,576742,576744,578044,579273,579647,579740,580187,581784,581785,584650,586917,587725,589093,592202,592214,593583,593611,595230,596103,597940,600128,600139,600889,602139,605391,609256,613152,613160,613161,614782,616711,617288,618574,619004,621375,621943,622318,624421,625399,627682,627692,627783,629974,632206,639343,643839,662132,677032,690376,695896,698944,701239,702426,709929,717716,718823,726799,727921,728509,736609,740595,743000,755916,756851,757149,757304,758408,762324,768313,768732,769192,769433,770954,771398,777776,777992,779025,780274,780451,780712,780936,783924,785576,785776,787709,788364,791814,793805,794494,797163,798589,798819,798823,799185,801831,805300,805747,807047,808023,808067,808140,808481,811616,817002,819635,820186,822938,824856,825326,825705,826581,827882,831658,831846,832103,832197,835499,844305,849014,851635,855236,855536,855960,877986,886277,888470,893684,897202,914511,926847,936737,950438,951528,952022,952984,984766,986864,994281,995679,995817,999759,1001547,1001569,1005590,1011283,1011745,1013056,1014973,1015766,1022232,1033115,1034349,1035371,1042567,1053676,1054512,1055864,1057248,1070638,1085464,1086842,1096138,1100129,1100237,1101600,1122833,1137624,1140196,1141329,1150837">790 bugs that were rated as security-critical</a>. <!--(For complete lists, see <a href="https://bugzilla.mozilla.org/showdependencytree.cgi?id=domfuzz&maxdepth=2&hide_resolved=0">DOMFuzz bugs</a> and <a href="https://bugzilla.mozilla.org/showdependencytree.cgi?id=jsfunfuzz&maxdepth=1&hide_resolved=0">jsfunfuzz bugs</a>.)--></p>

<p>I had to keep these fuzzers private for a long time because of the frequency with which they found security holes in Firefox. But three things have changed that have tipped the balance toward openness.</p>

<p>First, each area of Firefox has been through many fuzz-fix cycles. So now I'm mostly finding regressions in the Nightly <a href="https://hacks.mozilla.org/2012/05/firefox-and-the-release-channels/" title="The Firefox channels: Nightly, Aurora (Dev), Beta, and Release">channel</a>, and the severe ones are fixed well before they reach most Firefox users. Second, modern Firefox is much less fragile, thanks to architectural changes to areas that once oozed with fuzz bugs. Third, other security researchers have noticed my success and demonstrated that they can write similarly powerful fuzzers.</p>

<p>My fuzzers are no longer unique in their ability to find security bugs, but they are unusual in their ability to churn out reliable, reduced testcases. Each fuzzer alternates between randomly building a JS string and then <code>eval</code>ing it. This construction makes it possible to make a reproduction file from the same generated strings. Furthermore, most <a href="https://github.com/MozillaSecurity/funfuzz/tree/master/dom/fuzzer/modules">DOMFuzz modules</a> are designed so their functions will have the same effect even if other parts of the testcase are removed. As a result, <a href="https://github.com/MozillaSecurity/lithium/">a simple testcase reduction tool</a> can reduce most testcases from 3000 lines to 3-10 lines, and I can usually <a href="https://github.com/MozillaSecurity/funfuzz/blob/master/dom/reducing-testcases.md">finish reducing testcases</a> in less than 15 minutes.</p>

<p>The ease of getting reduced testcases lets me afford to report less severe bugs. Occasionally, one of these turns out to be a <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=489682#c5">security bug in disguise</a>. But most importantly, these bug reports help me establish positive relationships with Firefox developers, by frequently saving them time.</p>

<p><iframe border=0 frameborder=0 height=250 width=550 src="https://twitframe.com/show?url=https://twitter.com/preinheimer/status/621730343314329600"></iframe>

<p>A JavaScript engine developer can easily spend a day trying to figure out why a web site doesn't work in Firefox. If instead I can give them a simple testcase that shows an incorrect result with a new JS optimization enabled, they can quickly find the source of the bug and fix it. Similarly, they much prefer reliable assertion testcases over bug reports saying "sometimes, Google Maps crashes after a while".</p>

<p>As a result, instead of being <a href="https://www.nccgroup.trust/uk/about-us/newsroom-and-events/blogs/2014/january/introduction-to-anti-fuzzing-a-defence-in-depth-aid/">hostile to fuzzing</a>, Firefox developers actively help me fuzz their code. They've <a href="http://www.squarefree.com/2014/02/03/fuzzers-love-assertions/">added numerous assertions to their code</a>, allowing fuzzers to notice as soon as the smallest thing goes wrong. They've fixed most of the <a href="https://bugzilla.mozilla.org/buglist.cgi?quicksearch=sw:fuzzblocker">bugs that impede fuzzing progress</a>. And several have suggested new ways to test their code, even (especially) ways that scare them.</p>

<p>Developers working on the JavaScript engine have been especially helpful. First, they ensured I could test their code directly, apart from the rest of the browser. They already had a <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Projects/SpiderMonkey/Introduction_to_the_JavaScript_shell">JavaScript shell</a> for running regression tests, and they added a <code>--fuzzing-safe</code> option to disable the more dangerous testing functions.</p>

<p>The JS team also created <a href="https://dxr.mozilla.org/mozilla-central/search?q=JS_FN_HELP">a large set of testing functions</a> to let me <a href="https://github.com/MozillaSecurity/funfuzz/blob/master/js/shared/testing-functions.js">control things that would normally be based on heuristics</a>. Fuzzers can now choose when garbage collection happens and even how much. They can make expensive <a href="https://en.wikipedia.org/wiki/Just-in-time_compilation">JITs</a> kick in after 2 loop iterations rather than 100. Fuzzers can even <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=912928">simulate out-of-memory conditions</a>. All of these things make it possible to create small, reliable testcases for nasty classes of bugs.</p>

<p>Finally, the JS team has supported differential testing, a form of fuzzing where output is checked for correctness against some oracle. In this case, the oracle is the same JavaScript engine with most of its optimizations disabled. By <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=js-differential-test">fixing inconsistencies quickly</a> and <a href="https://dxr.mozilla.org/mozilla-central/search?q=JS_MORE_DETERMINISTIC">supporting <code>--enable-more-deterministic</code></a>, they've ensured that differential testing doesn't get stuck finding the same problems repeatedly.</p>

<p style="text-align: center;"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=457778#c2"><img width="433" height="121" src="https://www.squarefree.com/blogimages/agal-vow.png" alt="Andreas Gal, a developer working on Firefox's JavaScript engine, once commented on Bugzilla: 'From this day forward, I shall never write a JIT again without Jesse.'"></a></p>

<p>Please <a href="irc://irc.mozilla.org/fuzzing" title="#fuzzing on irc.mozilla.org">join us on IRC</a>, or just <a href="https://github.com/MozillaSecurity/funfuzz/">dive in and contribute</a>! Your suggestions and patches can have a large impact: fuzzer modules often act together to find complex interactions within the browser. For example, <a href="https://bugzilla.mozilla.org/attachment.cgi?id=775106&amp;action=edit" title="Testcase for bug 893333 - &quot;ASSERTION: damage area expanded incorrectly&quot; with table row/colspan, editor">bug 893333</a> was found by <a href="https://github.com/MozillaSecurity/funfuzz/blob/master/dom/fuzzer/modules/editor.js">my <code>designMode</code> module</a> interacting with <a href="https://github.com/MozillaSecurity/funfuzz/blob/master/dom/fuzzer/modules/tables.js">a <code>&lt;table&gt;</code> module</a> contributed by a Firefox developer, Mats Palmgren. Likewise, <a href="https://bugzilla.mozilla.org/attachment.cgi?id=8597550&amp;action=edit" title="Testcase for bug 1158427 - &quot;ASSERTION: Stream already destroyed&quot; and crash with mozCaptureStreamUntilEnded, cycle collection">bug 1158427</a> was found by <a href="https://twitter.com/posidron">Christoph Diehl</a>'s <code>WebAudio</code> module combined with my <a href="https://en.wikipedia.org/wiki/Reflection_%28computer_programming%29">reflection</a>-based API-discovery modules.</p>

<p>If your contributions result in me finding a security bug, and I think I wouldn't have found it otherwise, I'll make sure you get a <a href="https://www.mozilla.org/en-US/security/client-bug-bounty/">bug bounty</a> as if you had reported it yourself.</p>

<p>To the next 6450 browser bug fixes!</p>				</div>
		
				<p class="postmetadata">Posted in <a href="http://www.squarefree.com/categories/fuzzing/" rel="category tag">Fuzzing</a>, <a href="http://www.squarefree.com/categories/mozilla/" rel="category tag">Mozilla</a>, <a href="http://www.squarefree.com/categories/security/" rel="category tag">Security</a> <strong>|</strong>   <a href="http://www.squarefree.com/2015/07/28/releasing-jsfunfuzz-and-domfuzz/#comments">12 Comments &#187;</a></p> 
				
			</div>
	
						
			<div class="post">
				<h2 id="post-854"><a href="http://www.squarefree.com/2014/02/03/fuzzers-love-assertions/" rel="bookmark" title="Permanent Link to Fuzzers love assertions">Fuzzers love assertions</a></h2>
				<small>February 3rd, 2014 </small>
				
				<div class="entry">
					<p style="text-align:center; font-style:italic;">Fuzzers make things go wrong.<br>Assertions make sure we find out.</p>

<p><a href="http://blog.regehr.org/archives/1091">Assertions can improve code quality in many ways</a>, but they truly shine when combined with fuzzing. Fuzzing is normally limited to finding obvious symptoms like crashes, because it's <a href="http://www.squarefree.com/categories/differential-testing/">rare to be able to tell correct behavior from incorrect behavior when the input is generated randomly</a>. Assertions expand the scope of fuzzing to include everything they check.</p>

<p>Assertions can even help find crash bugs: some bugs are relatively easy for fuzzers to trigger, but only lead to crashes when additional conditions are met. A well-placed assertion can let us know every time we trigger the bug.</p>

<p>Fuzzing JS and DOM has found about 4000 assertion bugs, including <a href="https://bugzilla.mozilla.org/buglist.cgi?quicksearch=ALL%20reporter%3Ajruderman%2Cgary%40rumb%2Ccholler%20kw%3Atestcase%20kw%3Aassertion%20%20-kw%3Acrash%20%20-kw%3Amlk%20%20sw%2Ckw%3Asec-critical%2Csec-high%2C%22sg%3Acritical%22%2C%22sg%3Ahigh%22">about 300 security bugs</a>.</p>


<h3 id="data-structures">Asserting safe use of generic data structures</h3>

<p>Assertions in widely-used data structures can find bugs in many callers.</p>

<ul>
<li><strong>Array indices must be within bounds</strong>. This simple precondition assert in nsTArray has caught <a href="https://bugzilla.mozilla.org/buglist.cgi?quicksearch=ALL%20su%2Cdesc%3A%22invalid%20array%20index%22&amp;order=bugs.bug_id%20desc">about 90 bugs</a>.</li>

<li><strong>Hash tables must not be modified during enumeration</strong>. If the modification happened to resize the hash table, it would leave stack pointers dangling. This PLDHashTable assertion has caught <a href="https://bugzilla.mozilla.org/buglist.cgi?quicksearch=ALL%20su%2Cdesc%3Arecursion_level&amp;order=bugs.bug_id%20desc">over 50 bugs</a>.</li>

<li><strong>Cached values should not be out of date</strong>. When a cache's <code>get</code> method takes a key and a closure for computing values in the case of a cache miss, debug builds can check whether the cached values are still correct. This is effectively a form of <a href="http://www.squarefree.com/categories/differential-testing/">differential testing</a> that notices bugs in cache-invalidation logic.</li>
</ul>


<h3 id="module-invariants">Asserting module invariants</h3>

<p>When <a href="https://developer.mozilla.org/en-US/docs/SpiderMonkey/Internals/Invariants">an entire module must maintain an invariant</a>, a single assertion can catch dozens of bugs.</p>

<ul>
<li><strong>Compartment mismatches.</strong> When a JS object in one page's <a href="https://developer.mozilla.org/en-US/docs/SpiderMonkey/SpiderMonkey_compartments">compartment</a> references an object in another, it must do so through a <a href="https://developer.mozilla.org/en-US/docs/Mozilla/XPConnect/XPConnect_security_membranes">wrappers</a> that enforces security policies. Without these assertions, we would have missed <a href="https://bugzilla.mozilla.org/buglist.cgi?quicksearch=ALL%20kw%3Atestcase%20su%3Acompartment%20kw%3Aassertion%20su%3Amism%2Cwrong&amp;order=bugs.bug_id%20desc">over 25 violations</a> of Firefox's script security model.</li>
<li><strong>Phases of layout</strong>. These assertions have strings like "Should be in an update while creating frames" and "reflowing in the middle of frame construction". <a href="https://bugzilla.mozilla.org/buglist.cgi?quicksearch=335053,335054,355975,686402,858473">More phase and nesting assertions are wanted</a>, but sometimes <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=612662#c7">special cases like plugins get in the way</a>.</li>
</ul>


<h3 id="frame-arena">Making the frame arena safer</h3>

<p>Gecko's CSS box objects, called "frames", are created and destroyed manually. They are allocated within an arena to reduce malloc overhead and fragmentation. The arena also made it possible to reduce the risk associated with manual memory management. A combination of assertions (in debug builds) and runtime mitigations (in all builds) mitigates dangling pointer bugs that involve frames.</p>

<ul>
<li>When the arena is destroyed, debug builds <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=framedest">assert that all objects in the arena were also destroyed</a>. <a href="https://bugzilla.mozilla.org/showdependencytree.cgi?id=334514&amp;maxdepth=1&amp;hide_resolved=0">Over 60 bugs</a> have been caught by the assertion.  About half of the bugs that trigger the assertion <em>can</em> lead to exploitable crashes, but without a specially crafted testcase, they will not crash at all.</li>

<li>While the arena is still alive, deleted frames are overwritten with a special poison pattern. If any code uses a pointer from a deleted frame, the browser will segfault safely. This mitigation, called <a href="http://robert.ocallahan.org/2010/10/mitigating-dangling-pointer-bugs-using_15.html">frame poisoning</a>, has <a href="https://bugzilla.mozilla.org/showdependencytree.cgi?id=526587&amp;maxdepth=1&amp;hide_resolved=0">prevented dozens of bugs from being exploitable</a>.</li>

<li>Writing over the poison trips another assertion. This assertion is actually more prone to catch <a href="https://bugzilla.mozilla.org/buglist.cgi?quicksearch=799091,775045,772725">hardware errors</a> than <a href="https://bugzilla.mozilla.org/buglist.cgi?quicksearch=561981,586389">software bugs</a>, so it has been <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=785737">modified to help distinguish between the two</a>.</li>
</ul>

<h3 id="requests">Requests for Gecko developers</h3>

<p>Please add assertions, especially when:</p>
<ul>
  <li>A bug would be a security hole</li>
  <li>Crashing is not guaranteed</li>
  <li>Many callers must fulfill a precondition</li>
  <li>Complex, extensive code must maintain an invariant</li>
</ul>

<p>Also consider:</p>
<ul>
<li>Ensure <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=503190">assertions in third-party libraries</a> are enabled in debug builds of Firefox.</li>
<li>Fix <a href="https://bugzilla.mozilla.org/buglist.cgi?v4=assert%20when&amp;o5=substring&amp;f10=short_desc&amp;f1=keywords&amp;o3=substring&amp;v6=should%20assert&amp;o7=substring&amp;f8=OP&amp;v3=assert%20if&amp;o1=substring&amp;j2=OR&amp;o9=equals&amp;resolution=---&amp;v10=assert&amp;o6=substring&amp;v7=add%20assert&amp;f9=bug_severity&amp;n1=1&amp;f4=short_desc&amp;v5=assert%20that&amp;query_format=advanced&amp;o10=substring&amp;v9=enhancement&amp;f3=short_desc&amp;f2=OP&amp;o4=substring&amp;f5=short_desc&amp;v1=assertion&amp;f6=short_desc&amp;f7=short_desc">bugs requesting new assertions</a>.</li>
<li>Fix <a href="https://bugzilla.mozilla.org/buglist.cgi?quicksearch=reporter%3Ajruderman%20kw%3Aassertion%20kw%3Atestcase&amp;order=bugs.bug_id%20desc">my assertion bugs</a> to <a href="http://www.squarefree.com/2010/11/21/how-my-dom-fuzzer-ignores-known-bugs/">allow my fuzzers to find more</a>.</li>
</ul>
				</div>
		
				<p class="postmetadata">Posted in <a href="http://www.squarefree.com/categories/fuzzing/" rel="category tag">Fuzzing</a>, <a href="http://www.squarefree.com/categories/mozilla/" rel="category tag">Mozilla</a> <strong>|</strong>   <a href="http://www.squarefree.com/2014/02/03/fuzzers-love-assertions/#comments">1 Comment &#187;</a></p> 
				
			</div>
	
						
			<div class="post">
				<h2 id="post-844"><a href="http://www.squarefree.com/2013/12/17/customizing-the-mozilla-manifesto/" rel="bookmark" title="Permanent Link to Customizing the Mozilla Manifesto">Customizing the Mozilla Manifesto</a></h2>
				<small>December 17th, 2013 </small>
				
				<div class="entry">
					<p>I have mixed feelings about <a href="http://hoosteeno.com/2013/12/17/a-new-mozillians-org-signup-process/">requiring Mozillians to “agree”</a> to the <a href="http://www.mozilla.org/en-US/about/manifesto/#principles">Mozilla Manifesto</a>. I get the impression that many volunteers aren’t fond of “commercial involvement” (9). Firefox development often does not live up to the ideals of absolute security (4) or transparency (8), so we’d be asking new contributors to commit to behavior for which they may have little support.</p>

<p>Meanwhile, the manifesto is oddly silent on two issues that many Mozillians care about deeply. First, it says little about privacy. “Shaping your own experience on the Internet” (5) suggests control over customized ads, but not control over tracking by advertisers or governments.</p>

<p>Second, the manifesto does not adequately address removing barriers to contribution or promoting inclusiveness in community processes. The relevant principles (6, 8) are worded as vague beliefs rather than strong values. Compare with <a href="http://adainitiative.org/2012/10/jesse-ruderman-i-wanted-to-atone-for-years-of-thats-what-she-said-jokes/">my favorite part</a> of the <a href="http://adainitiative.org/faq/#why-focus-on-women-in-open-technology-and-culture">Ada Initiative FAQ</a>:</p>

<blockquote><p>“Open technology and culture are shaping the future of global society. If we want that society to be socially just and to serve the interests of all people, [all kinds of people] must be involved in its creation and organization.”</p></blockquote>

<p>Rather than asking each Mozillian to agree to the entire manifesto, <strong>let’s instead encourage everyone to <a href="https://twitter.com/jruderman/status/413186102250328064">Likert</a> the 10 existing principles and add a few of their own</strong>.</p>

<p>Indicating how you feel about each principle is more memorable than clicking “Agree” once. Each Mozillian would have a personal version of the Manifesto to remind them what drives them to contribute. Such a survey could also lead to better understanding of the community and suggest improvements to the Manifesto.</p>				</div>
		
				<p class="postmetadata">Posted in <a href="http://www.squarefree.com/categories/mozilla/" rel="category tag">Mozilla</a> <strong>|</strong>   <a href="http://www.squarefree.com/2013/12/17/customizing-the-mozilla-manifesto/#comments">8 Comments &#187;</a></p> 
				
			</div>
	
						
			<div class="post">
				<h2 id="post-840"><a href="http://www.squarefree.com/2012/04/16/car-free-apps/" rel="bookmark" title="Permanent Link to Mobile apps for car-free living">Mobile apps for car-free living</a></h2>
				<small>April 16th, 2012 </small>
				
				<div class="entry">
					<div style="margin: 1em 0; text-align: center;">
  <div style=""><img src="http://www.squarefree.com/blogimages/swings-on-bart.jpg" width="427" height="640" alt="A man swings through the aisle of a train."></div>
  <div style="font-style: italic; font-size: smaller;"><a href="http://www.flickr.com/photos/audreypenven/3482041699/">Swings on BART</a> (photo by <a href="http://audreypenven.net/">Audrey Penven</a>)</div>
</div>


<p>Each of these apps makes transit more efficient or convenient. Together, they can do something almost magical: make transit <em>attractive</em> to urbanites who previously saw owning a car as a necessity.</p>


<h4>Planning your trips</h4>

<p>These apps try to find the best way to reach your destination by combining timetables from multiple transit agencies:</p>

<p><a href="http://maps.google.com/">Google Maps</a><sup>[<a href="http://www.google.com/intl/en/landing/transit/" title="Using Google Maps for public transportation">Learn more</a>]</sup> shows your current location along with walking, transit, or driving directions. In the iPhone app, you can double-tap the locator button to align the map with the iPhone's compass.</p>

<p><a href="http://www.hopstop.com/search">HopStop</a><sup>[<a href="http://itunes.apple.com/us/artist/hopstop.com/id303217147" title="HopStop for iOS">iOS</a> | <a href="http://hopstop.com/?action=mobile_android" title="HopStop for Android">Android</a>]</sup> lets you specify whether you prefer trains or buses, and whether you prefer walking or waiting for a transfer. It shows a zoomed-in map for each transfer.</p>

<p><a href="http://codeforamerica.org/?cfa_project=transportation-choices">Reroute.it</a> lets you <a href="http://codeforamerica.org/2011/09/27/introducing-reroute-it/">quickly compare modes of transportation</a> before getting directions.</p>


<h4>Catching your ride</h4>

<p><a href="http://routesy.com/">Routesy</a>, <a href="http://nextransit.org/apps/nextime/">Nextime</a>, and <a href="http://www.nextbus.com/homepage/">Nextbus</a> use real-time transit data to help you make quick decisions on familiar routes.  For example, you'll know when to walk to your stop, when to run, and when to wait inside.</p>


<h4>Not missing your stop</h4>

<p>A location-based alarm, such as <a href="http://itunes.apple.com/us/app/get-off-now!-predictive-gps/id415576580?mt=8">Get Off Now</a> or <a href="http://itunes.apple.com/us/app/gpsalarms/id447537468?mt=8">GPSAlarms</a>, can allow you to nap, read, or work without worrying about missing your stop.</p>

<p>These  apps can run in the background and have surprisingly little effect on  battery life. They use power-hungry GPS only when cell/wifi location  data indicates that you are somewhat close.</p>


<h4>Staying productive and entertained</h4>

<p>One of the biggest advantages of public transportation is being able to <a href="http://www.squarefree.com/2009/04/16/how-i-use-gtd/">get things done</a> while in transit.  Some people check email, watch TV shows, or even <a href="http://itunes.apple.com/app/chipotle-ordering/id327228455?mt=8">order from Chipotle</a> using their phones.</p>

<p>I often use time on the train to read articles. Whenever I find myself with <a href="http://xkcd.com/214/">too many Wikipedia tabs open</a>, I send them to my phone using the <a href="http://www.instapaper.com/">Instapaper</a> or <a href="https://getspool.com/">Spool</a> bookmarklet.  Sometimes I read books on my phone using the <a href="http://www.amazon.com/gp/feature.html?docId=1000493771">Amazon Kindle app</a>.</p>


<h4>Getting a car when you need one</h4>

<p>The <a href="http://www.zipcar.com/mobile/">Zipcar app</a> lets you borrow cars from <a href="http://www.zipcar.com/find-cars">Zipcar locations</a>, while <a href="http://www.getaround.com/">Getaround</a> lets you borrow cars from awesome neighbors.</p>

<p>Or you can pay for a ride using <a href="http://taximagic.com/">Taxi Magic</a> or <a href="https://www.uber.com/">Uber</a>.</p>


<h4>More reading</h4>

<p>Some transit authorities recommend apps for their cities: <a href="http://www.511.org/apps-3rd-party-apps.asp">San Francisco</a>, <a href="http://www.nytransit.org/resources/transit-apps-ny">New York</a>, <a href="http://www.transitchicago.com/apps/">Chicago</a>, <a href="http://www.kingcounty.gov/transportation/kcdot/MetroTransit/Developers/AppCenter.aspx">Seattle</a>, and <a href="http://trimet.org/apps/">Portland, Oregon</a>.</p>

<p>In my next posts, I'll list my ideas for new transit apps and explain how platforms could better support location-aware apps.</p>
				</div>
		
				<p class="postmetadata">Posted in <a href="http://www.squarefree.com/categories/transportation/" rel="category tag">Transportation</a> <strong>|</strong>   <span>Comments Off<span class="screen-reader-text"> on Mobile apps for car-free living</span></span></p> 
				
			</div>
	
						
			<div class="post">
				<h2 id="post-823"><a href="http://www.squarefree.com/2012/03/03/fuzzing-for-consistent-rendering/" rel="bookmark" title="Permanent Link to Fuzzing for consistent rendering">Fuzzing for consistent rendering</a></h2>
				<small>March 3rd, 2012 </small>
				
				<div class="entry">
					<p>My DOM fuzzer can now find bugs where the layout of a DOM tree depends on its history.</p>

<p>In this example, forcing a re-layout swapped a “1” and “3” on the screen. My fuzzer didn’t know which rendering was correct, but it could tell that Firefox was being inconsistent.</p>

<style>
   .domtree { font-family: monospace; font-size: 130%; margin-top: 0; margin-bottom: 0; }
   .domtree code { color: purple; font-weight: bold; }
</style>

<table cellpadding="4" border="1" style="border-collapse: collapse; margin: auto;">
<tr>
<td>Initial DOM tree</td>
<td>

<ul class="domtree">
<li><code>DIV</code>
  <ul>
    <li>&#x062a;</li>
    <li><code>SPAN</code>
      <ul>
        <li>1</li>
        <li><code>SPAN</code>
        <li>3</li>
      </ul>
    </li>
  </ul>
</li>
</ul>

</td>
<td>31<bdi>&#x062a;</bdi></td>
</tr>
<tr>
<td>Random change:<br/> remove the inner span</td>
<td>

<ul class="domtree">
<li><code>DIV</code>
  <ul>
    <li>&#x062a;</li>
    <li><code>SPAN</code>
      <ul>
        <li>1</li>
        <li>3</li>
      </ul>
    </li>
  </ul>
</li>
</ul>

</td>
<td>31<bdi>&#x062a;</bdi></td>
</tr>
<tr>
<td>Force re-layout</td>
<td>

<ul class="domtree">
<li><code>DIV</code>
  <ul>
    <li>&#x062a;</li>
    <li><code>SPAN</code>
      <ul>
        <li>1</li>
        <li>3</li>
      </ul>
    </li>
  </ul>
</li>
</ul>

</td>
<td>13<bdi>&#x062a;</bdi></td>
</tr>
</table>


<p>Gecko developer <a href="http://smontagu.org/">Simon Montagu</a> quickly <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=718236#c1">determined that <span>13<bdi>&#x062a;</bdi></span> is the correct rendering</a> and attached a patch. Later, when a user <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=730671">reported that the bug affected Persian comments on Facebook</a>, we were able to <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=718236#c12">backport Simon’s fix to Firefox 11</a>.</p>


<h4>How it works</h4>

<p>The fuzzer starts by making random dynamic changes to a page.  Then it compares two snapshots: one taken immediately after the dynamic changes, and another taken after also forcing a relayout.</p>

<p>To force a relayout, it removes the root from the document and then adds it back:</p>

<pre>
  var r = document.documentElement; 
  document.removeChild(r);
  document.appendChild(r);
</pre>

<p>Like <a href="https://developer.mozilla.org/en/Creating_reftest-based_unit_tests">reftest</a>, it uses <a href="https://developer.mozilla.org/en/DOM/CanvasRenderingContext2D#drawWindow%28%29">drawWindow()</a> to take snapshots and <a href="https://developer.mozilla.org/en/XPCOM_Interface_Reference/nsIDOMWindowUtils#compareCanvases%28%29">compareCanvases()</a> to compare them.</p>

<p>In theory, I could also look for bugs where dynamic changes do not repaint enough of the window. But I've been told that testing for painting invalidation bugs is tricky, so I'll wait until most of the layout bugs are fixed.</p>


<h4>Exceptions</h4>

<p>Since the testcases are random, I have to be heavy-handed in ignoring known bugs. If I file a rendering bug where the weirdest part of the testcase is floats, I'll have the fuzzer ignore inconsistent rendering in testcases with floats <a href="http://www.squarefree.com/2011/06/10/tracking-after-fix-tasks/">until the bug is fixed</a>.</p>

<p>The <a href="http://pastebin.mozilla.org/1501141">current list of exceptions</a> is fairly large and includes key web technologies:</p>

<ul>
<li>CSS border/padding (<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=718452">bug 718452</a>)</li>
<li>CSS position: relative/absolute (<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=728100">bug 728100</a>)</li>
<li>CSS float (<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=725928">bug 725928</a>)</li>
<li>Non-ASCII text (<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=726460">bug 726460</a>)</li>
<li>Right-to-left text (<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=730562">bug 730562</a>)</li>
<li>&lt;table&gt; (<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=467723">bug 467723</a>)</li>
<li>MathML (<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=522393">bug 522393</a>)</li>
<li>SVG (<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=723376">bug 723376</a>, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=475216">bug 475216</a>)</li>
<li>Anything that causes <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=265084">coordinate overflow</a></li>
<li>Anything that causes assertion failures (which are <a href="http://www.squarefree.com/2010/11/21/how-my-dom-fuzzer-ignores-known-bugs/">tracked separately</a>)</li>
</ul>
				</div>
		
				<p class="postmetadata">Posted in <a href="http://www.squarefree.com/categories/differential-testing/" rel="category tag">Differential testing</a>, <a href="http://www.squarefree.com/categories/fuzzing/" rel="category tag">Fuzzing</a>, <a href="http://www.squarefree.com/categories/mozilla/" rel="category tag">Mozilla</a> <strong>|</strong>   <span>Comments Off<span class="screen-reader-text"> on Fuzzing for consistent rendering</span></span></p> 
				
			</div>
	
						
			<div class="post">
				<h2 id="post-819"><a href="http://www.squarefree.com/2012/03/01/movie-rental/" rel="bookmark" title="Permanent Link to Renting movies is hard">Renting movies is hard</a></h2>
				<small>March 1st, 2012 </small>
				
				<div class="entry">
					<p>None of the major video rental systems appeal to me:</p>

<ul>
<li><a href="http://www.redbox.com/">Redbox</a> is for people who visit the grocery store two days in a row. (Why don't they put kiosks at train stations?)</li>

<li><a href="https://www.netflix.com/">Netflix DVD-by-mail</a> is for people who watch lots of movies and check snail mail daily.</li>

<li><a href="http://www.amazon.com/gp/feature.html?docId=1000663511">Amazon Instant Video</a> is for people who live online, yet are willing to <a href="http://www.defectivebydesign.org/what_is_drm_digital_restrictions_management">give up control over their computers</a>.</li>
</ul>

<p>The iTunes Store mostly works for my current set of devices, but all the movies I want to watch are either too new or too obscure for them to have rentals available.</p>

<p>Maybe I should sign up for Netflix but use <a href="https://thepiratebay.se/">other means</a> to actually watch movies. At least then Hollywood will have enough money to <del>make good films</del> <a href="http://rootstrikers.org/">buy politicians</a>, print and distribute <a href="http://www.homemediamagazine.com/digital-copy/kevin-tsujihara-discs-key-driving-ultraviolet-adoption-26560">billions</a> of <a href="https://twitter.com/#!/jruderman/status/175455285442379777">optical discs</a>, <a href="https://www.eff.org/issues/drm">prevent paying customers from exercising their fair use rights</a>, and <a href="https://www.eff.org/issues/file-sharing">sue my neighbors</a>.</p>				</div>
		
				<p class="postmetadata">Posted in <a href="http://www.squarefree.com/categories/broken/" rel="category tag">Broken</a> <strong>|</strong>   <a href="http://www.squarefree.com/2012/03/01/movie-rental/#comments">1 Comment &#187;</a></p> 
				
			</div>
	
						
			<div class="post">
				<h2 id="post-813"><a href="http://www.squarefree.com/2012/02/05/alpha/" rel="bookmark" title="Permanent Link to I dream of Alpha">I dream of Alpha</a></h2>
				<small>February 5th, 2012 </small>
				
				<div class="entry">
					<p>This museum’s rooms are empty, waiting to be filled with answers to visitors’ questions.</p>

<p style="text-align: center"><img src="https://www.squarefree.com/blogimages/WAlogoSmallGreen.png" width="44" height="45" alt="-"></p>

<p>In my search for nutrition, have I overlooked some fruit that I might find convenient and delicious? I start by trying to find out what’s popular throughout the world.</p>

<p><em>What fruits are liked by the most people?</em> <samp>Human thoughts are not my forte.</samp></p>

<p><em>What fruits are eaten the most?</em> I get an answer, but not in the chart form I expected.</p>

<p>A row of fruit appears on the floor. The larger ones are shown both whole and sliced. Does the <a href="http://en.wikipedia.org/wiki/Five-second_rule">five-second rule</a> apply to food that suddenly appeared on the floor, or only to food that has been dropped? Am I looking at holograms?</p>

<p>A bigger problem is that the list is dominated by small fruits like berries. I don’t like berries.</p>

<p><em>What fruits are eaten the most, by weight?</em> <samp>Insufficient data.</samp></p>

<p>I probe, using simpler questions, to figure out what it knows. <em>What’s the weight of an apple?</em> <samp>180 grams.</samp> <em>What’s the total weight of apples eaten in a year?</em> <samp>Insufficient data.</samp></p>

<p>I guess I have to be explicit if I want it to combine its weight and consumption data.</p>

<p><em>For each fruit for which you have sufficient data, chart the number eaten in a year, the average weight, and the product of the two.</em></p>

<p>I don’t get an answer right away. Is it just taking a while? Did I mangle the question, causing it to make a chart that is invisible because it has no entries? Did I confuse it with the phrase “the product of the two”?</p>


<p style="text-align: center"><img src="https://www.squarefree.com/blogimages/banana-from-clker-83002-tiny.png" width="75" height="58"  alt="-"></p>

<p>Two women are debating the merits of bananas. In this place, they aren’t limited to speculation. <em>Can you chart fruit by potassium per Calorie? Vitamin B<sub>6</sub> per dollar?</em> It helpfully highlights the “banana” row in each chart.</p>

<p>They explore the supply side as well. <em>Show me maps of where bananas are grown. Can you add a yearly animation with harvests shown as glowing dots? Draw a chart with axes for temperature and latitude, colored to show how well bananas grow in each condition.</em></p>

<p>I start thinking of my own questions, but I don’t expect it to be able to answer them. How do most people <a href="http://www.youtube.com/watch?v=8Hdajei5i7Q">open bananas</a>? How many bananas are used in recipes rather than eaten directly?</p>

<p><em>How many bananas are used as sex toys?</em> Oops, did I ask that out loud?</p>

<p>It doesn’t even acknowledge my question, but one of the women retorts with a question of her own.</p>

<p><em>What percent of the time are men thinking about sex?</em> <samp>Human thoughts are not my forte.</samp></p>


<p style="text-align: center"><img src="https://www.squarefree.com/blogimages/WAlogoSmall.png" width="44" height="45" alt="-"></p>

<p>When I wake up, it’s still dark outside.</p>

<p>Today, the closest thing to the museum of my dream is a web site called <a href="http://www.wolframalpha.com/">Wolfram Alpha</a>. It can <a href="http://www.wolframalpha.com/input/?i=population+vs+GDP+per+capita+by+country">chart</a> <a href="http://www.wolframalpha.com/input/?i=temperature+in+mountain+view+CA+and+san+francisco+CA+during+2011">many</a> <a href="http://www.wolframalpha.com/input/?i=apple+stock+price+from+1980+to+today">things</a>. But it <a href="http://www.wolframalpha.com/input/?i=vehicles+in+california+%2F+population+of+california">requires</a> <a href="http://www.wolframalpha.com/input/?i=vehicles+per+capita+in+california">us</a> to <a href="http://www.wolframalpha.com/input/?i=languages+by+number+of+native+speakers">phrase</a> <a href="http://www.wolframalpha.com/input/?i=languages+with+the+most+native+speakers">questions</a> carefully, and sometimes it <a href="http://www.wolframalpha.com/input/?i=number+of+prisoners">simply</a> <a href="http://www.wolframalpha.com/input/?i=mass+of+250+gallons+of+gasoline">misinterprets</a> queries.</p>

<p>As for fruit? Wolfram Alpha has <a href="http://www.wolframalpha.com/input/?i=worldwide+fruit+consumption">consumption data for some fruit</a>. But <a href="http://www.wolframalpha.com/input/?i=worldwide+consumption+of+peaches">some fruit is missing</a>, and <a href="http://www.wolframalpha.com/input/?i=worldwide+kiwi+consumption">some</a> <a href="http://www.wolframalpha.com/input/?i=US+consumption+of+kiwis">fruit</a> <a href="http://www.wolframalpha.com/input/?i=%28kiwi+fruit%29+US+consumption">confuses</a> it.</p>

<p>I start writing this post while eating the last two apples from my fridge.</p>

<p>I go back to bed, hoping for additional pleasant dreams.</p>
				</div>
		
				<p class="postmetadata">Posted in <a href="http://www.squarefree.com/categories/uncategorized/" rel="category tag">Uncategorized</a> <strong>|</strong>   <span>Comments Off<span class="screen-reader-text"> on I dream of Alpha</span></span></p> 
				
			</div>
	
						
			<div class="post">
				<h2 id="post-791"><a href="http://www.squarefree.com/2011/09/01/lessons-from-js-engine-bugs/" rel="bookmark" title="Permanent Link to Lessons from JS engine bugs">Lessons from JS engine bugs</a></h2>
				<small>September 1st, 2011 </small>
				
				<div class="entry">
					<p>Last week, I asked <a href="http://blog.mozilla.com/luke/">Luke Wagner</a> to explain some security bugs that he fixed in the past. I hoped to <a href="http://en.wikipedia.org/wiki/Root_cause_analysis">learn from each bug at multiple levels</a>, in ways that could help prevent future security bugs from arising and persisting.</p>

<p>Luke is one of the developers working on <a href="https://developer.mozilla.org/en/SpiderMonkey">Firefox's JavaScript engine</a>, which is currently our largest source of <a href="https://wiki.mozilla.org/Security_Severity_Ratings">critical</a> security bugs.</p>

<h4>Method</h4>

<p>I imagined we would recurse in <a href="http://en.wikipedia.org/wiki/Why-Because_analysis">exhaustive breadth</a> and <a href="http://en.wikipedia.org/wiki/5_Whys">exhausting depth</a>. Instead, we recursed only on the most interesting items, and refined a checklist of starting points:</p>

<ul>
<li>What was the bug?</li>
<li>What went wrong in the developer's thinking that caused the bug to be introduced?</li>
<li>What made the bug exploitable?</li>
<li>What caused us to use especially dangerous features of C++?</li>
<li>Could a new abstraction make it possible to do this both fast and safe?</li>
<li>What caused the bug to persist? Could we have caught this earlier with improved regression tests, fuzz testing, dynamic analysis, or static analysis?</li>
</ul>

<p>Luke and I made <strong><a href="http://www.squarefree.com/lessons-from-js-bugs.html">trees for all ten bugs</a></strong>, at first on paper and later using EtherPad. Then I extracted and categorized what I thought were the most useful lessons and recommendations.</p>

<h4>Recommendations for introducing fewer bugs</h4>

<p>Casts</p>

<ul>
<li>Create centralized, type-restricted cast functions. This protects you when you change the representation of one of the types. It also protects against mistakes that cause the input type to be incorrect.</li>
</ul>

<p>Sentinel values</p>

<ul>
<li>Use tagged unions instead.</li>
<li>Use a typed wrapper (a struct containing a single value). When assigning from the underlying numeric type, convert using one of two functions: one that checks for special values, and one that explicitly does not.</li>
<li>Audit existing code paths to ensure they cannot generate the special value.</li>
</ul>

<p>Clarity of invariants</p>

<ul>
<li>Increase use of <a href="http://mxr.mozilla.org/mozilla-central/search?string=AssertInvariants">methods named AssertInvariants</a></li>
<li>Create an alias for JS_ASSERTION called JS_INVARIANT.</li>
</ul>

<p>Interacting with other developers</p>

<ul>
<li>If you're about to do something gross because someone else doesn't expose the right API/helper, maybe you should get it exposed.</li>
</ul>

<p>JS Engine specific</p>

<ul>
<li>Any patch that touches rooting should be reviewed by Igor.</li>
<li>Interpreter could have better abstraction and encapsulation for its stack.</li>
</ul>

<h4>Recommendations for catching bugs earlier</h4>

<p>Static analysis</p>

<ul>
<li>Find all casts (C-style casts, the reinterpret_cast keyword, and casts through unions) for a given type. Could be used to enforce centralization or to find things that should be centralized.</li>
<li>Be suspicious of a function with multiple return statements, all of which return the same primitive value.</li>
<li>Be suspicious of a function returning true/success in an OOM path.</li>
</ul>

<p>Dynamic analysis</p>

<ul>
<li>Ask Valgrind developers what they think of providing (in valgrind.h) a way to tie the addressability of "stacklike memory" to a variable that represents the end of the stack.</li>
</ul>

<p>Fuzzing</p>

<ul>
<li>We should fuzz <a href="https://developer.mozilla.org/En/DOM/Worker">worker threads</a> somehow.
  <ul>
  <li>In browser (slow and messy, but it's what users are running).
  <li>In thread-safe shell (--enable-threadsafe?), which has "toy workers".</li>
  </ul>
</li>
<li>We should fuzz compartments better.
  <ul>
  <li>I should ask Blake and Andreas for help with testing compartments and wrappers.</li>
  <li>I should ask Gary to run jsfunfuzz in xpcshell, where I can test both same-origin and different-origin compartments, and thus get more interesting wrappers.</li>
  </ul>
</li>
<li>We should give JS OOM fuzzing another shot.</li>
</ul>

<h4>Next steps</h4>

<p>I'm curious if others have additional ideas for what could have prevented the ten bugs we looked at. For example, someone like <a href="http://whereswalden.com/">Jeff Walden</a>, who loves to write exhaustive regression tests, might have ideas that Luke and I did not consider.</p>

<p>I'd also like to do this kind of analysis with a other developers on bugs they have fixed.</p>				</div>
		
				<p class="postmetadata">Posted in <a href="http://www.squarefree.com/categories/javascript/" rel="category tag">JavaScript</a>, <a href="http://www.squarefree.com/categories/mozilla/" rel="category tag">Mozilla</a>, <a href="http://www.squarefree.com/categories/security/" rel="category tag">Security</a> <strong>|</strong>   <a href="http://www.squarefree.com/2011/09/01/lessons-from-js-engine-bugs/#comments">1 Comment &#187;</a></p> 
				
			</div>
	
		
		<div class="navigation">
			<div class="alignleft"><a href="http://www.squarefree.com/page/2/" >&laquo; Previous Entries</a></div>
			<div class="alignright"><a href="http://www.squarefree.com/page/2/" >Next Page &raquo;</a></div>
		</div>
		
	
	</div>

    <div id="sidebar">
        <ul>
            
            <li>
                <form method="get" id="searchform" action="/index.php">
<div><input type="text" value="" name="s" id="s" />
<input type="submit" id="searchsubmit" value="Search" />
</div>
</form>            </li>

            <!-- Author information is disabled per default. Uncomment and fill in your details if you want to use it.
            <li><h2>Author</h2>
            <p>A little something about you, the author. Nothing lengthy, just an overview.</p>
            </li>
            -->

            
                        

<li><h2>Jesse</h2>

<ul>
<li class="iconlink"><a href="https://twitter.com/#!/jruderman"><img width="16" height="16" src="//www.squarefree.com/icons/twitter2.png" alt="" /> <span>Twitter</span></a></li>
<li class="iconlink"><a href="http://www.delicious.com/jesser"><img width="16" height="16" src="//www.squarefree.com/icons/delicious.png" alt="" /> <span>My bookmarks</span></a></li>
<li class="iconlink"><a href="aim:goim?screenname=JesseRud"><img width="16" height="16" 
src="//www.squarefree.com/icons/aim2.png" alt="" /> <span>IM me</span></a></li>
<li class="iconlink"><a href="mailto:jruderman@gmail.com"><img width="16" height="16" 
src="//www.squarefree.com/icons/gmail2.png" alt="" /> <span>Mail me</span></a></li>

</ul>
</li>

<li><h2>Firefox</h2>
<ul>
<li><a href="http://www.squarefree.com/burningedge/">The Burning Edge</a></li>
<li><a href="http://www.squarefree.com/pornzilla/">Pornzilla</a></li>
<li><a href="http://www.squarefree.com/bugzilla/quicksearch-help.html">Bugzilla QuickSearch Guide</a></li>
</ul>
</li>

<li><h2>Browser addons</h2>
<ul>
<li><a href="https://www.squarefree.com/extensions/">Firefox extensions</a></li>
<li><a href="http://www.squarefree.com/categories/user-scripts/">Greasemonkey scripts</a></li>
<li><a href="https://www.squarefree.com/bookmarklets/">Bookmarklets</a></li>
<li><a href="http://www.squarefree.com/userstyles/">User Styles</a></li>
</ul>
</li>

<li><h2>Web development tools</h2>
<ul>
<li><a href="http://www.squarefree.com/htmledit/">Live HTML Editor</a></li>
<li><a href="http://www.squarefree.com/shell/">JavaScript Shell</a></li>
<li><a href="http://www.squarefree.com/jsenv/">JavaScript Environment</a></li>
</ul>
</li>


            <li><h2>Archives</h2>
                <ul>
                <li><a href="http://www.squarefree.com/all/">All posts</a></li>
                	<li class="cat-item cat-item-57"><a href="http://www.squarefree.com/categories/ads/" >Ads</a> (1)
</li>
	<li class="cat-item cat-item-46"><a href="http://www.squarefree.com/categories/apple/" >Apple</a> (2)
</li>
	<li class="cat-item cat-item-36"><a href="http://www.squarefree.com/categories/art/" >Art</a> (4)
</li>
	<li class="cat-item cat-item-39"><a href="http://www.squarefree.com/categories/ask-jesse/" >Ask Jesse</a> (8)
</li>
	<li class="cat-item cat-item-42"><a href="http://www.squarefree.com/categories/ask-the-world/" >Ask the world</a> (6)
</li>
	<li class="cat-item cat-item-11"><a href="http://www.squarefree.com/categories/blogging/" >Blogging</a> (14)
</li>
	<li class="cat-item cat-item-12"><a href="http://www.squarefree.com/categories/bookmarklets/" >Bookmarklets</a> (20)
</li>
	<li class="cat-item cat-item-34"><a href="http://www.squarefree.com/categories/broken/" >Broken</a> (9)
</li>
	<li class="cat-item cat-item-51"><a href="http://www.squarefree.com/categories/bug-tracking/" >Bug tracking</a> (11)
</li>
	<li class="cat-item cat-item-14"><a href="http://www.squarefree.com/categories/computational-complexity/" >Computational Complexity</a> (3)
</li>
	<li class="cat-item cat-item-31"><a href="http://www.squarefree.com/categories/cryptography/" >Cryptography</a> (2)
</li>
	<li class="cat-item cat-item-10"><a href="http://www.squarefree.com/categories/css/" >CSS</a> (5)
</li>
	<li class="cat-item cat-item-59"><a href="http://www.squarefree.com/categories/democracy/" >Democracy</a> (2)
</li>
	<li class="cat-item cat-item-62"><a href="http://www.squarefree.com/categories/differential-testing/" >Differential testing</a> (5)
</li>
	<li class="cat-item cat-item-29"><a href="http://www.squarefree.com/categories/dreamhost/" >DreamHost</a> (9)
</li>
	<li class="cat-item cat-item-58"><a href="http://www.squarefree.com/categories/economics/" >Economics</a> (3)
</li>
	<li class="cat-item cat-item-60"><a href="http://www.squarefree.com/categories/ethics/" >Ethics</a> (1)
</li>
	<li class="cat-item cat-item-45"><a href="http://www.squarefree.com/categories/fuzzing/" >Fuzzing</a> (18)
</li>
	<li class="cat-item cat-item-18"><a href="http://www.squarefree.com/categories/games/" >Games</a> (12)
</li>
	<li class="cat-item cat-item-8"><a href="http://www.squarefree.com/categories/google/" >Google</a> (38)
</li>
	<li class="cat-item cat-item-50"><a href="http://www.squarefree.com/categories/gtd/" >GTD</a> (9)
</li>
	<li class="cat-item cat-item-21"><a href="http://www.squarefree.com/categories/html/" >HTML</a> (2)
</li>
	<li class="cat-item cat-item-3"><a href="http://www.squarefree.com/categories/humor/" >Humor</a> (37)
</li>
	<li class="cat-item cat-item-27"><a href="http://www.squarefree.com/categories/intellectual-property/" >Intellectual Property</a> (4)
</li>
	<li class="cat-item cat-item-6"><a href="http://www.squarefree.com/categories/javascript/" >JavaScript</a> (19)
</li>
	<li class="cat-item cat-item-38"><a href="http://www.squarefree.com/categories/javascript-shell/" >JavaScript Shell</a> (5)
</li>
	<li class="cat-item cat-item-16"><a href="http://www.squarefree.com/categories/linguistics/" >Linguistics</a> (17)
</li>
	<li class="cat-item cat-item-47"><a href="http://www.squarefree.com/categories/mac/" >Mac</a> (3)
</li>
	<li class="cat-item cat-item-23"><a href="http://www.squarefree.com/categories/math/" >Math</a> (6)
</li>
	<li class="cat-item cat-item-33"><a href="http://www.squarefree.com/categories/me/" >Me</a> (4)
</li>
	<li class="cat-item cat-item-40"><a href="http://www.squarefree.com/categories/memes/" >Memes</a> (2)
</li>
	<li class="cat-item cat-item-7"><a href="http://www.squarefree.com/categories/mozilla/" >Mozilla</a> (253)
</li>
	<li class="cat-item cat-item-13"><a href="http://www.squarefree.com/categories/mudd/" >Mudd</a> (22)
</li>
	<li class="cat-item cat-item-9"><a href="http://www.squarefree.com/categories/music/" >Music</a> (11)
</li>
	<li class="cat-item cat-item-25"><a href="http://www.squarefree.com/categories/my-plans/" >My plans</a> (11)
</li>
	<li class="cat-item cat-item-5"><a href="http://www.squarefree.com/categories/perception/" >Perception</a> (9)
</li>
	<li class="cat-item cat-item-52"><a href="http://www.squarefree.com/categories/performance/" >Performance</a> (7)
</li>
	<li class="cat-item cat-item-24"><a href="http://www.squarefree.com/categories/photography/" >Photography</a> (3)
</li>
	<li class="cat-item cat-item-35"><a href="http://www.squarefree.com/categories/physics/" >Physics</a> (2)
</li>
	<li class="cat-item cat-item-4"><a href="http://www.squarefree.com/categories/politics/" >Politics</a> (24)
</li>
	<li class="cat-item cat-item-41"><a href="http://www.squarefree.com/categories/polls/" >Polls</a> (1)
</li>
	<li class="cat-item cat-item-26"><a href="http://www.squarefree.com/categories/porn/" >Porn</a> (15)
</li>
	<li class="cat-item cat-item-55"><a href="http://www.squarefree.com/categories/presentations/" >Presentations</a> (2)
</li>
	<li class="cat-item cat-item-20"><a href="http://www.squarefree.com/categories/quotes/" >Quotes</a> (5)
</li>
	<li class="cat-item cat-item-61"><a href="http://www.squarefree.com/categories/rapid-release/" >Rapid release</a> (6)
</li>
	<li class="cat-item cat-item-49"><a href="http://www.squarefree.com/categories/reduction/" >Reduction</a> (2)
</li>
	<li class="cat-item cat-item-48"><a href="http://www.squarefree.com/categories/religion/" >Religion</a> (3)
</li>
	<li class="cat-item cat-item-30"><a href="http://www.squarefree.com/categories/reputation/" >Reputation</a> (1)
</li>
	<li class="cat-item cat-item-32"><a href="http://www.squarefree.com/categories/research/" >Research</a> (3)
</li>
	<li class="cat-item cat-item-17"><a href="http://www.squarefree.com/categories/security/" >Security</a> (65)
</li>
	<li class="cat-item cat-item-15"><a href="http://www.squarefree.com/categories/space/" >Space</a> (3)
</li>
	<li class="cat-item cat-item-19"><a href="http://www.squarefree.com/categories/spam/" >Spam</a> (2)
</li>
	<li class="cat-item cat-item-54"><a href="http://www.squarefree.com/categories/tinderbox/" >Tinderbox</a> (6)
</li>
	<li class="cat-item cat-item-53"><a href="http://www.squarefree.com/categories/transportation/" >Transportation</a> (2)
</li>
	<li class="cat-item cat-item-22"><a href="http://www.squarefree.com/categories/travel/" >Travel</a> (10)
</li>
	<li class="cat-item cat-item-28"><a href="http://www.squarefree.com/categories/ucsd/" >UCSD</a> (9)
</li>
	<li class="cat-item cat-item-1"><a href="http://www.squarefree.com/categories/uncategorized/" >Uncategorized</a> (7)
</li>
	<li class="cat-item cat-item-2"><a href="http://www.squarefree.com/categories/user-interfaces/" >User Interfaces</a> (29)
</li>
	<li class="cat-item cat-item-37"><a href="http://www.squarefree.com/categories/user-scripts/" >User Scripts</a> (27)
</li>
	<li class="cat-item cat-item-56"><a href="http://www.squarefree.com/categories/user-styles/" >User Styles</a> (1)
</li>
                </ul>
            </li>
     </ul>
</div>


<hr />
<div id="footer">
	<p>
		Indistinguishable from Jesse is proudly powered by 
		<a href="http://wordpress.org">WordPress</a>
		<br /><a href="http://www.squarefree.com/feed/">Entries (RSS)</a>
		and <a href="http://www.squarefree.com/comments/feed/">Comments (RSS)</a>.
		<!-- 12 queries. 0.264 seconds. -->
	</p>
</div>
</div>

<!-- Gorgeous design by Michael Heilemann - http://binarybonsai.com/kubrick/ -->

		<script type='text/javascript' src='http://www.squarefree.com/wp-includes/js/wp-embed.min.js?ver=4.5.13'></script>

</body>
</html>