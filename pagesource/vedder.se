<!DOCTYPE html>
<!--[if IE 6]>
<html id="ie6" lang="en-US">
<![endif]-->
<!--[if IE 7]>
<html id="ie7" lang="en-US">
<![endif]-->
<!--[if IE 8]>
<html id="ie8" lang="en-US">
<![endif]-->
<!--[if !(IE 6) | !(IE 7) | !(IE 8)  ]><!-->
<html lang="en-US">
<!--<![endif]-->
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width" />
<title>Benjamin&#039;s robotics | A site about some of my projects, some tutorials and anything else I feel like publishing</title>
<link rel="profile" href="http://gmpg.org/xfn/11" />
<link rel="stylesheet" type="text/css" media="all" href="http://vedder.se/wp-content/themes/twentyeleven/style.css" />
<link rel="pingback" href="http://vedder.se/xmlrpc.php" />
<!--[if lt IE 9]>
<script src="http://vedder.se/wp-content/themes/twentyeleven/js/html5.js" type="text/javascript"></script>
<![endif]-->
<link rel="alternate" type="application/rss+xml" title="Benjamin&#039;s robotics &raquo; Feed" href="http://vedder.se/feed/" />
<link rel="alternate" type="application/rss+xml" title="Benjamin&#039;s robotics &raquo; Comments Feed" href="http://vedder.se/comments/feed/" />
		<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/72x72\/","ext":".png","source":{"concatemoji":"http:\/\/vedder.se\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.4.14"}};
			!function(a,b,c){function d(a){var c,d,e,f=b.createElement("canvas"),g=f.getContext&&f.getContext("2d"),h=String.fromCharCode;return g&&g.fillText?(g.textBaseline="top",g.font="600 32px Arial","flag"===a?(g.fillText(h(55356,56806,55356,56826),0,0),f.toDataURL().length>3e3):"diversity"===a?(g.fillText(h(55356,57221),0,0),c=g.getImageData(16,16,1,1).data,g.fillText(h(55356,57221,55356,57343),0,0),c=g.getImageData(16,16,1,1).data,e=c[0]+","+c[1]+","+c[2]+","+c[3],d!==e):("simple"===a?g.fillText(h(55357,56835),0,0):g.fillText(h(55356,57135),0,0),0!==g.getImageData(16,16,1,1).data[0])):!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g;c.supports={simple:d("simple"),flag:d("flag"),unicode8:d("unicode8"),diversity:d("diversity")},c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.simple&&c.supports.flag&&c.supports.unicode8&&c.supports.diversity||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
<link rel='stylesheet' id='wp-syntax-css-css'  href='http://vedder.se/wp-content/plugins/wp-syntax/css/wp-syntax.css?ver=1.0' type='text/css' media='all' />
<link rel='https://api.w.org/' href='http://vedder.se/wp-json/' />
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://vedder.se/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://vedder.se/wp-includes/wlwmanifest.xml" /> 
<meta name="generator" content="WordPress 4.4.14" />
</head>

<body class="home blog custom-background single-author two-column left-sidebar">
<div id="page" class="hfeed">
	<header id="branding" role="banner">
			<hgroup>
				<h1 id="site-title"><span><a href="http://vedder.se/" title="Benjamin&#039;s robotics" rel="home">Benjamin&#039;s robotics</a></span></h1>
				<h2 id="site-description">A site about some of my projects, some tutorials and anything else I feel like publishing</h2>
			</hgroup>

						<a href="http://vedder.se/">
									<img src="http://vedder.se/wp-content/uploads/2013/04/cropped-IMG_0945.jpg" width="1000" height="288" alt="" />
							</a>
			
								<form method="get" id="searchform" action="http://vedder.se/">
		<label for="s" class="assistive-text">Search</label>
		<input type="text" class="field" name="s" id="s" placeholder="Search" />
		<input type="submit" class="submit" name="submit" id="searchsubmit" value="Search" />
	</form>
			
			<nav id="access" role="navigation">
				<h3 class="assistive-text">Main menu</h3>
								<div class="skip-link"><a class="assistive-text" href="#content" title="Skip to primary content">Skip to primary content</a></div>
				<div class="skip-link"><a class="assistive-text" href="#secondary" title="Skip to secondary content">Skip to secondary content</a></div>
								<div class="menu"><ul><li class="current_page_item"><a href="http://vedder.se/">Home</a></li><li class="page_item page-item-853"><a href="http://vedder.se/open-hardware-projects/">Open Hardware Projects</a></li><li class="page_item page-item-118"><a href="http://vedder.se/tutorials/">Tutorials</a></li><li class="page_item page-item-2"><a href="http://vedder.se/sample-page/">About</a></li><li class="page_item page-item-14"><a href="http://vedder.se/contact/">Contact</a></li><li class="page_item page-item-958"><a href="http://vedder.se/forums">Forums</a></li></ul></div>
			</nav><!-- #access -->
	</header><!-- #branding -->


	<div id="main">

		<div id="primary">
			<div id="content" role="main">

													<nav id="nav-above">
			<h3 class="assistive-text">Post navigation</h3>
			<div class="nav-previous"><a href="http://vedder.se/page/2/" ><span class="meta-nav">&larr;</span> Older posts</a></div>
			<div class="nav-next"></div>
		</nav><!-- #nav-above -->
	
								
					
	<article id="post-916" class="post-916 post type-post status-publish format-standard hentry category-embedded_software category-tutorials">
		<header class="entry-header">
						<h1 class="entry-title"><a href="http://vedder.se/2015/08/vesc-writing-custom-applications/" rel="bookmark">VESC &#8211; Writing Custom Applications</a></h1>
			
						<div class="entry-meta">
				<span class="sep">Posted on </span><a href="http://vedder.se/2015/08/vesc-writing-custom-applications/" title="11:02" rel="bookmark"><time class="entry-date" datetime="2015-08-18T11:02:30+00:00">August 18, 2015</time></a><span class="by-author"> <span class="sep"> by </span> <span class="author vcard"><a class="url fn n" href="http://vedder.se/author/benjamin/" title="View all posts by Benjamin" rel="author">Benjamin</a></span></span>			</div><!-- .entry-meta -->
			
						<div class="comments-link">
				<a href="http://vedder.se/2015/08/vesc-writing-custom-applications/#comments">26</a>			</div>
					</header><!-- .entry-header -->

				<div class="entry-content">
			<p><strong>Updated: 2016-01-22</strong></p>
<p>The <a href="http://vedder.se/2015/01/vesc-open-source-esc/" target="_blank">VESC</a> has several extra ports and much extra computational power, so it can be used to run custom user code in addition to controlling a motor. This is convenient when there are space constraints and it is also the best way to implement real-time control applications where timing is critical. The code of the VESC is organized in such a way that it is easy to write and maintain custom applications while keeping the code up to date without having many conflicts when pulling updates using git. In this tutorial I will demonstrate how to make a custom application that will run a motor using speed control while a button is held with a speed proportional to the voltage on the ADC_EXT pin.</p>
<p> <a href="http://vedder.se/2015/08/vesc-writing-custom-applications/#more-916" class="more-link">Continue reading <span class="meta-nav">&rarr;</span></a></p>
					</div><!-- .entry-content -->
		
		<footer class="entry-meta">
												<span class="cat-links">
				<span class="entry-utility-prep entry-utility-prep-cat-links">Posted in</span> <a href="http://vedder.se/category/projects/embedded_software/" rel="category tag">Embedded Software</a>, <a href="http://vedder.se/category/tutorials/" rel="category tag">Tutorials</a>			</span>
															
									<span class="sep"> | </span>
						<span class="comments-link"><a href="http://vedder.se/2015/08/vesc-writing-custom-applications/#comments"><b>26</b> Replies</a></span>
			
					</footer><!-- .entry-meta -->
	</article><!-- #post-916 -->

				
					
	<article id="post-787" class="post-787 post type-post status-publish format-standard hentry category-electronics_hardware category-embedded_software category-news category-projects category-software tag-arm tag-arm-esc tag-bldc tag-chibios tag-esc tag-linux tag-longboard tag-open-source tag-p_oshw tag-pcb tag-skateboard tag-stm32f4 tag-tutorial tag-ubuntu tag-usb-cdc tag-ws2811 tag-ws2812">
		<header class="entry-header">
						<h1 class="entry-title"><a href="http://vedder.se/2015/01/vesc-open-source-esc/" rel="bookmark">VESC &#8211; Open Source ESC</a></h1>
			
						<div class="entry-meta">
				<span class="sep">Posted on </span><a href="http://vedder.se/2015/01/vesc-open-source-esc/" title="20:08" rel="bookmark"><time class="entry-date" datetime="2015-01-07T20:08:41+00:00">January 7, 2015</time></a><span class="by-author"> <span class="sep"> by </span> <span class="author vcard"><a class="url fn n" href="http://vedder.se/author/benjamin/" title="View all posts by Benjamin" rel="author">Benjamin</a></span></span>			</div><!-- .entry-meta -->
			
						<div class="comments-link">
				<a href="http://vedder.se/2015/01/vesc-open-source-esc/#comments">441</a>			</div>
					</header><!-- .entry-header -->

				<div class="entry-content">
			<p><strong>Post updated 2016-01-22</strong></p>
<h1>About this project</h1>
<p>I have made many updates to my custom motor controller recently and the old post is getting confusing with notes and updates, I decided to write a new post about it that hopefully is more clear, more complete and easier to follow. This might sound a bit ambitions, but my goal is to make the best ESC available. I really enjoy sharing knowledge, so I want to keep all the hardware and software open.</p>
<p>This is an overview of the schematic (download a complete PDF <a title="Schematic" href="https://github.com/vedderb/bldc-hardware/blob/master/design/BLDC_4.pdf?raw=true" target="_blank">here</a>):</p>
<p><a href="http://vedder.se/wp-content/uploads/2015/01/Schematic-1.png"><img class="alignnone size-large wp-image-798" src="http://vedder.se/wp-content/uploads/2015/01/Schematic-1-1024x725.png" alt="Schematic-1" width="584" height="413" srcset="http://vedder.se/wp-content/uploads/2015/01/Schematic-1-300x212.png 300w, http://vedder.se/wp-content/uploads/2015/01/Schematic-1-1024x725.png 1024w, http://vedder.se/wp-content/uploads/2015/01/Schematic-1-424x300.png 424w" sizes="(max-width: 584px) 100vw, 584px" /></a></p>
<p>This is the front of the PCB:</p>
<p><a href="http://vedder.se/wp-content/uploads/2015/01/PCB_Front.png"><img class="alignnone size-large wp-image-792" src="http://vedder.se/wp-content/uploads/2015/01/PCB_Front-1024x683.png" alt="PCB_Front" width="584" height="390" srcset="http://vedder.se/wp-content/uploads/2015/01/PCB_Front-300x200.png 300w, http://vedder.se/wp-content/uploads/2015/01/PCB_Front-1024x683.png 1024w, http://vedder.se/wp-content/uploads/2015/01/PCB_Front-450x300.png 450w" sizes="(max-width: 584px) 100vw, 584px" /></a></p>
<p>The back:</p>
<p><a href="http://vedder.se/wp-content/uploads/2015/01/pcb_back.jpg"><img class="alignnone size-large wp-image-789" src="http://vedder.se/wp-content/uploads/2015/01/pcb_back-1024x683.jpg" alt="pcb_back" width="584" height="390" srcset="http://vedder.se/wp-content/uploads/2015/01/pcb_back-300x200.jpg 300w, http://vedder.se/wp-content/uploads/2015/01/pcb_back-1024x683.jpg 1024w, http://vedder.se/wp-content/uploads/2015/01/pcb_back-450x300.jpg 450w" sizes="(max-width: 584px) 100vw, 584px" /></a></p>
<p>3D render from <a title="KiCad" href="http://www.kicad-pcb.org" target="_blank">KiCad</a>:</p>
<p><a href="http://vedder.se/wp-content/uploads/2015/01/3D.png"><img class="alignnone size-large wp-image-868" src="http://vedder.se/wp-content/uploads/2015/01/3D-1024x535.png" alt="3D" width="584" height="305" srcset="http://vedder.se/wp-content/uploads/2015/01/3D-300x157.png 300w, http://vedder.se/wp-content/uploads/2015/01/3D-1024x535.png 1024w, http://vedder.se/wp-content/uploads/2015/01/3D-500x261.png 500w, http://vedder.se/wp-content/uploads/2015/01/3D.png 1299w" sizes="(max-width: 584px) 100vw, 584px" /></a></p>
<p>Some screenshots of the configuration GUI (BLDC Tool):</p>
<p><a href="http://vedder.se/wp-content/uploads/2015/01/RT_Data.png"><img class="alignnone size-large wp-image-812" src="http://vedder.se/wp-content/uploads/2015/01/RT_Data-1024x605.png" alt="RT_Data" width="584" height="345" srcset="http://vedder.se/wp-content/uploads/2015/01/RT_Data-300x177.png 300w, http://vedder.se/wp-content/uploads/2015/01/RT_Data-1024x605.png 1024w, http://vedder.se/wp-content/uploads/2015/01/RT_Data-500x295.png 500w, http://vedder.se/wp-content/uploads/2015/01/RT_Data.png 1288w" sizes="(max-width: 584px) 100vw, 584px" /></a></p>
<p><a href="http://vedder.se/wp-content/uploads/2015/01/MCCONF_Limits.png"><img class="alignnone size-large wp-image-811" src="http://vedder.se/wp-content/uploads/2015/01/MCCONF_Limits-1024x605.png" alt="MCCONF_Limits" width="584" height="345" srcset="http://vedder.se/wp-content/uploads/2015/01/MCCONF_Limits-300x177.png 300w, http://vedder.se/wp-content/uploads/2015/01/MCCONF_Limits-1024x605.png 1024w, http://vedder.se/wp-content/uploads/2015/01/MCCONF_Limits-500x295.png 500w, http://vedder.se/wp-content/uploads/2015/01/MCCONF_Limits.png 1288w" sizes="(max-width: 584px) 100vw, 584px" /></a></p>
<p><a href="http://vedder.se/wp-content/uploads/2015/01/APP_PPM.png"><img class="alignnone size-large wp-image-813" src="http://vedder.se/wp-content/uploads/2015/01/APP_PPM-1024x605.png" alt="APP_PPM" width="584" height="345" srcset="http://vedder.se/wp-content/uploads/2015/01/APP_PPM-300x177.png 300w, http://vedder.se/wp-content/uploads/2015/01/APP_PPM-1024x605.png 1024w, http://vedder.se/wp-content/uploads/2015/01/APP_PPM-500x295.png 500w, http://vedder.se/wp-content/uploads/2015/01/APP_PPM.png 1288w" sizes="(max-width: 584px) 100vw, 584px" /></a></p>
<h1>Resources</h1>
<p>All files are on github to keep them up to date, so check these links on a regular basis:</p>
<ul>
<li><a title="bldc-hardware" href="https://github.com/vedderb/bldc-hardware" target="_blank">Hardware design</a></li>
<li><a title="BOM" href="https://docs.google.com/spreadsheet/ccc?key=0AnvZ-ouEB058dGpzaDl4MUxNM3NxZ1BzTWNZZ1RhRUE&amp;usp=sharing" target="_blank">Bill of materials</a></li>
<li><a title="bldc-firmware" href="https://github.com/vedderb/bldc" target="_blank">Firmware</a></li>
<li><a title="bldc-tool" href="https://github.com/vedderb/bldc-tool" target="_blank">Configuration GUI</a></li>
<li><a title="BLDC Logger" href="https://github.com/vedderb/bldc-logger" target="_blank">Video logger</a></li>
<li><a href="https://drive.google.com/folderview?id=0Bym9XrdeViekfkRETmRndENkcVpySW5sWjIzOWdrLThCY01HY3BPOXpqYVRHUlQxS0R5ZlU" target="_blank">osx and windows builds of BLDC Tool, Video logger etc. by Jacob Bloy</a></li>
</ul>
<h1>Related posts</h1>
<ul>
<li><a title="A custom BLDC motor controller (a custom ESC)" href="http://vedder.se/2014/01/a-custom-bldc-motor-controller/">Old post motor controller (just for reference)</a></li>
<li><a title="Open Source ESC Video Logging on Electric Longboard" href="http://vedder.se/2014/11/open-source-esc-video-logging-on-electric-longboard/">Video overlay logging</a></li>
<li><a title="Chosing the right BLDC motor and battery setup for an electric skateboard" href="http://vedder.se/2014/10/chosing-the-right-bldc-motor-and-battery-setup-for-an-electric-skateboard/">Electric skateboard motor tutorial (KV, cells, etc.)</a></li>
<li><a title="Startup torque on sensorless BLDC motors" href="http://vedder.se/2014/08/startup-torque-on-sensorless-bldc-motors/">Startup torque</a></li>
<li><a title="Debugging the STM32F4 using openocd, gdb and Eclipse" href="http://vedder.se/2012/12/debugging-the-stm32f4-using-openocd-gdb-and-eclipse/">Hardware debugging</a></li>
<li><a title="Connecting a programmer/debugger to my custom STM32 PCBs" href="http://vedder.se/2014/12/connecting-a-programmerdebugger-my-custom-stm32-pcbs/">Making a programmer</a></li>
<li><a href="http://vedder.se/2015/08/vesc-writing-custom-applications/" target="_blank">Writing custom applications</a></li>
<li><a href="http://vedder.se/2015/10/communicating-with-the-vesc-using-uart/" target="_blank">UART Communication</a></li>
</ul>
<h1>Forums</h1>
<p>Because information about the VESC is scattered all over the internet and a lot of information is in email conversations with me, I have created a forum dedicated to the VESC <a href="http://vedder.se/forums/" target="_blank">here</a>.</p>
<h1>Live Chat</h1>
<p>I have created an IRC channel on freenode where you can live chat with me and other users about VESC and my other projects. Feel free to join: <a title="vedder IRC channel" href="http://webchat.freenode.net/?channels=vedder" target="_blank">http://webchat.freenode.net/?channels=vedder</a></p>
<h1>Features</h1>
<ul>
<li>The hardware and software is open source. Since there are plenty of CPU-resources left, the customization possibilities are almost endless.</li>
<li>STM32F4 microcontroller.</li>
<li><a title="DRV8302" href="http://www.ti.com/product/drv8302" target="_blank">DRV8302</a> MOSFET driver / buck converter / current shunt amplifier.</li>
<li>IRFS7530 MOEFETs (other FETs in the same package also fit).</li>
<li>5V 1A output for external electronics from the buck converter integrated on the DRV8302.</li>
<li>Voltage: 8V &#8211; 60V (Safe for 3S to 12S LiPo).</li>
<li>Current: Up to 240A for a couple of seconds or about 50A continuous depending on the temperature and air circulation around the PCB.</li>
<li>Sensored and sensorless FOC wich auto-detection of all motor parameters is implemented since FW 2.3.</li>
<li>Firmware based on <a title="ChibiOS" href="http://www.chibios.org" target="_blank">ChibiOS/RT</a>.</li>
<li>PCB size: slightly less than 40mm x 60mm.</li>
<li>Current and voltage measurement on all phases.</li>
<li>Regenerative braking.</li>
<li>DC motors are also supported.</li>
<li>Sensored or sensorless operation.</li>
<li>A GUI with lots of configuration parameters</li>
<li>Adaptive PWM frequency to get as good ADC measurements as possible.</li>
<li>RPM-based phase advance (or timing/field weakening).</li>
<li>Good start-up torque in the sensorless mode (and obviously in the sensored mode as well).</li>
<li>The motor is used as a tachometer, which is good for odometry on modified RC cars.</li>
<li>Duty-cycle control, speed control or current control.</li>
<li>Seamless 4-quadrant operation.</li>
<li>Interface to control the motor: PPM signal (RC servo), analog, UART, I2C, USB  or CAN-bus.</li>
<li>Wireless wii nunchuk (Nyko Kama) control through the I2C port. This is convenient for electric skateboards.</li>
<li>Consumed and regenerated amp-hour and watt-hour counting.</li>
<li>Optional PPM signal output. Useful when e.g. controlling an RC car from a raspberry pi or an android device.</li>
<li>The USB port uses the modem profile, so an Android device can be connected to the motor controller without rooting. Because of the servo output, the odometry and the extra ADC inputs (that can be used for sensors), this is perfect for modifying an RC car to be controlled from Android (or raspberry pi).</li>
<li>Adjustable protection against
<ul>
<li>Low input voltage</li>
<li>High input voltage</li>
<li>High motor current</li>
<li>High input current</li>
<li>High regenerative braking current (separate limits for the motor and the input)</li>
<li>Rapid duty cycle changes (ramping)</li>
<li>High RPM (separate limits for each direction).</li>
</ul>
</li>
<li>When the current limits are hit, a soft back-off strategy is used while the motor keeps running. If the current becomes way too high, the motor is switched off completely.</li>
<li>The RPM limit also has a soft back-off strategy.</li>
<li>Commutation works perfectly even when the speed of the motor changes rapidly. This is due to the fact that the magnetic flux is integrated after the zero crossing instead of adding a delay based on the previous speed.</li>
<li>When the motor is rotating while the controller is off, the commutations and the direction are tracked. The duty-cycle to get the same speed is also calculated. This is to get a smooth start when the motor is already spinning.</li>
<li>All of the hardware is ready for sensorless <a title="Vector Control wikipedia" href="http://en.wikipedia.org/wiki/Vector_control_%28motor%29" target="_blank">field-oriented control (FOC)</a>. <del>Writing the software is the remaining part. However, I&#8217;m not sure if FOC will have many benefits for low inductance high-speed motors besides running a bit quieter.</del> Sensored and sensorless FOC is fully implemented since FW 2.3.</li>
</ul>
<p> <a href="http://vedder.se/2015/01/vesc-open-source-esc/#more-787" class="more-link">Continue reading <span class="meta-nav">&rarr;</span></a></p>
					</div><!-- .entry-content -->
		
		<footer class="entry-meta">
												<span class="cat-links">
				<span class="entry-utility-prep entry-utility-prep-cat-links">Posted in</span> <a href="http://vedder.se/category/projects/electronics_hardware/" rel="category tag">Electronics/Hardware</a>, <a href="http://vedder.se/category/projects/embedded_software/" rel="category tag">Embedded Software</a>, <a href="http://vedder.se/category/news/" rel="category tag">News/Announcements</a>, <a href="http://vedder.se/category/projects/" rel="category tag">Projects</a>, <a href="http://vedder.se/category/projects/software/" rel="category tag">Software</a>			</span>
															<span class="sep"> | </span>
							<span class="tag-links">
				<span class="entry-utility-prep entry-utility-prep-tag-links">Tagged</span> <a href="http://vedder.se/tag/arm/" rel="tag">ARM</a>, <a href="http://vedder.se/tag/arm-esc/" rel="tag">ARM ESC</a>, <a href="http://vedder.se/tag/bldc/" rel="tag">BLDC</a>, <a href="http://vedder.se/tag/chibios/" rel="tag">ChibiOS</a>, <a href="http://vedder.se/tag/esc/" rel="tag">ESC</a>, <a href="http://vedder.se/tag/linux/" rel="tag">linux</a>, <a href="http://vedder.se/tag/longboard/" rel="tag">longboard</a>, <a href="http://vedder.se/tag/open-source/" rel="tag">open source</a>, <a href="http://vedder.se/tag/p_oshw/" rel="tag">p_oshw</a>, <a href="http://vedder.se/tag/pcb/" rel="tag">PCB</a>, <a href="http://vedder.se/tag/skateboard/" rel="tag">skateboard</a>, <a href="http://vedder.se/tag/stm32f4/" rel="tag">STM32F4</a>, <a href="http://vedder.se/tag/tutorial/" rel="tag">tutorial</a>, <a href="http://vedder.se/tag/ubuntu/" rel="tag">Ubuntu</a>, <a href="http://vedder.se/tag/usb-cdc/" rel="tag">USB-CDC</a>, <a href="http://vedder.se/tag/ws2811/" rel="tag">ws2811</a>, <a href="http://vedder.se/tag/ws2812/" rel="tag">ws2812</a>			</span>
						
									<span class="sep"> | </span>
						<span class="comments-link"><a href="http://vedder.se/2015/01/vesc-open-source-esc/#comments"><b>441</b> Replies</a></span>
			
					</footer><!-- .entry-meta -->
	</article><!-- #post-787 -->

				
					
	<article id="post-935" class="post-935 post type-post status-publish format-standard hentry category-embedded_software category-tutorials">
		<header class="entry-header">
						<h1 class="entry-title"><a href="http://vedder.se/2015/10/communicating-with-the-vesc-using-uart/" rel="bookmark">Communicating with the VESC using UART</a></h1>
			
						<div class="entry-meta">
				<span class="sep">Posted on </span><a href="http://vedder.se/2015/10/communicating-with-the-vesc-using-uart/" title="13:34" rel="bookmark"><time class="entry-date" datetime="2015-10-09T13:34:47+00:00">October 9, 2015</time></a><span class="by-author"> <span class="sep"> by </span> <span class="author vcard"><a class="url fn n" href="http://vedder.se/author/benjamin/" title="View all posts by Benjamin" rel="author">Benjamin</a></span></span>			</div><!-- .entry-meta -->
			
						<div class="comments-link">
				<a href="http://vedder.se/2015/10/communicating-with-the-vesc-using-uart/#comments">10</a>			</div>
					</header><!-- .entry-header -->

				<div class="entry-content">
			<p>Many people have asked me how to communicate with the <a href="http://vedder.se/2015/01/vesc-open-source-esc/" target="_blank">VESC</a> using UART, but I did not have a good answer since I haven&#8217;t written any tutorial about that and the only thing I could refer to was the BLDC Tool code. Now I have created a project for the STM32F4 discovery board that implements UART communication with the VESC where the full interface is implemented. In this post I will try to explain how the code works and how to port it to other platforms.</p>
<p> <a href="http://vedder.se/2015/10/communicating-with-the-vesc-using-uart/#more-935" class="more-link">Continue reading <span class="meta-nav">&rarr;</span></a></p>
					</div><!-- .entry-content -->
		
		<footer class="entry-meta">
												<span class="cat-links">
				<span class="entry-utility-prep entry-utility-prep-cat-links">Posted in</span> <a href="http://vedder.se/category/projects/embedded_software/" rel="category tag">Embedded Software</a>, <a href="http://vedder.se/category/tutorials/" rel="category tag">Tutorials</a>			</span>
															
									<span class="sep"> | </span>
						<span class="comments-link"><a href="http://vedder.se/2015/10/communicating-with-the-vesc-using-uart/#comments"><b>10</b> Replies</a></span>
			
					</footer><!-- .entry-meta -->
	</article><!-- #post-935 -->

				
					
	<article id="post-777" class="post-777 post type-post status-publish format-standard hentry category-electronics_hardware category-embedded_software category-news category-projects category-tutorials tag-debug tag-discovery tag-program tag-stm32">
		<header class="entry-header">
						<h1 class="entry-title"><a href="http://vedder.se/2014/12/connecting-a-programmerdebugger-my-custom-stm32-pcbs/" rel="bookmark">Connecting a programmer/debugger to my custom STM32 PCBs</a></h1>
			
						<div class="entry-meta">
				<span class="sep">Posted on </span><a href="http://vedder.se/2014/12/connecting-a-programmerdebugger-my-custom-stm32-pcbs/" title="22:19" rel="bookmark"><time class="entry-date" datetime="2014-12-08T22:19:01+00:00">December 8, 2014</time></a><span class="by-author"> <span class="sep"> by </span> <span class="author vcard"><a class="url fn n" href="http://vedder.se/author/benjamin/" title="View all posts by Benjamin" rel="author">Benjamin</a></span></span>			</div><!-- .entry-meta -->
			
						<div class="comments-link">
				<a href="http://vedder.se/2014/12/connecting-a-programmerdebugger-my-custom-stm32-pcbs/#comments">11</a>			</div>
					</header><!-- .entry-header -->

				<div class="entry-content">
			<p>When I make custom STM32 PCBs (such as my <a title="CC2520 and STM32 RF boards" href="http://vedder.se/2013/04/cc2520-and-stm32-rf-boards/" target="_blank">RF-mote</a> or my <a title="A custom BLDC motor controller (a custom ESC)" href="http://vedder.se/2014/01/a-custom-bldc-motor-controller/" target="_blank">ESC</a>), I use an <a title="SWD wikipedia" href="http://en.wikipedia.org/wiki/Joint_Test_Action_Group#Serial_Wire_Debug" target="_blank">SWD</a> connector for programming and debugging the microcontroller. The connector is a 6-pin micro-jst connector with 2mm pitch, which easily can be found by <a title="ebay jst search" href="https:/whttp://www.ebay.com/sch/i.html?_from=R40&amp;_trksid=p2050601.m570.l1313.TR0.TRC0.H0.Xjst+6+pin+2.0.TRS0&amp;_nkw=jst+6+pin+2.0&amp;_sacat=0ww.ebay.com%2Fsch%2Fi.html%3F_trksid%3Dp2054436.m570.l1313.TR0.TRC0.Xjst%2B6%2Bpin%2B2.0%26_nkw%3Djst%2B6%2Bpin%2B2.0%26_sacat%3D0%26_from%3DR40" target="_blank">searching on ebay</a>. An STM32 discovery board with stlinkv2 works perfectly for programming and debugging, and can be connected as shown here (click on the picture to get a larger version where the wire colors can be seen):</p>
<p><a href="http://vedder.se/wp-content/uploads/2014/12/DiscoveryBoards_text.jpg"><img class="alignnone size-large wp-image-778" src="http://vedder.se/wp-content/uploads/2014/12/DiscoveryBoards_text-1024x625.jpg" alt="DiscoveryBoards_text" width="584" height="356" srcset="http://vedder.se/wp-content/uploads/2014/12/DiscoveryBoards_text-300x183.jpg 300w, http://vedder.se/wp-content/uploads/2014/12/DiscoveryBoards_text-1024x625.jpg 1024w" sizes="(max-width: 584px) 100vw, 584px" /></a></p>
<p>Notice that I have removed two jumpers on the discovery board to disconnect the SWD from the microcontroller. The pins in the jst connector are ordered in the same way as on the discovery board, but the outermost (green) cable is connected to 3V or VDD.</p>
<p>There are also some small and inexpensive stlinkv2 programmers available on ebay (just search for stlink v2), such as this one which I have soldered a micro-jst cable to:</p>
<p><a href="http://vedder.se/wp-content/uploads/2014/12/EbayStlink_small.jpg"><img class="alignnone size-large wp-image-779" src="http://vedder.se/wp-content/uploads/2014/12/EbayStlink_small-1024x786.jpg" alt="EbayStlink_small" width="584" height="448" srcset="http://vedder.se/wp-content/uploads/2014/12/EbayStlink_small-300x230.jpg 300w, http://vedder.se/wp-content/uploads/2014/12/EbayStlink_small-1024x786.jpg 1024w" sizes="(max-width: 584px) 100vw, 584px" /></a></p>
<p><strong>Update:</strong></p>
<p>I had some problems with too long JST cables. If uploading the program does not work for you, try shortening the JST cable.</p>
					</div><!-- .entry-content -->
		
		<footer class="entry-meta">
												<span class="cat-links">
				<span class="entry-utility-prep entry-utility-prep-cat-links">Posted in</span> <a href="http://vedder.se/category/projects/electronics_hardware/" rel="category tag">Electronics/Hardware</a>, <a href="http://vedder.se/category/projects/embedded_software/" rel="category tag">Embedded Software</a>, <a href="http://vedder.se/category/news/" rel="category tag">News/Announcements</a>, <a href="http://vedder.se/category/projects/" rel="category tag">Projects</a>, <a href="http://vedder.se/category/tutorials/" rel="category tag">Tutorials</a>			</span>
															<span class="sep"> | </span>
							<span class="tag-links">
				<span class="entry-utility-prep entry-utility-prep-tag-links">Tagged</span> <a href="http://vedder.se/tag/debug/" rel="tag">Debug</a>, <a href="http://vedder.se/tag/discovery/" rel="tag">discovery</a>, <a href="http://vedder.se/tag/program/" rel="tag">Program</a>, <a href="http://vedder.se/tag/stm32/" rel="tag">stm32</a>			</span>
						
									<span class="sep"> | </span>
						<span class="comments-link"><a href="http://vedder.se/2014/12/connecting-a-programmerdebugger-my-custom-stm32-pcbs/#comments"><b>11</b> Replies</a></span>
			
					</footer><!-- .entry-meta -->
	</article><!-- #post-777 -->

				
					
	<article id="post-458" class="post-458 post type-post status-publish format-standard hentry category-electronics_hardware category-embedded_software category-projects tag-arm tag-arm-toolchain tag-cc2520 tag-contiki tag-hardfloat tag-linux tag-pcb tag-stlink tag-stm32f4 tag-ubuntu tag-usb tag-usb-cdc tag-ws2811">
		<header class="entry-header">
						<h1 class="entry-title"><a href="http://vedder.se/2013/10/a-contiki-port-for-my-custom-cc2520stm32f4-boards/" rel="bookmark">A Contiki port for my custom cc2520+stm32f4-boards</a></h1>
			
						<div class="entry-meta">
				<span class="sep">Posted on </span><a href="http://vedder.se/2013/10/a-contiki-port-for-my-custom-cc2520stm32f4-boards/" title="13:08" rel="bookmark"><time class="entry-date" datetime="2013-10-04T13:08:53+00:00">October 4, 2013</time></a><span class="by-author"> <span class="sep"> by </span> <span class="author vcard"><a class="url fn n" href="http://vedder.se/author/benjamin/" title="View all posts by Benjamin" rel="author">Benjamin</a></span></span>			</div><!-- .entry-meta -->
			
						<div class="comments-link">
				<a href="http://vedder.se/2013/10/a-contiki-port-for-my-custom-cc2520stm32f4-boards/#comments">43</a>			</div>
					</header><!-- .entry-header -->

				<div class="entry-content">
			<p>Previously, I have designed a small circuit board with a cc2520 rf-tranceiver and a stm32f4 microcontroller (see <a title="CC2520 and STM32 RF boards" href="http://vedder.se/2013/04/cc2520-and-stm32-rf-boards/" target="_blank">this</a> post). After porting the driver for the cc2520 to <a title="ChibiOS" href="http://www.chibios.org" target="_blank">ChibiOS</a> for a few tests, I decided to port <a title="Contiki" href="http://www.contiki-os.org/" target="_blank">Contiki</a> to support this platform as well. As this is the first time that I work with Contiki, uipv6 and 6LoWPAN, this was quite a challenge for me. Nevertheless, I managed to make the following features work:</p>
<ul>
<li>The cc2520 radio</li>
<li>The RPL border router using the USB connector</li>
<li>RIME</li>
<li>IPv6</li>
<li>LEDs</li>
<li>printf for debugging</li>
<li>Many applications, such as the webserver, telnet, udp</li>
<li>I made a driver for ws2811 LEDs that uses DMA and a timer</li>
</ul>
<p>In this post, I will describe what the essential steps were to port Contiki to this board and how to use my port. I have uploaded the Contiki port together with a few example applications to github. You can download it <a title="Contiki" href="https://github.com/vedderb/contiki" target="_blank">here</a>.</p>
<p> <a href="http://vedder.se/2013/10/a-contiki-port-for-my-custom-cc2520stm32f4-boards/#more-458" class="more-link">Continue reading <span class="meta-nav">&rarr;</span></a></p>
					</div><!-- .entry-content -->
		
		<footer class="entry-meta">
												<span class="cat-links">
				<span class="entry-utility-prep entry-utility-prep-cat-links">Posted in</span> <a href="http://vedder.se/category/projects/electronics_hardware/" rel="category tag">Electronics/Hardware</a>, <a href="http://vedder.se/category/projects/embedded_software/" rel="category tag">Embedded Software</a>, <a href="http://vedder.se/category/projects/" rel="category tag">Projects</a>			</span>
															<span class="sep"> | </span>
							<span class="tag-links">
				<span class="entry-utility-prep entry-utility-prep-tag-links">Tagged</span> <a href="http://vedder.se/tag/arm/" rel="tag">ARM</a>, <a href="http://vedder.se/tag/arm-toolchain/" rel="tag">ARM toolchain</a>, <a href="http://vedder.se/tag/cc2520/" rel="tag">CC2520</a>, <a href="http://vedder.se/tag/contiki/" rel="tag">Contiki</a>, <a href="http://vedder.se/tag/hardfloat/" rel="tag">hardfloat</a>, <a href="http://vedder.se/tag/linux/" rel="tag">linux</a>, <a href="http://vedder.se/tag/pcb/" rel="tag">PCB</a>, <a href="http://vedder.se/tag/stlink/" rel="tag">STLink</a>, <a href="http://vedder.se/tag/stm32f4/" rel="tag">STM32F4</a>, <a href="http://vedder.se/tag/ubuntu/" rel="tag">Ubuntu</a>, <a href="http://vedder.se/tag/usb/" rel="tag">usb</a>, <a href="http://vedder.se/tag/usb-cdc/" rel="tag">USB-CDC</a>, <a href="http://vedder.se/tag/ws2811/" rel="tag">ws2811</a>			</span>
						
									<span class="sep"> | </span>
						<span class="comments-link"><a href="http://vedder.se/2013/10/a-contiki-port-for-my-custom-cc2520stm32f4-boards/#comments"><b>43</b> Replies</a></span>
			
					</footer><!-- .entry-meta -->
	</article><!-- #post-458 -->

				
					
	<article id="post-529" class="post-529 post type-post status-publish format-standard hentry category-electronics_hardware category-embedded_software category-projects category-software tag-arm tag-arm-bldc tag-arm-esc tag-bldc tag-chibios tag-custom-esc tag-drv8301 tag-drv8302 tag-esc tag-linux tag-pcb tag-robot-sm tag-robotsm tag-stm32-bldc tag-stm32-esc tag-stm32f4 tag-ubuntu tag-usb tag-usb-cdc">
		<header class="entry-header">
						<h1 class="entry-title"><a href="http://vedder.se/2014/01/a-custom-bldc-motor-controller/" rel="bookmark">A custom BLDC motor controller (a custom ESC)</a></h1>
			
						<div class="entry-meta">
				<span class="sep">Posted on </span><a href="http://vedder.se/2014/01/a-custom-bldc-motor-controller/" title="08:44" rel="bookmark"><time class="entry-date" datetime="2014-01-22T08:44:31+00:00">January 22, 2014</time></a><span class="by-author"> <span class="sep"> by </span> <span class="author vcard"><a class="url fn n" href="http://vedder.se/author/benjamin/" title="View all posts by Benjamin" rel="author">Benjamin</a></span></span>			</div><!-- .entry-meta -->
			
						<div class="comments-link">
				<a href="http://vedder.se/2014/01/a-custom-bldc-motor-controller/#comments">163</a>			</div>
					</header><!-- .entry-header -->

				<div class="entry-content">
			<h1>================= IMPORTANT UPDATE =================</h1>
<p>I have written a new post about my open ESC on <a title="VESC – Open Source ESC" href="http://vedder.se/2015/01/vesc-open-source-esc/">this page</a> and also updated the hardware significantly. If you haven&#8217;t built it yet and if you are planning to order parts for it, please refer to that page. I will only leave this page for reference in case you have built it before I wrote the new post and updated the hardware. Also, If you have built the ESC before, the tutorial and software on the new page also applies to the old hardware.</p>
<h1>=====================================================</h1>
<p><strong>Updated 2014-12-08</strong></p>
<p>For about three years I have been working on a custom <a title="BLDC wikipedia" href="http://en.wikipedia.org/wiki/Brushless_DC_electric_motor" target="_blank">BLDC</a> motor controller (also known as an <a title="ESC wikipedia" href="http://en.wikipedia.org/wiki/Electronic_Speed_Control" target="_blank">ESC</a>). I have spent hundreds of hours on writing code and I have made many minor and four major revisions of the printed circuit board (PCB). Now I finally have something that I can publish. The code can still be cleaned up a lot, especially the latest parts that I wrote in a hurry, but I don&#8217;t want to delay the release forever.</p>
<p>The features of this BLDC controller are:</p>
<ul>
<li>The hardware and software is open source.</li>
<li>A STM32F4 microcontroller.</li>
<li>A <a title="DRV8302" href="http://www.ti.com/product/drv8302" target="_blank">DRV8302</a> MOSFET driver / buck converter / current shunt amplifier.</li>
<li>IRFS3006 MOEFETs.</li>
<li>5V 1A output for external electronics from the buck converter integrated on the DRV8302.</li>
<li>Voltage: 8V &#8211; 60V.</li>
<li>Current: Up to 240A for a couple of seconds or about 50A continuous depending on the cooling.</li>
<li>PCB size: slightly less than 40mm x 60mm.</li>
<li>Current and voltage measurement on all phases.</li>
<li>Regenerative braking.</li>
<li>Sensored or sensorless commutation.</li>
<li>Adaptive PWM frequency to get as good ADC measurements as possible.</li>
<li>RPM-based phase advance.</li>
<li>Good start-up torque in the sensorless mode (and obviously in the sensored mode as well).</li>
<li>The motor is used as a tachometer, which is good for odometry on modified RC cars.</li>
<li>Duty-cycle control, speed control or current control.</li>
<li>Seamless 4-quadrant operation.</li>
<li>Interface to control the motor: servo signal, analog, UART, I2C, USB  or CAN (with a transceiver). Some of these modes need a bit more code to work, but not much.</li>
<li>Servo signal output. Good when e.g. controlling an RC car from a raspberry pi or an android device.</li>
<li>The USB port uses the modem profile, so an Android device can be connected to the motor controller without rooting. Because of the servo output, the odometry and the extra ADC inputs (that can be used for sensors), this is perfect for modifying a RC car to be controlled from Android (or raspberry pi).</li>
<li>Adjustable protection against
<ul>
<li>Low input voltage</li>
<li>High input voltage</li>
<li>High motor current</li>
<li>High input current</li>
<li>High regenerative braking current (separate limits for the motor and the input)</li>
<li>Rapid duty cycle changes (ramping)</li>
<li>High RPM (separate limits for each direction).</li>
</ul>
</li>
<li>When the current limits are hit, a soft back-off strategy is used while the motor keeps running.</li>
<li>The RPM limit also has a soft back-off strategy.</li>
<li>The commutation works perfectly even when the speed of the motor changes rapidly. This is due to the fact that the magnetic flux is integrated after the zero crossing instead of adding a delay based on the previous speed.</li>
<li>When the motor is rotating while the controller is off, the commutations and the direction are tracked. The duty-cycle to get the same speed is also calculated. This is to get a smooth start when the motor is already spinning.</li>
<li>All of the hardware is ready for sensorless <a title="Vector Control wikipedia" href="http://en.wikipedia.org/wiki/Vector_control_%28motor%29" target="_blank">field-oriented control (FOC)</a>. Writing the software is the remaining part.</li>
</ul>
<p>This is a photo of the front of the assembled PCB (please ignore the soldering quality&#8230;):</p>
<p><a href="http://vedder.se/wp-content/uploads/2014/01/Front1.jpg"><img class="alignnone size-large wp-image-594" src="http://vedder.se/wp-content/uploads/2014/01/Front1-1024x682.jpg" alt="Front" width="584" height="388" /></a></p>
<p> <a href="http://vedder.se/2014/01/a-custom-bldc-motor-controller/#more-529" class="more-link">Continue reading <span class="meta-nav">&rarr;</span></a></p>
					</div><!-- .entry-content -->
		
		<footer class="entry-meta">
												<span class="cat-links">
				<span class="entry-utility-prep entry-utility-prep-cat-links">Posted in</span> <a href="http://vedder.se/category/projects/electronics_hardware/" rel="category tag">Electronics/Hardware</a>, <a href="http://vedder.se/category/projects/embedded_software/" rel="category tag">Embedded Software</a>, <a href="http://vedder.se/category/projects/" rel="category tag">Projects</a>, <a href="http://vedder.se/category/projects/software/" rel="category tag">Software</a>			</span>
															<span class="sep"> | </span>
							<span class="tag-links">
				<span class="entry-utility-prep entry-utility-prep-tag-links">Tagged</span> <a href="http://vedder.se/tag/arm/" rel="tag">ARM</a>, <a href="http://vedder.se/tag/arm-bldc/" rel="tag">ARM BLDC</a>, <a href="http://vedder.se/tag/arm-esc/" rel="tag">ARM ESC</a>, <a href="http://vedder.se/tag/bldc/" rel="tag">BLDC</a>, <a href="http://vedder.se/tag/chibios/" rel="tag">ChibiOS</a>, <a href="http://vedder.se/tag/custom-esc/" rel="tag">custom ESC</a>, <a href="http://vedder.se/tag/drv8301/" rel="tag">DRV8301</a>, <a href="http://vedder.se/tag/drv8302/" rel="tag">DRV8302</a>, <a href="http://vedder.se/tag/esc/" rel="tag">ESC</a>, <a href="http://vedder.se/tag/linux/" rel="tag">linux</a>, <a href="http://vedder.se/tag/pcb/" rel="tag">PCB</a>, <a href="http://vedder.se/tag/robot-sm/" rel="tag">robot-sm</a>, <a href="http://vedder.se/tag/robotsm/" rel="tag">RobotSM</a>, <a href="http://vedder.se/tag/stm32-bldc/" rel="tag">STM32 BLDC</a>, <a href="http://vedder.se/tag/stm32-esc/" rel="tag">STM32 ESC</a>, <a href="http://vedder.se/tag/stm32f4/" rel="tag">STM32F4</a>, <a href="http://vedder.se/tag/ubuntu/" rel="tag">Ubuntu</a>, <a href="http://vedder.se/tag/usb/" rel="tag">usb</a>, <a href="http://vedder.se/tag/usb-cdc/" rel="tag">USB-CDC</a>			</span>
						
									<span class="sep"> | </span>
						<span class="comments-link"><a href="http://vedder.se/2014/01/a-custom-bldc-motor-controller/#comments"><b>163</b> Replies</a></span>
			
					</footer><!-- .entry-meta -->
	</article><!-- #post-529 -->

				
					
	<article id="post-392" class="post-392 post type-post status-publish format-standard hentry category-electronics_hardware category-embedded_software category-projects tag-arm tag-cc2520 tag-contiki tag-p_oshw tag-pcb tag-stm32f4 tag-ubuntu tag-usb tag-usb-cdc">
		<header class="entry-header">
						<h1 class="entry-title"><a href="http://vedder.se/2013/04/cc2520-and-stm32-rf-boards/" rel="bookmark">CC2520 and STM32 RF boards</a></h1>
			
						<div class="entry-meta">
				<span class="sep">Posted on </span><a href="http://vedder.se/2013/04/cc2520-and-stm32-rf-boards/" title="18:48" rel="bookmark"><time class="entry-date" datetime="2013-04-08T18:48:15+00:00">April 8, 2013</time></a><span class="by-author"> <span class="sep"> by </span> <span class="author vcard"><a class="url fn n" href="http://vedder.se/author/benjamin/" title="View all posts by Benjamin" rel="author">Benjamin</a></span></span>			</div><!-- .entry-meta -->
			
						<div class="comments-link">
				<a href="http://vedder.se/2013/04/cc2520-and-stm32-rf-boards/#comments">13</a>			</div>
					</header><!-- .entry-header -->

				<div class="entry-content">
			<p>I have made a small PCB with an STM32F4 microcontroller and a TI CC2520 radio transceiver. There are many mote modules available already, but I wanted one optimized for performance as opposed to power consumption. I also wanted to try making a PCB with some RF-parts since I haven&#8217;t done that before.</p>
<p>These are the 2-layer PCBs ordered from <a href="http://oshpark.com/" target="_blank">OSHPark</a>:</p>
<p><a href="http://vedder.se/wp-content/uploads/2013/04/RF_All.jpg"><img class="alignnone size-large wp-image-413" src="http://vedder.se/wp-content/uploads/2013/04/RF_All-1024x682.jpg" alt="RF_All" width="584" height="388" /></a></p>
<p> <a href="http://vedder.se/2013/04/cc2520-and-stm32-rf-boards/#more-392" class="more-link">Continue reading <span class="meta-nav">&rarr;</span></a></p>
					</div><!-- .entry-content -->
		
		<footer class="entry-meta">
												<span class="cat-links">
				<span class="entry-utility-prep entry-utility-prep-cat-links">Posted in</span> <a href="http://vedder.se/category/projects/electronics_hardware/" rel="category tag">Electronics/Hardware</a>, <a href="http://vedder.se/category/projects/embedded_software/" rel="category tag">Embedded Software</a>, <a href="http://vedder.se/category/projects/" rel="category tag">Projects</a>			</span>
															<span class="sep"> | </span>
							<span class="tag-links">
				<span class="entry-utility-prep entry-utility-prep-tag-links">Tagged</span> <a href="http://vedder.se/tag/arm/" rel="tag">ARM</a>, <a href="http://vedder.se/tag/cc2520/" rel="tag">CC2520</a>, <a href="http://vedder.se/tag/contiki/" rel="tag">Contiki</a>, <a href="http://vedder.se/tag/p_oshw/" rel="tag">p_oshw</a>, <a href="http://vedder.se/tag/pcb/" rel="tag">PCB</a>, <a href="http://vedder.se/tag/stm32f4/" rel="tag">STM32F4</a>, <a href="http://vedder.se/tag/ubuntu/" rel="tag">Ubuntu</a>, <a href="http://vedder.se/tag/usb/" rel="tag">usb</a>, <a href="http://vedder.se/tag/usb-cdc/" rel="tag">USB-CDC</a>			</span>
						
									<span class="sep"> | </span>
						<span class="comments-link"><a href="http://vedder.se/2013/04/cc2520-and-stm32-rf-boards/#comments"><b>13</b> Replies</a></span>
			
					</footer><!-- .entry-meta -->
	</article><!-- #post-392 -->

				
					
	<article id="post-766" class="post-766 post type-post status-publish format-standard hentry category-embedded_software category-projects category-software tag-esc tag-open-source tag-opencv tag-qt tag-stm32 tag-threads tag-video">
		<header class="entry-header">
						<h1 class="entry-title"><a href="http://vedder.se/2014/11/open-source-esc-video-logging-on-electric-longboard/" rel="bookmark">Open Source ESC Video Logging on Electric Longboard</a></h1>
			
						<div class="entry-meta">
				<span class="sep">Posted on </span><a href="http://vedder.se/2014/11/open-source-esc-video-logging-on-electric-longboard/" title="20:14" rel="bookmark"><time class="entry-date" datetime="2014-11-12T20:14:42+00:00">November 12, 2014</time></a><span class="by-author"> <span class="sep"> by </span> <span class="author vcard"><a class="url fn n" href="http://vedder.se/author/benjamin/" title="View all posts by Benjamin" rel="author">Benjamin</a></span></span>			</div><!-- .entry-meta -->
			
						<div class="comments-link">
				<a href="http://vedder.se/2014/11/open-source-esc-video-logging-on-electric-longboard/#comments">6</a>			</div>
					</header><!-- .entry-header -->

				<div class="entry-content">
			<p>In order to get an impression about what the load looks like while using my open source ESC on an electric longboard, I wrote a program using <a title="Qt" href="http://qt-project.org/" target="_blank">Qt</a> and <a title="opencv" href="http://opencv.org/" target="_blank">opencv</a> to do real-time video overlay logging while testing. This is the first test I made in my basement:</p>
<p><iframe src="//www.youtube.com/embed/KhORTusnI4k" width="560" height="315" frameborder="0" allowfullscreen="allowfullscreen"></iframe></p>
<p> <a href="http://vedder.se/2014/11/open-source-esc-video-logging-on-electric-longboard/#more-766" class="more-link">Continue reading <span class="meta-nav">&rarr;</span></a></p>
					</div><!-- .entry-content -->
		
		<footer class="entry-meta">
												<span class="cat-links">
				<span class="entry-utility-prep entry-utility-prep-cat-links">Posted in</span> <a href="http://vedder.se/category/projects/embedded_software/" rel="category tag">Embedded Software</a>, <a href="http://vedder.se/category/projects/" rel="category tag">Projects</a>, <a href="http://vedder.se/category/projects/software/" rel="category tag">Software</a>			</span>
															<span class="sep"> | </span>
							<span class="tag-links">
				<span class="entry-utility-prep entry-utility-prep-tag-links">Tagged</span> <a href="http://vedder.se/tag/esc/" rel="tag">ESC</a>, <a href="http://vedder.se/tag/open-source/" rel="tag">open source</a>, <a href="http://vedder.se/tag/opencv/" rel="tag">opencv</a>, <a href="http://vedder.se/tag/qt/" rel="tag">qt</a>, <a href="http://vedder.se/tag/stm32/" rel="tag">stm32</a>, <a href="http://vedder.se/tag/threads/" rel="tag">threads</a>, <a href="http://vedder.se/tag/video/" rel="tag">video</a>			</span>
						
									<span class="sep"> | </span>
						<span class="comments-link"><a href="http://vedder.se/2014/11/open-source-esc-video-logging-on-electric-longboard/#comments"><b>6</b> Replies</a></span>
			
					</footer><!-- .entry-meta -->
	</article><!-- #post-766 -->

				
					
	<article id="post-748" class="post-748 post type-post status-publish format-standard hentry category-electronics_hardware category-news category-projects category-tutorials tag-battery tag-bldc tag-electric-longboard tag-electric-skateboard tag-esc tag-kv">
		<header class="entry-header">
						<h1 class="entry-title"><a href="http://vedder.se/2014/10/chosing-the-right-bldc-motor-and-battery-setup-for-an-electric-skateboard/" rel="bookmark">Chosing the right BLDC motor and battery setup for an electric skateboard</a></h1>
			
						<div class="entry-meta">
				<span class="sep">Posted on </span><a href="http://vedder.se/2014/10/chosing-the-right-bldc-motor-and-battery-setup-for-an-electric-skateboard/" title="23:47" rel="bookmark"><time class="entry-date" datetime="2014-10-04T23:47:02+00:00">October 4, 2014</time></a><span class="by-author"> <span class="sep"> by </span> <span class="author vcard"><a class="url fn n" href="http://vedder.se/author/benjamin/" title="View all posts by Benjamin" rel="author">Benjamin</a></span></span>			</div><!-- .entry-meta -->
			
						<div class="comments-link">
				<a href="http://vedder.se/2014/10/chosing-the-right-bldc-motor-and-battery-setup-for-an-electric-skateboard/#comments">35</a>			</div>
					</header><!-- .entry-header -->

				<div class="entry-content">
			<p>Recently, I have been involved with the electric skateboard community because of my <a title="A custom BLDC motor controller (a custom ESC)" href="http://vedder.se/2014/01/a-custom-bldc-motor-controller/" target="_blank">custom ESC</a>. I get many questions about motor kv, gear ratio, current, voltage and efficiency. In this post, I will try to explain how things are connected and how to chose the right setup. I will try to keep things simple and not involve too many equations to provide a good intuition for the DIY community. The assumption in this post is that we are using an 50mm-60mm hobby <a title="outrunner" href="http://en.wikipedia.org/wiki/Outrunner">outrunner</a> motor.</p>
<p> <a href="http://vedder.se/2014/10/chosing-the-right-bldc-motor-and-battery-setup-for-an-electric-skateboard/#more-748" class="more-link">Continue reading <span class="meta-nav">&rarr;</span></a></p>
					</div><!-- .entry-content -->
		
		<footer class="entry-meta">
												<span class="cat-links">
				<span class="entry-utility-prep entry-utility-prep-cat-links">Posted in</span> <a href="http://vedder.se/category/projects/electronics_hardware/" rel="category tag">Electronics/Hardware</a>, <a href="http://vedder.se/category/news/" rel="category tag">News/Announcements</a>, <a href="http://vedder.se/category/projects/" rel="category tag">Projects</a>, <a href="http://vedder.se/category/tutorials/" rel="category tag">Tutorials</a>			</span>
															<span class="sep"> | </span>
							<span class="tag-links">
				<span class="entry-utility-prep entry-utility-prep-tag-links">Tagged</span> <a href="http://vedder.se/tag/battery/" rel="tag">battery</a>, <a href="http://vedder.se/tag/bldc/" rel="tag">BLDC</a>, <a href="http://vedder.se/tag/electric-longboard/" rel="tag">electric longboard</a>, <a href="http://vedder.se/tag/electric-skateboard/" rel="tag">electric skateboard</a>, <a href="http://vedder.se/tag/esc/" rel="tag">ESC</a>, <a href="http://vedder.se/tag/kv/" rel="tag">kv</a>			</span>
						
									<span class="sep"> | </span>
						<span class="comments-link"><a href="http://vedder.se/2014/10/chosing-the-right-bldc-motor-and-battery-setup-for-an-electric-skateboard/#comments"><b>35</b> Replies</a></span>
			
					</footer><!-- .entry-meta -->
	</article><!-- #post-748 -->

				
					
	<article id="post-694" class="post-694 post type-post status-publish format-standard hentry category-electronics_hardware category-embedded_software category-news tag-arm tag-bldc tag-chibios tag-custom-esc tag-drv8301 tag-drv8302 tag-esc tag-linux tag-pcb tag-stm32f4 tag-usb-cdc">
		<header class="entry-header">
						<h1 class="entry-title"><a href="http://vedder.se/2014/08/startup-torque-on-sensorless-bldc-motors/" rel="bookmark">Startup torque on sensorless BLDC motors</a></h1>
			
						<div class="entry-meta">
				<span class="sep">Posted on </span><a href="http://vedder.se/2014/08/startup-torque-on-sensorless-bldc-motors/" title="22:02" rel="bookmark"><time class="entry-date" datetime="2014-08-16T22:02:48+00:00">August 16, 2014</time></a><span class="by-author"> <span class="sep"> by </span> <span class="author vcard"><a class="url fn n" href="http://vedder.se/author/benjamin/" title="View all posts by Benjamin" rel="author">Benjamin</a></span></span>			</div><!-- .entry-meta -->
			
						<div class="comments-link">
				<a href="http://vedder.se/2014/08/startup-torque-on-sensorless-bldc-motors/#comments">24</a>			</div>
					</header><!-- .entry-header -->

				<div class="entry-content">
			<p>One of the major challenges when working on my <a title="A custom BLDC motor controller (a custom ESC)" href="http://vedder.se/2014/01/a-custom-bldc-motor-controller/" target="_blank">custom open source ESC</a> was to get good startup torque and low-speed performance with sensorless motors. This challenge has been addressed in several places around the net:</p>
<ul>
<li>Here is one article where Team Novak explain why sensored systems are superior to sensorless systems: <a title="Brushless Motors: Sensor-Based vs Sensorless" href="http://teamnovak.com/tech_info/view_article/24" target="_blank">http://teamnovak.com/tech_info/view_article/24</a></li>
<li>This article about electric scooters has some information about that topic too: <a title="Controlling the Outrunner: Sensorless or Sensored?" href="http://www.instructables.com/id/The-New-and-Improved-Brushless-Electric-Scooter-Po/step4/Controlling-the-Outrunner-Sensorless-or-Sensored/" target="_blank">http://www.instructables.com/id/The-New-and-Improved-Brushless-Electric-Scooter-Po/step4/Controlling-the-Outrunner-Sensorless-or-Sensored/</a></li>
<li>The metroboard has modified motors with hall sensors: <a title="Brushless Outrunner Motor Testing" href="http://metro-board.com/brushless-outrunner-motor-testing/" target="_blank">http://metro-board.com/brushless-outrunner-motor-testing/</a></li>
<li>The marbel electric skateboard also uses hall sensors: <a title="Marbel kickstarter" href="http://howtomakeanelectricskateboard.wordpress.com/2014/06/22/marbel-kickstarter/" target="_blank">http://howtomakeanelectricskateboard.wordpress.com/2014/06/22/marbel-kickstarter/</a></li>
<li>Here is a video of an electric longboard with a standard sensorless hobby ESC. There are obvious startup and low-speed issues: <a href="http://www.youtube.com/watch?v=SNt70MdUh0Q" target="_blank">http://www.youtube.com/watch?v=SNt70MdUh0Q</a></li>
</ul>
<h1>Techniques I used</h1>
<p>In order to get a smooth and quick startup without sensors I used several tricks, namely:</p>
<ul>
<li>There are no hardware low-pass filters that introduce phase delay. Such filters can be avoided because the ADC samples are synchronized to the PWM timer and adjusted dynamically every time the duty cycle or switching frequency is changed.</li>
<li>After a zero crossing, the area under the voltage is integrated until a threshold for commutation based on the motor parameters. This integration is robust agaist acceleration and provides good SNR since an integrator is a low-pass filter.</li>
<li>There is a parameter that defines the voltage coupling between the windings when measuring the back-emf. This make a huge difference when running at low speeds with low duty cycle. This compensation has a RPM dependence though, which is something I tried to avoid where possible because the RPM estimation has a delay and thus causes problems during acceleration.</li>
<li>To get better voltage samples, the switching frequency is adaptive and proportional to the duty cycle. This is because the back-EMF only can be sampled during the ON-time of the PWM cycle and low duty cycles have short ON time. Since the motor is running slowly on low duty cycles, sampling and switching does not have to be as fast to keep up with the motor which makes this less of a problem. Lower switching frequency also decreases switching losses, which is a positive side-effect.</li>
<li>When the motor is un-driven, the back-emf on all phases is analysed to track the position, direction and speed of the motor. So when the motor is already spinning, the algorithm will begin in the exact state of the motor (position, duty-cycle, direction).</li>
<li>I have also used some hack-ish conditions based on trial and error to improve the startup.</li>
<li>Closed loop operation is used from the first commutation, since the measured values are clean enough when using these techniques.</li>
</ul>
<p>This is a video where I demonstrate how this works on a scorpion outrunner and an electric longboard:</p>
<p><iframe src="//www.youtube.com/embed/MfNcHmt_avE" width="560" height="315" frameborder="0" allowfullscreen="allowfullscreen"></iframe></p>
<h1>Some examples with plots</h1>
<p>** Note that all the plots show the voltages samples captured by the motor controller, which are synchronized to the PWM timer. It would look different on an oscilloscope since the switching distorts the signal. **</p>
<p>This is what the phase voltage for a typical startup sequence looks like, where the duty cycle is set to 5%:</p>
<p><a href="http://vedder.se/wp-content/uploads/2014/08/start_d5_almost_auto_voltage.png"><img class="alignnone size-large wp-image-715" src="http://vedder.se/wp-content/uploads/2014/08/start_d5_almost_auto_voltage-1024x408.png" alt="start_d5_almost_auto_voltage" width="584" height="232" srcset="http://vedder.se/wp-content/uploads/2014/08/start_d5_almost_auto_voltage-300x119.png 300w, http://vedder.se/wp-content/uploads/2014/08/start_d5_almost_auto_voltage-1024x408.png 1024w, http://vedder.se/wp-content/uploads/2014/08/start_d5_almost_auto_voltage-500x199.png 500w" sizes="(max-width: 584px) 100vw, 584px" /></a></p>
<p>Even though the duty cycle is only 5%, the waveform is clean. This is because the switching frequency is low at this speed and the on-time is long enough to get good samples. The first commutation is a bit off at first since the motor is not perfectly aligned, but the second commutation already looks perfect.</p>
<p> <a href="http://vedder.se/2014/08/startup-torque-on-sensorless-bldc-motors/#more-694" class="more-link">Continue reading <span class="meta-nav">&rarr;</span></a></p>
					</div><!-- .entry-content -->
		
		<footer class="entry-meta">
												<span class="cat-links">
				<span class="entry-utility-prep entry-utility-prep-cat-links">Posted in</span> <a href="http://vedder.se/category/projects/electronics_hardware/" rel="category tag">Electronics/Hardware</a>, <a href="http://vedder.se/category/projects/embedded_software/" rel="category tag">Embedded Software</a>, <a href="http://vedder.se/category/news/" rel="category tag">News/Announcements</a>			</span>
															<span class="sep"> | </span>
							<span class="tag-links">
				<span class="entry-utility-prep entry-utility-prep-tag-links">Tagged</span> <a href="http://vedder.se/tag/arm/" rel="tag">ARM</a>, <a href="http://vedder.se/tag/bldc/" rel="tag">BLDC</a>, <a href="http://vedder.se/tag/chibios/" rel="tag">ChibiOS</a>, <a href="http://vedder.se/tag/custom-esc/" rel="tag">custom ESC</a>, <a href="http://vedder.se/tag/drv8301/" rel="tag">DRV8301</a>, <a href="http://vedder.se/tag/drv8302/" rel="tag">DRV8302</a>, <a href="http://vedder.se/tag/esc/" rel="tag">ESC</a>, <a href="http://vedder.se/tag/linux/" rel="tag">linux</a>, <a href="http://vedder.se/tag/pcb/" rel="tag">PCB</a>, <a href="http://vedder.se/tag/stm32f4/" rel="tag">STM32F4</a>, <a href="http://vedder.se/tag/usb-cdc/" rel="tag">USB-CDC</a>			</span>
						
									<span class="sep"> | </span>
						<span class="comments-link"><a href="http://vedder.se/2014/08/startup-torque-on-sensorless-bldc-motors/#comments"><b>24</b> Replies</a></span>
			
					</footer><!-- .entry-meta -->
	</article><!-- #post-694 -->

				
						<nav id="nav-below">
			<h3 class="assistive-text">Post navigation</h3>
			<div class="nav-previous"><a href="http://vedder.se/page/2/" ><span class="meta-nav">&larr;</span> Older posts</a></div>
			<div class="nav-next"></div>
		</nav><!-- #nav-above -->
	
			
			</div><!-- #content -->
		</div><!-- #primary -->

		<div id="secondary" class="widget-area" role="complementary">
					<aside id="recent-posts-2" class="widget widget_recent_entries">		<h3 class="widget-title">Recent Posts</h3>		<ul>
					<li>
				<a href="http://vedder.se/2015/10/communicating-with-the-vesc-using-uart/">Communicating with the VESC using UART</a>
						</li>
					<li>
				<a href="http://vedder.se/2015/08/vesc-writing-custom-applications/">VESC &#8211; Writing Custom Applications</a>
						</li>
					<li>
				<a href="http://vedder.se/2015/01/vesc-open-source-esc/">VESC &#8211; Open Source ESC</a>
						</li>
					<li>
				<a href="http://vedder.se/2014/12/connecting-a-programmerdebugger-my-custom-stm32-pcbs/">Connecting a programmer/debugger to my custom STM32 PCBs</a>
						</li>
					<li>
				<a href="http://vedder.se/2014/11/open-source-esc-video-logging-on-electric-longboard/">Open Source ESC Video Logging on Electric Longboard</a>
						</li>
				</ul>
		</aside>		<aside id="categories-2" class="widget widget_categories"><h3 class="widget-title">Categories</h3>		<ul>
	<li class="cat-item cat-item-1"><a href="http://vedder.se/category/news/" >News/Announcements</a> (6)
</li>
	<li class="cat-item cat-item-4"><a href="http://vedder.se/category/projects/" >Projects</a> (19)
<ul class='children'>
	<li class="cat-item cat-item-5"><a href="http://vedder.se/category/projects/electronics_hardware/" >Electronics/Hardware</a> (10)
</li>
	<li class="cat-item cat-item-7"><a href="http://vedder.se/category/projects/embedded_software/" title="Software intended to run on embedded platforms, often aimed towards specific hardware.">Embedded Software</a> (16)
</li>
	<li class="cat-item cat-item-6"><a href="http://vedder.se/category/projects/software/" title="Software that runs on Linux">Software</a> (3)
</li>
</ul>
</li>
	<li class="cat-item cat-item-3"><a href="http://vedder.se/category/tutorials/" >Tutorials</a> (8)
</li>
		</ul>
</aside><aside id="archives-2" class="widget widget_archive"><h3 class="widget-title">Archives</h3>		<ul>
			<li><a href='http://vedder.se/2015/10/'>October 2015</a></li>
	<li><a href='http://vedder.se/2015/08/'>August 2015</a></li>
	<li><a href='http://vedder.se/2015/01/'>January 2015</a></li>
	<li><a href='http://vedder.se/2014/12/'>December 2014</a></li>
	<li><a href='http://vedder.se/2014/11/'>November 2014</a></li>
	<li><a href='http://vedder.se/2014/10/'>October 2014</a></li>
	<li><a href='http://vedder.se/2014/08/'>August 2014</a></li>
	<li><a href='http://vedder.se/2014/05/'>May 2014</a></li>
	<li><a href='http://vedder.se/2014/02/'>February 2014</a></li>
	<li><a href='http://vedder.se/2014/01/'>January 2014</a></li>
	<li><a href='http://vedder.se/2013/10/'>October 2013</a></li>
	<li><a href='http://vedder.se/2013/04/'>April 2013</a></li>
	<li><a href='http://vedder.se/2012/12/'>December 2012</a></li>
	<li><a href='http://vedder.se/2012/07/'>July 2012</a></li>
	<li><a href='http://vedder.se/2012/05/'>May 2012</a></li>
	<li><a href='http://vedder.se/2012/04/'>April 2012</a></li>
		</ul>
		</aside>		</div><!-- #secondary .widget-area -->

	</div><!-- #main -->

	<footer id="colophon" role="contentinfo">

			
<div id="supplementary" class="two">
		<div id="first" class="widget-area" role="complementary">
		<aside id="categories-3" class="widget widget_categories"><h3 class="widget-title">Categories</h3><label class="screen-reader-text" for="cat">Categories</label><select name='cat' id='cat' class='postform' >
	<option value='-1'>Select Category</option>
	<option class="level-0" value="1">News/Announcements&nbsp;&nbsp;(6)</option>
	<option class="level-0" value="4">Projects&nbsp;&nbsp;(19)</option>
	<option class="level-1" value="5">&nbsp;&nbsp;&nbsp;Electronics/Hardware&nbsp;&nbsp;(10)</option>
	<option class="level-1" value="7">&nbsp;&nbsp;&nbsp;Embedded Software&nbsp;&nbsp;(16)</option>
	<option class="level-1" value="6">&nbsp;&nbsp;&nbsp;Software&nbsp;&nbsp;(3)</option>
	<option class="level-0" value="3">Tutorials&nbsp;&nbsp;(8)</option>
</select>

<script type='text/javascript'>
/* <![CDATA[ */
(function() {
	var dropdown = document.getElementById( "cat" );
	function onCatChange() {
		if ( dropdown.options[ dropdown.selectedIndex ].value > 0 ) {
			location.href = "http://vedder.se/?cat=" + dropdown.options[ dropdown.selectedIndex ].value;
		}
	}
	dropdown.onchange = onCatChange;
})();
/* ]]> */
</script>

</aside>	</div><!-- #first .widget-area -->
	
	
		<div id="third" class="widget-area" role="complementary">
		<aside id="text-2" class="widget widget_text">			<div class="textwidget"><a href="https://www.paypal.com/cgi-bin/webscr?cmd=_donations&amp;business=7ZMDJJFHUSCV4&amp;lc=US&amp;item_name=vedder%2ese&amp;currency_code=EUR&amp;bn=PP%2dDonationsBF%3abtn_donateCC_LG%2egif%3aNonHosted" target="_blank" rel="nofollow"><img src="https://www.paypal.com/en_US/i/btn/x-click-but21.gif" alt="" /></a></div>
		</aside>	</div><!-- #third .widget-area -->
	</div><!-- #supplementary -->
			<div id="site-generator">
								Benjamin Vedder 2014 | <a href="http://wordpress.org/" title="Semantic Personal Publishing Platform" rel="generator">Powered by WordPress</a>
			</div>
	</footer><!-- #colophon -->
</div><!-- #page -->

<script type='text/javascript' src='http://vedder.se/wp-includes/js/wp-embed.min.js?ver=4.4.14'></script>

</body>
</html>